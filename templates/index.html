    <!DOCTYPE html>
    <html lang="tr">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Ser Elektrik Otomasyon - Dashboard</title>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
        <style>
            /* --- anasayfa.html'den alınan tüm CSS buraya gelecek --- */
            :root {
                --primary: #005c9d;
                --primary-light: #0980d3;
                --white: #ffffff;
                --light-gray: #97a1aa;
                --dark-gray: #5e6870;
                --bg-color: #f8f9fa;
                --card-bg: #ffffff;
                --text-color: #333333;
                --input-bg: #f0f4f8;
                --border-color: #e1e5e9;
                --sidebar-bg: #ffffff;
                --topbar-bg: #ffffff;
                --success: #2ed573;
                --danger: #ff4757;
                --warning: #ffc107;
                --info: #0980d3;
                --primary-light-bg: rgba(9, 128, 211, 0.1); /* Yeni: Hafif birincil renk arka planı */
            }

            [data-theme="dark"] {
                --bg-color: #121212;
                --card-bg: #1e1e1e;
                --text-color: #e0e0e0;
                --input-bg: #2d2d2d;
                --border-color: #3a3a3a;
                --sidebar-bg: #1a1a1a;
                --topbar-bg: #1a1a1a;
                --primary-light-bg: rgba(9, 128, 211, 0.2); /* Koyu tema için hafif birincil renk arka planı */
            }

            /* Chart.js renkleri için doğrudan HEX değerleri (mevcut temayla uyumlu) */
            .chart-color-info { background-color: #0980d3; }
            .chart-color-success { background-color: #2ed573; }
            .chart-color-danger { background-color: #ff4757; }
            .chart-color-warning { background-color: #ffc107; }

            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                transition: background-color 0.3s, color 0.3s;
            }

            body {
                background-color: var(--bg-color);
                color: var(--text-color);
                display: flex;
                min-height: 100vh;
                overflow-x: hidden; /* Yatay kaydırmayı engelle */
            }

            /* Hamburger menü butonu */
            .hamburger-menu {
                display: none; /* Varsayılan olarak gizli */
                background-color: var(--primary);
                color: var(--white);
                border: none;
                border-radius: 8px;
                padding: 10px 12px;
                cursor: pointer;
                font-size: 20px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.2);
                margin-right: 15px; /* Sağında boşluk bırak */
                flex-shrink: 0; /* Küçülmesini engelle */
            }

            .sidebar {
                width: 260px;
                background-color: var(--sidebar-bg);
                border-right: 1px solid var(--border-color);
                height: 100vh;
                position: fixed; /* Masaüstünde sabit */
                overflow-y: auto;
                padding: 20px 0;
                z-index: 1000;
                transform: translateX(0); /* Masaüstünde görünür */
                transition: transform 0.3s ease-in-out;
            }

            .sidebar.show { /* Mobil görünümde açıldığında */
                transform: translateX(0);
            }
            .sidebar.hidden { /* Mobil görünümde gizli */
                transform: translateX(-100%);
            }

            .logo-container {
                display: flex;
                align-items: center;
                padding: 0 20px 25px 20px;
                border-bottom: 1px solid var(--border-color);
                margin-bottom: 25px;
            }

            .logo-icon {
                background: linear-gradient(135deg, var(--primary), var(--primary-light));
                width: 40px;
                height: 40px;
                border-radius: 10px;
                display: flex;
                align-items: center;
                justify-content: center;
                color: var(--white);
                font-size: 20px;
                margin-right: 12px;
            }

            .logo-text {
                font-size: 20px;
                font-weight: 700;
                color: var(--primary);
            }

            .nav-item {
                padding: 12px 25px;
                display: flex;
                align-items: center;
                color: var(--text-color);
                text-decoration: none;
                border-left: 3px solid transparent;
                margin-bottom: 5px;
                transition: all 0.2s;
            }

            .nav-item:hover, .nav-item.active {
                background-color: rgba(9, 128, 211, 0.1);
                border-left-color: var(--primary-light);
                color: var(--primary-light);
            }

            .nav-item i {
                font-size: 18px;
                margin-right: 15px;
                width: 24px;
                text-align: center;
            }

            .main-content {
                flex: 1;
                margin-left: 260px; /* Sidebar genişliği kadar boşluk */
                transition: margin-left 0.3s ease-in-out;
                width: calc(100% - 260px); /* Kalan genişliği kapla */
            }

            .main-content.expanded {
                margin-left: 0; /* Sidebar gizlendiğinde boşluk sıfırla */
                width: 100%;
            }

            /* Topbar */
            .topbar {
                background-color: var(--topbar-bg);
                border-bottom: 1px solid var(--border-color);
                padding: 15px 30px; /* Takvim.html ile aynı padding */
                display: flex;
                justify-content: space-between;
                align-items: center;
                position: sticky;
                top: 0;
                z-index: 100;
                flex-wrap: nowrap; /* Masaüstünde sarmalamayı engelle */
                gap: 15px; /* Öğeler arası boşluk */
            }

            .search-container {
                position: relative;
                width: 300px; /* Masaüstü varsayılan */
                flex-grow: 1; /* Esnek genişlik */
            }

            .search-container input {
                width: 100%;
                padding: 10px 15px 10px 40px;
                border-radius: 8px;
                border: 1px solid var(--border-color);
                background-color: var(--input-bg);
                color: var(--text-color);
            }

            .search-container i {
                position: absolute;
                left: 15px;
                top: 50%;
                transform: translateY(-50%);
                color: var(--light-gray);
            }

            .topbar-actions {
                display: flex;
                align-items: center;
                gap: 20px;
                margin-left: auto; /* Masaüstünde sağa it */
                flex-shrink: 0; /* Küçülmesini engelle */
            }

            .notification-btn, .theme-toggle {
                width: 40px;
                height: 40px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                background-color: var(--input-bg);
                color: var(--text-color);
                cursor: pointer;
                position: relative;
                flex-shrink: 0; /* Küçülmesini engelle */
            }

            .notification-btn::after {
                content: attr(data-count); /* JS ile dinamik olarak güncellenecek */
                position: absolute;
                top: 5px;
                right: 5px;
                background-color: #ff4757;
                color: white;
                font-size: 10px;
                width: 16px;
                height: 16px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                /* Başlangıçta gizli, bildirim varsa gösterilecek */
                opacity: 0; 
                transform: scale(0);
                transition: all 0.2s ease-out;
            }
            .notification-btn.has-notifications::after {
                opacity: 1;
                transform: scale(1);
            }

            .user-profile {
                display: flex;
                align-items: center;
                gap: 12px;
                cursor: pointer;
                flex-shrink: 0;
            }

            /* user-avatar.js tarafından yönetilecek */
            /* .user-avatar {
                width: 40px;
                height: 40px;
                border-radius: 50%;
                background: linear-gradient(135deg, var(--primary), var(--primary-light));
                display: flex;
                align-items: center;
                justify-content: center;
                color: var(--white);
                font-weight: 600;
                overflow: hidden; /* Added for circular image clipping 
            }
    */
            .user-avatar img { /* Added for circular image clipping */
                width: 100%;
                height: 100%;
                object-fit: cover;
            } */

            .user-info {
                display: flex;
                flex-direction: column;
            }

            .user-name {
                font-weight: 600;
                font-size: 15px;
            }

            .user-role {
                font-size: 13px;
                color: var(--light-gray);
            }

            /* Tek Çıkış Butonu Stilleri */
            .logout-btn {
                display: flex; /* Varsayılan olarak masaüstünde görünür */
                align-items: center;
                justify-content: center;
                padding: 10px 20px; /* Standart padding */
                border-radius: 10px;
                font-size: 15px;
                font-weight: 600;
                gap: 8px;
                transition: all 0.3s ease;
                background: transparent;
                border: 1px solid var(--primary-light);
                color: var(--primary-light);
                margin-left: 10px; /* Masaüstünde sağa boşluk */
            }

            .logout-btn:hover {
                background-color: var(--primary); /* Takvim.html'deki gibi hover rengi */
                color: var(--white); /* Takvim.html'deki gibi yazı rengi */
                transform: translateY(-2px);
                box-shadow: 0 6px 20px rgba(0,0,0,0.2); /* Takvim.html'deki gibi gölge */
            }

            .dashboard-content {
                padding: 30px;
            }

            .page-title {
                font-size: 28px;
                margin-bottom: 25px;
                display: flex;
                align-items: center;
                gap: 12px;
            }

            .page-title i {
                color: var(--primary-light);
            }

            .stats-container {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
                gap: 20px;
                margin-bottom: 30px;
            }

            .stat-card {
                background-color: var(--card-bg);
                border-radius: 12px;
                padding: 20px;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
                display: flex;
                flex-direction: column;
            }

            .stat-card-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 15px;
            }

            .stat-card-title {
                color: var(--light-gray);
                font-size: 15px;
            }

            .stat-card-icon {
                width: 40px;
                height: 40px;
                border-radius: 10px;
                display: flex;
                align-items: center;
                justify-content: center;
                background-color: rgba(9, 128, 211, 0.1);
                color: var(--primary-light);
            }

            .stat-card-value {
                font-size: 28px;
                font-weight: 700;
                margin-bottom: 5px;
            }

            .stat-card-change {
                font-size: 13px;
                color: #2ed573;
                display: flex;
                align-items: center;
            }

            .stat-card-change.down {
                color: #ff4757;
            }

            .charts-activity-container {
                display: grid;
                grid-template-columns: 2fr 1fr;
                gap: 25px;
                margin-bottom: 30px;
            }

            .card {
                background-color: var(--card-bg);
                border-radius: 12px;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
                overflow: hidden;
                height: 100%;
            }

            .card-header {
                padding: 18px 20px;
                border-bottom: 1px solid var(--border-color);
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .card-title {
                font-size: 18px;
                font-weight: 600;
            }

            .card-link {
                color: var(--primary-light);
                font-size: 14px;
                text-decoration: none;
            }

            .card-body {
                padding: 20px;
            }

            .chart-container {
                height: 300px;
                position: relative;
            }

            .activity-item {
                display: flex;
                padding: 15px 0;
                border-bottom: 1px solid var(--border-color);
                /* Make activity items visually static */
                cursor: default; 
                pointer-events: none;
            }

            .activity-item:last-child {
                border-bottom: none;
            }

            .activity-icon {
                width: 40px;
                height: 40px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                background-color: rgba(9, 128, 211, 0.1);
                color: var(--primary-light);
                font-size: 18px;
                margin-right: 15px;
                flex-shrink: 0;
            }

            .activity-content {
                flex: 1;
            }

            .activity-title {
                font-weight: 600;
                margin-bottom: 5px;
            }

            .activity-desc {
                color: var(--light-gray);
                font-size: 14px;
                margin-bottom: 5px;
            }

            .activity-time {
                font-size: 12px;
                color: var(--light-gray);
            }

            .projects-container {
                background-color: var(--card-bg);
                border-radius: 12px;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
                overflow: hidden;
                margin-bottom: 30px;
            }

            .projects-header {
                padding: 15px 20px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                border-bottom: 1px solid var(--border-color);
                flex-wrap: wrap; /* Mobil görünümde alt alta gelmesi için */
                gap: 15px; /* Öğeler arası boşluk */
            }

            .projects-actions {
                display: flex;
                gap: 15px;
                flex-wrap: wrap; /* Mobil görünümde alt alta gelmesi için */
                justify-content: flex-end; /* Sağ tarafa hizala */
            }
            .btn {
                padding: 8px 15px;
                border-radius: 8px;
                border: none;
                background: linear-gradient(to right, var(--primary), var(--primary-light));
                color: var(--white);
                font-weight: 500;
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 8px;
                transition: all 0.2s;
            }

            .btn-outline {
                background: transparent;
                border: 1px solid var(--primary-light);
                color: var(--primary-light);
            }

            .btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 5px 15px rgba(9, 128, 211, 0.3);
            }

            .btn i {
                font-size: 14px;
            }

            .table-container {
                overflow-x: auto; /* Tablo içeriği taşarsa yatay kaydırma */
            }
            .projects-table td {
                padding: 15px 20px;
                border-bottom: 1px solid var(--border-color);
                color: var(--text-color); 
            }
            .projects-table {
                width: 100%;
                border-collapse: collapse;
            }

            .projects-table th {
                text-align: left;
                padding: 15px 20px;
                background-color: rgba(9, 128, 211, 0.05);
                color: var(--light-gray);
                font-weight: 500;
                border-bottom: 1px solid var(--border-color);
            }

            .projects-table td {
                padding: 15px 20px;
                border-bottom: 1px solid var(--border-color);
                color: var(--text-color); 
            }

            /* Adjusted status badge styles to match actual backend status values */
            .status-badge {
                padding: 5px 10px;
                border-radius: 20px;
                font-size: 12px;
                font-weight: 500;
                display: inline-block;
            }

            /* Yeni durumlar için renk tanımları */
            .status-badge.gecikmeli {
                background-color: rgba(255, 71, 87, 0.1); /* Kırmızı tonu */
                color: #ff4757;
                border: 1px dashed #ff4757;
            }

            .status-badge.normal {
                background-color: rgba(46, 213, 115, 0.1); /* Yeşil tonu */
                color: #2ed573;
            }

            .status-badge.tamamlandı {
                background-color: rgba(9, 128, 211, 0.1); /* Mavi tonu */
                color: var(--primary-light);
            }

            /* Filtreleme alanı için yeni stiller */
            .filters-container {
                display: none; /* Varsayılan olarak gizli */
                grid-template-columns: 1fr;
                gap: 15px;
                margin-bottom: 25px;
                background-color: var(--card-bg);
                border-radius: 12px;
                padding: 20px;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            }

            .filters-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 10px;
            }

            .filter-title {
                font-weight: 600;
                font-size: 16px;
            }

            .filter-reset {
                color: var(--primary-light);
                cursor: pointer;
                font-size: 14px;
            }

            .filter-row {
                display: grid;
                grid-template-columns: repeat(4, 1fr);
                gap: 15px;
            }

            .filter-group {
                display: flex;
                flex-direction: column;
            }

            .filter-label {
                font-size: 13px;
                margin-bottom: 5px;
                color: var(--light-gray);
            }

            .filter-input {
                padding: 10px 12px;
                border-radius: 8px;
                border: 1px solid var(--border-color);
                background-color: var(--input-bg);
                color: var(--text-color);
                font-size: 14px;
                width: 100%;
            }

            /* Responsive tasarım iyileştirmeleri */
            @media (max-width: 1200px) {
                .filter-row {
                    grid-template-columns: repeat(2, 1fr);
                }
            }

            @media (max-width: 992px) {
                .charts-activity-container {
                    grid-template-columns: 1fr;
                }
                
                .sidebar {
                    width: 260px; /* Mobil görünümde açıkken genişlik */
                    position: fixed; /* Mobil görünümde sabit */
                    transform: translateX(-100%); /* Varsayılan olarak gizli */
                    box-shadow: 0 0 20px rgba(0,0,0,0.3);
                }
                .sidebar.show {
                    transform: translateX(0); /* Açıldığında görünür */
                }
                
                .logo-text, .nav-text {
                    display: block; /* Mobil menü açıkken görünür */
                }
                
                .logo-container {
                    justify-content: flex-start;
                    padding: 0 20px 25px 20px;
                }
                
                .logo-icon {
                    margin-right: 12px;
                }
                
                .nav-item {
                    justify-content: flex-start;
                    padding: 12px 25px;
                }
                
                .nav-item i {
                    margin-right: 15px;
                }
                
                .main-content {
                    margin-left: 0; /* Mobil görünümde boşluk yok */
                    width: 100%;
                }

                .hamburger-menu {
                    display: block;
                    order: 1;
                    margin-right: 10px; /* Takvim.html ile aynı margin */
                }

                .topbar {
                    padding: 15px; /* Takvim.html ile aynı padding */
                    flex-wrap: wrap;
                    justify-content: flex-start;
                    gap: 10px; /* Takvim.html ile aynı gap */
                }
                .search-container {
                    order: 2;
                    flex-grow: 1;
                    margin-right: 0; /* Takvim.html ile aynı margin */
                }
                .topbar-actions {
                    order: 3;
                    width: 100%;
                    justify-content: flex-end;
                    margin-top: 10px; /* Takvim.html ile aynı margin */
                    gap: 10px; /* Takvim.html ile aynı gap */
                }
                .user-profile {
                    flex-grow: 0;
                }
                .logout-btn {
                    padding: 8px 10px; /* Takvim.html ile aynı padding */
                    font-size: 14px; /* Takvim.html ile aynı font-size */
                    margin-left: 0; /* Takvim.html ile aynı margin */
                }
            }

            @media (max-width: 768px) {
                .filter-row {
                    grid-template-columns: 1fr;
                }
                
                .dashboard-content {
                    padding: 15px;
                }
                
                .projects-header {
                    flex-direction: column;
                    align-items: flex-start;
                    gap: 15px;
                }
                
                .projects-actions {
                    width: 100%;
                    flex-direction: column;
                    gap: 10px;
                }
                
                .projects-actions .btn {
                    width: 100%;
                    justify-content: center;
                }
            }

            @media (max-width: 576px) {
                .stats-container {
                    grid-template-columns: 1fr;
                }
                
                .filter-row {
                    grid-template-columns: 1fr;
                }
                
                .page-title {
                    font-size: 22px;
                }
                
                .stat-card-value {
                    font-size: 24px;
                }
                
                .user-info {
                    display: none; /* Mobil görünümde kullanıcı adını gizle */
                }

                /* Proje tablosu responsive düzenlemesi */
                .projects-table, .projects-table thead, .projects-table tbody, .projects-table th, .projects-table td, .projects-table tr {
                    display: block;
                }
                .projects-table thead {
                    display: none; /* Başlıkları gizle */
                }
                .projects-table tr {
                    margin-bottom: 15px;
                    border-radius: 8px;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
                    background: var(--card-bg); /* Temaya uygun kart rengi */
                    border: 1px solid var(--border-color); /* Kart kenarlığı */
                }
                .projects-table td {
                    padding: 10px 15px; /* Daha uygun padding */
                    border: none; /* Hücre kenarlıklarını kaldır */
                    position: relative;
                    text-align: left;
                    display: flex; /* İçeriği yan yana hizala */
                    justify-content: space-between; /* Başlık ve değeri ayır */
                    align-items: center;
                    font-size: 14px; /* Mobil için yazı boyutu */
                }
                .projects-table td:before {
                    content: attr(data-label);
                    font-weight: bold;
                    color: var(--primary); /* Başlık rengi temaya uygun */
                    display: block;
                    margin-right: 15px; /* Başlık ile değer arası boşluk */
                    min-width: 120px; /* Başlık için minimum genişlik */
                    font-size: 13px;
                    flex-shrink: 0; /* Küçülmesini engelle */
                }
                
                .status-badge {
                    padding: 4px 8px;
                    font-size: 11px;
                }

                .action-btn {
                    width: 38px; /* Sabit genişlik */
                    height: 38px; /* Sabit yükseklik */
                    padding: 0; /* Padding'i sıfırla */
                    font-size: 16px;
                }
                .action-btn i {
                    margin: 0; /* İkonun margin'ini sıfırla */
                }
                .projects-table td[data-label="İşlemler"] {
                    justify-content: center; /* İşlem butonlarını ortala */
                }
                .projects-table td[data-label="İşlemler"]::before {
                    display: none; /* İşlemler başlığını gizle */
                }

                /* Takvim.html'deki mobil topbar düzenini buraya uygula */
                .topbar {
                    padding: 10px; /* Takvim.html ile aynı padding */
                    flex-wrap: nowrap;
                    gap: 8px; /* Takvim.html ile aynı gap */
                    flex-direction: row; 
                    justify-content: flex-start;
                    align-items: center;
                }
                .hamburger-menu {
                    order: 1;
                }
                .search-container {
                    flex-grow: 1;
                    order: 2;
                    margin-left: 0;
                    width: auto;
                }
                .topbar-actions {
                    width: auto;
                    order: 3;
                    justify-content: flex-end;
                    margin-left: auto;
                    flex-wrap: nowrap;
                    gap: 5px; /* Takvim.html ile aynı gap */
                }
                .logout-btn .logout-text {
                    display: none;
                }
                .logout-btn i {
                    margin-right: 0;
                }
            }

            /* PDF export için geçici tablo stili */
            .pdf-export-table {
                border: 1px solid #005c9d !important;
                border-radius: 8px !important;
                overflow: hidden !important;
                background: #fff !important;
                color: #222 !important;
            }
            [data-theme="dark"] .pdf-export-table {
                background: #181c20 !important;
                color: #f1f1f1 !important;
            }
            
            /* Toast bildirimi */
            .toast {
                position: fixed;
                bottom: 20px;
                right: 20px;
                background-color: var(--success);
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                display: flex;
                align-items: center;
                gap: 10px;
                z-index: 10000;
                opacity: 0;
                transform: translateY(20px);
                transition: all 0.3s ease;
            }
            
            .toast.show {
                opacity: 1;
                transform: translateY(0);
            }
            
            .toast.error {
                background-color: var(--danger);
            }
            
            .footer {
                text-align: center;
                padding: 20px;
                color: var(--light-gray);
                font-size: 14px;
                border-top: 1px solid var(--border-color);
                margin-top: 30px;
            }

            /* --- PROJELER.HTML İLE AYNI ACTION-BTN TASARIMI --- */
        .action-btn {
            width: auto;
            min-width: 38px;
            height: 38px;
            padding: 0 10px;
            border-radius: 10px;
            font-size: 16px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease-in-out;
            background-color: var(--input-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            cursor: pointer;
        }
        .action-btn:hover {
            background-color: var(--primary-light);
            color: var(--white);
            box-shadow: 0 4px 12px rgba(9, 128, 211, 0.2);
            transform: translateY(-1px) scale(1.02);
            border-color: var(--primary-light);
        }
        [data-theme="dark"] .card-title,
        [data-theme="dark"] .card-header,
        [data-theme="dark"] .charts-activity-container .card-header {
            color: #fff !important;
        }
        [data-theme="dark"] .activity-title {
            color: #fff !important;
        }

        /* Modal için ek stiller (Bootstrap modalını özelleştirmek için) */
        .modal-content {
            background-color: var(--card-bg);
            color: var(--text-color);
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        .modal-header {
            border-bottom-color: var(--border-color);
        }

        .modal-title {
            color: var(--primary);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-body p {
            margin-bottom: 8px;
        }

        .modal-body strong {
            color: var(--dark-gray);
        }

        .modal-body hr {
            border-top: 1px solid var(--border-color);
            margin: 20px 0;
        }

        .modal-body h6 {
            color: var(--primary-light);
            margin-bottom: 15px;
            font-weight: 600;
        }

        .input-group .form-control {
            background-color: var(--input-bg);
            color: var(--text-color);
            border-color: var(--border-color);
        }

        .input-group .btn-primary {
            background-color: var(--primary);
            border-color: var(--primary);
        }

        .input-group .btn-primary:hover {
            background-color: var(--primary-light);
            border-color: var(--primary-light);
        }

        .modal-footer {
            border-top-color: var(--border-color);
        }

        .modal-footer .btn-secondary {
            background-color: var(--light-gray);
            border-color: var(--light-gray);
            color: white;
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-top: 1px solid var(--border-color);
            flex-wrap: wrap; /* Küçük ekranlarda sarmalamak için */
            gap: 10px; /* Elemanlar arası boşluk */
        }

        .pagination-info {
            font-size: 14px;
            color: var(--light-gray);
        }

        .pagination-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        #pageNumbers {
            display: flex;
            gap: 5px;
        }

        .page-btn {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--input-bg);
            color: var(--text-color);
            cursor: pointer;
            border: none;
            flex-shrink: 0;
        }

        .page-btn.active {
            background: linear-gradient(to right, var(--primary), var(--primary-light));
            color: var(--white);
        }

        .page-btn:hover:not(.active) {
            background-color: rgba(9, 128, 211, 0.1);
            color: var(--primary-light);
        }

        /* Responsive pagination */
        @media (max-width: 576px) {
            .pagination {
                flex-direction: column; /* Sayfalandırma bilgilerini ve kontrollerini dikey sırala */
                align-items: center;
            }

            .pagination-controls {
                margin-top: 10px;
            }
        }

        /* Bildirim Paneli Stilleri (bildirim.html'den alındı) */
        .notification-panel {
            position: fixed;
            top: 60px;
            right: 20px;
            width: 360px;
            max-height: 500px;
            background-color: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            border: 1px solid var(--border-color);
            z-index: 1001;
            display: none;
            flex-direction: column;
            overflow: hidden;
            opacity: 0;
            transform: translateY(-10px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .notification-panel.show {
            display: flex;
            opacity: 1;
            transform: translateY(0);
        }

        .notification-panel-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            color: var(--text-color);
        }

        .notification-panel-header .close-btn {
            background: none;
            border: none;
            font-size: 20px;
            color: var(--light-gray);
            cursor: pointer;
            transition: color 0.2s;
        }

        .notification-panel-header .close-btn:hover {
            color: var(--primary);
        }

        .notification-list {
            flex-grow: 1;
            overflow-y: auto;
            padding: 5px 0;
        }

        .notification-item {
            display: flex;
            align-items: flex-start;
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-color);
            position: relative;
            transition: background-color 0.2s;
        }

        .notification-item:last-child {
            border-bottom: none;
        }

        .notification-item:hover {
            background-color: var(--primary-light-bg);
        }

        .notification-item.unread {
            background-color: var(--primary-light-bg);
            border-left: 3px solid var(--primary);
        }

        .notification-item-content {
            cursor: pointer;
            flex-grow: 1;
            padding-right: 30px; /* Silme butonu için yer aç */
        }
        
        .notification-item-icon {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: rgba(9, 128, 211, 0.1);
            color: var(--primary-light);
            font-size: 16px;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .notification-item-title {
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 4px;
            color: var(--text-color);
        }

        .notification-item-description {
            font-size: 13px;
            color: var(--light-gray);
            line-height: 1.4;
        }

        .notification-item-time {
            font-size: 11px;
            color: var(--light-gray);
            margin-top: 5px;
        }

        .notification-item-actions {
            position: absolute;
            top: 50%;
            right: 10px;
            transform: translateY(-50%);
            opacity: 0;
            transition: opacity 0.2s;
        }

        .notification-item:hover .notification-item-actions {
            opacity: 1;
        }

        .delete-notification-btn {
            background: transparent;
            border: none;
            color: var(--light-gray);
            cursor: pointer;
            font-size: 14px;
            padding: 5px;
            border-radius: 50%;
        }

        .delete-notification-btn:hover {
            background-color: rgba(255, 71, 87, 0.1);
            color: var(--danger);
        }

        .notification-panel-footer {
            padding: 10px 15px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--bg-color);
        }

        .notification-action-btn {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-color);
            padding: 6px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .notification-action-btn:hover {
            background-color: var(--input-bg);
            border-color: var(--primary-light);
            color: var(--primary-light);
        }
        
        .notification-action-btn.danger:hover {
            border-color: var(--danger);
            color: var(--danger);
            background-color: rgba(255, 71, 87, 0.1);
        }

        .no-notifications {
            text-align: center;
            padding: 20px;
            color: var(--light-gray);
            font-size: 14px;
        }

        @media (max-width: 576px) {
            .notification-panel {
                width: calc(100% - 20px);
                left: 10px;
                right: 10px;
                top: 65px;
            }
            .notification-action-btn span {
                display: none;
            }
            .notification-action-btn {
                padding: 8px;
            }
        }
    </style>
</head>
<body data-theme="light">
    <div id="notification-panel-placeholder"></div>
    <!-- Proje düzenleme ve detay modal'ları kaldırıldı -->

    <div class="sidebar" id="sidebar">
        <a href="index.html" style="text-decoration: none;">
            <div class="logo-container" style="cursor: pointer;">
            <img src="static/serlogo.png" alt="Ser Elektrik Otomasyon" style="width: 180px; height: auto; padding-left: 10px;">
            </div>
        </a>
        

        <a href="index.html" class="nav-item active">
            <i class="fas fa-home"></i>
            <span class="nav-text">Dashboard</span>
        </a>
        <a href="projeler.html" class="nav-item">
            <i class="fas fa-project-diagram"></i>
            <span class="nav-text">Projeler</span>
        </a>
        <a href="proje_ekle.html" class="nav-item">
            <i class="fas fa-plus-circle"></i>
            <span class="nav-text">Yeni Proje</span>
        </a>
        <a href="raporlar.html" class="nav-item">
            <i class="fas fa-chart-line"></i>
            <span class="nav-text">Raporlar</span>
        </a>
        <a href="musteriler.html" class="nav-item">
            <i class="fas fa-users"></i>
            <span class="nav-text">Müşteriler</span>
        </a>
        <a href="takvim.html" class="nav-item">
            <i class="fas fa-calendar-alt"></i>
            <span class="nav-text">Takvim</span>
        </a>
        <a href="ayarlar.html" class="nav-item">
            <i class="fas fa-cog"></i>
            <span class="nav-text">Ayarlar</span>
        </a>
    </div>

    <div class="main-content" id="mainContent">
        <!-- Topbar -->
        <div class="topbar">
            <!-- Hamburger Menü Butonu -->
            <button class="hamburger-menu" id="hamburgerMenu">
                <i class="fas fa-bars"></i>
            </button>
            <div class="search-container">
                <i class="fas fa-search"></i>
                <input type="text" id="searchInput" placeholder="Görev, müşteri veya proje ara...">
            </div>
            
            <div class="topbar-actions">
                <div class="theme-toggle" id="theme-toggle">
                    <i class="fas fa-moon"></i>
                </div>
                
                <div class="notification-btn" id="notificationButton" data-count="0">
                    <i class="fas fa-bell"></i>
                </div>
                
                <div class="user-profile" id="userProfileLink">
                    <!-- user-avatar.js tarafından yönetilecek avatar kapsayıcısı -->
                    <div id="userAvatarContainer" class="avatar-container"></div>
                    <div class="user-info">
                        <div class="user-name" id="userName"></div>
                        <div class="user-role" id="userRole"></div>
                    </div>
                </div>
                <button class="btn btn-outline logout-btn" id="logoutButton">
                    <i class="fas fa-sign-out-alt"></i> <span class="logout-text">Çıkış Yap</span>
                </button>
            </div>
        </div>

        <!-- Bildirim Paneli için Placeholder -->
        <div id="notification-panel-placeholder">
            <!-- bildirim.html içeriği buraya yüklenecek -->
        </div>

        <div class="dashboard-content">
            <h1 class="page-title" id="pageTitle">
                <i class="fas fa-home"></i>
                Dashboard
            </h1>
            
            <div class="stat-card" style="margin-bottom: 25px; background: linear-gradient(135deg, var(--primary), #003f6d); color: white;">
                <div class="stat-card-header">
                    <div class="stat-card-title" style="color: rgba(255,255,255,0.8);">Veritabanı Bağlantısı</div>
                    <div class="stat-card-icon" style="background-color: rgba(255,255,255,0.2); color: white;">
                        <i class="fas fa-plug"></i>
                    </div>
                </div>
                <div class="stat-card-value" id="dbStatus">Bağlantı Kontrol Ediliyor...</div>
                <div class="stat-card-change">
                    <i class="fas fa-sync-alt"></i>
                    Veritabanı aktifliği izleniyor.
                </div>
            </div>

            <div class="stats-container" id="statsContainer">
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div class="stat-card-title">Aktif Projeler</div>
                        <div class="stat-card-icon">
                            <i class="fas fa-sync-alt"></i>
                        </div>
                    </div>
                    <div class="stat-card-value" id="activeProjects">Yükleniyor...</div>
                    <div class="stat-card-change">
                        <i class="fas fa-database"></i>
                        Veritabanından çekildi
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-card-header">
                        <div class="stat-card-title">Tamamlanan Projeler</div>
                        <div class="stat-card-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                    </div>
                    <div class="stat-card-value" id="completedProjects">Yükleniyor...</div>
                    <div class="stat-card-change">
                        <i class="fas fa-database"></i>
                        Veritabanından çekildi
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-card-header">
                        <div class="stat-card-title">Geciken Projeler</div>
                        <div class="stat-card-icon">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                    </div>
                    <div class="stat-card-value" id="delayedProjects">Yükleniyor...</div>
                    <div class="stat-card-change down">
                        <i class="fas fa-database"></i>
                        Veritabanından çekildi
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-card-header">
                        <div class="stat-card-title">Toplam Proje</div>
                        <div class="stat-card-icon">
                            <i class="fas fa-project-diagram"></i>
                        </div>
                    </div>
                    <div class="stat-card-value" id="totalProjects">Yükleniyor...</div>
                    <div class="stat-card-change">
                        <i class="fas fa-database"></i>
                        Veritabanından çekildi
                    </div>
                </div>
            </div>
            
            <div class="filters-container" id="filtersContainer">
                <div class="filters-header">
                    <div class="filter-title">Proje Filtreleri</div>
                    <div class="filter-reset" id="resetFilters">Tümünü Sıfırla</div>
                </div>
                <div class="filter-row">
                    <div class="filter-group">
                        <label class="filter-label">Proje Adı</label>
                        <input type="text" class="filter-input" id="filterProjectName" placeholder="Proje adı girin">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Referans No</label>
                        <input type="text" class="filter-input" id="filterRefNo" placeholder="Referans no girin">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Müşteri</label>
                        <input type="text" class="filter-input" id="filterCustomer" placeholder="Müşteri adı">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Durum</label>
                        <select class="filter-input" id="filterStatus">
                            <option value="">Tümü</option>
                            <option value="Aktif">Aktif</option>
                            <option value="Tamamlandı">Tamamlandı</option>
                            <option value="Gecikmeli">Gecikmeli</option>
                            <option value="Planlama Aşamasında">Planlama Aşamasında</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="projects-container">
                <div class="projects-header">
                    <div class="card-title">Proje Listesi</div>
                    <div class="projects-actions">
                        <button class="btn btn-outline" id="filterBtn">
                            <i class="fas fa-filter"></i> Filtrele
                        </button>
                        <button class="btn btn-outline" id="toggleMyProjectsBtn">
                            <i class="fas fa-user-tie"></i> Projelerim
                        </button>
                        <button class="btn" id="exportPdf">
                            <i class="fas fa-file-pdf"></i> PDF Oluştur
                        </button>
                        <button class="btn" id="refreshData">
                            <i class="fas fa-sync-alt"></i> Verileri Yenile
                        </button>
                    </div>
                </div>
                <div class="table-container">
                    <table class="projects-table" id="projectsTable">
                        <thead>
                            <tr>
                                <th>Proje Adı</th>
                                <th>Referans No</th>
                                <th>Müşteri</th>
                                <th>Durum</th>
                                <th>Başlangıç</th>
                                <th>Bitiş</th>
                                <th>Yönetici</th>
                            </tr>
                        </thead>
                        <tbody id="projectsTableBody">
                            <tr><td colspan="8" style="text-align: center;">Projeler yükleniyor...</td></tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination -->
                <div class="pagination">
                    <div class="pagination-info">Toplam <span id="totalProjectsCount">0</span> proje, sayfa <span id="currentPage">1</span>/<span id="totalPages">1</span></div>
                    <div class="pagination-controls">
                        <button class="page-btn" id="prevPage"><i class="fas fa-chevron-left"></i></button>
                        <div id="pageNumbers">
                            <button class="page-btn active">1</button>
                        </div>
                        <button class="page-btn" id="nextPage"><i class="fas fa-chevron-right"></i></button>
                    </div>
                </div>
            </div>
            
            <div class="charts-activity-container">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Proje Durum Dağılımı</div>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="projectChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Son Aktiviteler</div>
                    </div>
                    <div class="card-body" id="recentActivitiesList"> <!-- BU SATIRI KONTROL EDİN -->
    <!-- Aktiviteler buraya JavaScript ile dinamik olarak yüklenecek -->
    <div class="activity-item">
        <div class="activity-icon">
            <i class="fas fa-spinner fa-spin"></i>
        </div>
        <div class="activity-content">
            <div class="activity-title">Aktiviteler Yükleniyor</div>
            <div class="activity-desc">Sunucudan son aktiviteler alınıyor...</div>
            <div class="activity-time">Az önce</div>
        </div>
    </div>
</div>
</div>
</div>
            <div class="footer">
                    &copy; 2025 Ser Elektrik Otomasyon. Tüm hakları saklıdır. | Mustafa Öztürk
                </div>
            </div>
        </div>
        
        <div class="toast" id="toast">
            <i class="fas fa-check-circle"></i>
            <span id="toastMessage">İşlem başarıyla tamamlandı</span>
        </div>
<script>
    // API Base URL
    const API_BASE_URL = "https://ser-proje.onrender.com";
    let currentUser = null; // Mevcut kullanıcı bilgisi
    let allProjectsData = [];
    let filteredProjects = []; // Filtrelenmiş projeleri tutacak
    let currentPage = 1;
    let rowsPerPage = 10; // Masaüstü varsayılanı
    let isMyProjectsView = false; // "Projelerim" görünümünde miyiz?

    // Pagination elementleri
    const totalProjectsCountSpan = document.getElementById('totalProjectsCount');
    const currentPageSpan = document.getElementById('currentPage');
    const totalPagesSpan = document.getElementById('totalPages');
    const prevPageButton = document.getElementById('prevPage');
    const nextPageButton = document.getElementById('nextPage');
    const pageNumbersContainer = document.getElementById('pageNumbers');
    const confirmationModal = new bootstrap.Modal(document.getElementById('confirmationModal'));
    const confirmActionBtn = document.getElementById('confirmActionBtn');
    let currentConfirmAction = null;
    const pageTitleElement = document.getElementById('pageTitle');
    const toggleMyProjectsBtn = document.getElementById('toggleMyProjectsBtn');


    // Genel Toast bildirim fonksiyonu
    function showToast(message, isError = false) {
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toastMessage');

        if (!toast || !toastMessage) {
            console.error("Toast elementleri bulunamadı!");
            return;
        }

        toastMessage.textContent = message;
        toast.classList.remove('success', 'error');
        toast.classList.add(isError ? 'error' : 'success');

        toast.classList.add('show');

        setTimeout(() => {
            toast.classList.remove('show');
        }, 3000);
    }

    // Custom Confirm Modal (alert yerine kullanılacak)
    function showConfirmationModal(message, onConfirm) {
        document.getElementById('confirmationMessage').textContent = message;
        currentConfirmAction = onConfirm;
        confirmationModal.show();
    }

    // Kullanıcı bilgilerini yükle ve oturum kontrolünü yap
    function loadUserInfo() {
        const storedUser = localStorage.getItem('currentUser');
        if (!storedUser) {
            console.log("LocalStorage'da kullanıcı verisi bulunamadı. Giriş sayfasına yönlendiriliyor...");
            showToast("Oturum süreniz doldu veya giriş yapmadınız. Lütfen giriş yapın.", true);
            setTimeout(() => {
                window.location.href = 'login.html';
            }, 2000);
            return; // Buradan sonra işlem yapma, direkt yönlendir
        }

        try {
            currentUser = JSON.parse(storedUser); 
        } catch (e) {
            console.error("Kayıtlı kullanıcı verisi bozuk:", e);
            localStorage.removeItem('currentUser'); // Bozuk veriyi temizle
            showToast("Kullanıcı verileriniz bozuk. Lütfen tekrar giriş yapın.", true);
            setTimeout(() => {
                window.location.href = 'login.html';
            }, 2000);
            return; // Buradan sonra işlem yapma, direkt yönlendir
        }

        // Kullanıcı arayüzünü güncelleme (user-avatar.js yüklendikten sonra çağrılacak)
        const userNameElement = document.getElementById('userName');
        const userRoleElement = document.getElementById('userRole');

        if (userNameElement) {
            userNameElement.textContent = currentUser.fullname || currentUser.username || 'Kullanıcı';
        }
        if (userRoleElement) {
            userRoleElement.textContent = currentUser.role || 'Rol Yok';
        }
        // updateUserAvatar DOMContentLoaded içinde çağrılacak
    }

    // loadUserInfo fonksiyonunu hemen çağırıyoruz ki currentUser değişkeni set edilsin
    loadUserInfo();

    // --- DOM Yüklendiğinde Çalışacak Kod ---
    document.addEventListener("DOMContentLoaded", function () {
        // user-avatar.js yüklendiyse updateUserAvatar'ı çağır
        if (currentUser && typeof updateUserAvatar === 'function') {
            updateUserAvatar(currentUser); 
        }

        // Topbar kullanıcı profili linki için event listener
        const userProfileLink = document.getElementById('userProfileLink');
        if (userProfileLink) {
            userProfileLink.addEventListener('click', () => {
                window.location.href = 'users.html';
            });
        }

        const logoutButton = document.getElementById("logoutButton");
        const themeToggle = document.getElementById("theme-toggle");
        const hamburgerMenu = document.getElementById('hamburgerMenu');
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('mainContent');

        // Tema değiştirme
        const savedTheme = localStorage.getItem("theme");
        if (savedTheme) {
            document.body.setAttribute("data-theme", savedTheme);
            themeToggle.innerHTML =
                savedTheme === "dark"
                ? '<i class="fas fa-sun"></i>'
                : '<i class="fas fa-moon"></i>';
        }
        themeToggle.addEventListener("click", () => {
            const currentTheme = document.body.getAttribute("data-theme");
            const newTheme = currentTheme === "dark" ? "light" : "dark";
            document.body.setAttribute("data-theme", newTheme);
            themeToggle.innerHTML =
                newTheme === "dark"
                ? '<i class="fas fa-sun"></i>'
                : '<i class="fas fa-moon"></i>';
            localStorage.setItem("theme", newTheme);
        });

        // Çıkış Yap butonu
        logoutButton.addEventListener("click", () => {
            localStorage.removeItem("currentUser");
            window.location.href = "login.html";
        });

        // Hamburger menü işlevselliği
        hamburgerMenu.addEventListener('click', () => {
            sidebar.classList.toggle('show');
            mainContent.classList.toggle('expanded');
        });

        // Sidebar dışına tıklayınca kapatma
        document.addEventListener('click', (event) => {
            if (sidebar.classList.contains('show') && 
                !sidebar.contains(event.target) && 
                !hamburgerMenu.contains(event.target)) {
                sidebar.classList.remove('show');
                mainContent.classList.remove('expanded');
            }
        });

        // Pencere boyutu değiştiğinde sidebar durumunu sıfırla (masaüstü için)
        window.addEventListener('resize', () => {
            if (window.innerWidth > 992) {
                sidebar.classList.remove('show');
                mainContent.classList.remove('expanded');
            }
            updateRowsPerPage(); // Ekran boyutuna göre sayfa başına satır sayısını güncelle
            applyFiltersAndRenderTable(); // Tabloyu yeniden render et
        });

        updateRowsPerPage(); // Sayfa yüklendiğinde başlangıç değeri ayarla

        fetchProjects(); // Sayfa yüklendiğinde projeleri çek
        fetchUnreadNotificationCount(); // Sayfa yüklendiğinde okunmamış bildirim sayısını çek

        // Bildirim Paneli İşlevselliği
        const notificationButton = document.getElementById('notificationButton');
        const notificationPanel = document.getElementById('notificationPanel');
        const closeNotificationPanel = document.getElementById('closeNotificationPanel');
        const notificationList = document.getElementById('notificationList');
        const markAllReadBtn = document.getElementById('markAllReadBtn');
        const clearAllNotificationsBtn = document.getElementById('clearAllNotificationsBtn');

        if (notificationButton) {
            notificationButton.addEventListener('click', (event) => {
                event.stopPropagation(); // Olayın body'ye yayılmasını engelle
                if (notificationPanel) {
                    notificationPanel.classList.toggle('show');
                    // Panel açıldığında bildirimleri yeniden yükle
                    if (notificationPanel.classList.contains('show')) {
                        fetchAndRenderNotifications();
                    }
                }
            });
        }

        if (closeNotificationPanel) {
            closeNotificationPanel.addEventListener('click', () => {
                if (notificationPanel) {
                    notificationPanel.classList.remove('show');
                }
            });
        }

        document.addEventListener('click', (event) => {
            // Bildirim paneli açıksa ve tıklama panelin veya bildirim butonunun dışında ise kapat
            if (notificationPanel && notificationPanel.classList.contains('show') && 
                !notificationPanel.contains(event.target) && 
                !notificationButton.contains(event.target)) {
                notificationPanel.classList.remove('show');
            }
        });

        if (markAllReadBtn) {
            markAllReadBtn.addEventListener('click', async () => {
                if (!currentUser || !currentUser.id) {
                    showToast('Kullanıcı oturumu bulunamadı.', true);
                    return;
                }
                showConfirmationModal('Tümünü Okundu İşaretle', 'Tüm bildirimleri okundu olarak işaretlemek istediğinizden emin misiniz?', async () => {
                    try {
                        const response = await fetch(`${API_BASE_URL}/api/notifications/mark-all-read`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ user_id: currentUser.id })
                        });
                        if (!response.ok) throw new Error('Tüm bildirimler okundu olarak işaretlenemedi.');
                        showToast('Tüm bildirimler okundu olarak işaretlendi.');
                        fetchAndRenderNotifications(); // Listeyi ve sayacı yenile
                    } catch (error) {
                        console.error('Tüm bildirimleri okundu hatası:', error);
                        showToast('Tüm bildirimler okundu olarak işaretlenirken hata oluştu.', true);
                    }
                });
            });
        }

        if (clearAllNotificationsBtn) {
            clearAllNotificationsBtn.addEventListener('click', async () => {
                if (!currentUser || !currentUser.id) {
                    showToast('Kullanıcı oturumu bulunamadı.', true);
                    return;
                }
                showConfirmationModal('Tüm Bildirimleri Temizle', 'Tüm bildirimleri silmek istediğinizden emin misiniz? Bu işlem geri alınamaz.', async () => {
                    try {
                        const response = await fetch(`${API_BASE_URL}/api/notifications/clear-all?user_id=${currentUser.id}`, {
                            method: 'DELETE'
                        });
                        if (!response.ok) throw new Error('Tüm bildirimler temizlenemedi.');
                        showToast('Tüm bildirimler başarıyla temizlendi.');
                        fetchAndRenderNotifications(); // Listeyi ve sayacı yenile
                    } catch (error) {
                        console.error('Tüm bildirimleri temizleme hatası:', error);
                        showToast('Tüm bildirimler temizlenirken hata oluştu.', true);
                    }
                });
            });
        }

        // Filtreleme butonları
        const filterBtn = document.getElementById("filterBtn");
        const filtersContainer = document.getElementById("filtersContainer");
        filterBtn.addEventListener("click", () => {
            filtersContainer.style.display =
                filtersContainer.style.display === "none" ? "grid" : "none";
        });

        document.getElementById("refreshData").addEventListener("click", () => {
            fetchProjects();
            showToast("Proje verileri yenilendi.");
        });

        document.getElementById("exportAllPdf").addEventListener("click", async function() {
            const hasPermission = await checkPermission('pdf_olusturma');
            if (!hasPermission) return;
            exportAllProjectsToPdf();
        });

        // "Projelerim" butonuna tıklama olayı
        toggleMyProjectsBtn.addEventListener('click', () => {
            isMyProjectsView = !isMyProjectsView; // Durumu tersine çevir
            if (isMyProjectsView) {
                toggleMyProjectsBtn.innerHTML = '<i class="fas fa-list"></i> Tüm Projeleri Görüntüle';
                pageTitleElement.innerHTML = '<i class="fas fa-project-diagram"></i> Projelerim';
            } else {
                toggleMyProjectsBtn.innerHTML = '<i class="fas fa-user-tie"></i> Projelerim';
                pageTitleElement.innerHTML = '<i class="fas fa-project-diagram"></i> Tüm Projeler';
            }
            applyFiltersAndRenderTable(); // Filtreleri yeniden uygula
        });


        // Genel arama inputu
        document.getElementById("searchInput").addEventListener("keyup", applyFiltersAndRenderTable);

        // Filtre inputlarına keyup ve change event'leri
        document
            .getElementById("filterProjectName")
            .addEventListener("keyup", applyFiltersAndRenderTable);
        document
            .getElementById("filterRefNo")
            .addEventListener("keyup", applyFiltersAndRenderTable);
        document
            .getElementById("filterCustomer")
            .addEventListener("keyup", applyFiltersAndRenderTable);
        document
            .getElementById("filterStatus")
            .addEventListener("change", applyFiltersAndRenderTable);

        // Filtreleri sıfırlama
        document.getElementById("resetFilters").addEventListener("click", () => {
            document.getElementById("filterProjectName").value = "";
            document.getElementById("filterRefNo").value = "";
            document.getElementById("filterCustomer").value = "";
            document.getElementById("filterStatus").value = "";
            document.getElementById("searchInput").value = ""; // Global aramayı da sıfırla
            applyFiltersAndRenderTable();
            showToast("Filtreler sıfırlandı.");
        });

        // Confirmation Modal "Onayla" butonu için olay dinleyicisi
        if (confirmActionBtn) {
            confirmActionBtn.addEventListener('click', () => {
                if (currentConfirmAction) {
                    currentConfirmAction();
                }
                confirmationModal.hide();
                const confirmationModalElement = document.getElementById('confirmationModal');
                confirmationModalElement.style.zIndex = ''; // z-index'i sıfırla
            });
        }
        
        // Bu sayfayı görüntüleme yetkisi kontrolü kaldırıldı.
        // Proje ekleme, düzenleme, silme gibi spesifik eylemler için yetki kontrolü yapılacaktır.
        // await checkPermission('projeler'); // Bu satır kaldırıldı.
    });

    // --- Yardımcı Fonksiyonlar ---
    // Tarih formatlama (DD.MM.YYYY)
    function formatDateForDisplay(dateStr) {
        if (!dateStr) return "";
        const parts = dateStr.split("-");
        if (parts.length === 3) {
            return `${parts[2]}.${parts[1]}.${parts[0]}`;
        }
        return dateStr;
    }

    // Tarih formatlama (YYYY-MM-DD) input için
    function formatDateForInput(dateStr) {
        if (!dateStr) return "";
        if (dateStr.includes(".")) {
            const parts = dateStr.split(".");
            return `${parts[2]}-${parts[1].padStart(2, "0")}-${parts[0].padStart(
                2,
                "0"
            )}`;
        }
        return dateStr;
    }

    // Durum rozeti ve renk sınıfı HTML'i döndürür
    function getStatusBadgeHtml(status) {
        let statusClass = "normal"; // Varsayılan olarak normal (yeşil)
        let statusText = status;

        if (status && status.includes('(Gecikmeli)')) {
            statusClass = "gecikmeli";
            statusText = status.replace(' (Gecikmeli)', ''); // Metinden "(Gecikmeli)" kısmını çıkar
        } else if (status === "Tamamlandı") {
            statusClass = "tamamlandı";
        }
        // Diğer durumlar için varsayılan normal kalır

        return `<span class="status-badge ${statusClass}">${statusText}</span>`;
    }

    // Aktivite loglama fonksiyonu (frontend'den backend'e istek gönderecek)
    async function addActivity(title, rawDescription, project_id, icon = "fas fa-info-circle", actionType = "other") {
        if (!currentUser || !currentUser.id) {
            console.warn("Kullanıcı oturumu bulunamadı, aktivite kaydedilemedi.");
            return;
        }

        const activityData = {
            user_id: currentUser.id,
            project_id: project_id, // null olabilir
            title: title,
            description: rawDescription,
            icon: icon,
            action_type: actionType
        };

        try {
            const response = await fetch(`${API_BASE_URL}/api/activities`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(activityData)
            });
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Aktivite eklenirken bilinmeyen bir hata oluştu.');
            }
            console.log("Aktivite başarıyla kaydedildi:", activityData);
        } catch (error) {
            console.error('Aktivite ekleme hatası:', error);
        }
    }
    

    // --- Proje Listesi ve İşlemleri ---
    async function fetchProjects() {
        const tbody = document.getElementById("projectsTableBody");
        if (!tbody) {
            console.error("HATA: projectsTableBody elementi bulunamadı!");
            return;
        }

        tbody.innerHTML =
            '<tr><td colspan="11" style="text-align: center;"><i class="fas fa-spinner fa-spin"></i> Projeler yükleniyor...</td></tr>';
        console.log("FETCH_DEBUG: 'Projeler yükleniyor...' mesajı ayarlandı.");

        try {
            console.log(
                "FETCH_DEBUG: API çağrısı başlatılıyor:",
                `${API_BASE_URL}/api/projects`
            );
            const response = await fetch(`${API_BASE_URL}/api/projects`);
            console.log(
                "FETCH_DEBUG: API yanıtı alındı. Status:",
                response.status
            );

            if (!response.ok) {
                let errorDetails = "Bilinmeyen Hata";
                try {
                    const errorData = await response.json();
                    errorDetails = errorData.message || errorDetails;
                } catch (jsonError) {
                    errorDetails = `Yanıt JSON olarak parse edilemedi: ${response.statusText}`;
                }
                console.error(
                    "FETCH_DEBUG HATA: API yanıtı OK değil.",
                    `Durum: ${response.status}`,
                    `Detay: ${errorDetails}`
                );
                throw new Error(`HTTP hatası! Durum: ${response.status} - ${errorDetails}`);
            }

            const projects = await response.json();
            console.log(
                "FETCH_DEBUG: API'den çekilen ham projeler (allProjectsData'ya atanacak):",
                projects
            );

            allProjectsData = projects;
            console.log("FETCH_DEBUG: allProjectsData güncellendi. applyFiltersAndRenderTable çağrılıyor.");
            applyFiltersAndRenderTable(); // Filtreleri uygula ve tabloyu render et
            updateStatsAndChart(allProjectsData); // İstatistikleri ve grafiği güncelle
            console.log("FETCH_DEBUG: Projeler yükleme tamamlandı.");
        } catch (error) {
            console.error("FETCH KAPSAMLI HATA: Projeler çekilemedi:", error);
            showToast(`Projeler yüklenirken hata oluştu: ${error.message}`, true);
            if (tbody) {
                tbody.innerHTML = `<tr><td colspan="11" style="text-align: center; color: var(--danger);">Projeler yüklenemedi. Hata: ${error.message} Lütfen sunucu bağlantısını ve loglarını kontrol edin.</td></tr>`;
            }
        }
    }

    function renderProjectsTable(projectsToRender) {
        let tbody = document.getElementById("projectsTableBody");
        if (!tbody) {
            const table = document.getElementById("projectsTable");
            if (table) {
                tbody = document.createElement("tbody");
                tbody.id = "projectsTableBody";
                table.appendChild(tbody);
                console.warn("projectsTableBody bulunamadı, yeni tbody eklendi.");
            } else {
                console.error("RENDER_DEBUG: projectsTable ve projectsTableBody elementi bulunamadı!");
                return;
            }
        }
        console.log(
            "RENDER_DEBUG: renderProjectsTable başladı. projectsToRender (gelecek veri):",
            projectsToRender
        );

        tbody.innerHTML = "";
        console.log("RENDER_DEBUG: tbody içeriği temizlendi.");

        if (projectsToRender.length === 0) {
            tbody.innerHTML =
                '<tr><td colspan="11" style="text-align: center;">Gösterilecek proje bulunamadı.</td></tr>';
            updatePagination(0, 0, 0); // Sayfalandırmayı güncelle
            return;
        }

        // Pagination için dilimleme
        const startIndex = (currentPage - 1) * rowsPerPage;
        const endIndex = startIndex + rowsPerPage;
        const paginatedProjects = projectsToRender.slice(startIndex, endIndex);

        // Yardımcı fonksiyonlar:
        function dateDiffInDays(date1, date2) {
            // Tarih formatı: YYYY-MM-DD veya DD.MM.YYYY
            function parseDate(str) {
                if (!str) return null;
                if (str.includes('-')) {
                    // YYYY-MM-DD
                    const [y, m, d] = str.split('-');
                    return new Date(Number(y), Number(m) - 1, Number(d));
                } else if (str.includes('.')) {
                    // DD.MM.YYYY
                    const [d, m, y] = str.split('.');
                    return new Date(Number(y), Number(m) - 1, Number(d));
                }
                return null;
            }
            const dt1 = parseDate(date1);
            const dt2 = parseDate(date2);
            if (!dt1 || !dt2) return null;
            return Math.ceil((dt2 - dt1) / (1000 * 60 * 60 * 24));
        }

        function sumDelayDays(progressArr) {
            if (!Array.isArray(progressArr)) return 0;
            return progressArr.reduce((sum, step) => sum + (step.delay_days || 0), 0);
        }

        function getTodayStr() {
            const today = new Date();
            return today.toISOString().slice(0, 10); // YYYY-MM-DD
        }

        paginatedProjects.forEach((project) => {
            // Toplam Gün
            let totalDays = dateDiffInDays(project.start_date, project.end_date);
            totalDays = (typeof totalDays === "number" && !isNaN(totalDays)) ? (totalDays >= 0 ? totalDays : 0) : '-';

            // Geçen Gün
            const todayStr = getTodayStr();
            let elapsedDays = dateDiffInDays(project.start_date, todayStr);
            elapsedDays = (typeof elapsedDays === "number" && !isNaN(elapsedDays)) ? (elapsedDays >= 0 ? elapsedDays : 0) : '-';

            // Gecikme Durumu
            let delayDays = 0;
            if (project.total_delay_days !== undefined && project.total_delay_days !== null) {
                delayDays = Number(project.total_delay_days);
                if (isNaN(delayDays)) delayDays = 0;
            }
            
            let overdue = 0;
            if (project.end_date) {
                const endDateObj = (() => {
                    if (project.end_date.includes('-')) {
                        const [y, m, d] = project.end_date.split('-');
                        return new Date(Number(y), Number(m) - 1, Number(d));
                    } else if (project.end_date.includes('.')) {
                        const [d, m, y] = project.end_date.split('.');
                        return new Date(Number(y), Number(m) - 1, Number(d));
                    }
                    return null;
                })();
                const todayObj = new Date();
                if (endDateObj && todayObj > endDateObj && project.status !== 'Tamamlandı') { // Sadece tamamlanmamış projeler için
                    overdue = Math.ceil((todayObj - endDateObj) / (1000 * 60 * 60 * 24));
                }
            }

            // Gecikme günleri toplamı
            let gecikmeDurumu = "-";
            const combinedDelay = delayDays + overdue;
            if (combinedDelay > 0) {
                gecikmeDurumu = combinedDelay + " gün";
            } else if (typeof combinedDelay === 'number' && combinedDelay === 0) {
                gecikmeDurumu = "0 gün";
            }

            const row = document.createElement("tr");
            row.innerHTML = `
                <td data-label="Proje Adı">${project.project_name ? project.project_name.normalize('NFC') : "-"}</td>
                <td data-label="Referans No">${project.reference_no || "-"}</td>
                <td data-label="Müşteri">${project.customer_name || "-"}</td>
                <td data-label="Durum">${getStatusBadgeHtml(project.display_status || "-")}</td>
                <td data-label="Başlangıç">${formatDateForDisplay(project.start_date || "-")}</td>
                <td data-label="Bitiş">${formatDateForDisplay(project.end_date || "-")}</td>
                <td data-label="Toplam Gün">${totalDays !== '-' ? totalDays + ' gün' : '-'}</td>
                <td data-label="Geçen Gün">${elapsedDays !== '-' ? elapsedDays + ' gün' : '-'}</td>
                <td data-label="Gecikme Durumu">${gecikmeDurumu}</td>
                <td data-label="Yönetici">${project.project_manager_name || "-"}</td>
                <td data-label="İşlemler">
                    <div style="display: flex; gap: 10px;">
                        <button class="action-btn view-project-btn" data-id="${project.project_id}" title="Detayları Görüntüle"><i class="fas fa-eye"></i></button>
                        <button class="action-btn edit-project-btn" data-id="${project.project_id}" title="Projeyi Düzenle"><i class="fas fa-edit"></i></button>
                        <button class="action-btn delete-project-btn" data-id="${project.project_id}" title="Projeyi Sil"><i class="fas fa-trash"></i></button>
                        <button class="action-btn generate-pdf-btn" data-id="${project.project_id}" title="PDF Raporu Oluştur"><i class="fas fa-file-pdf"></i></button>
                    </div>
                </td>
            `;
            tbody.appendChild(row);
        });
        attachProjectTableEventListeners();
        updatePagination(projectsToRender.length, currentPage, Math.ceil(projectsToRender.length / rowsPerPage));
    }

    function attachProjectTableEventListeners() {
        document.querySelectorAll(".view-project-btn").forEach((btn) => {
            btn.onclick = (e) => {
                e.preventDefault();
                const projectId = e.currentTarget.dataset.id;
                openProjectModal(projectId, "view");
            };
        });
        document.querySelectorAll(".edit-project-btn").forEach((btn) => {
            btn.onclick = async (e) => {
                e.preventDefault();
                const projectId = e.currentTarget.dataset.id;
                const hasPermission = await checkPermission('proje_duzenle');
                if (!hasPermission) return;
                openProjectModal(projectId, "edit");
            };
        });
        document.querySelectorAll(".delete-project-btn").forEach((btn) => {
            btn.onclick = async (e) => {
                e.preventDefault();
                const projectId = e.currentTarget.dataset.id;
                const hasPermission = await checkPermission('proje_sil');
                if (!hasPermission) return;
                showConfirmationModal(`Bu projeyi silmek istediğinize emin misiniz? Bu işlem geri alınamaz!`, () => deleteProject(projectId));
            };
        });
        document.querySelectorAll(".generate-pdf-btn").forEach((btn) => {
            btn.onclick = async (e) => {
                e.preventDefault();
                const projectId = e.currentTarget.dataset.id;
                const project = allProjectsData.find((p) => p.project_id == projectId);
                if (project) {
                    const hasPermission = await checkPermission('pdf_olusturma');
                    if (!hasPermission) return;
                    generateProjectPdf(project);
                } else showToast("Proje bulunamadı!", true);
            };
        });
    }

    async function deleteProject(id) {
        const project = allProjectsData.find(p => String(p.project_id) === String(id));
        const projectName = project ? project.project_name : `ID: ${id}`;
        try {
            // user_id'yi query parametresi olarak ekle
            const response = await fetch(`${API_BASE_URL}/api/projects/${id}?user_id=${currentUser.id}`, {
                method: "DELETE",
            });
            const data = await response.json();
            if (response.ok) {
                showToast(data.message || "Proje başarıyla silindi");
                fetchProjects();
                // Aktivite kaydı eklendi
                addActivity(
                    "Proje Silindi",
                    `"${projectName}" projesi silindi.`,
                    id,
                    "fas fa-trash",
                    "project_delete"
                );
            } else {
                showToast(`Hata: ${data.message}`, true);
            }
        } catch (error) {
            console.error("Proje silme hatası:", error);
            showToast("Sunucuya bağlanılamadı veya bir sorun oluştu.", true);
        }
    }

    // --- Proje Detay/Düzenleme Modalı ve İş Gidişatı Fonksiyonları ---

    const projectModal = document.getElementById("projectModal");
    const projectModalContent = document.getElementById("projectModalContent");
    const closeModalBtn = document.getElementById("closeModalBtn");
    const cancelModalBtn = document.getElementById("cancelModalBtn");
    const modalTitle = document.getElementById("modalTitle");
    const modalBody = document.getElementById("modalBody");
    const modalActions = document.getElementById("modalActions");

    let modalBodyClickListener = null;

    // Modal kapatma fonksiyonu
    function closeProjectModal() {
        if (modalBodyClickListener) {
            modalBody.removeEventListener('click', modalBodyClickListener);
            modalBodyClickListener = null;
        }
        projectModal.style.display = "none";
        modalTitle.innerHTML = '<i class="fas fa-info-circle"></i> Proje Detayları';
        modalBody.innerHTML = "<p>Yükleniyor...</p>";
        modalActions.innerHTML = `<button class="modal-btn modal-btn-cancel" id="cancelModalBtn">Kapat</button>`;
        document.removeEventListener("keydown", handleEscapeKey);
        // Yeni kapatma butonuna olay dinleyicisi ekle
        const newCancelBtn = document.getElementById("cancelModalBtn");
        if (newCancelBtn) {
            newCancelBtn.addEventListener("click", closeProjectModal);
        }
        console.log("Modal kapatıldı.");
    }

    // Modal açma fonksiyonu
    async function openProjectModal(projectId, mode) {
        const project = allProjectsData.find((p) => p.project_id == projectId);
        if (!project) {
            showToast("Proje bulunamadı!", true);
            return;
        }

        projectModal.style.display = "flex";
        modalBody.innerHTML =
            '<p style="text-align: center;"><i class="fas fa-spinner fa-spin"></i> Yükleniyor...</p>';

        if (mode === "view") {
            modalTitle.innerHTML = `<i class="fas fa-info-circle"></i> Proje Detayları: ${project.project_name}`;
            await renderViewModal(project);
            modalActions.innerHTML = `<button class="modal-btn modal-btn-cancel" id="cancelModalBtn">Kapat</button>`;

            if (!modalBodyClickListener) {
                modalBodyClickListener = function(e) {
                    if (e.target.closest('.open-location-btn')) {
                        const btn = e.target.closest('.open-location-btn');
                        const location = btn.dataset.location;
                        openLocationInGoogleMaps(location);
                    }
                };
                modalBody.addEventListener('click', modalBodyClickListener);
            }
        } else if (mode === "edit") {
            modalTitle.innerHTML = `<i class="fas fa-edit"></i> Projeyi Düzenle: ${project.project_name}`;
            await renderEditModal(project);
            modalActions.innerHTML = `
                <button class="modal-btn modal-btn-save" id="saveProjectBtn"><i class="fas fa-save"></i> Kaydet</button>
                <button class="modal-btn modal-btn-cancel" id="cancelModalBtn">İptal</button>
            `;
            document.getElementById("saveProjectBtn").addEventListener("click", saveProjectChanges);
            document.getElementById("cancelModalBtn").addEventListener("click", closeProjectModal);
        }

        // Her zaman güncel kapatma butonlarına olay dinleyicisi ekle
        const cancelBtn = document.getElementById("cancelModalBtn");
        if (cancelBtn) {
            cancelBtn.addEventListener("click", closeProjectModal);
        }
        if (closeModalBtn) {
            closeModalBtn.addEventListener("click", closeProjectModal);
        }

        // Modalın dışına tıklayarak kapatma
        projectModal.onclick = (e) => {
            if (e.target === projectModal) {
                closeProjectModal();
            }
        };

        // Esc tuşu ile kapatma
        document.addEventListener("keydown", handleEscapeKey);
    }

    function handleEscapeKey(e) {
        if (e.key === "Escape" && projectModal.style.display === "flex") {
            closeProjectModal();
        }
    }

    // Google Haritalar'da konum açma fonksiyonu
    function openLocationInGoogleMaps(location) {
        if (!location) {
            showToast("Konum bilgisi bulunamadı!", true);
            return;
        }
        const encodedLocation = encodeURIComponent(location);
        const url = `https://www.google.com/maps/search/?api=1&query=${encodedLocation}`;
        window.open(url, '_blank');
    }

    async function renderViewModal(project) {
        let locationHtml = project.project_location || "-";
        if (project.project_location) {
            locationHtml += ` <button class="action-btn open-location-btn" data-location="${project.project_location}" title="Haritada Aç"><i class="fas fa-map-marker-alt"></i></button>`;
        }
        modalBody.innerHTML = `
            <div class="detail-item">
                <span class="detail-label">Proje Adı:</span>
                <span class="detail-value">${project.project_name ? project.project_name.normalize('NFC') : "-"}</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">Referans No:</span>
                <span class="detail-value">${project.reference_no || "-"}</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">Müşteri:</span>
                <span class="detail-value">${project.customer_name || "-"}</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">Konum:</span>
                <span class="detail-value">${locationHtml}</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">Durum:</span>
                <span class="detail-value">${getStatusBadgeHtml(project.display_status || "-")}</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">Başlangıç Tarihi:</span>
                <span class="detail-value">${formatDateForDisplay(project.start_date || "-")}</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">Bitiş Tarihi:</span>
                <span class="detail-value">${formatDateForDisplay(project.end_date || "-")}</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">Yönetici:</span>
                <span class="detail-value">${project.project_manager_name || "-"}</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">Açıklama:</span>
                <span class="detail-value">${project.description || "-"}</span>
            </div>
            <div class="progress-detail-section">
                <h3 class="modal-title" style="margin-bottom: 15px;"><i class="fas fa-tasks"></i> İş Gidişatı</h3>
                <div id="progressStepsContainer"></div>
                <button class="btn" style="margin-top: 15px;" id="addProgressStepBtn">
                    <i class="fas fa-plus"></i> İş Adımı Ekle
                </button>
            </div>
        `;
        try {
            await fetchProgressSteps(project.project_id);
        } catch (err) {
            const progressStepsContainer = document.getElementById("progressStepsContainer");
            if (progressStepsContainer) {
                progressStepsContainer.innerHTML = `<p style="color: var(--danger);">İş adımları yüklenemedi. Sunucuya ulaşılamıyor veya API hatası.</p>`;
            }
        }
    }

    // Düzenleme modalı fonksiyonu
    async function renderEditModal(project) {
        // Müşterileri ve Proje Yöneticilerini çek
        const customers = await fetchCustomersForSelect();
        const projectManagers = await fetchProjectManagersForSelect();

        let customerOptions = customers.map(c => 
            `<option value="${c.customer_id}" ${c.customer_id === project.customer_id ? 'selected' : ''}>${c.customer_name}</option>`
        ).join('');

        let managerOptions = projectManagers.map(pm => 
            `<option value="${pm.id}" ${pm.id === project.project_manager_user_id ? 'selected' : ''}>${pm.fullname}</option>`
        ).join('');

        modalBody.innerHTML = `
            <input type="hidden" id="editProjectId" value="${project.project_id}">
            <div class="form-group">
                <label for="editProjectName" class="form-label">Proje Adı</label>
                <input type="text" id="editProjectName" class="form-input" value="${project.project_name ? project.project_name.normalize('NFC') : ""}">
            </div>
            <div class="form-group">
                <label for="editReferenceNo" class="form-label">Referans No</label>
                <input type="text" id="editReferenceNo" class="form-input" value="${project.reference_no || ""}">
            </div>
            <div class="form-group">
                <label for="editCustomerId" class="form-label">Müşteri</label>
                <select id="editCustomerId" class="form-input">
                    ${customerOptions}
                </select>
            </div>
            <div class="form-group">
                <label for="editLocation" class="form-label">Konum</label>
                <input type="text" id="editLocation" class="form-input" value="${project.project_location || ""}">
            </div>
            <div class="form-group">
                <label for="editStatus" class="form-label">Durum</label>
                <select id="editStatus" class="form-input">
                    <option value="Aktif" ${project.status === "Aktif" ? "selected" : ""}>Aktif</option>
                    <option value="Tamamlandı" ${project.status === "Tamamlandı" ? "selected" : ""}>Tamamlandı</option>
                    <option value="Gecikti" ${project.status === "Gecikti" ? "selected" : ""}>Gecikti</option>
                    <option value="Planlama Aşamasında" ${project.status === "Planlama Aşamasında" ? "selected" : ""}>Planlama Aşamasında</option>
                    <option value="Aktif (İş Gecikmeli)" ${project.status === "Aktif (İş Gecikmeli)" ? "selected" : ""}>Aktif (İş Gecikmeli)</option>
                    <option value="Planlama (İş Gecikmeli)" ${project.status === "Planlama (İş Gecikmeli)" ? "selected" : ""}>Planlama (İş Gecikmeli)</option>
                </select>
            </div>
            <div class="form-group">
                <label for="editStartDate" class="form-label">Başlangıç Tarihi</label>
                <input type="date" id="editStartDate" class="form-input" value="${formatDateForInput(project.start_date || "")}">
            </div>
            <div class="form-group">
                <label for="editEndDate" class="form-label">Bitiş Tarihi</label>
                <input type="date" id="editEndDate" class="form-input" value="${formatDateForInput(project.end_date || "")}">
            </div>
            <div class="form-group">
                <label for="editProjectManagerId" class="form-label">Proje Yöneticisi</label>
                <select id="editProjectManagerId" class="form-input">
                    ${managerOptions}
                </select>
            </div>
            <div class="form-group">
                <label for="editDescription" class="form-label">Açıklama</label>
                <textarea id="editDescription" class="form-input" rows="4">${project.description || ""}</textarea>
            </div>
            <div class="progress-detail-section">
                <h3 class="modal-title" style="margin-bottom: 15px;"><i class="fas fa-tasks"></i> İş Gidişatı</h3>
                <div id="progressStepsContainer"></div>
                <button class="btn" style="margin-top: 15px;" id="addProgressStepBtn">
                    <i class="fas fa-plus"></i> İş Adımı Ekle
                </button>
            </div>
        `;
        await fetchProgressSteps(project.project_id, true);
    }

    // Müşterileri API'den çeken fonksiyon
    async function fetchCustomersForSelect() {
        try {
            const response = await fetch(`${API_BASE_URL}/api/customers`);
            if (!response.ok) {
                throw new Error('Müşteriler çekilemedi.');
            }
            const customers = await response.json();
            return customers;
        } catch (error) {
            console.error("Müşteriler çekilirken hata:", error);
            showToast("Müşteriler yüklenirken bir sorun oluştu.", true);
            return [];
        }
    }

    // Proje Yöneticilerini API'den çeken fonksiyon
    async function fetchProjectManagersForSelect() {
        try {
            const response = await fetch(`${API_BASE_URL}/api/project_managers`);
            if (!response.ok) {
                throw new Error('Proje yöneticileri çekilemedi.');
            }
            const managers = await response.json();
            return managers;
        } catch (error) {
            console.error("Proje yöneticileri çekilirken hata:", error);
            showToast("Proje yöneticileri yüklenirken bir sorun oluştu.", true);
            return [];
        }
    }


    async function saveProjectChanges() {
        const hasPermission = await checkPermission('proje_duzenle');
        if (!hasPermission) return;
        const projectId = document.getElementById("editProjectId").value;
        const projectName = document.getElementById("editProjectName").value;
        const referenceNo = document.getElementById("editReferenceNo").value;
        const customerId = document.getElementById("editCustomerId").value; // Müşteri ID'si
        const location = document.getElementById("editLocation").value;
        const status = document.getElementById("editStatus").value;
        const startDate = document.getElementById("editStartDate").value;
        const endDate = document.getElementById("editEndDate").value;
        const projectManagerId = document.getElementById("editProjectManagerId").value; // Proje Yöneticisi ID'si
        const description = document.getElementById("editDescription").value;

        const updatedProject = {
            project_name: projectName,
            reference_no: referenceNo,
            customer_id: customerId, // Müşteri ID'si eklendi
            project_location: location,
            status: status,
            start_date: startDate,
            end_date: endDate,
            project_manager_id: projectManagerId, // Proje Yöneticisi ID'si eklendi
            description: description,
            user_id: currentUser.id // Kullanıcı ID'si eklendi
        };

        try {
            const response = await fetch(`${API_BASE_URL}/api/projects/${projectId}`, {
                method: "PUT",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify(updatedProject),
            });

            const data = await response.json();
            if (response.ok) {
                showToast("Proje başarıyla güncellendi!");
                addActivity(
                    "Proje Güncellendi",
                    `${projectName} adlı proje güncellendi.`,
                    projectId,
                    "fas fa-pen-to-square",
                    "project_update"
                );
                fetchProjects(); // Listeyi yenile
                closeProjectModal();
            } else {
                showToast(`Hata: ${data.message}`, true);
            }
        } catch (error) {
            console.error("Proje güncelleme hatası:", error);
            showToast("Proje güncellenirken bir sorun oluştu.", true);
        }
    }

    // `isEditable` parametresi eklendi
    async function fetchProgressSteps(projectId, isEditable = false) {

        const progressStepsContainer = document.getElementById("progressStepsContainer");
        console.log("DEBUG: fetchProgressSteps başı, projectId:", projectId, "isEditable:", isEditable, "progressStepsContainer:", progressStepsContainer);
        if (!progressStepsContainer) {
            console.error("DEBUG: fetchProgressSteps, progressStepsContainer bulunamadı!");
            return;
        }
        progressStepsContainer.innerHTML =
            '<p style="text-align: center;"><i class="fas fa-spinner fa-spin"></i> İş adımları yükleniyor...</td></tr>';

        let timeoutId = setTimeout(() => {
            progressStepsContainer.innerHTML = `<p style='color: var(--danger);'>İş adımları yüklenemedi. Sunucuya ulaşılamıyor veya API çok yavaş.</p>`;
        }, 7000); // 7 saniye sonra hata mesajı göster

        try {
            console.log("DEBUG: fetchProgressSteps, API fetch başlıyor:", `${API_BASE_URL}/api/projects/${projectId}/progress`);
            const response = await fetch(`${API_BASE_URL}/api/projects/${projectId}/progress`);
            clearTimeout(timeoutId);
            if (!response.ok) {
                const errorText = await response.text();
                console.error(`API Yanıtı Hata (Durum: ${response.status}):`, errorText);
                throw new Error(`HTTP hatası! Sunucu yanıtı: ${response.status} - ${errorText.substring(0, 100)}...`);
            }
            const progressSteps = await response.json();
            console.log("DEBUG: fetchProgressSteps, API'den progressSteps geldi:", progressSteps);
            renderProgressSteps(progressSteps, projectId, isEditable);
            console.log("DEBUG: fetchProgressSteps, renderProgressSteps çağrıldı");
        } catch (error) {
            clearTimeout(timeoutId);
            console.error("İş adımları çekilemedi:", error);
            progressStepsContainer.innerHTML = `<p style=\"color: var(--danger);\">İş adımları yüklenemedi. Hata: ${error.message}. Lütfen sunucu bağlantısını ve API rotalarını kontrol edin.</p>`;
            showToast("İş adımları yüklenirken bir sorun oluştu.", true);
        }
    }

    // `isEditable` parametresi eklendi
    function renderProgressSteps(steps, projectId, isEditable = false) {
        const progressStepsContainer = document.getElementById("progressStepsContainer");
        if (!progressStepsContainer) return;
        progressStepsContainer.innerHTML = "";

        if (steps.length === 0) {
            progressStepsContainer.innerHTML = '<p>Bu proje için henüz iş adımı eklenmemiş.</p>';
        } else {
            steps.forEach((step) => {
                const stepElement = document.createElement("div");
                stepElement.className = "progress-detail-item";

                const titleContent = isEditable ?
                    `<input type="text" id="step-${step.progress_id}-name" class="progress-step-name-input" value="${step.step_name || ''}" placeholder="Adım Adı" required>` :
                    `<span class="progress-detail-title">${step.step_name || ''}</span>`;

                const startDateContent = isEditable ?
                    `<label for="step-${step.progress_id}-start">Başlangıç:</label><input type="date" id="step-${step.progress_id}-start" class="progress-datepicker" value="${formatDateForInput(step.start_date || '')}" required>` :
                    `Başlangıç: ${formatDateForDisplay(step.start_date || '-')}`;

                const endDateContent = isEditable ?
                    `<label for="step-${step.progress_id}-end">Bitiş:</label><input type="date" id="step-${step.progress_id}-end" class="progress-datepicker" value="${formatDateForInput(step.end_date || '')}" required>` :
                    `Bitiş: ${formatDateForDisplay(step.end_date || '-')}`;

                const delayDisplay = (step.delay_days > 0 && !isEditable) ? `<span class='pdf-delay-text'>(${step.delay_days} gün gecikmeli)</span>` : '';

                const descriptionContent = isEditable ?
                    `<textarea id="step-${step.progress_id}-desc" class="progress-description-textarea" placeholder="Açıklama">${step.description || ''}</textarea>` :
                    `<div class="progress-detail-description">Açıklama: ${step.description || 'Yok'}</div>`;

                const actionsContent = isEditable ?
                
                    `
                    <div class="progress-actions">
                        <button type="button" class="action-btn save-progress-btn" data-id="${step.progress_id}" data-project-id="${projectId}" title="Kaydet"><i class="fas fa-save"></i> Kaydet</button>
                        <button type="button" class="action-btn delete-progress-btn" data-id="${step.progress_id}" data-project-id="${projectId}" title="Sil"><i class="fas fa-trash"></i> Sil</button>
                    </div>
                        ` : ``;

                stepElement.innerHTML = `
                    <div class="progress-item-header">
                        <div class="input-group" style="flex: 1;">
                            ${isEditable ? '<label for="step-' + step.progress_id + '-name">Adım Başlığı</label>' : ''}
                            ${titleContent}
                        </div>
                        <div class="progress-dates" style="margin-left: ${isEditable ? '20px' : '0'};">
                            <span>
                                ${startDateContent}
                            </span>
                            <span>
                                ${endDateContent}
                            </span>
                            ${delayDisplay}
                        </div>
                    </div>
                    <div class="input-group">
                        ${isEditable ? '<label for="step-' + step.progress_id + '-desc">Açıklama</label>' : ''}
                        ${descriptionContent}
                    </div>
                    ${actionsContent}
                `;
                progressStepsContainer.appendChild(stepElement);
            });

            // Event listener'ları dinamik olarak atama (sadece düzenleme modunda)
            if (isEditable) {
                document.querySelectorAll('.save-progress-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const progressId = e.currentTarget.dataset.id;
                        const projId = e.currentTarget.dataset.projectId;
                        const stepName = document.getElementById(`step-${progressId}-name`).value;
                        const startDate = document.getElementById(`step-${progressId}-start`).value;
                        const endDate = document.getElementById(`step-${progressId}-end`).value;
                        const description = document.getElementById(`step-${progressId}-desc`).value;
                        editProgressStep(progressId, projId, { step_name: stepName, start_date: startDate, end_date: endDate, description: description });
                    });
                });
                document.querySelectorAll('.delete-progress-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const progressId = e.currentTarget.dataset.id;
                        const projId = e.currentTarget.dataset.projectId;
                        showConfirmationModal(`Bu iş adımını silmek istediğinize emin misiniz? Bu işlem geri alınamaz!`, () => deleteProgressStep(progressId, projId));
                    });
                });
            }
        }

        // "İş Adımı Ekle" butonu için olay dinleyicisi
        const addProgressStepButton = document.getElementById("addProgressStepBtn");
        if (addProgressStepButton) {
            addProgressStepButton.onclick = null;
            addProgressStepButton.onclick = () => addNewProgressStepForm(projectId);
        }
    }
    // MODAL İÇİNE YENİ İŞ ADIMI EKLEME FORMU OLUŞTURAN FONKSİYON
    function addNewProgressStepForm(projectId) {
        const progressStepsContainer = document.getElementById("progressStepsContainer");
        // Zaten bir ekleme formu varsa yeni bir tane daha açma
        if (document.getElementById('newProgressForm')) {
            showToast("Zaten açık bir ekleme formu var.", false);
            return;
        }

        const formElement = document.createElement('div');
        formElement.id = 'newProgressForm';
        formElement.className = 'progress-detail-item'; // Mevcut öğe stilini kullan

        formElement.innerHTML = `
            <div class="progress-item-header">
                <div class="input-group" style="flex: 1;">
                    <label for="newStepName">Adım Başlığı</label>
                    <input type="text" id="newStepName" class="progress-step-name-input" placeholder="İş gidişat başlığı" required>
                </div>
                <div class="progress-dates" style="margin-left: 20px;">
                    <span>
                        <label for="newStepStartDate">Başlangıç:</label>
                        <input type="date" id="newStepStartDate" class="progress-datepicker" required>
                    </span>
                    <span>
                        <label for="newStepEndDate">Bitiş:</label>
                        <input type="date" id="newStepEndDate" class="progress-datepicker" required>
                    </span>
                </div>
            </div>
            <div class="input-group">
                <label for="newStepDescription">Açıklama</label>
                <textarea id="newStepDescription" class="progress-description-textarea" placeholder="İş gidişat açıklaması"></textarea>
            </div>
            <div class="progress-actions">
                <button type="button" class="action-btn modal-btn-cancel" id="cancelAddProgressBtn"><i class="fas fa-times"></i> İptal</button>
                <button type="button" class="action-btn modal-btn-save" id="saveNewProgressBtn"><i class="fas fa-plus"></i> Ekle</button>
            </div>
        `;
        progressStepsContainer.appendChild(formElement);

        // Yeni form için olay dinleyicileri
        document.getElementById('saveNewProgressBtn').addEventListener('click', async () => {
            const stepName = document.getElementById('newStepName').value;
            const startDate = document.getElementById('newStepStartDate').value;
            const endDate = document.getElementById('newStepEndDate').value;
            const description = document.getElementById('newStepDescription').value;

            if (!stepName || !startDate || !endDate) {
                showToast("Lütfen tüm zorunlu alanları doldurun.", true);
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/api/projects/${projectId}/progress`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ step_name: stepName, start_date: startDate, end_date: endDate, description: description })
                });
                const data = await response.json();
                if (response.ok) {
                    showToast("İş adımı başarıyla eklendi.");
                    formElement.remove(); // Formu kapat
                    fetchProgressSteps(projectId, true); // Adımları yeniden yükle (düzenleme modunda kal)
                    addActivity('İş Adımı Eklendi', `Proje ID: ${projectId} için "${stepName}" iş adımı eklendi.`, projectId, 'fas fa-tasks', 'progress_add');
                } else {
                    showToast(`Hata: ${data.message}`, true);
                }
            } catch (error) {
                console.error("Yeni iş adımı ekleme hatası:", error);
                showToast("İş adımı eklenirken bir sorun oluştu.", true);
            }
        });

        document.getElementById('cancelAddProgressBtn').addEventListener('click', () => {
            formElement.remove(); // Formu kaldır
            showToast("İş adımı ekleme iptal edildi.", false);
        });
    }

    // editProgressStep fonksiyonu doğrudan SweetAlert2 kullanmak yerine
    // renderProgressSteps içinde inline form elemanlarından veri alacak şekilde güncellendi.
    // progress_id kullanıldı
    async function editProgressStep(progressId, projectId, updatedStepData) {
        try {
            const response = await fetch(`${API_BASE_URL}/api/progress/${progressId}`, { // progressId kullanılıyor
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(updatedStepData),
            });
            const data = await response.json();
            if (response.ok) {
                showToast("İş adımı başarıyla güncellendi.");
                fetchProjects(); // Projeler listesini de yenile (durum güncellenmiş olabilir)
                fetchProgressSteps(projectId, true); // Adımları yenile (düzenleme modunda kal)
                addActivity(
                    "İş Adımı Güncellendi",
                    `Proje ID: ${projectId} için "${updatedStepData.step_name}" iş adımı güncellendi.`,
                    projectId,
                    "fas fa-pen",
                    "progress_update"
                );
            } else {
                showToast(`Hata: ${data.message}`, true);
            }
        } catch (error) {
            console.error("İş adımı güncelleme hatası:", error);
            showToast("İş adımı güncellenirken bir sorun oluştu.", true);
        }
    }

    // progress_id kullanıldı
    async function deleteProgressStep(progressId, projectId) {
        try {
            const response = await fetch(`${API_BASE_URL}/api/progress/${progressId}`, { // progressId kullanılıyor
                method: "DELETE",
            });
            const data = await response.json();
            if (response.ok) {
                showToast("İş adımı başarıyla silindi!");
                fetchProjects(); // Projeler listesini de yenile (durum güncellenmiş olabilir)
                fetchProgressSteps(projectId, true); // Adımları yenile (düzenleme modunda kal)
                addActivity(
                    "İş Adımı Silindi",
                    `Proje ID: ${projectId} için bir iş adımı silindi.`,
                    projectId,
                    "fas fa-times",
                    "progress_delete"
                );
            } else {
                showToast(`Hata: ${data.message}`, true);
            }
        } catch (error) {
            console.error("İş adımı silme hatası:", error);
            showToast("İş adımı silinirken bir sorun oluştu.", true);
        }
    }

    // PDF Oluşturma Fonksiyonları (progress_id kullanıldı)
    async function generateProjectPdf(project) {
        // 1. Progress adımlarını çek
        let progressSteps = [];
        try {
            const response = await fetch(`${API_BASE_URL}/api/projects/${project.project_id}/progress`);
            if (response.ok) {
                progressSteps = await response.json();
            }
        } catch (e) {
            // Progress adımları olmadan da PDF oluşturulabilir
        }

        // 2. PDF içeriğini detaylı ve görsel olarak hazırla
        const pdfContent = document.createElement('div');
        pdfContent.className = 'pdf-report-content';
        pdfContent.innerHTML = `
            <div class="pdf-header">
                <h1 style='font-size:28px;color:#005c9d;margin-bottom:5px;'>Ser Elektrik Otomasyon</h1>
                <h2 style='font-size:22px;color:#0980d3;margin-bottom:15px;'>Proje Detaylı Raporu</h2>
            </div>
            <table class="pdf-info-table" style="width:100%;margin-bottom:20px;font-size:15px;">
                <tr><th>Proje Adı</th><td>${project.project_name ? project.project_name.normalize('NFC') : "-"}</td></tr>
                <tr><th>Referans No</th><td>${project.reference_no || '-'}</td></tr>
                <tr><th>Müşteri</th><td>${project.customer_name || '-'}</td></tr>
                <tr><th>Konum</th><td>${project.project_location || '-'}</td></tr>
                <tr><th>Durum</th><td>${project.display_status || '-'}</td></tr>
                <tr><th>Başlangıç Tarihi</th><td>${formatDateForDisplay(project.start_date || '-')}</td></tr>
                <tr><th>Bitiş Tarihi</th><td>${formatDateForDisplay(project.end_date || '-')}</td></tr>
                <tr><th>Yönetici</th><td>${project.project_manager_name || '-'}</td></tr>
                <tr><th>Açıklama</th><td>${project.description || '-'}</td></tr>
            </table>
            <div class="pdf-section-title" style='font-size:18px; color:#005c9d; border-bottom:1px solid #e1e5e9; padding-bottom:5px; margin-bottom:15px;'><i class="fas fa-tasks"></i> İş Gidişatı</div>
            <div>
                ${progressSteps.length === 0 ? '<p>İş adımı bulunamadı.</p>' : progressSteps.map(step => `
                    <div style="margin-bottom:12px;">
                        <div style="font-weight:bold;font-size:15px;">${step.step_name || ''}</div>
                        <div style="font-size:13px; color:#555;">Başlangıç: ${formatDateForDisplay(step.start_date || '-')} - Bitiş: ${formatDateForDisplay(step.end_date || '-')} ${(step.delay_days > 0) ? `<span class='pdf-delay-text'>(${step.delay_days} gün gecikmeli)</span>` : ''}</div>
                        <div style="font-size:13px;">${step.description || ''}</div>
                    </div>
                `).join('')}
            </div>
            <div class="pdf-footer" style='margin-top:40px; font-size:12px; color:#6c757d; border-top:1px solid #eee; padding-top:15px;'>
                © 2025 Ser Elektrik Otomasyon. Tüm hakları saklıdır.
            </div>
        `;

        // Yeni pencere aç
        const newWindow = window.open('', '_blank', 'width=900,height=800,resizable=yes,scrollbars=yes');
        if (!newWindow) {
            showToast("PDF önizlemesi için yeni pencere açılamadı. Tarayıcınızın pop-up engelleyicisini kontrol edin.", true);
            return;
        }

        // Yeni pencereye PDF içeriğini ve gerekli CSS'i ekle
        newWindow.document.write(`
            <!DOCTYPE html>
            <html lang="tr">
            <head>
                <meta charset="UTF-8">
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>${project.project_name ? project.project_name.normalize('NFC') : "Proje"} Raporu Önizlemesi</title>
                <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
                <style>
                    body { font-family: 'Segoe UI', Arial, sans-serif; margin: 0; padding: 0; background-color: #f0f2f5; }
                    .pdf-container {
                        width: 210mm; /* A4 genişliği */
                        min-height: 297mm; /* A4 yüksekliği */
                        margin: 20px auto;
                        background: #fff;
                        box-shadow: 0 0 10px rgba(0,0,0,0.1);
                        padding: 20mm; /* Kenar boşlukları */
                        box-sizing: border-box;
                    }
                    .pdf-report-content {
                        font-family: "Segoe UI", Arial, sans-serif;
                        color: #333;
                        box-sizing: border-box;
                    }
                    .pdf-header h1 { color: #005c9d; font-size: 28px; margin-bottom: 5px; }
                    .pdf-header h2 { color: #0980d3; font-size: 22px; margin-bottom: 15px; }
                    .pdf-info-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 15px; }
                    .pdf-info-table th, .pdf-info-table td { padding: 8px; border: 1px solid #e1e5e9; text-align: left; }
                    .pdf-info-table th { background-color: #f0f4f8; color: #5e6870; width: 30%; }
                    .pdf-section-title { color: #005c9d; border-bottom: 1px solid #e1e5e9; padding-bottom: 5px; margin-bottom: 15px; font-size: 18px; }
                    .pdf-delay-text { color: red; font-weight: bold; }
                    .pdf-footer { text-align: center; font-size: 12px; color: #6c757d; margin-top: 40px; border-top: 1px solid #eee; padding-top: 15px; }
                    .print-button-container {
                        text-align: center;
                        margin-top: 20px;
                        padding-bottom: 20px;
                    }
                    .print-button {
                        background-color: #005c9d;
                        color: white;
                        padding: 10px 20px;
                        border: none;
                        border-radius: 8px;
                        font-size: 16px;
                        cursor: pointer;
                        transition: background-color 0.3s ease;
                    }
                    .print-button:hover {
                        background-color: #0980d3;
                    }
                    @media print {
                        .print-button-container { display: none; }
                        body { background-color: #fff; }
                        .pdf-container { margin: 0; box-shadow: none; padding: 0; }
                    }
                </style>
            </head>
            <body>
                <div class="pdf-container">
                    ${pdfContent.innerHTML}
                </div>
                <div class="print-button-container">
                    <button class="print-button" onclick="window.print()"><i class="fas fa-print"></i> PDF Kaydet / Yazdır</button>
                </div>
            </body>
            </html>
        `);
        newWindow.document.close(); // Yazma işlemini bitir

        // Yeni pencere yüklendiğinde aktivite kaydı
        newWindow.onload = () => {
            showToast(`${project.project_name ? project.project_name.normalize('NFC') : "proje"} için PDF raporu önizlemesi hazır.`);
            addActivity(
                "PDF Raporu Önizlendi",
                `${project.project_name ? project.project_name.normalize('NFC') : "proje"} için PDF raporu önizlemesi açıldı.`,
                project.project_id,
                "fas fa-file-pdf",
                "pdf_preview"
            );
        };
    }

    // Tüm projeleri PDF olarak dışa aktar
    async function exportAllProjectsToPdf() {
        showToast("Tüm projeler PDF olarak hazırlanıyor...", false);

        // 1. Tüm projeleri içeren bir HTML tablosu oluştur
        let allProjectsHtml = `
            <div style="font-family: 'Segoe UI', Arial, sans-serif; padding: 15mm; color: #333; background: #fff; box-sizing: border-box;">
                <div style="text-align: center; margin-bottom: 20px;">
                    <h1 style='font-size:28px;color:#005c9d;margin-bottom:5px;'>Ser Elektrik Otomasyon</h1>
                    <h2 style='font-size:22px;color:#0980d3;margin-bottom:15px;'>Tüm Projeler Raporu</h2>
                </div>
                <table style="width:100%; border-collapse: collapse; margin-bottom: 20px; border: 1px solid #e1e5e9;">
                    <thead>
                        <tr>
                            <th style="border: 1px solid #e1e5e9; padding: 10px 8px; text-align: left; background-color: #f0f4f8; font-weight: bold; color: #5e6870;">Proje Adı</th>
                            <th style="border: 1px solid #e1e5e9; padding: 10px 8px; text-align: left; background-color: #f0f4f8; font-weight: bold; color: #5e6870;">Referans No</th>
                            <th style="border: 1px solid #e1e5e9; padding: 10px 8px; text-align: left; background-color: #f0f4f8; font-weight: bold; color: #5e6870;">Müşteri</th>
                            <th style="border: 1px solid #e1e5e9; padding: 10px 8px; text-align: left; background-color: #f0f4f8; font-weight: bold; color: #5e6870;">Durum</th>
                            <th style="border: 1px solid #e1e5e9; padding: 10px 8px; text-align: left; background-color: #f0f4f8; font-weight: bold; color: #5e6870;">Başlangıç</th>
                            <th style="border: 1px solid #e1e5e9; padding: 10px 8px; text-align: left; background-color: #f0f4f8; font-weight: bold; color: #5e6870;">Bitiş</th>
                            <th style="border: 1px solid #e1e5e9; padding: 10px 8px; text-align: left; background-color: #f0f4f8; font-weight: bold; color: #5e6870;">Toplam Gün</th>
                            <th style="border: 1px solid #e1e5e9; padding: 10px 8px; text-align: left; background-color: #f0f4f8; font-weight: bold; color: #5e6870;">Geçen Gün</th>
                            <th style="border: 1px solid #e1e5e9; padding: 10px 8px; text-align: left; background-color: #f0f4f8; font-weight: bold; color: #5e6870;">Gecikme Durumu</th>
                            <th style="border: 1px solid #e1e5e9; padding: 10px 8px; text-align: left; background-color: #f0f4f8; font-weight: bold; color: #5e6870;">Yönetici</th>
                        </tr>
                    </thead>
                    <tbody>
        `;

        // Yardımcı fonksiyonlar (mevcut fonksiyonlardan kopyalandı)
        function dateDiffInDays(date1, date2) {
            function parseDate(str) {
                if (!str) return null;
                if (str.includes('-')) {
                    const [y, m, d] = str.split('-');
                    return new Date(Number(y), Number(m) - 1, Number(d));
                } else if (str.includes('.')) {
                    const [d, m, y] = str.split('.');
                    return new Date(Number(y), Number(m) - 1, Number(d));
                }
                return null;
            }
            const dt1 = parseDate(date1);
            const dt2 = parseDate(date2);
            if (!dt1 || !dt2) return null;
            return Math.ceil((dt2 - dt1) / (1000 * 60 * 60 * 24));
        }

        function getTodayStr() {
            const today = new Date();
            return today.toISOString().slice(0, 10); // YYYY-MM-DD
        }

        allProjectsData.forEach((project, index) => {
            let totalDays = dateDiffInDays(project.start_date, project.end_date);
            totalDays = (typeof totalDays === "number" && !isNaN(totalDays)) ? (totalDays >= 0 ? totalDays : 0) : '-';

            const todayStr = getTodayStr();
            let elapsedDays = dateDiffInDays(project.start_date, todayStr);
            elapsedDays = (typeof elapsedDays === "number" && !isNaN(elapsedDays)) ? (elapsedDays >= 0 ? elapsedDays : 0) : '-';

            let delayDays = 0;
            if (project.total_delay_days !== undefined && project.total_delay_days !== null) {
                delayDays = Number(project.total_delay_days);
                if (isNaN(delayDays)) delayDays = 0;
            }
            
            let overdue = 0;
            if (project.end_date) {
                const endDateObj = (() => {
                    if (project.end_date.includes('-')) {
                        const [y, m, d] = project.end_date.split('-');
                        return new Date(Number(y), Number(m) - 1, Number(d));
                    } else if (project.end_date.includes('.')) {
                        const [d, m, y] = project.end_date.split('.');
                        return new Date(Number(y), Number(m) - 1, Number(d));
                    }
                    return null;
                })();
                const todayObj = new Date();
                if (endDateObj && todayObj > endDateObj && project.status !== 'Tamamlandı') {
                    overdue = Math.ceil((todayObj - endDateObj) / (1000 * 60 * 60 * 24));
                }
            }
            
            let gecikmeDurumu = "-";
            const combinedDelay = delayDays + overdue;
            if (combinedDelay > 0) {
                gecikmeDurumu = combinedDelay + " gün";
            } else if (typeof combinedDelay === 'number' && combinedDelay === 0) {
                gecikmeDurumu = "0 gün";
            }

            // Satır rengi için basit bir alternatif
            const rowBgColor = index % 2 === 0 ? '#ffffff' : '#f9f9f9';

            allProjectsHtml += `
                <tr style="background-color: ${rowBgColor};">
                    <td style="border: 1px solid #e1e5e9; padding: 8px; text-align: left;">${project.project_name ? project.project_name.normalize('NFC') : "-"}</td>
                    <td style="border: 1px solid #e1e5e9; padding: 8px; text-align: left;">${project.reference_no || "-"}</td>
                    <td style="border: 1px solid #e1e5e9; padding: 8px; text-align: left;">${project.customer_name || "-"}</td>
                    <td style="border: 1px solid #e1e5e9; padding: 8px; text-align: left;">${project.display_status || "-"}</td>
                    <td style="border: 1px solid #e1e5e9; padding: 8px; text-align: left;">${formatDateForDisplay(project.start_date || "-")}</td>
                    <td style="border: 1px solid #e1e5e9; padding: 8px; text-align: left;">${formatDateForDisplay(project.end_date || "-")}</td>
                    <td style="border: 1px solid #e1e5e9; padding: 8px; text-align: left;">${totalDays !== '-' ? totalDays + ' gün' : '-'}</td>
                    <td style="border: 1px solid #e1e5e9; padding: 8px; text-align: left;">${elapsedDays !== '-' ? elapsedDays + ' gün' : '-'}</td>
                    <td style="border: 1px solid #e1e5e9; padding: 8px; text-align: left;">${gecikmeDurumu}</td>
                    <td style="border: 1px solid #e1e5e9; padding: 8px; text-align: left;">${project.project_manager_name || "-"}</td>
                </tr>
            `;
        });

        allProjectsHtml += `
                    </tbody>
                </table>
                <div style="text-align: center; font-size: 10px; color: #6c757d; margin-top: 30px; border-top: 1px solid #eee; padding-top: 10px;">
                    © 2025 Ser Elektrik Otomasyon. Tüm hakları saklıdır.
                </div>
            </div>
        `;

        // 2. html2pdf kütüphanesini kullanarak PDF oluştur
        const element = document.createElement('div');
        element.innerHTML = allProjectsHtml;

        const options = {
            margin: 10,
            filename: 'Tüm_Projeler_Raporu.pdf',
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2, logging: true, dpi: 192, letterRendering: true },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' } // Yatay A4 formatı
        };

        try {
            await html2pdf().from(element).set(options).save();
            showToast("Tüm projeler PDF olarak başarıyla dışa aktarıldı!");
            addActivity(
                "Tüm Projeler PDF Dışa Aktarıldı",
                "Tüm projeler PDF olarak indirildi.",
                null, // Proje ID'si yok, tüm projeler
                "fas fa-file-pdf",
                "pdf_export_all"
            );
        } catch (error) {
            console.error("Tüm projeleri PDF'e aktarırken hata oluştu:", error);
            showToast(`PDF oluşturulurken hata oluştu: ${error.message}`, true);
        }
    }

    // --- Sayfalandırma Fonksiyonları ---
    function updateRowsPerPage() {
        // Ekran genişliğine göre sayfa başına gösterilecek proje sayısını ayarla
        if (window.innerWidth <= 576) { // Mobil cihazlar için
            rowsPerPage = 8;
        } else { // Masaüstü ve tabletler için
            rowsPerPage = 10;
        }
    }

    function updatePagination(totalItems, currentP, totalP) {
        totalProjectsCountSpan.textContent = totalItems;
        currentPageSpan.textContent = currentP;
        totalPagesSpan.textContent = totalP;

        prevPageButton.disabled = currentP === 1;
        nextPageButton.disabled = currentP === totalP || totalP === 0;

        pageNumbersContainer.innerHTML = '';
        // Sadece mevcut sayfa etrafında birkaç numara göster
        const maxPageButtons = 5;
        let startPage = Math.max(1, currentP - Math.floor(maxPageButtons / 2));
        let endPage = Math.min(totalP, startPage + maxPageButtons - 1);

        if (endPage - startPage + 1 < maxPageButtons) {
            startPage = Math.max(1, endPage - maxPageButtons + 1);
        }

        for (let i = startPage; i <= endPage; i++) {
            const pageButton = document.createElement('button');
            pageButton.className = `page-btn ${i === currentP ? 'active' : ''}`;
            pageButton.textContent = i;
            pageButton.addEventListener('click', () => {
                currentPage = i;
                renderProjectsTable(filteredProjects);
            });
            pageNumbersContainer.appendChild(pageButton);
        }
    }
    
    // Sayfalandırma butonları olay dinleyicileri
    prevPageButton.addEventListener('click', () => {
        if (currentPage > 1) {
            currentPage--;
            renderProjectsTable(filteredProjects);
        }
    });

    nextPageButton.addEventListener('click', () => {
        if (currentPage < Math.ceil(filteredProjects.length / rowsPerPage)) {
            currentPage++;
            renderProjectsTable(filteredProjects);
        }
    });

    function applyFiltersAndRenderTable() {
        const searchTerm = document.getElementById("searchInput").value.toLowerCase();
        const filterProjectName = document.getElementById("filterProjectName").value.toLowerCase();
        const filterRefNo = document.getElementById("filterRefNo").value.toLowerCase();
        const filterCustomer = document.getElementById("filterCustomer").value.toLowerCase();
        const filterStatus = document.getElementById("filterStatus").value; // Durum direkt string

        let projectsToFilter = allProjectsData;

        // "Projelerim" filtresi
        if (isMyProjectsView && currentUser && currentUser.id) {
            projectsToFilter = projectsToFilter.filter(project => 
                project.project_manager_user_id == currentUser.id
            );
        }

        filteredProjects = projectsToFilter.filter((project) => {
            const matchesSearch =
                (project.project_name &&
                project.project_name.toLowerCase().includes(searchTerm)) ||
                (project.reference_no &&
                project.reference_no.toLowerCase().includes(searchTerm)) ||
                (project.customer_name &&
                project.customer_name.toLowerCase().includes(searchTerm)) ||
                (project.project_location &&
                project.project_location.toLowerCase().includes(searchTerm));

            // Backend'den gelen 'display_status' ile filtreleme yap
            const matchesStatus = filterStatus === "" || 
                                (project.display_status && project.display_status.includes(filterStatus));


            const matchesFilters =
                (filterProjectName === "" ||
                (project.project_name &&
                    project.project_name.toLowerCase().includes(filterProjectName))) &&
                (filterRefNo === "" ||
                (project.reference_no &&
                    project.reference_no.toLowerCase().includes(filterRefNo))) &&
                (filterCustomer === "" ||
                (project.customer_name &&
                    project.customer_name.toLowerCase().includes(filterCustomer))) &&
                matchesStatus; // Yeni durum filtresi

            return matchesSearch && matchesFilters;
        });
        currentPage = 1; // Filtreler değiştiğinde ilk sayfaya dön
        renderProjectsTable(filteredProjects);
    }

    function uint8ToBase64(uint8) {
        let CHUNK_SIZE = 0x8000; // 32KB
        let index = 0;
        let length = uint8.length;
        let result = '';
        let slice;
        while (index < length) {
            slice = uint8.subarray(index, Math.min(index + CHUNK_SIZE, length));
            result += String.fromCharCode.apply(null, slice);
            index += CHUNK_SIZE;
        }
        return btoa(result);
    }

    function getCurrentUserRole() {
        // currentUser global olarak set edildiği için doğrudan ona erişebiliriz
        return currentUser ? currentUser.role : null;
    }

    // Bildirimleri çekme ve gösterme fonksiyonu (yeni_musteri.html'den kopyalandı)
    async function fetchAndRenderNotifications() {
        const notificationList = document.getElementById('notificationList');
        const notificationButton = document.getElementById('notificationButton');

        if (!currentUser || !currentUser.id) {
            if (notificationList) notificationList.innerHTML = '<p class="no-notifications">Bildirimleri görmek için giriş yapın.</p>';
            if (notificationButton) {
                notificationButton.setAttribute('data-count', '0');
                notificationButton.classList.remove('has-notifications');
            }
            return;
        }

        try {
            const response = await fetch(`${API_BASE_URL}/api/notifications?user_id=${currentUser.id}`);
            if (!response.ok) throw new Error('Bildirimler çekilemedi.');
            const notifications = await response.json();
            
            if (notificationList) notificationList.innerHTML = ''; // Listeyi temizle
            if (notifications.length === 0) {
                if (notificationList) notificationList.innerHTML = '<p class="no-notifications">Henüz bildirim yok.</p>';
                if (notificationButton) {
                    notificationButton.setAttribute('data-count', '0');
                    notificationButton.classList.remove('has-notifications');
                }
                return;
            }

            let unreadCount = 0;
            notifications.forEach(notification => {
                if (!notification.is_read) {
                    unreadCount++;
                }
                const notificationItem = document.createElement('div');
                notificationItem.className = `notification-item ${notification.is_read ? '' : 'unread'}`;
                notificationItem.dataset.id = notification.id;
                notificationItem.innerHTML = `
                    <div class="notification-item-icon">
                        <i class="${notification.icon || 'fas fa-info-circle'}"></i>
                    </div>
                    <div class="notification-item-content">
                        <div class="notification-item-title">${notification.title}</div>
                        <div class="notification-item-description">${notification.message}</div>
                        <div class="notification-item-time">${new Date(notification.timestamp).toLocaleString('tr-TR')}</div>
                    </div>
                    <div class="notification-item-actions">
                        <button class="delete-notification-btn" data-id="${notification.id}">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
                notificationItem.querySelector('.notification-item-content').addEventListener('click', (e) => {
                    e.stopPropagation(); // İçerik tıklaması silme butonuna yayılmasın
                    markNotificationAsRead(notification.id);
                });
                notificationItem.querySelector('.delete-notification-btn').addEventListener('click', (e) => {
                    e.stopPropagation(); // Silme butonu tıklaması öğeye yayılmasın
                    deleteNotification(notification.id);
                });
                if (notificationList) notificationList.appendChild(notificationItem);
            });
            if (notificationButton) {
                notificationButton.setAttribute('data-count', unreadCount);
                if (unreadCount > 0) {
                    notificationButton.classList.add('has-notifications');
                } else {
                    notificationButton.classList.remove('has-notifications');
                }
            }

        } catch (error) {
            console.error('Bildirimleri çekerken hata:', error);
            if (notificationList) notificationList.innerHTML = '<p class="no-notifications" style="color: var(--danger);">Bildirimler yüklenemedi.</p>';
        }
    }

    // Bildirimi okundu olarak işaretle
    async function markNotificationAsRead(notificationId) {
        try {
            const response = await fetch(`${API_BASE_URL}/api/notifications/${notificationId}/read`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: currentUser.id })
            });
            if (!response.ok) throw new Error('Bildirim okundu olarak işaretlenemedi.');
            fetchAndRenderNotifications(); // Listeyi yenile
        } catch (error) {
            console.error('Bildirim okundu hatası:', error);
            showToast('Bildirim okundu olarak işaretlenemedi.', true);
        }
    }

    // Bildirimi sil
    async function deleteNotification(notificationId) {
        if (!currentUser || !currentUser.id) {
            showToast('Kullanıcı oturumu bulunamadı.', true);
            return;
        }
        showConfirmationModal('Bildirimi Sil', 'Bu bildirimi silmek istediğinizden emin misiniz?', async () => {
            try {
                const response = await fetch(`${API_BASE_URL}/api/notifications/${notificationId}?user_id=${currentUser.id}`, {
                    method: 'DELETE'
                });
                if (!response.ok) throw new Error('Bildirim silinemedi.');
                showToast('Bildirim başarıyla silindi.', false);
                fetchAndRenderNotifications(); // Listeyi yenile
            } catch (error) {
                console.error('Bildirim silme hatası:', error);
                showToast('Bildirim silinirken hata oluştu.', true);
            }
        });
    }


    async function fetchUnreadNotificationCount() {
        const notificationButton = document.getElementById('notificationButton');
        try {
            let userId = currentUser ? currentUser.id : null;

            if (!userId) {
                console.warn('Kullanıcı ID bulunamadı. Okunmamış bildirim sayısı çekilemiyor.');
                notificationButton.setAttribute('data-count', '0');
                notificationButton.classList.remove('has-notifications');
                return;
            }

            const response = await fetch(`${API_BASE_URL}/api/notifications/unread-count?user_id=${userId}`);
            if (!response.ok) {
                if (response.status === 404) {
                    console.warn('API endpoint not found: /api/notifications/unread-count. Setting notification count to 0.');
                    notificationButton.setAttribute('data-count', '0');
                    notificationButton.classList.remove('has-notifications');
                    return;
                }
                const errorText = await response.text();
                throw new Error(`Okunmamış bildirim sayısı çekilemedi. Sunucu yanıtı: ${response.status} - ${errorText.substring(0, 100)}...`);
            }
            const data = await response.json();
            const unreadCount = data.unread_count;

            notificationButton.setAttribute('data-count', unreadCount);
            if (unreadCount > 0) {
                notificationButton.classList.add('has-notifications');
            } else {
                notificationButton.classList.remove('has-notifications');
            }
        } catch (error) {
            console.error('Okunmamış bildirim sayısı çekilemedi:', error);
            notificationButton.setAttribute('data-count', '!');
            showToast(`Bildirim sayısı yüklenirken hata oluştu: ${error.message}`, true);
        }
    }

    async function checkPermission(permissionKey) {
        const role = getCurrentUserRole();
        if (!role) {
            showToast('Kullanıcı rolü bulunamadı. Lütfen tekrar giriş yapın.', true);
            setTimeout(() => { window.location.href = 'index.html'; }, 1500);
            return false;
        }
        try {
            const response = await fetch(`${API_BASE_URL}/api/role-permissions?role=${encodeURIComponent(role)}`);
            if (!response.ok) throw new Error('Yetki sorgusu başarısız');
            const perms = await response.json();
            const permission = Array.isArray(perms) ? perms[0] : perms; // API'den dönen yapıya göre ayarlayın
            if (permission[permissionKey] != 1) { // Yetkinin 1 olması gerekiyor
                let msg = 'Bu işlem için yetkiniz yok!';
                if (permissionKey === 'proje_duzenle') msg = 'Proje düzenleme yetkiniz yok!';
                else if (permissionKey === 'proje_sil') msg = 'Proje silme yetkiniz yok!';
                else if (permissionKey === 'pdf_olusturma') msg = 'PDF oluşturma yetkiniz yok!';
                showToast(msg, true);
                return false;
            }
            return true;
        } catch (error) {
            console.error('Yetki sorgusu sırasında hata oluştu:', error);
            showToast('Yetki sorgusu sırasında hata oluştu. Lütfen tekrar deneyin.', true);
            setTimeout(() => { window.location.href = 'index.html'; }, 1500);
            return false;
        }
    }

    // Yeni eklenen fonksiyon: Yetkilere göre butonların görünürlüğünü ayarlar
    function updateButtonPermissions() {
        // Bu fonksiyon, index.html'deki butonları hedef almalı
        // Örnek:
        // const addProjectBtn = document.getElementById('addProjectBtn'); // Eğer böyle bir buton varsa
        // if (addProjectBtn) {
        //     if (userPermissions && userPermissions.proje_ekle === 1) {
        //         addProjectBtn.style.display = 'block';
        //     } else {
        //         addProjectBtn.style.display = 'none';
        //     }
        // }
        // index.html'de spesifik buton ID'leri olmadığı için bu fonksiyon şimdilik genel bir yapıya sahip.
        // Eğer dashboard'da yetkiye göre gizlenmesi/gösterilmesi gereken butonlar varsa,
        // onların ID'lerini buraya ekleyip kontrol edebilirsiniz.
        console.log("updateButtonPermissions called. User permissions:", userPermissions);
    }

    // Eksik olan updateStatsAndChart fonksiyonu eklendi ve güncellendi
    function updateStatsAndChart(projects) {
        // İstatistikleri güncelle
        let active = 0, completed = 0, delayed = 0, total = 0, planning = 0;
        projects.forEach(p => {
            // Backend'den gelen 'status' alanını kullanarak sayım yap
            if (p.status === 'Aktif') {
                active++;
            } else if (p.status === 'Tamamlandı') {
                completed++;
            } else if (p.status === 'Gecikti') {
                delayed++;
            } else if (p.status === 'Planlama Aşamasında') {
                planning++;
            }
            total++;

            // İş gidişatındaki gecikmeleri de 'delayed' kategorisine dahil et
            // Eğer projenin ana durumu 'Tamamlandı' değilse ve toplam gecikme günü varsa
            if (p.status !== 'Tamamlandı' && p.total_delay_days > 0) {
                // Eğer projenin ana durumu zaten 'Gecikti' değilse, tekrar saymamak için
                if (p.status !== 'Gecikti') {
                    // Bu kısım, projenin kendisi "Gecikti" olarak işaretlenmemiş olsa bile,
                    // iş gidişatındaki gecikmeler nedeniyle "Geciken Projeler" sayısına eklenmesini sağlar.
                    // Ancak bu, grafik dilimlerinin toplamının %100'ü geçmesine neden olabilir.
                    // Daha doğru bir yaklaşım için, 'display_status' alanını kullanabiliriz.
                    // Veya gecikmeli durumları ayrı bir kategori olarak ele alabiliriz.
                    // Şimdilik, 'display_status' içinde 'Gecikmeli' geçenleri sayalım.
                }
            }
        });

        // 'display_status' alanına göre gecikmeli proje sayısını yeniden hesaplayalım
        // Bu, hem "Gecikti" hem de "Aktif (İş Gecikmeli)" gibi durumları kapsayacaktır.
        delayed = projects.filter(p => p.display_status && p.display_status.includes('Gecikmeli')).length;


        document.getElementById('activeProjects').textContent = active;
        document.getElementById('completedProjects').textContent = completed;
        document.getElementById('delayedProjects').textContent = delayed;
        document.getElementById('totalProjects').textContent = total;
        updateChart({
            active: active,
            planning: planning,
            completed: completed,
            delayed: delayed
        });
    }

    // Grafik Güncelleme Fonksiyonu
    function updateChart(stats) {
        const ctx = document.getElementById('projectChart').getContext('2d');
        
        if (projectChartInstance) {
            projectChartInstance.destroy(); 
        }
        
        // Tema kontrolü
        const isDark = document.body.getAttribute('data-theme') === 'dark';
        const legendColor = isDark ? '#fff' : '#222';

        const chartColors = [
            '#2ed573',   // Aktif - Yeşil
            '#ff4757',   // Gecikmeli - Kırmızı
            '#ffc107',   // Planlama - Sarı
            '#0980d3'    // Tamamlandı - Mavi
        ];

        const dataArr = [
            stats.active,
            stats.delayed,
            stats.planning,
            stats.completed
        ];
        const labels = ['Aktif', 'Gecikmeli', 'Planlama', 'Tamamlandı'];
        
        // Eğer tümü 0 ise, en azından bir dilim 1 olsun ki grafik gözüksün
        const allZero = dataArr.every(v => v === 0);
        if (allZero) dataArr[0] = 1; // Aktif projeler 0 ise bile 1 göster

        projectChartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: dataArr,
                    backgroundColor: chartColors, 
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            color: legendColor
                        }
                    },
                    tooltip: {
                        bodyColor: legendColor,
                        titleColor: legendColor,
                        backgroundColor: isDark ? '#222' : '#fff',
                    }
                }
            }
        });
    }
</script>
    <script src="static/bildirim.js"></script>
    <script src="static/user-avatar.js"></script>
  </body>
</html>
