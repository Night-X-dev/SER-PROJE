<!DOCTYPE html>
<html lang="tr">
    <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ser Elektrik Otomasyon - Projeler</title>
    <link
      rel="stylesheet"
      href="[https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css](https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css)"
    />
    <script src="[https://cdn.jsdelivr.net/npm/chart.js](https://cdn.jsdelivr.net/npm/chart.js)"></script>
    <script src="[https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js](https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js)"></script>
    <script src="[https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js](https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js)"></script>
    <script src="[https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js](https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js)"></script>
    <script src="[https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js](https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js)"></script>
    <script src="[https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js](https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js)"></script>
    <style>
      :root {
        --primary: #005c9d;
        --primary-light: #0980d3;
        --white: #ffffff;
        --light-gray: #97a1aa;
        --dark-gray: #5e6870;
        --bg-color: #f8f9fa;
        --card-bg: #ffffff;
        --text-color: #333333;
        --input-bg: #f0f4f8;
        --border-color: #e1e5e9;
        --sidebar-bg: #ffffff;
        --topbar-bg: #ffffff;
        --success: #2ed573;
        --danger: #ff4757;
        --warning: #ffc107;
        --info: #0980d3;
        --primary-light-bg: rgba(9, 128, 211, 0.1); /* Yeni: Hafif birincil renk arka planı */
      }

      [data-theme="dark"] {
        --bg-color: #121212;
        --card-bg: #1e1e1e;
        --text-color: #e0e0e0;
        --input-bg: #2d2d2d;
        --border-color: #3a3a3a;
        --sidebar-bg: #1a1a1a;
        --topbar-bg: #1a1a1a;
        --primary-light-bg: rgba(9, 128, 211, 0.2); /* Koyu tema için hafif birincil renk arka planı */
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        transition: background-color 0.3s, color 0.3s;
      }

      body {
        background-color: var(--bg-color);
        color: var(--text-color);
        display: flex;
        min-height: 100vh;
        overflow-x: hidden;
      }

      /* Hamburger menü butonu */
      .hamburger-menu {
          display: none; /* Varsayılan olarak gizli */
          background-color: var(--primary);
          color: var(--white);
          border: none;
          border-radius: 8px;
          padding: 10px 12px;
          cursor: pointer;
          font-size: 20px;
          box-shadow: 0 2px 10px rgba(0,0,0,0.2);
          margin-right: 15px; /* Sağında boşluk bırak */
          flex-shrink: 0; /* Küçülmesini engelle */
      }

      .sidebar {
        width: 260px;
        background-color: var(--sidebar-bg);
        border-right: 1px solid var(--border-color);
        height: 100vh;
        position: fixed;
        overflow-y: auto;
        padding: 20px 0;
        z-index: 1000;
        transform: translateX(0); /* Masaüstünde görünür */
        transition: transform 0.3s ease-in-out;
      }

      .sidebar.show { /* Mobil görünümde açıldığında */
          transform: translateX(0);
      }
      .sidebar.hidden { /* Mobil görünümde gizli */
          transform: translateX(-100%);
      }

      .logo-container {
        display: flex;
        align-items: center;
        padding: 0 20px 25px 20px;
        border-bottom: 1px solid var(--border-color);
        margin-bottom: 25px;
      }

      .logo-icon {
        background: linear-gradient(135deg, var(--primary), var(--primary-light));
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--white);
        font-size: 20px;
        margin-right: 12px;
      }

      .logo-text {
        font-size: 20px;
        font-weight: 700;
        color: var(--primary);
      }

      .nav-item {
        padding: 12px 25px;
        display: flex;
        align-items: center;
        color: var(--text-color);
        text-decoration: none;
        border-left: 3px solid transparent;
        margin-bottom: 5px;
        transition: all 0.2s;
      }

      .nav-item:hover,
      .nav-item.active {
        background-color: rgba(9, 128, 211, 0.1);
        border-left-color: var(--primary-light);
        color: var(--primary-light);
      }

      .nav-item i {
        font-size: 18px;
        margin-right: 15px;
        width: 24px;
        text-align: center;
      }

      .main-content {
        flex: 1;
        margin-left: 260px; /* Sidebar genişliği kadar boşluk */
        transition: margin-left 0.3s ease-in-out;
        width: calc(100% - 260px); /* Kalan genişliği kapla */
      }
      .main-content.expanded {
          margin-left: 0; /* Sidebar gizlendiğinde boşluk sıfırla */
          width: 100%;
      }

      .topbar {
        background-color: var(--topbar-bg);
        border-bottom: 1px solid var(--border-color);
        padding: 15px 30px; /* Takvim.html ile aynı padding */
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: sticky;
        top: 0;
        z-index: 100;
        flex-wrap: nowrap; /* Masaüstünde sarmalamayı engelle */
        gap: 15px; /* Öğeler arası boşluk */
      }

      .search-container {
        position: relative;
        width: 300px; /* Takvim.html ile aynı genişlik */
        flex-grow: 1; /* Esnek genişlik */
        margin-right: 15px; /* Takvim.html ile aynı margin */
      }

      .search-container input {
        width: 100%;
        padding: 10px 15px 10px 40px;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        background-color: var(--input-bg);
        color: var(--text-color);
        font-size: 14px; /* Takvim.html ile aynı font-size */
      }

      .search-container i {
        position: absolute;
        left: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--light-gray);
        font-size: 16px; /* Takvim.html ile aynı font-size */
      }

      .topbar-actions {
        display: flex;
        align-items: center;
        gap: 20px; /* Takvim.html ile aynı gap */
        margin-left: auto; /* Masaüstünde sağa it */
        flex-shrink: 0; /* Küçülmesini engelle */
      }

      .notification-btn,
      .theme-toggle {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: var(--input-bg);
        color: var(--text-color);
        cursor: pointer;
        position: relative;
        flex-shrink: 0;
        font-size: 18px; /* Takvim.html ile aynı font-size */
      }

      /* Bildirim sayacı stilleri */
      .notification-btn::after {
          content: attr(data-count); /* JS ile dinamik olarak güncellenecek */
          position: absolute;
          top: 5px;
          right: 5px;
          background-color: #ff4757;
          color: white;
          font-size: 10px;
          width: 16px;
          height: 16px;
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          opacity: 0; /* Başlangıçta gizli */
          transform: scale(0);
          transition: all 0.2s ease-out;
      }
      .notification-btn.has-notifications::after {
          opacity: 1;
          transform: scale(1);
      }

      .user-profile {
        display: flex;
        align-items: center;
        gap: 12px;
        cursor: pointer;
        flex-shrink: 0;
      }

      .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--primary), var(--primary-light));
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--white);
        font-weight: 600;
        font-size: 16px; /* Takvim.html ile aynı font-size */
      }

      .user-info {
        display: flex;
        flex-direction: column;
      }

      .user-name {
        font-weight: 600;
        font-size: 15px;
      }

      .user-role {
        font-size: 13px;
        color: var(--light-gray);
      }

      /* Tek Çıkış Butonu Stilleri */
      .logout-btn {
          display: flex; /* Varsayılan olarak masaüstünde görünür */
          align-items: center;
          justify-content: center;
          padding: 10px 20px; /* Takvim.html ile aynı padding */
          border-radius: 10px;
          font-size: 15px;
          font-weight: 600;
          gap: 8px;
          transition: all 0.3s ease;
          background: transparent;
          border: 1px solid var(--primary-light);
          color: var(--primary-light);
          margin-left: 10px; /* Masaüstünde sağa boşluk */
      }

      .logout-btn:hover {
          background-color: var(--primary); /* Takvim.html'deki gibi hover rengi */
          color: var(--white); /* Takvim.html'deki gibi yazı rengi */
          transform: translateY(-2px);
          box-shadow: 0 6px 20px rgba(0,0,0,0.2); /* Takvim.html'deki gibi gölge */
      }

      .projects-content {
        padding: 30px;
      }

      .page-title {
        font-size: 28px;
        margin-bottom: 25px;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .page-title i {
        color: var(--primary-light);
      }

      .filters-container {
        background-color: var(--card-bg);
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        padding: 20px;
        margin-bottom: 30px;
        display: none;
      }

      .filters-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
      }

      .filter-title {
        font-weight: 600;
        font-size: 18px;
      }

      .filter-reset {
        color: var(--primary-light);
        font-size: 14px;
        cursor: pointer;
      }

      .filter-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
      }

      .filter-group {
        margin-bottom: 15px;
      }

      .filter-label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: var(--text-color);
      }

      .filter-input {
        width: 100%;
        padding: 10px 15px;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        background-color: var(--input-bg);
        color: var(--text-color);
        font-size: 14px;
      }

      .projects-container {
        background-color: var(--card-bg);
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        overflow: hidden;
        margin-bottom: 30px;
      }

      .projects-header {
        padding: 15px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid var(--border-color);
        flex-wrap: wrap; /* Mobil görünümde alt alta gelmesi için */
        gap: 15px; /* Öğeler arası boşluk */
      }

      .projects-actions {
        display: flex;
        gap: 15px;
        flex-wrap: wrap; /* Mobil görünümde alt alta gelmesi için */
        justify-content: flex-end; /* Sağ tarafa hizala */
      }

      .btn {
        padding: 8px 15px;
        border-radius: 8px;
        border: none;
        background: linear-gradient(to right, var(--primary), var(--primary-light));
        color: var(--white);
        font-weight: 500;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.2s;
      }

      .btn-outline {
        background: transparent;
        border: 1px solid var(--primary-light);
        color: var(--primary-light);
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(9, 128, 211, 0.3);
      }

      /* Genel buton stilini biraz iyileştirebiliriz */
      .btn, .modal-btn {
          padding: 10px 20px; /* Buton padding'ini artır */
          border-radius: 10px; /* Daha yuvarlak köşeler */
          font-size: 15px; /* Yazı boyutunu biraz büyüt */
          font-weight: 600; /* Daha belirgin yazı */
          display: inline-flex; /* İçerik sığmasa bile düzgün hizalama */
          align-items: center;
          justify-content: center;
          gap: 8px; /* İkon ve yazı arası boşluk */
          transition: all 0.3s ease; /* Daha yumuşak geçişler */
      }

      /* Aksiyon butonları (tablo içindeki küçük butonlar) */
      .action-btn {
          width: auto; /* Genişliği içeriğe göre ayarla */
          min-width: 38px; /* Minimum genişlik */
          height: 38px; /* Yüksekliği artır */
          padding: 0 10px; /* Yatay padding ekle */
          border-radius: 10px; /* Daha yuvarlak */
          font-size: 16px; /* İkon boyutunu büyüt */
          display: inline-flex;
          align-items: center;
          justify-content: center;
          transition: all 0.2s ease-in-out;
          background-color: var(--input-bg); /* Hafif arkaplan */
          color: var(--text-color);
          border: 1px solid var(--border-color); /* Hafif border */
          box-shadow: 0 2px 5px rgba(0,0,0,0.05);
          cursor: pointer;
      }

      .action-btn:hover {
          background-color: var(--primary-light); /* Hover'da daha belirgin renk */
          color: var(--white); /* Yazı rengi beyaz olsun */
          box-shadow: 0 4px 12px rgba(9, 128, 211, 0.2); /* Daha belirgin gölge */
          transform: translateY(-1px) scale(1.02); /* Hafif kalkma efekti */
          border-color: var(--primary-light);
      }

      /* Progress actions içindeki butonlar (Kaydet/Sil) */
      .progress-actions .action-btn {
          min-width: 80px; /* "Kaydet" ve "Sil" gibi butonlar için daha fazla alan */
          height: 38px; /* Yüksekliği koru */
          font-size: 14px; /* Yazı boyutu */
          font-weight: 500;
          gap: 5px; /* İkon ve yazı arası boşluk */
      }

      .progress-actions .save-progress-btn {
          background: linear-gradient(to right, var(--success), #28a745); /* Yeşil gradient */
          color: var(--white);
          border: none;
      }

      .progress-actions .save-progress-btn:hover {
          background: linear-gradient(to right, #28a745, #218838); /* Daha koyu yeşil */
          box-shadow: 0 4px 12px rgba(46, 213, 115, 0.3);
      }

      .progress-actions .delete-progress-btn {
          background-color: var(--danger); /* Direkt kırmızı arkaplan */
          color: var(--white);
          border: none;
      }

      .progress-actions .delete-progress-btn:hover {
          background-color: #dc3545; /* Daha koyu kırmızı */
          box-shadow: 0 4px 12px rgba(255, 71, 87, 0.3);
      }

      /* Modaldaki İptal butonu */
      .modal-btn-cancel {
          background-color: var(--light-gray); /* Gri arkaplan */
          color: var(--white);
          border: none;
      }

      .modal-btn-cancel:hover {
          background-color: var(--dark-gray);
          box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      }

      .table-container {
        overflow-x: auto;
      }
      .projects-table {
        width: 100%;
        border-collapse: collapse;
      }

      .projects-table th {
        text-align: left;
        padding: 15px 20px;
        background-color: rgba(9, 128, 211, 0.05);
        color: var(--light-gray);
        font-weight: 500;
        border-bottom: 1px solid var(--border-color);
      }
      .projects-table td {
        padding: 15px 20px;
        border-bottom: 1px solid var(--border-color);
        vertical-align: middle;
        color: var(--text-color); /* Metin rengini temaya göre ayarla */
      }
      .projects-table tr {
        transition: background-color 0.2s;
      }
      .projects-table tr:hover {
        background-color: rgba(9, 128, 211, 0.05);
      }
      .status-badge {
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 500;
        display: inline-block;
      }
      .status-Aktif {
        background-color: rgba(46, 213, 115, 0.1);
        color: #2ed573;
      }
      .status-Tamamlandı {
        background-color: rgba(9, 128, 211, 0.1);
        color: var(--primary-light);
      }
      .status-Gecikti {
        background-color: rgba(255, 71, 87, 0.1);
        color: #ff4757;
      }
      .status-Planlama-Aşamasında {
        background-color: rgba(255, 193, 7, 0.1);
        color: #ffc107;
      }
      .status-Aktif-İş-Gecikmeli {
        background-color: rgba(46, 213, 115, 0.1);
        color: rgb(0, 181, 57);
        border: 1px dashed rgb(255, 0, 0);
      }
      .status-Planlama-İş-Gecikmeli {
        background-color: rgba(255, 193, 7, 0.15);
        color: darkgoldenrod;
        border: 1px dashed darkgoldenrod;
      }
      /* Modal CSS - Genel Modal Stilleri */
      .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 2000;
        overflow-y: auto;
      }
      .modal-content {
        background: var(--card-bg);
        padding: 30px;
        border-radius: 12px;
        width: 800px;
        max-width: 95%; /* Mobil uyumluluk için */
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        overflow-y: auto;
        max-height: 90vh;
        margin: auto;
      }
      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid var(--border-color);
      }
      .modal-title {
        font-size: 24px;
        color: var(--primary);
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .modal-title i {
        color: var(--primary-light);
      }
      .close-modal-btn {
        background: none;
        border: none;
        font-size: 28px;
        cursor: pointer;
        color: var(--light-gray);
      }
      .form-group {
        margin-bottom: 20px;
      }
      .form-label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: var(--text-color);
      }
      .form-input {
        width: 100%;
        padding: 10px 15px;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        background-color: var(--input-bg);
        color: var(--text-color);
        font-size: 14px;
      }
      .form-textarea {
        width: 100%;
        padding: 10px 15px;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        background-color: var(--input-bg);
        color: var(--text-color);
        font-size: 14px;
        min-height: 80px;
        resize: vertical;
      }
      .form-actions {
        display: flex;
        justify-content: flex-end;
        gap: 15px;
        margin-top: 30px;
      }

      /* Pagination Styles */
      .pagination {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 15px 20px;
          border-top: 1px solid var(--border-color);
          background-color: var(--card-bg);
          flex-wrap: wrap; /* Mobil uyumluluk için */
          gap: 10px; /* Öğeler arası boşluk */
      }

      .pagination-info {
          font-size: 14px;
          color: var(--dark-gray);
      }

      .pagination-controls {
          display: flex;
          align-items: center;
          gap: 5px; /* Butonlar arası boşluk */
      }

      /* Sayfa numaralarının bulunduğu div */
      #pageNumbers {
          display: flex; /* Sayfa numaralarını yatay sırala */
          gap: 5px; /* Sayfa numaraları arası boşluk */
      }

      .page-btn {
          background-color: var(--input-bg);
          color: var(--text-color);
          border: 1px solid var(--border-color);
          padding: 8px 12px;
          border-radius: 8px;
          cursor: pointer;
          font-size: 14px;
          min-width: 38px; /* Ok butonları için minimum genişlik */
          display: flex;
          justify-content: center;
          align-items: center;
          transition: all 0.2s ease;
      }

      .page-btn:hover:not(:disabled) {
          background-color: var(--primary-light);
          color: var(--white);
          border-color: var(--primary-light);
      }

      .page-btn.active {
          background-color: var(--primary);
          color: var(--white);
          border-color: var(--primary);
          font-weight: bold;
      }

      .page-btn:disabled {
          opacity: 0.5;
          cursor: not-allowed;
      }

      /* Responsive tasarım iyileştirmeleri */
      @media (max-width: 992px) {
          .sidebar {
              width: 260px; /* Mobil görünümde açıkken genişlik */
              position: fixed; /* Mobil görünümde sabit */
              transform: translateX(-100%); /* Varsayılan olarak gizli */
              box-shadow: 0 0 20px rgba(0,0,0,0.3);
          }
          .sidebar.show {
              transform: translateX(0); /* Açıldığında görünür */
          }
          .logo-text, .nav-text {
              display: block; /* Mobil menü açıkken görünür */
          }
          .logo-container {
              justify-content: flex-start;
              padding: 0 20px 25px 20px;
          }
          .logo-icon {
              margin-right: 12px;
          }
          .nav-item {
              justify-content: flex-start;
              padding: 12px 25px;
          }
          .nav-item i {
              margin-right: 15px;
          }
          .main-content {
              margin-left: 0; /* Mobil görünümde boşluk yok */
              width: 100%;
          }
          .hamburger-menu {
              display: block; /* Hamburger menüyü göster */
              order: 1; /* Diğer öğelerin önüne al */
              margin-right: 10px;
          }
          .topbar {
              padding: 15px; /* Daha küçük padding */
              flex-wrap: wrap; /* Mobil görünümde sarmala */
              justify-content: flex-start; /* Sola hizala */
              gap: 10px;
          }
          .search-container {
              order: 2;
              flex-grow: 1;
              margin-right: 0; /* Sağa boşluğu kaldır */
          }
          .topbar-actions {
              order: 3;
              margin-left: 0; /* Sağa itmeyi kaldır */
              width: 100%; /* Tam genişlik kapla */
              justify-content: flex-end; /* Sağ tarafa hizala */
          }
          .logout-btn {
              display: none; /* Mobil görünümde çıkış butonunu gizle (isteğe bağlı) */
          }
          .filter-row {
              grid-template-columns: 1fr; /* Mobil görünümde tek sütun */
          }
          .projects-actions {
              width: 100%;
              justify-content: center; /* Butonları ortaya hizala */
          }
      }

      @media (max-width: 768px) {
          .projects-header {
              flex-direction: column;
              align-items: flex-start;
          }
          .projects-actions {
              width: 100%;
              justify-content: center;
          }
          .modal-content {
              padding: 20px;
          }
          .modal-title {
              font-size: 20px;
          }
          .close-modal-btn {
              font-size: 24px;
          }
          .filter-row {
              grid-template-columns: 1fr;
          }
          .pagination {
              flex-direction: column;
              align-items: center;
          }
          .pagination-controls {
              margin-top: 10px;
              justify-content: center;
          }
      }

      /* Bildirim Paneli Stilleri */
      .notification-panel {
        position: fixed; /* Düzeltme: absolute yerine fixed */
        top: 70px; /* Topbar yüksekliğine göre ayarlanabilir */
        right: 30px;
        width: 350px;
        max-width: 95vw;
        max-height: 450px;
        background-color: var(--card-bg);
        border-radius: 12px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        border: 1px solid var(--border-color);
        z-index: 20000;
        display: none; /* Varsayılan olarak gizli */
        flex-direction: column;
        overflow: hidden;
        opacity: 0;
        transform: translateY(-10px);
        transition: opacity 0.3s ease, transform 0.3s ease;
      }
      /* Animasyon keyframes */
      @keyframes fadeInNotif {
        from { opacity: 0; transform: translateY(-20px); }
        to { opacity: 1; transform: translateY(0); }
      }
      .notification-panel.show {
        display: flex;
        opacity: 1;
        transform: translateY(0);
        animation: fadeInNotif 0.2s forwards; /* Animasyonu uygula */
      }

      .notification-panel-header {
          padding: 15px 20px;
          border-bottom: 1px solid var(--border-color);
          display: flex;
          justify-content: space-between;
          align-items: center;
          font-weight: 600;
          color: var(--text-color);
      }

      .notification-panel-header .close-btn {
          background: none;
          border: none;
          font-size: 20px;
          color: var(--light-gray);
          cursor: pointer;
          transition: color 0.2s;
      }

      .notification-panel-header .close-btn:hover {
          color: var(--primary);
      }

      .notification-list {
          flex-grow: 1;
          overflow-y: auto;
          padding: 10px 0;
      }

      .notification-item {
          display: flex;
          align-items: flex-start;
          padding: 12px 20px;
          border-bottom: 1px solid var(--border-color);
          cursor: pointer;
          transition: background-color 0.2s;
      }

      .notification-item:last-child {
          border-bottom: none;
      }

      .notification-item:hover {
          background-color: rgba(9, 128, 211, 0.05);
      }

      /* Okunmamış bildirimler için arkaplan rengi ve sol kenarlık */
      .notification-item.unread {
          background-color: var(--primary-light-bg); /* Hafif birincil renk arka planı */
          border-left: 4px solid var(--primary); /* Sol tarafta renkli bir çizgi */
      }
      .notification-item.unread:hover {
          background-color: rgba(9, 128, 211, 0.2); /* Hover'da biraz daha koyu */
      }

      .notification-item-icon {
          width: 35px;
          height: 35px;
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          background-color: rgba(9, 128, 211, 0.1);
          color: var(--primary-light);
          font-size: 16px;
          margin-right: 12px;
          flex-shrink: 0;
      }
      /* Okunmamış bildirim ikonunun arka planı ve rengi */
      .notification-item.unread .notification-item-icon {
          background-color: var(--primary-light);
          color: var(--white);
      }

      .notification-item-content {
          flex-grow: 1;
      }

      .notification-item-title {
          font-weight: 600;
          font-size: 15px;
          margin-bottom: 4px;
          color: var(--text-color);
      }

      .notification-item-description {
          font-size: 13px;
          color: var(--light-gray);
          line-height: 1.4;
      }

      .notification-item-time {
          font-size: 11px;
          color: var(--light-gray);
          margin-top: 5px;
          text-align: right;
      }

      .notification-panel-footer {
          padding: 10px 20px;
          border-top: 1px solid var(--border-color);
          text-align: center;
          font-size: 14px;
          color: var(--light-gray);
          display: flex;
          justify-content: center;
          align-items: center;
      }
      /* "Tümünü Okundu Olarak İşaretle" butonu için minimalist stil */
      .notification-panel-footer button {
          width: auto; /* Genişliği içeriğe göre ayarla */
          padding: 5px 10px; /* Daha küçük padding */
          border-radius: 8px;
          border: 1px solid var(--primary-light); /* İnce kenarlık */
          background: transparent; /* Şeffaf arka plan */
          color: var(--primary-light); /* Yazı rengi */
          font-weight: 500;
          cursor: pointer;
          display: inline-flex; /* İçeriği ortalamak için */
          align-items: center;
          justify-content: center;
          gap: 5px; /* İkon ile yazı arası boşluk */
          transition: all 0.2s;
      }
      .notification-panel-footer button:hover {
          background-color: rgba(9, 128, 211, 0.1); /* Hover'da hafif arka plan */
          color: var(--primary); /* Hover'da daha koyu yazı rengi */
          transform: none; /* Transform efektini kaldır */
          box-shadow: none; /* Gölgeyi kaldır */
      }


      /* Boş bildirim durumu */
      .no-notifications {
          text-align: center;
          padding: 20px;
          color: var(--light-gray);
          font-size: 14px;
      }

      /* Mobil uyumluluk için bildirim paneli */
      @media (max-width: 576px) {
          .notification-panel {
              width: calc(100% - 40px); /* Ekran genişliğine göre ayarla */
              right: 20px;
              left: 20px;
              top: 70px; /* Topbar'ın altına gelmesi için */
          }
      }

      /* Toast Bildirimi Stilleri */
      .toast {
          position: fixed;
          top: 20px;
          right: 20px;
          background-color: var(--success);
          color: var(--white);
          padding: 12px 20px;
          border-radius: 8px;
          box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
          display: flex;
          align-items: center;
          gap: 10px;
          opacity: 0; /* Başlangıçta gizli */
          visibility: hidden; /* Başlangıçta gizli */
          transform: translateY(-20px);
          transition: opacity 0.3s ease, transform 0.3s ease, visibility 0.3s ease;
          z-index: 20001; /* Bildirim panelinden daha yüksek olsun */
      }

      .toast.show {
          opacity: 1;
          visibility: visible;
          transform: translateY(0);
      }

      .toast.error {
          background-color: var(--danger);
      }

      .toast i {
          font-size: 18px;
      }
    </style>
  </head>
  <body data-theme="light">
    <!-- Confirmation Modal -->
    <div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-sm modal-dialog-centered"> <!-- modal-dialog-centered eklendi -->
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmationModalLabel">Onay Gerekli</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="confirmationMessage">
                    Emin misiniz?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                    <button type="button" class="btn btn-primary" id="confirmActionBtn">Onayla</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Proje Detay/Düzenleme Modalı -->
    <div id="projectModal" class="modal">
      <div class="modal-content" id="projectModalContent">
        <div class="modal-header">
          <h2 class="modal-title" id="modalTitle">
            <i class="fas fa-info-circle"></i> Proje Detayları
          </h2>
          <button class="close-modal-btn" id="closeModalBtn">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div id="modalBody">
          <p>Yükleniyor...</p>
        </div>
        <div class="form-actions" id="modalActions">
          <button class="modal-btn modal-btn-cancel" id="cancelModalBtn">
            Kapat
          </button>
        </div>
      </div>
    </div>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
      <a href="index.html" style="text-decoration: none;">
        <div class="logo-container" style="cursor: pointer;">
          <img src="{{ url_for('static', filename='serlogo.png') }}" alt="Ser Elektrik Otomasyon" style="width: 180px; height: auto; padding-left: 10px;">
        </div>
      </a>
      

      <a href="index.html" class="nav-item">
        <i class="fas fa-home"></i>
        <span class="nav-text">Dashboard</span>
      </a>
      <a href="projeler.html" class="nav-item active">
        <i class="fas fa-project-diagram"></i>
        <span class="nav-text">Projeler</span>
      </a>
      <a href="proje_ekle.html" class="nav-item">
        <i class="fas fa-plus-circle"></i>
        <span class="nav-text">Yeni Proje</span>
      </a>
      <a href="raporlar.html" class="nav-item">
        <i class="fas fa-chart-line"></i>
        <span class="nav-text">Raporlar</span>
      </a>
      <a href="musteriler.html" class="nav-item">
        <i class="fas fa-users"></i>
        <span class="nav-text">Müşteriler</span>
      </a>
      <a href="takvim.html" class="nav-item">
        <i class="fas fa-calendar-alt"></i>
        <span class="nav-text">Takvim</span>
      </a>
      <a href="ayarlar.html" class="nav-item">
        <i class="fas fa-cog"></i>
        <span class="nav-text">Ayarlar</span>
      </a>
    </div>

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
      <div class="topbar">
        <!-- Hamburger Menü Butonu -->
        <button class="hamburger-menu" id="hamburgerMenu">
            <i class="fas fa-bars"></i>
        </button>
        <div class="search-container">
          <i class="fas fa-search"></i>
          <input
            type="text"
            id="searchInput"
            placeholder="Proje, müşteri veya referans no ara..."
          />
        </div>

        <div class="topbar-actions">
          <div class="theme-toggle" id="theme-toggle">
            <i class="fas fa-moon"></i>
          </div>

         <div class="notification-btn" id="notificationButton" data-count="0">
             <i class="fas fa-bell"></i>
         </div>

          <div class="user-profile">
            <div class="user-avatar" id="userAvatar">MÖ</div>
            <div class="user-info">
              <div class="user-name" id="userName">Mustafa Öztürk</div>
              <div class="user-role" id="userRole">Veritabanı Yöneticisi</div>
            </div>
          </div>
          <!-- Tek Çıkış Yap Butonu -->
          <button
            class="btn btn-outline logout-btn"
            id="logoutButton"
          >
            <i class="fas fa-sign-out-alt"></i> <span class="logout-text">Çıkış Yap</span>
          </button>
        </div>
      </div>

      <!-- Bildirim Paneli (toggle ile açılır/kapanır) -->
      <div class="notification-panel" id="notificationPanel">
          <div class="notification-panel-header">
              <span>Bildirimler</span>
              <button class="close-btn" id="closeNotificationPanel"><i class="fas fa-times"></i></button>
          </div>
          <div class="notification-list" id="notificationList">
              <!-- Bildirimler buraya dinamik olarak yüklenecek -->
              <div class="no-notifications">Bildirimler yükleniyor...</div>
          </div>
          <div class="notification-panel-footer">
              <button id="markAllReadBtn">
                  <i class="fas fa-check-double"></i> Tümünü Okundu Olarak İşaretle
              </button>
          </div>
      </div>

      <div class="projects-content">
        <h1 class="page-title">
          <i class="fas fa-project-diagram"></i>
          Tüm Projeler
        </h1>

        <div class="filters-container" id="filtersContainer">
          <div class="filters-header">
            <div class="filter-title">Proje Filtreleri</div>
            <div class="filter-reset" id="resetFilters">Tümünü Sıfırla</div>
          </div>
          <div class="filter-row">
            <div class="filter-group">
              <label for="filterProjectName" class="filter-label"
                >Proje Adı</label
              >
              <input
                type="text"
                class="filter-input"
                id="filterProjectName"
                placeholder="Proje adı girin"
              />
            </div>
            <div class="filter-group">
              <label for="filterRefNo" class="filter-label">Referans No</label>
              <input
                type="text"
                class="filter-input"
                id="filterRefNo"
                placeholder="Referans no girin"
              />
            </div>
            <div class="filter-group">
              <label for="filterCustomer" class="filter-label">Müşteri</label>
              <input
                type="text"
                class="filter-input"
                id="filterCustomer"
                placeholder="Müşteri adı"
              />
            </div>
            <div class="filter-group">
              <label for="filterStatus" class="filter-label">Durum</label>
              <select class="filter-input" id="filterStatus">
                <option value="">Tümü</option>
                <option value="Aktif">Aktif</option>
                <option value="Tamamlandı">Tamamlandı</option>
                <option value="Gecikti">Gecikti</option>
                <option value="Planlama Aşamasında">Planlama Aşamasında</option>
                <option value="Aktif (İş Gecikmeli)">Aktif (İş Gecikmeli)</option>
                <option value="Planlama (İş Gecikmeli)">
                  Planlama (İş Gecikmeli)
                </option>
              </select>
            </div>
          </div>
        </div>

        <div class="projects-container">
          <div class="projects-header">
            <div class="card-title">Proje Listesi</div>
            <div class="projects-actions">
              <button class="btn btn-outline" id="filterBtn">
                <i class="fas fa-filter"></i> Filtrele
              </button>
              <button class="btn" id="exportAllPdf">
                <i class="fas fa-file-pdf"></i> Tümünü PDF Yap
              </button>
              <button class="btn" id="refreshData">
                <i class="fas fa-sync-alt"></i> Verileri Yenile
              </button>
            </div>
          </div>

          <div class="table-container">
            <table class="projects-table" id="projectsTable">
              <thead>
                <tr>
                  <th>Proje Adı</th>
                  <th>Referans No</th>
                  <th>Müşteri</th>
                  <th>Durum</th>
                  <th>Başlangıç</th>
                  <th>Bitiş</th>
                  <th>Toplam Gün</th>
                  <th>Geçen Gün</th>
                  <th>Gecikme Durumu</th>
                  <th>Yönetici</th>
                  <th>İşlemler</th>
                </tr>
              </thead>
              <tbody id="projectsTableBody">
                <tr>
                  <td colspan="11" style="text-align: center">
                    Projeler yükleniyor...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          
          <!-- Pagination -->
          <div class="pagination">
              <div class="pagination-info">Toplam <span id="totalProjectsCount">0</span> proje, sayfa <span id="currentPage">1</span>/<span id="totalPages">1</span></div>
              <div class="pagination-controls">
                  <button class="page-btn" id="prevPage"><i class="fas fa-chevron-left"></i></button>
                  <div id="pageNumbers">
                      <!-- Sayfa numaraları buraya JS ile eklenecek -->
                  </div>
                  <button class="page-btn" id="nextPage"><i class="fas fa-chevron-right"></i></button>
              </div>
          </div>
        </div>

        <div class="footer">
          &copy; 2025 Ser Elektrik Otomasyon. Tüm hakları saklıdır. | Mustafa Öztürk
        </div>
      </div>
    </div>

    <!-- Toast bildirimi HTML'i -->
    <div class="toast" id="toast">
      <i class="fas fa-check-circle"></i>
      <span id="toastMessage">İşlem başarıyla tamamlandı</span>
    </div>

    <script>
      const API_BASE_URL = "[https://ser-proje.onrender.com](https://ser-proje.onrender.com)";
      let currentUser = null;
      let allProjectsData = [];
      let filteredProjects = []; // Filtrelenmiş projeleri tutacak
      let currentPage = 1;
      let rowsPerPage = 10; // Masaüstü varsayılanı

      // Pagination elementleri
      const totalProjectsCountSpan = document.getElementById('totalProjectsCount');
      const currentPageSpan = document.getElementById('currentPage');
      const totalPagesSpan = document.getElementById('totalPages');
      const prevPageButton = document.getElementById('prevPage');
      const nextPageButton = document.getElementById('nextPage');
      const pageNumbersContainer = document.getElementById('pageNumbers');
      const confirmationModal = new bootstrap.Modal(document.getElementById('confirmationModal'));
      const confirmActionBtn = document.getElementById('confirmActionBtn');
      let currentConfirmAction = null;


      // --- Kullanıcı Oturum Kontrolü ve Tema ---
      document.addEventListener("DOMContentLoaded", function () {
        const userNameElement = document.getElementById("userName");
        const userRoleElement = document.getElementById("userRole");
        const userAvatarElement = document.getElementById("userAvatar");
        const logoutButton = document.getElementById("logoutButton");

        const storedUser = localStorage.getItem("currentUser");
        if (!storedUser) {
          showToast("Oturum süreniz doldu veya giriş yapmadınız. Lütfen giriş yapın.", true);
          setTimeout(() => {
              window.location.href = "login.html";
          }, 2000);
        } else {
          try {
            currentUser = JSON.parse(storedUser);
            updateUserInfo(currentUser);
          } catch (e) {
            console.error("Kayıtlı kullanıcı verisi bozuk:", e);
            localStorage.removeItem("currentUser");
            showToast("Kullanıcı verileriniz bozuk. Lütfen tekrar giriş yapın.", true);
            setTimeout(() => {
                window.location.href = "login.html";
            }, 2000);
          }
        }

        function updateUserInfo(user) {
          if (user) {
            userNameElement.textContent = user.fullname;
            userRoleElement.textContent = user.role;
            userAvatarElement.textContent = getInitials(user.fullname);
          }
        }

        function getInitials(fullname) {
          if (!fullname) return "";
          const parts = fullname.split(" ");
          if (parts.length === 1) {
            return parts[0].charAt(0).toUpperCase();
          } else if (parts.length >= 2) {
            return (
              parts[0].charAt(0) + parts[parts.length - 1].charAt(0)
            ).toUpperCase();
          }
          return "";
        }

        const themeToggle = document.getElementById("theme-toggle");
        const savedTheme = localStorage.getItem("theme");
        if (savedTheme) {
            document.body.setAttribute("data-theme", savedTheme);
            themeToggle.innerHTML =
                savedTheme === "dark"
                    ? '<i class="fas fa-sun"></i>'
                    : '<i class="fas fa-moon"></i>';
        }
        themeToggle.addEventListener("click", () => {
            const currentTheme = document.body.getAttribute("data-theme");
            const newTheme = currentTheme === "dark" ? "light" : "dark";
            document.body.setAttribute("data-theme", newTheme);
            themeToggle.innerHTML =
                newTheme === "dark"
                    ? '<i class="fas fa-sun"></i>'
                    : '<i class="fas fa-moon"></i>';
            localStorage.setItem("theme", newTheme);
        });

        const handleLogout = () => {
            localStorage.removeItem("currentUser");
            window.location.href = "login.html";
        };

        logoutButton.addEventListener("click", handleLogout);
        
        // Hamburger menü işlevselliği
        const hamburgerMenu = document.getElementById('hamburgerMenu');
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('mainContent');

        hamburgerMenu.addEventListener('click', () => {
            sidebar.classList.toggle('show');
            mainContent.classList.toggle('expanded');
        });

        // Sidebar dışına tıklayınca kapatma
        document.addEventListener('click', (event) => {
            if (sidebar.classList.contains('show') && 
                !sidebar.contains(event.target) && 
                !hamburgerMenu.contains(event.target)) {
                sidebar.classList.remove('show');
                mainContent.classList.remove('expanded');
            }
        });

        // Pencere boyutu değiştiğinde sidebar durumunu sıfırla (masaüstü için)
        window.addEventListener('resize', () => {
            if (window.innerWidth > 992) {
                sidebar.classList.remove('show');
                mainContent.classList.remove('expanded');
            }
            updateRowsPerPage(); // Ekran boyutuna göre sayfa başına satır sayısını güncelle
            applyFiltersAndRenderTable(); // Tabloyu yeniden render et
        });

        updateRowsPerPage(); // Sayfa yüklendiğinde başlangıç değeri ayarla

        // Bildirim Paneli İşlevselliği
        const notificationButton = document.getElementById('notificationButton');
        const notificationPanel = document.getElementById('notificationPanel');
        const closeNotificationPanel = document.getElementById('closeNotificationPanel');
        const markAllReadBtn = document.getElementById('markAllReadBtn');

        notificationButton.addEventListener('click', (event) => {
            event.stopPropagation(); // Butona tıklayınca panelin kapanmasını engelle
            notificationPanel.classList.toggle('show');
            if (notificationPanel.classList.contains('show')) {
                fetchNotifications(); // Panel açıldığında bildirimleri çek
            }
        });

        closeNotificationPanel.addEventListener('click', () => {
            notificationPanel.classList.remove('show');
        });

        // Panel dışına tıklayınca kapatma
        document.addEventListener('click', (event) => {
            if (notificationPanel.classList.contains('show') && 
                !notificationPanel.contains(event.target) && 
                !notificationButton.contains(event.target)) {
                notificationPanel.classList.remove('show');
            }
        });

        // "Tümünü Okundu Olarak İşaretle" butonu tıklama olayı
        markAllReadBtn.addEventListener('click', markAllNotificationsAsRead);
        fetchUnreadNotificationCount(); // Sayfa yüklendiğinde SADECE okunmamış sayısını çek
      });

      // --- Yardımcı Fonksiyonlar ---
      function showToast(message, isError = false) {
        const toast = document.getElementById("toast");
        const toastMessage = document.getElementById("toastMessage");

        toastMessage.textContent = message;
        toast.className = "toast show"; // Reset classes and add 'show'
        if (isError) {
          toast.classList.add("error");
        } else {
          toast.classList.remove("error");
        }

        // Set a timeout to hide the toast after 3 seconds
        setTimeout(() => {
          toast.classList.remove("show"); // Hide the toast
        }, 3000);
      }

      // Confirmation Modal'ı gösterme fonksiyonu
      function showConfirmationModal(message, actionCallback) {
          document.getElementById('confirmationMessage').innerHTML = message;
          currentConfirmAction = actionCallback;
          confirmationModal.show();
      }

      // Confirmation Modal'daki onay butonuna tıklama
      confirmActionBtn.addEventListener('click', () => {
          if (currentConfirmAction) {
              currentConfirmAction();
          }
          confirmationModal.hide();
      });

      // Tarih formatlama (DD.MM.YYYY)
      function formatDateForDisplay(dateStr) {
        if (!dateStr) return "";
        const parts = dateStr.split("-");
        if (parts.length === 3) {
          return `${parts[2]}.${parts[1]}.${parts[0]}`;
        }
        return dateStr;
      }

      // Tarih formatlama (YYYY-MM-DD) input için
      function formatDateForInput(dateStr) {
        if (!dateStr) return "";
        if (dateStr.includes(".")) {
          const parts = dateStr.split(".");
          return `${parts[2]}-${parts[1].padStart(2, "0")}-${parts[0].padStart(
            2,
            0
          )}`;
        }
        return dateStr;
      }

      // Durum rozeti ve renk sınıfı HTML'i döndürür
      function getStatusBadgeHtml(status) {
        let statusClass = "";
        let statusText = status;
        switch (status) {
          case "Aktif":
            statusClass = "status-Aktif";
            break;
          case "Tamamlandı":
            statusClass = "status-Tamamlandı";
            break;
          case "Gecikti":
            statusClass = "status-Gecikti";
            break;
          case "Planlama Aşamasında":
            statusClass = "status-Planlama-Aşamasında";
            break;
          case "Aktif (İş Gecikmeli)":
            statusClass = "status-Aktif-İş-Gecikmeli";
            break;
          case "Planlama (İş Gecikmeli)":
            statusClass = "status-Planlama-İş-Gecikmeli";
            break;
          default:
            statusClass = "";
            break;
        }
        return `<span class="status-badge ${statusClass}">${statusText}</span>`;
      }

      // Aktivite loglama fonksiyonu (frontend'den backend'e istek gönderecek)
      async function addActivity(title, rawDescription, project_id, icon = "fas fa-info-circle", actionType = "other") {
        if (!currentUser || !currentUser.id) {
          console.warn("Kullanıcı oturumu bulunamadı, aktivite kaydedilemedi.");
          return;
        }

        const activityData = {
          user_id: currentUser.id,
          project_id: project_id, // null olabilir
          title: title,
          description: rawDescription,
          icon: icon,
          action_type: actionType
        };

        try {
          const response = await fetch(`${API_BASE_URL}/api/activities`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(activityData)
          });
          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || 'Aktivite eklenirken bilinmeyen bir hata oluştu.');
          }
          console.log("Aktivite başarıyla kaydedildi:", activityData);
        } catch (error) {
          console.error('Aktivite ekleme hatası:', error);
        }
      }
      

      // --- Proje Listesi ve İşlemleri ---
      async function fetchProjects() {
        const tbody = document.getElementById("projectsTableBody");
        if (!tbody) {
          console.error("HATA: projectsTableBody elementi bulunamadı!");
          return;
        }

        tbody.innerHTML =
          '<tr><td colspan="11" style="text-align: center;"><i class="fas fa-spinner fa-spin"></i> Projeler yükleniyor...</td></tr>';
        console.log("FETCH_DEBUG: 'Projeler yükleniyor...' mesajı ayarlandı.");

        try {
          console.log(
            "FETCH_DEBUG: API çağrısı başlatılıyor:",
            `${API_BASE_URL}/api/projects`
          );
          const response = await fetch(`${API_BASE_URL}/api/projects`);
          console.log(
            "FETCH_DEBUG: API yanıtı alındı. Status:",
            response.status
          );

          if (!response.ok) {
            let errorDetails = "Bilinmeyen Hata";
            try {
              const errorData = await response.json();
              errorDetails = errorData.message || errorDetails;
            } catch (jsonError) {
              errorDetails = `Yanıt JSON olarak parse edilemedi: ${response.statusText}`;
            }
            console.error(
              "FETCH_DEBUG HATA: API yanıtı OK değil.",
              `Durum: ${response.status}`,
              `Detay: ${errorDetails}`
            );
            throw new Error(`HTTP hatası! Durum: ${response.status} - ${errorDetails}`);
          }

          const projects = await response.json();
          console.log(
            "FETCH_DEBUG: API'den çekilen ham projeler (allProjectsData'ya atanacak):",
            projects
          );

          allProjectsData = projects;
          console.log("FETCH_DEBUG: allProjectsData güncellendi. applyFiltersAndRenderTable çağrılıyor.");
          applyFiltersAndRenderTable(); // Filtreleri uygula ve tabloyu render et
          console.log("FETCH_DEBUG: Projeler yükleme tamamlandı.");
        } catch (error) {
          console.error("FETCH KAPSAMLI HATA: Projeler çekilemedi:", error);
          showToast(`Projeler yüklenirken hata oluştu: ${error.message}`, true);
          if (tbody) {
            tbody.innerHTML = `<tr><td colspan="11" style="text-align: center; color: var(--danger);">Projeler yüklenemedi. Hata: ${error.message} Lütfen sunucu bağlantısını ve loglarını kontrol edin.</td></tr>`;
          }
        }
      }

      function renderProjectsTable(projectsToRender) {
        let tbody = document.getElementById("projectsTableBody");
        if (!tbody) {
          // Eğer tbody yoksa, tabloya tbody ekle
          const table = document.getElementById("projectsTable");
          if (table) {
            tbody = document.createElement("tbody");
            tbody.id = "projectsTableBody";
            table.appendChild(tbody);
            console.warn("projectsTableBody bulunamadı, yeni tbody eklendi.");
          } else {
            console.error("RENDER_DEBUG: projectsTable ve projectsTableBody elementi bulunamadı!");
            return;
          }
        }
        console.log(
          "RENDER_DEBUG: renderProjectsTable başladı. projectsToRender (gelecek veri):",
          projectsToRender
        );

        tbody.innerHTML = "";
        console.log("RENDER_DEBUG: tbody içeriği temizlendi.");

        if (projectsToRender.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="11" style="text-align: center;">Gösterilecek proje bulunamadı.</td></tr>';
          updatePagination(0, 0, 0); // Sayfalandırmayı güncelle
          return;
        }

        // Pagination için dilimleme
        const startIndex = (currentPage - 1) * rowsPerPage;
        const endIndex = startIndex + rowsPerPage;
        const paginatedProjects = projectsToRender.slice(startIndex, endIndex);

        // Yardımcı fonksiyonlar:
        function dateDiffInDays(date1, date2) {
          // Tarih formatı: YYYY-MM-DD veya DD.MM.YYYY
          function parseDate(str) {
            if (!str) return null;
            if (str.includes('-')) {
              // YYYY-MM-DD
              const [y, m, d] = str.split('-');
              return new Date(Number(y), Number(m) - 1, Number(d));
            } else if (str.includes('.')) {
              // DD.MM.YYYY
              const [d, m, y] = str.split('.');
              return new Date(Number(y), Number(m) - 1, Number(d));
            }
            return null;
          }
          const dt1 = parseDate(date1);
          const dt2 = parseDate(date2);
          if (!dt1 || !dt2) return null;
          // Sıfırdan küçükse daima 0 döndürme, gerçek farkı döndür
          return Math.ceil((dt2 - dt1) / (1000 * 60 * 60 * 24));
        }

        function sumDelayDays(progressArr) {
          if (!Array.isArray(progressArr)) return 0;
          return progressArr.reduce((sum, step) => sum + (step.delay_days || 0), 0);
        }

        function getTodayStr() {
          const today = new Date();
          return today.toISOString().slice(0, 10); // YYYY-MM-DD
        }

        paginatedProjects.forEach((project) => {
          // Toplam Gün
          let totalDays = dateDiffInDays(project.start_date, project.end_date);
          totalDays = (typeof totalDays === "number" && !isNaN(totalDays)) ? (totalDays >= 0 ? totalDays : 0) : '-';

          // Geçen Gün
          const todayStr = getTodayStr();
          let elapsedDays = dateDiffInDays(project.start_date, todayStr);
          elapsedDays = (typeof elapsedDays === "number" && !isNaN(elapsedDays)) ? (elapsedDays >= 0 ? elapsedDays : 0) : '-';

          // Gecikme Durumu
          let delayDays = 0;
          // Backend'den gelen delay_days'i öncelikli kullan
          // DİKKAT: MySQL'den gelen delay_days bazen string olabilir, burada sayıya çevir!
          if (project.delay_days !== undefined && project.delay_days !== null) {
            delayDays = Number(project.delay_days);
            if (isNaN(delayDays)) delayDays = 0;
          } else if (Array.isArray(project.progress_steps) && project.progress_steps.length > 0) {
            delayDays = sumDelayDays(project.progress_steps);
          }

          // Bitiş tarihi geçtiyse bugüne kadar olan farkı ekle
          let overdue = 0;
          if (project.end_date) {
            const endDateObj = (() => {
              if (project.end_date.includes('-')) {
                const [y, m, d] = project.end_date.split('-');
                return new Date(Number(y), Number(m) - 1, Number(d));
              } else if (project.end_date.includes('.')) {
                const [d, m, y] = project.end_date.split('.');
                return new Date(Number(y), Number(m) - 1, Number(d));
              }
              return null;
            })();
            const todayObj = new Date();
            if (endDateObj && todayObj > endDateObj) {
              overdue = Math.ceil((todayObj - endDateObj) / (1000 * 60 * 60 * 24));
            }
          }

          // Gecikme günleri toplamı
          let gecikmeDurumu = "-";
          if ((delayDays > 0 || overdue > 0)) {
            gecikmeDurumu = (delayDays + overdue) + " gün";
          } else if (typeof delayDays === 'number' && delayDays === 0 && overdue === 0) {
            gecikmeDurumu = "0 gün";
          }

          const row = document.createElement("tr");
          row.innerHTML = `
            <td data-label="Proje Adı">${project.project_name ? project.project_name.normalize('NFC') : "-"}</td>
            <td data-label="Referans No">${project.reference_no || "-"}</td>
            <td data-label="Müşteri">${project.customer_name || "-"}</td>
            <td data-label="Durum">${getStatusBadgeHtml(project.status || "-")}</td>
            <td data-label="Başlangıç">${formatDateForDisplay(project.start_date || "-")}</td>
            <td data-label="Bitiş">${formatDateForDisplay(project.end_date || "-")}</td>
            <td data-label="Toplam Gün">${totalDays !== '-' ? totalDays + ' gün' : '-'}</td>
            <td data-label="Geçen Gün">${elapsedDays !== '-' ? elapsedDays + ' gün' : '-'}</td>
            <td data-label="Gecikme Durumu">${gecikmeDurumu}</td>
            <td data-label="Yönetici">${project.project_manager_name || "-"}</td>
            <td data-label="İşlemler">
              <div style="display: flex; gap: 10px;">
                <button class="action-btn view-project-btn" data-id="${project.project_id}" title="Detayları Görüntüle"><i class="fas fa-eye"></i></button>
                <button class="action-btn edit-project-btn" data-id="${project.project_id}" title="Projeyi Düzenle"><i class="fas fa-edit"></i></button>
                <button class="action-btn delete-project-btn" data-id="${project.project_id}" title="Projeyi Sil"><i class="fas fa-trash"></i></button>
                <button class="action-btn generate-pdf-btn" data-id="${project.project_id}" title="PDF Raporu Oluştur"><i class="fas fa-file-pdf"></i></button>
              </div>
            </td>
          `;
          tbody.appendChild(row);
        });
        attachProjectTableEventListeners();
        updatePagination(projectsToRender.length, currentPage, Math.ceil(projectsToRender.length / rowsPerPage));
      }

      function attachProjectTableEventListeners() {
        document.querySelectorAll(".view-project-btn").forEach((btn) => {
          btn.onclick = (e) => {
            e.preventDefault();
            const projectId = e.currentTarget.dataset.id;
            openProjectModal(projectId, "view");
          };
        });
        document.querySelectorAll(".edit-project-btn").forEach((btn) => {
          btn.onclick = async (e) => {
            e.preventDefault();
            const projectId = e.currentTarget.dataset.id;
            const hasPermission = await checkPermission('proje_duzenle');
            if (!hasPermission) return;
            openProjectModal(projectId, "edit");
          };
        });
        document.querySelectorAll(".delete-project-btn").forEach((btn) => {
          btn.onclick = async (e) => {
            e.preventDefault();
            const projectId = e.currentTarget.dataset.id;
            const hasPermission = await checkPermission('proje_sil');
            if (!hasPermission) return;
            showConfirmationModal(`Bu projeyi silmek istediğinize emin misiniz? Bu işlem geri alınamaz!`, () => deleteProject(projectId));
          };
        });
        document.querySelectorAll(".generate-pdf-btn").forEach((btn) => {
          btn.onclick = async (e) => {
            e.preventDefault();
            const projectId = e.currentTarget.dataset.id;
            const project = allProjectsData.find((p) => p.project_id == projectId);
            if (project) {
              const hasPermission = await checkPermission('pdf_olusturma');
              if (!hasPermission) return;
              generateProjectPdf(project);
            } else showToast("Proje bulunamadı!", true);
          };
        });
      }

      async function deleteProject(id) {
        const project = allProjectsData.find(p => String(p.project_id) === String(id));
        const projectName = project ? project.project_name : `ID: ${id}`;
        try {
          // user_id'yi query parametresi olarak ekle
          const response = await fetch(`${API_BASE_URL}/api/projects/${id}?user_id=${currentUser.id}`, {
            method: "DELETE",
          });
          const data = await response.json();
          if (response.ok) {
            showToast(data.message || "Proje başarıyla silindi");
            fetchProjects();
            // Aktivite kaydı eklendi
            addActivity(
              "Proje Silindi",
              `"${projectName}" projesi silindi.`,
              id,
              "fas fa-trash",
              "project_delete"
            );
          } else {
            showToast(`Hata: ${data.message}`, true);
          }
        } catch (error) {
          console.error("Proje silme hatası:", error);
          showToast("Sunucuya bağlanılamadı veya bir sorun oluştu.", true);
        }
      }

      // --- Proje Detay/Düzenleme Modalı ve İş Gidişatı Fonksiyonları ---

const projectModal = document.getElementById("projectModal");
const projectModalContent = document.getElementById("projectModalContent");
const closeModalBtn = document.getElementById("closeModalBtn");
const cancelModalBtn = document.getElementById("cancelModalBtn");
const modalTitle = document.getElementById("modalTitle");
const modalBody = document.getElementById("modalBody");
const modalActions = document.getElementById("modalActions");

let modalBodyClickListener = null;

// Modal kapatma fonksiyonu
function closeProjectModal() {
  if (modalBodyClickListener) {
    modalBody.removeEventListener('click', modalBodyClickListener);
    modalBodyClickListener = null;
  }
  projectModal.style.display = "none";
  modalTitle.innerHTML = '<i class="fas fa-info-circle"></i> Proje Detayları';
  modalBody.innerHTML = "<p>Yükleniyor...</p>";
  modalActions.innerHTML = `<button class="modal-btn modal-btn-cancel" id="cancelModalBtn">Kapat</button>`;
  document.removeEventListener("keydown", handleEscapeKey);
  document.getElementById("cancelModalBtn").addEventListener("click", closeProjectModal);
  console.log("Modal kapatıldı.");
}

// Modal açma fonksiyonu
async function openProjectModal(projectId, mode) {
  const project = allProjectsData.find((p) => p.project_id == projectId);
  if (!project) {
    showToast("Proje bulunamadı!", true);
    return;
  }

  projectModal.style.display = "flex";
  modalBody.innerHTML =
    '<p style="text-align: center;"><i class="fas fa-spinner fa-spin"></i> Yükleniyor...</p>';

  if (mode === "view") {
    modalTitle.innerHTML = `<i class="fas fa-info-circle"></i> Proje Detayları: ${project.project_name}`;
    await renderViewModal(project);
    modalActions.innerHTML = `<button class="modal-btn modal-btn-cancel" id="cancelModalBtn">Kapat</button>`;

    if (!modalBodyClickListener) {
      modalBodyClickListener = function(e) {
        if (e.target.closest('.open-location-btn')) {
          const btn = e.target.closest('.open-location-btn');
          const location = btn.dataset.location;
          openLocationInGoogleMaps(location);
        }
      };
      modalBody.addEventListener('click', modalBodyClickListener);
    }
  } else if (mode === "edit") {
    modalTitle.innerHTML = `<i class="fas fa-edit"></i> Projeyi Düzenle: ${project.project_name}`;
    await renderEditModal(project);
    modalActions.innerHTML = `
      <button class="modal-btn modal-btn-save" id="saveProjectBtn"><i class="fas fa-save"></i> Kaydet</button>
      <button class="modal-btn modal-btn-cancel" id="cancelModalBtn">İptal</button>
    `;
    document.getElementById("saveProjectBtn").addEventListener("click", saveProjectChanges);
    document.getElementById("cancelModalBtn").addEventListener("click", closeProjectModal);
  }

  // Her zaman güncel kapatma butonlarına olay dinleyicisi ekle
  const cancelBtn = document.getElementById("cancelModalBtn");
  if (cancelBtn) {
    cancelBtn.addEventListener("click", closeProjectModal);
  }
  if (closeModalBtn) {
    closeModalBtn.addEventListener("click", closeProjectModal);
  }

  // Modalın dışına tıklayarak kapatma
  projectModal.onclick = (e) => {
    if (e.target === projectModal) {
      closeProjectModal();
    }
  };

  // Esc tuşu ile kapatma
  document.addEventListener("keydown", handleEscapeKey);
}

function handleEscapeKey(e) {
  if (e.key === "Escape" && projectModal.style.display === "flex") {
    closeProjectModal();
  }
}

// Google Haritalar'da konum açma fonksiyonu
function openLocationInGoogleMaps(location) {
  if (!location) {
    showToast("Konum bilgisi bulunamadı!", true);
    return;
  }
  const encodedLocation = encodeURIComponent(location);
  const url = `https://www.google.com/maps/search/?api=1&query=${encodedLocation}`;
  window.open(url, '_blank');
}

async function renderViewModal(project) {
  let locationHtml = project.project_location || "-";
  if (project.project_location) {
    locationHtml += ` <button class="action-btn open-location-btn" data-location="${project.project_location}" title="Haritada Aç"><i class="fas fa-map-marker-alt"></i></button>`;
  }
  modalBody.innerHTML = `
    <div class="detail-item">
        <span class="detail-label">Proje Adı:</span>
        <span class="detail-value">${project.project_name ? project.project_name.normalize('NFC') : "-"}</td>
    </div>
    <div class="detail-item">
        <span class="detail-label">Referans No:</span>
        <span class="detail-value">${project.reference_no || "-"}</span>
    </div>
    <div class="detail-item">
        <span class="detail-label">Müşteri:</span>
        <span class="detail-value">${project.customer_name || "-"}</span>
    </div>
    <div class="detail-item">
        <span class="detail-label">Konum:</span>
        <span class="detail-value">${locationHtml}</span>
    </div>
    <div class="detail-item">
        <span class="detail-label">Durum:</span>
        <span class="detail-value">${getStatusBadgeHtml(project.status || "-")}</span>
    </div>
    <div class="detail-item">
        <span class="detail-label">Başlangıç Tarihi:</span>
        <span class="detail-value">${formatDateForDisplay(project.start_date || "-")}</span>
    </div>
    <div class="detail-item">
        <span class="detail-label">Bitiş Tarihi:</span>
        <span class="detail-value">${formatDateForDisplay(project.end_date || "-")}</span>
    </div>
    <div class="detail-item">
        <span class="detail-label">Yönetici:</span>
        <span class="detail-value">${project.project_manager_name || "-"}</span>
    </div>
    <div class="detail-item">
        <span class="detail-label">Açıklama:</span>
        <span class="detail-value">${project.description || "-"}</span>
    </div>
    <div class="progress-detail-section">
        <h3 class="modal-title" style="margin-bottom: 15px;"><i class="fas fa-tasks"></i> İş Gidişatı</h3>
        <div id="progressStepsContainer"></div>
        <button class="btn" style="margin-top: 15px;" id="addProgressStepBtn">
            <i class="fas fa-plus"></i> İş Adımı Ekle
        </button>
    </div>
  `;
  try {
    await fetchProgressSteps(project.project_id);
  } catch (err) {
    const progressStepsContainer = document.getElementById("progressStepsContainer");
    if (progressStepsContainer) {
      progressStepsContainer.innerHTML = `<p style="color: var(--danger);">İş adımları yüklenemedi. Sunucuya ulaşılamıyor veya API hatası.</p>`;
    }
  }
}

// Düzenleme modalı fonksiyonu
async function renderEditModal(project) {
  modalBody.innerHTML = `
    <input type="hidden" id="editProjectId" value="${project.project_id}">
    <div class="form-group">
        <label for="editProjectName" class="form-label">Proje Adı</label>
        <input type="text" id="editProjectName" class="form-input" value="${project.project_name ? project.project_name.normalize('NFC') : ""}">
    </div>
    <div class="form-group">
        <label for="editReferenceNo" class="form-label">Referans No</label>
        <input type="text" id="editReferenceNo" class="form-input" value="${project.reference_no || ""}">
    </div>
    <div class="form-group">
        <label for="editCustomerName" class="form-label">Müşteri Adı</label>
        <input type="text" id="editCustomerName" class="form-input" value="${project.customer_name || ""}">
    </div>
    <div class="form-group">
        <label for="editLocation" class="form-label">Konum</label>
        <input type="text" id="editLocation" class="form-input" value="${project.project_location || ""}">
    </div>
    <div class="form-group">
        <label for="editStatus" class="form-label">Durum</label>
        <select id="editStatus" class="form-input">
            <option value="Aktif" ${project.status === "Aktif" ? "selected" : ""}>Aktif</option>
            <option value="Tamamlandı" ${project.status === "Tamamlandı" ? "selected" : ""}>Tamamlandı</option>
            <option value="Gecikti" ${project.status === "Gecikti" ? "selected" : ""}>Gecikti</option>
            <option value="Planlama Aşamasında" ${project.status === "Planlama Aşamasında" ? "selected" : ""}>Planlama Aşamasında</option>
            <option value="Aktif (İş Gecikmeli)" ${project.status === "Aktif (İş Gecikmeli)" ? "selected" : ""}>Aktif (İş Gecikmeli)</option>
            <option value="Planlama (İş Gecikmeli)" ${project.status === "Planlama (İş Gecikmeli)" ? "selected" : ""}>Planlama (İş Gecikmeli)</option>
        </select>
    </div>
    <div class="form-group">
        <label for="editStartDate" class="form-label">Başlangıç Tarihi</label>
        <input type="date" id="editStartDate" class="form-input" value="${formatDateForInput(project.start_date || "")}">
    </div>
    <div class="form-group">
        <label for="editEndDate" class="form-label">Bitiş Tarihi</label>
        <input type="date" id="editEndDate" class="form-input" value="${formatDateForInput(project.end_date || "")}">
    </div>
    <div class="form-group">
        <label for="editProjectManager" class="form-label">Proje Yöneticisi</label>
        <input type="text" id="editProjectManager" class="form-input" value="${project.project_manager_name || ""}">
    </div>
    <div class="form-group">
        <label for="editDescription" class="form-label">Açıklama</label>
        <textarea id="editDescription" class="form-input" rows="4">${project.description || ""}</textarea>
    </div>
    <div class="progress-detail-section">
        <h3 class="modal-title" style="margin-bottom: 15px;"><i class="fas fa-tasks"></i> İş Gidişatı</h3>
        <div id="progressStepsContainer"></div>
        <button class="btn" style="margin-top: 15px;" id="addProgressStepBtn">
            <i class="fas fa-plus"></i> İş Adımı Ekle
        </button>
    </div>
  `;
  await fetchProgressSteps(project.project_id, true);
}

      async function saveProjectChanges() {
        const hasPermission = await checkPermission('proje_duzenle');
        if (!hasPermission) return;
        const projectId = document.getElementById("editProjectId").value;
        const projectName = document.getElementById("editProjectName").value;
        const referenceNo = document.getElementById("editReferenceNo").value;
        const customerName = document.getElementById("editCustomerName").value;
        const location = document.getElementById("editLocation").value;
        const status = document.getElementById("editStatus").value;
        const startDate = document.getElementById("editStartDate").value;
        const endDate = document.getElementById("editEndDate").value;
        const projectManagerName = document.getElementById("editProjectManager").value;
        const description = document.getElementById("editDescription").value;

        const updatedProject = {
          project_name: projectName,
          reference_no: referenceNo,
          customer_name: customerName,
          project_location: location,
          status: status,
          start_date: startDate,
          end_date: endDate,
          project_manager_name: projectManagerName,
          description: description,
          user_id: currentUser.id // Kullanıcı ID'si eklendi
        };

        try {
          const response = await fetch(`${API_BASE_URL}/api/projects/${projectId}`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(updatedProject),
          });

          const data = await response.json();
          if (response.ok) {
            showToast("Proje başarıyla güncellendi!");
            addActivity(
              "Proje Güncellendi",
              `${projectName} adlı proje güncellendi.`,
              projectId,
              "fas fa-pen-to-square",
              "project_update"
            );
            fetchProjects(); // Listeyi yenile
            closeProjectModal();
          } else {
            showToast(`Hata: ${data.message}`, true);
          }
        } catch (error) {
          console.error("Proje güncelleme hatası:", error);
          showToast("Proje güncellenirken bir sorun oluştu.", true);
        }
      }

      // `isEditable` parametresi eklendi
      async function fetchProgressSteps(projectId, isEditable = false) {

        const progressStepsContainer = document.getElementById("progressStepsContainer");
        console.log("DEBUG: fetchProgressSteps başı, projectId:", projectId, "isEditable:", isEditable, "progressStepsContainer:", progressStepsContainer);
        if (!progressStepsContainer) {
          console.error("DEBUG: fetchProgressSteps, progressStepsContainer bulunamadı!");
          return;
        }
        progressStepsContainer.innerHTML =
          '<p style="text-align: center;"><i class="fas fa-spinner fa-spin"></i> İş adımları yükleniyor...</td></tr>';

        let timeoutId = setTimeout(() => {
          progressStepsContainer.innerHTML = `<p style='color: var(--danger);'>İş adımları yüklenemedi. Sunucuya ulaşılamıyor veya API çok yavaş.</p>`;
        }, 7000); // 7 saniye sonra hata mesajı göster

        try {
          console.log("DEBUG: fetchProgressSteps, API fetch başlıyor:", `${API_BASE_URL}/api/projects/${projectId}/progress`);
          const response = await fetch(`${API_BASE_URL}/api/projects/${projectId}/progress`);
          clearTimeout(timeoutId);
          if (!response.ok) {
            const errorText = await response.text();
            console.error(`API Yanıtı Hata (Durum: ${response.status}):`, errorText);
            throw new Error(`HTTP hatası! Sunucu yanıtı: ${response.status} - ${errorText.substring(0, 100)}...`);
          }
          const progressSteps = await response.json();
          console.log("DEBUG: fetchProgressSteps, API'den progressSteps geldi:", progressSteps);
          renderProgressSteps(progressSteps, projectId, isEditable);
          console.log("DEBUG: fetchProgressSteps, renderProgressSteps çağrıldı");
        } catch (error) {
          clearTimeout(timeoutId);
          console.error("İş adımları çekilemedi:", error);
          progressStepsContainer.innerHTML = `<p style=\"color: var(--danger);\">İş adımları yüklenemedi. Hata: ${error.message}. Lütfen sunucu bağlantısını ve API rotalarını kontrol edin.</p>`;
          showToast("İş adımları yüklenirken bir sorun oluştu.", true);
        }
      }

      // `isEditable` parametresi eklendi
  
function renderProgressSteps(steps, projectId, isEditable = false) {
  const progressStepsContainer = document.getElementById("progressStepsContainer");
  if (!progressStepsContainer) return;
  progressStepsContainer.innerHTML = "";

  if (steps.length === 0) {
    progressStepsContainer.innerHTML = '<p>Bu proje için henüz iş adımı eklenmemiş.</p>';
  } else {
    steps.forEach((step) => {
      const stepElement = document.createElement("div");
      stepElement.className = "progress-detail-item";

      const titleContent = isEditable ?
        `<input type="text" id="step-${step.progress_id}-name" class="progress-step-name-input" value="${step.step_name || ''}" placeholder="Adım Adı" required>` :
        `<span class="progress-detail-title">${step.step_name || ''}</span>`;

      const startDateContent = isEditable ?
        `<label for="step-${step.progress_id}-start">Başlangıç:</label><input type="date" id="step-${step.progress_id}-start" class="progress-datepicker" value="${formatDateForInput(step.start_date || '')}" required>` :
        `Başlangıç: ${formatDateForDisplay(step.start_date || '-')}`;

      const endDateContent = isEditable ?
        `<label for="step-${step.progress_id}-end">Bitiş:</label><input type="date" id="step-${step.progress_id}-end" class="progress-datepicker" value="${formatDateForInput(step.end_date || '')}" required>` :
        `Bitiş: ${formatDateForDisplay(step.end_date || '-')}`;

      const delayDisplay = (step.delay_days > 0 && !isEditable) ? `<span class='pdf-delay-text'>(${step.delay_days} gün gecikmeli)</span>` : '';

      const descriptionContent = isEditable ?
        `<textarea id="step-${step.progress_id}-desc" class="progress-description-textarea" placeholder="Açıklama">${step.description || ''}</textarea>` :
        `<div class="progress-detail-description">Açıklama: ${step.description || 'Yok'}</div>`;

      const actionsContent = isEditable ?
       
        `
          <div class="progress-actions">
              <button type="button" class="action-btn save-progress-btn" data-id="${step.progress_id}" data-project-id="${projectId}" title="Kaydet"><i class="fas fa-save"></i> Kaydet</button>
              <button type="button" class="action-btn delete-progress-btn" data-id="${step.progress_id}" data-project-id="${projectId}" title="Sil"><i class="fas fa-trash"></i> Sil</button>
          </div>
               ` : ``;

      stepElement.innerHTML = `
          <div class="progress-item-header">
              <div class="input-group" style="flex: 1;">
                  ${isEditable ? '<label for="step-' + step.progress_id + '-name">Adım Başlığı</label>' : ''}
                  ${titleContent}
              </div>
              <div class="progress-dates" style="margin-left: ${isEditable ? '20px' : '0'};">
                  <span>
                      ${startDateContent}
                  </span>
                  <span>
                      ${endDateContent}
                  </span>
                  ${delayDisplay}
              </div>
          </div>
          <div class="input-group">
              ${isEditable ? '<label for="step-' + step.progress_id + '-desc">Açıklama</label>' : ''}
              ${descriptionContent}
          </div>
          ${actionsContent}
      `;
      progressStepsContainer.appendChild(stepElement);
    });

    // Event listener'ları dinamik olarak atama (sadece düzenleme modunda)
    if (isEditable) {
      document.querySelectorAll('.save-progress-btn').forEach(button => {
        button.addEventListener('click', (e) => {
          const progressId = e.currentTarget.dataset.id;
          const projId = e.currentTarget.dataset.projectId;
          const stepName = document.getElementById(`step-${progressId}-name`).value;
          const startDate = document.getElementById(`step-${progressId}-start`).value;
          const endDate = document.getElementById(`step-${progressId}-end`).value;
          const description = document.getElementById(`step-${progressId}-desc`).value;
          editProgressStep(progressId, projId, { step_name: stepName, start_date: startDate, end_date: endDate, description: description });
        });
      });
      document.querySelectorAll('.delete-progress-btn').forEach(button => {
        button.addEventListener('click', (e) => {
          const progressId = e.currentTarget.dataset.id;
          const projId = e.currentTarget.dataset.projectId;
          showConfirmationModal(`Bu iş adımını silmek istediğinize emin misiniz? Bu işlem geri alınamaz!`, () => deleteProgressStep(progressId, projId));
        });
      });
    }
  }

  // "İş Adımı Ekle" butonu için olay dinleyicisi
  const addProgressStepButton = document.getElementById("addProgressStepBtn");
  if (addProgressStepButton) {
    addProgressStepButton.onclick = null;
    addProgressStepButton.onclick = () => addNewProgressStepForm(projectId);
  }
}
      // MODAL İÇİNE YENİ İŞ ADIMI EKLEME FORMU OLUŞTURAN FONKSİYON
      function addNewProgressStepForm(projectId) {
        const progressStepsContainer = document.getElementById("progressStepsContainer");
        // Zaten bir ekleme formu varsa yeni bir tane daha açma
        if (document.getElementById('newProgressForm')) {
            showToast("Zaten açık bir ekleme formu var.", false);
            return;
        }

        const formElement = document.createElement('div');
        formElement.id = 'newProgressForm';
        formElement.className = 'progress-detail-item'; // Mevcut öğe stilini kullan

        formElement.innerHTML = `
            <div class="progress-item-header">
                <div class="input-group" style="flex: 1;">
                    <label for="newStepName">Adım Başlığı</label>
                    <input type="text" id="newStepName" class="progress-step-name-input" placeholder="İş gidişat başlığı" required>
                </div>
                <div class="progress-dates" style="margin-left: 20px;">
                    <span>
                        <label for="newStepStartDate">Başlangıç:</label>
                        <input type="date" id="newStepStartDate" class="progress-datepicker" required>
                    </span>
                    <span>
                        <label for="newStepEndDate">Bitiş:</label>
                        <input type="date" id="newStepEndDate" class="progress-datepicker" required>
                    </span>
                </div>
            </div>
            <div class="input-group">
                <label for="newStepDescription">Açıklama</label>
                <textarea id="newStepDescription" class="progress-description-textarea" placeholder="İş gidişat açıklaması"></textarea>
            </div>
            <div class="progress-actions">
                <button type="button" class="action-btn modal-btn-cancel" id="cancelAddProgressBtn"><i class="fas fa-times"></i> İptal</button>
                <button type="button" class="action-btn modal-btn-save" id="saveNewProgressBtn"><i class="fas fa-plus"></i> Ekle</button>
            </div>
        `;
        progressStepsContainer.appendChild(formElement);

        // Yeni form için olay dinleyicileri
        document.getElementById('saveNewProgressBtn').addEventListener('click', async () => {
            const stepName = document.getElementById('newStepName').value;
            const startDate = document.getElementById('newStepStartDate').value;
            const endDate = document.getElementById('newStepEndDate').value;
            const description = document.getElementById('newStepDescription').value;

            if (!stepName || !startDate || !endDate) {
                showToast("Lütfen tüm zorunlu alanları doldurun.", true);
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/api/projects/${projectId}/progress`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ step_name: stepName, start_date: startDate, end_date: endDate, description: description })
                });
                const data = await response.json();
                if (response.ok) {
                    showToast("İş adımı başarıyla eklendi.");
                    formElement.remove(); // Formu kapat
                    fetchProgressSteps(projectId, true); // Adımları yeniden yükle (düzenleme modunda kal)
                    addActivity('İş Adımı Eklendi', `Proje ID: ${projectId} için "${stepName}" iş adımı eklendi.`, projectId, 'fas fa-tasks', 'progress_add');
                } else {
                    showToast(`Hata: ${data.message}`, true);
                }
            } catch (error) {
                console.error("Yeni iş adımı ekleme hatası:", error);
                showToast("İş adımı eklenirken bir sorun oluştu.", true);
            }
        });

        document.getElementById('cancelAddProgressBtn').addEventListener('click', () => {
            formElement.remove(); // Formu kaldır
            showToast("İş adımı ekleme iptal edildi.", false);
        });
      }

      // editProgressStep fonksiyonu doğrudan SweetAlert2 kullanmak yerine
      // renderProgressSteps içinde inline form elemanlarından veri alacak şekilde güncellendi.
      // progress_id kullanıldı
      async function editProgressStep(progressId, projectId, updatedStepData) {
        try {
          const response = await fetch(`${API_BASE_URL}/api/progress/${progressId}`, { // progressId kullanılıyor
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(updatedStepData),
          });
          const data = await response.json();
          if (response.ok) {
            showToast("İş adımı başarıyla güncellendi.");
            fetchProjects(); // Projeler listesini de yenile (durum güncellenmiş olabilir)
            fetchProgressSteps(projectId, true); // Adımları yenile (düzenleme modunda kal)
            addActivity(
              "İş Adımı Güncellendi",
              `Proje ID: ${projectId} için "${updatedStepData.step_name}" iş adımı güncellendi.`,
              projectId,
              "fas fa-pen",
              "progress_update"
            );
          } else {
            showToast(`Hata: ${data.message}`, true);
          }
        } catch (error) {
          console.error("İş adımı güncelleme hatası:", error);
          showToast("İş adımı güncellenirken bir sorun oluştu.", true);
        }
      }

      // progress_id kullanıldı
      async function deleteProgressStep(progressId, projectId) {
          try {
            const response = await fetch(`${API_BASE_URL}/api/progress/${progressId}`, { // progressId kullanılıyor
              method: "DELETE",
            });
            const data = await response.json();
            if (response.ok) {
              showToast("İş adımı başarıyla silindi!");
              fetchProjects(); // Projeler listesini de yenile (durum güncellenmiş olabilir)
              fetchProgressSteps(projectId, true); // Adımları yenile (düzenleme modunda kal)
              addActivity(
                "İş Adımı Silindi",
                `Proje ID: ${projectId} için bir iş adımı silindi.`,
                projectId,
                "fas fa-times",
                "progress_delete"
              );
            } else {
              showToast(`Hata: ${data.message}`, true);
            }
          } catch (error) {
            console.error("İş adımı silme hatası:", error);
            showToast("İş adımı silinirken bir sorun oluştu.", true);
          }
      }

      // PDF Oluşturma Fonksiyonları (progress_id kullanıldı)
      async function generateProjectPdf(project) {
        // 1. Progress adımlarını çek
        let progressSteps = [];
        try {
          const response = await fetch(`${API_BASE_URL}/api/projects/${project.project_id}/progress`);
          if (response.ok) {
            progressSteps = await response.json();
          }
        } catch (e) {
          // Progress adımları olmadan da PDF oluşturulabilir
        }

        // 2. PDF içeriğini detaylı ve görsel olarak hazırla
        const pdfContent = document.createElement('div');
        pdfContent.className = 'pdf-report-content';
        pdfContent.innerHTML = `
          <div class="pdf-header">
            <h1 style='font-size:28px;color:#005c9d;margin-bottom:5px;'>Ser Elektrik Otomasyon</h1>
            <h2 style='font-size:22px;color:#0980d3;margin-bottom:15px;'>Proje Detaylı Raporu</h2>
          </div>
          <table class="pdf-info-table" style="width:100%;margin-bottom:20px;font-size:15px;">
            <tr><th>Proje Adı</th><td>${project.project_name ? project.project_name.normalize('NFC') : "-"}</td></tr>
            <tr><th>Referans No</th><td>${project.reference_no || '-'}</td></tr>
            <tr><th>Müşteri</th><td>${project.customer_name || '-'}</td></tr>
            <tr><th>Konum</th><td>${project.project_location || '-'}</td></tr>
            <tr><th>Durum</th><td>${project.status || '-'}</td></tr>
            <tr><th>Başlangıç Tarihi</th><td>${formatDateForDisplay(project.start_date || '-')}</td></tr>
            <tr><th>Bitiş Tarihi</th><td>${formatDateForDisplay(project.end_date || '-')}</td></tr>
            <tr><th>Yönetici</th><td>${project.project_manager_name || '-'}</td></tr>
            <tr><th>Açıklama</th><td>${project.description || '-'}</td></tr>
          </table>
          <div class="pdf-section-title" style='font-size:18px; color:#005c9d; border-bottom:1px solid #e1e5e9; padding-bottom:5px; margin-bottom:15px;'><i class="fas fa-tasks"></i> İş Gidişatı</div>
          <div>
            ${progressSteps.length === 0 ? '<p>İş adımı bulunamadı.</p>' : progressSteps.map(step => `
              <div style="margin-bottom:12px;">
                <div style="font-weight:bold;font-size:15px;">${step.step_name || ''}</div>
                <div style="font-size:13px; color:#555;">Başlangıç: ${formatDateForDisplay(step.start_date || '-')} - Bitiş: ${formatDateForDisplay(step.end_date || '-')} ${(step.delay_days > 0) ? `<span class='pdf-delay-text'>(${step.delay_days} gün gecikmeli)</span>` : ''}</div>
                <div style="font-size:13px;">${step.description || ''}</div>
              </div>
            `).join('')}
          </div>
          <div class="pdf-footer" style='margin-top:40px; font-size:12px; color:#6c757d; border-top:1px solid #eee; padding-top:15px;'>
            &copy; 2025 Ser Elektrik Otomasyon. Tüm hakları saklıdır.
          </div>
        `;

        // Yeni pencere aç
        const newWindow = window.open('', '_blank', 'width=900,height=800,resizable=yes,scrollbars=yes');
        if (!newWindow) {
            showToast("PDF önizlemesi için yeni pencere açılamadı. Tarayıcınızın pop-up engelleyicisini kontrol edin.", true);
            return;
        }

        // Yeni pencereye PDF içeriğini ve gerekli CSS'i ekle
        newWindow.document.write(`
            <!DOCTYPE html>
            <html lang="tr">
            <head>
                <meta charset="UTF-8">
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>${project.project_name ? project.project_name.normalize('NFC') : "Proje"} Raporu Önizlemesi</title>
                <link rel="stylesheet" href="[https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css](https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css)">
                <style>
                    body { font-family: 'Segoe UI', Arial, sans-serif; margin: 0; padding: 0; background-color: #f0f2f5; }
                    .pdf-container {
                        width: 210mm; /* A4 genişliği */
                        min-height: 297mm; /* A4 yüksekliği */
                        margin: 20px auto;
                        background: #fff;
                        box-shadow: 0 0 10px rgba(0,0,0,0.1);
                        padding: 20mm; /* Kenar boşlukları */
                        box-sizing: border-box;
                    }
                    .pdf-report-content {
                        font-family: "Segoe UI", Arial, sans-serif;
                        color: #333;
                        box-sizing: border-box;
                    }
                    .pdf-header h1 { color: #005c9d; font-size: 28px; margin-bottom: 5px; }
                    .pdf-header h2 { color: #0980d3; font-size: 22px; margin-bottom: 15px; }
                    .pdf-info-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 15px; }
                    .pdf-info-table th, .pdf-info-table td { padding: 8px; border: 1px solid #e1e5e9; text-align: left; }
                    .pdf-info-table th { background-color: #f0f4f8; color: #5e6870; width: 30%; }
                    .pdf-section-title { color: #005c9d; border-bottom: 1px solid #e1e5e9; padding-bottom: 5px; margin-bottom: 15px; font-size: 18px; }
                    .pdf-delay-text { color: red; font-weight: bold; }
                    .pdf-footer { text-align: center; font-size: 12px; color: #6c757d; margin-top: 40px; border-top: 1px solid #eee; padding-top: 15px; }
                    .print-button-container {
                        text-align: center;
                        margin-top: 20px;
                        padding-bottom: 20px;
                    }
                    .print-button {
                        background-color: #005c9d;
                        color: white;
                        padding: 10px 20px;
                        border: none;
                        border-radius: 8px;
                        font-size: 16px;
                        cursor: pointer;
                        transition: background-color 0.3s ease;
                    }
                    .print-button:hover {
                        background-color: #0980d3;
                    }
                    @media print {
                        .print-button-container { display: none; }
                        body { background-color: #fff; }
                        .pdf-container { margin: 0; box-shadow: none; padding: 0; }
                    }
                </style>
            </head>
            <body>
                <div class="pdf-container">
                    ${pdfContent.innerHTML}
                </div>
                <div class="print-button-container">
                    <button class="print-button" onclick="window.print()"><i class="fas fa-print"></i> PDF Kaydet / Yazdır</button>
                </div>
            </body>
            </html>
        `);
        newWindow.document.close(); // Yazma işlemini bitir

        // Yeni pencere yüklendiğinde aktivite kaydı
        newWindow.onload = () => {
            showToast(`${project.project_name ? project.project_name.normalize('NFC') : "proje"} için PDF raporu önizlemesi hazır.`);
            addActivity(
                "PDF Raporu Önizlendi",
                `${project.project_name ? project.project_name.normalize('NFC') : "proje"} için PDF raporu önizlemesi açıldı.`,
                project.project_id,
                "fas fa-file-pdf",
                "pdf_preview"
            );
        };
      }

      // Tüm projeleri PDF olarak dışa aktar
      async function exportAllProjectsToPdf() {
        showToast("Tüm projeler PDF olarak hazırlanıyor...", false);

        // 1. Tüm projeleri içeren bir HTML tablosu oluştur
        let allProjectsHtml = `
            <div style="font-family: 'Segoe UI', Arial, sans-serif; padding: 15mm; color: #333; background: #fff; box-sizing: border-box;">
                <div style="text-align: center; margin-bottom: 20px;">
                    <h1 style='font-size:28px;color:#005c9d;margin-bottom:5px;'>Ser Elektrik Otomasyon</h1>
                    <h2 style='font-size:22px;color:#0980d3;margin-bottom:15px;'>Tüm Projeler Raporu</h2>
                </div>
                <table style="width:100%; border-collapse: collapse; margin-bottom: 20px; border: 1px solid #e1e5e9;">
                    <thead>
                        <tr>
                            <th style="border: 1px solid #e1e5e9; padding: 10px 8px; text-align: left; background-color: #f0f4f8; font-weight: bold; color: #5e6870;">Proje Adı</th>
                            <th style="border: 1px solid #e1e5e9; padding: 10px 8px; text-align: left; background-color: #f0f4f8; font-weight: bold; color: #5e6870;">Referans No</th>
                            <th style="border: 1px solid #e1e5e9; padding: 10px 8px; text-align: left; background-color: #f0f4f8; font-weight: bold; color: #5e6870;">Müşteri</th>
                            <th style="border: 1px solid #e1e5e9; padding: 10px 8px; text-align: left; background-color: #f0f4f8; font-weight: bold; color: #5e6870;">Durum</th>
                            <th style="border: 1px solid #e1e5e9; padding: 10px 8px; text-align: left; background-color: #f0f4f8; font-weight: bold; color: #5e6870;">Başlangıç</th>
                            <th style="border: 1px solid #e1e5e9; padding: 10px 8px; text-align: left; background-color: #f0f4f8; font-weight: bold; color: #5e6870;">Bitiş</th>
                            <th style="border: 1px solid #e1e5e9; padding: 10px 8px; text-align: left; background-color: #f0f4f8; font-weight: bold; color: #5e6870;">Toplam Gün</th>
                            <th style="border: 1px solid #e1e5e9; padding: 10px 8px; text-align: left; background-color: #f0f4f8; font-weight: bold; color: #5e6870;">Geçen Gün</th>
                            <th style="border: 1px solid #e1e5e9; padding: 10px 8px; text-align: left; background-color: #f0f4f8; font-weight: bold; color: #5e6870;">Gecikme Durumu</th>
                            <th style="border: 1px solid #e1e5e9; padding: 10px 8px; text-align: left; background-color: #f0f4f8; font-weight: bold; color: #5e6870;">Yönetici</th>
                        </tr>
                    </thead>
                    <tbody>
        `;

        // Yardımcı fonksiyonlar (mevcut fonksiyonlardan kopyalandı)
        function dateDiffInDays(date1, date2) {
            function parseDate(str) {
                if (!str) return null;
                if (str.includes('-')) {
                    const [y, m, d] = str.split('-');
                    return new Date(Number(y), Number(m) - 1, Number(d));
                } else if (str.includes('.')) {
                    const [d, m, y] = str.split('.');
                    return new Date(Number(y), Number(m) - 1, Number(d));
                }
                return null;
            }
            const dt1 = parseDate(date1);
            const dt2 = parseDate(date2);
            if (!dt1 || !dt2) return null;
            return Math.ceil((dt2 - dt1) / (1000 * 60 * 60 * 24));
        }

        function getTodayStr() {
            const today = new Date();
            return today.toISOString().slice(0, 10); // YYYY-MM-DD
        }

        allProjectsData.forEach((project, index) => {
            let totalDays = dateDiffInDays(project.start_date, project.end_date);
            totalDays = (typeof totalDays === "number" && !isNaN(totalDays)) ? (totalDays >= 0 ? totalDays : 0) : '-';

            const todayStr = getTodayStr();
            let elapsedDays = dateDiffInDays(project.start_date, todayStr);
            elapsedDays = (typeof elapsedDays === "number" && !isNaN(elapsedDays)) ? (elapsedDays >= 0 ? elapsedDays : 0) : '-';

            let delayDays = 0;
            if (project.delay_days !== undefined && project.delay_days !== null) {
                delayDays = Number(project.delay_days);
                if (isNaN(delayDays)) delayDays = 0;
            } else if (Array.isArray(project.progress_steps) && project.progress_steps.length > 0) {
                delayDays = project.progress_steps.reduce((sum, step) => sum + (step.delay_days || 0), 0);
            }

            let overdue = 0;
            if (project.end_date) {
                const endDateObj = (() => {
                    if (project.end_date.includes('-')) {
                        const [y, m, d] = project.end_date.split('-');
                        return new Date(Number(y), Number(m) - 1, Number(d));
                    } else if (project.end_date.includes('.')) {
                        const [d, m, y] = project.end_date.split('.');
                        return new Date(Number(y), Number(m) - 1, Number(d));
                    }
                    return null;
                })();
                const todayObj = new Date();
                if (endDateObj && todayObj > endDateObj) {
                    overdue = Math.ceil((todayObj - endDateObj) / (1000 * 60 * 60 * 24));
                }
            }
            
            let gecikmeDurumu = "-";
            if ((delayDays > 0 || overdue > 0)) {
                gecikmeDurumu = (delayDays + overdue) + " gün";
            } else if (typeof delayDays === 'number' && delayDays === 0 && overdue === 0) {
                gecikmeDurumu = "0 gün";
            }

            // Satır rengi için basit bir alternatif
            const rowBgColor = index % 2 === 0 ? '#ffffff' : '#f9f9f9';

            allProjectsHtml += `
                <tr style="background-color: ${rowBgColor};">
                    <td style="border: 1px solid #e1e5e9; padding: 8px; text-align: left;">${project.project_name ? project.project_name.normalize('NFC') : "-"}</td>
                    <td style="border: 1px solid #e1e5e9; padding: 8px; text-align: left;">${project.reference_no || "-"}</td>
                    <td style="border: 1px solid #e1e5e9; padding: 8px; text-align: left;">${project.customer_name || "-"}</td>
                    <td style="border: 1px solid #e1e5e9; padding: 8px; text-align: left;">${project.status || "-"}</td>
                    <td style="border: 1px solid #e1e5e9; padding: 8px; text-align: left;">${formatDateForDisplay(project.start_date || "-")}</td>
                    <td style="border: 1px solid #e1e5e9; padding: 8px; text-align: left;">${formatDateForDisplay(project.end_date || "-")}</td>
                    <td style="border: 1px solid #e1e5e9; padding: 8px; text-align: left;">${totalDays !== '-' ? totalDays + ' gün' : '-'}</td>
                    <td style="border: 1px solid #e1e5e9; padding: 8px; text-align: left;">${elapsedDays !== '-' ? elapsedDays + ' gün' : '-'}</td>
                    <td style="border: 1px solid #e1e5e9; padding: 8px; text-align: left;">${gecikmeDurumu}</td>
                    <td style="border: 1px solid #e1e5e9; padding: 8px; text-align: left;">${project.project_manager_name || "-"}</td>
                </tr>
            `;
        });

        allProjectsHtml += `
                    </tbody>
                </table>
                <div style="text-align: center; font-size: 10px; color: #6c757d; margin-top: 30px; border-top: 1px solid #eee; padding-top: 10px;">
                    &copy; 2025 Ser Elektrik Otomasyon. Tüm hakları saklıdır.
                </div>
            </div>
        `;

        // 2. html2pdf kütüphanesini kullanarak PDF oluştur
        const element = document.createElement('div');
        element.innerHTML = allProjectsHtml;

        const options = {
            margin: 10,
            filename: 'Tüm_Projeler_Raporu.pdf',
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2, logging: true, dpi: 192, letterRendering: true },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' } // Yatay A4 formatı
        };

        try {
            await html2pdf().from(element).set(options).save();
            showToast("Tüm projeler PDF olarak başarıyla dışa aktarıldı!");
            addActivity(
                "Tüm Projeler PDF Dışa Aktarıldı",
                "Tüm projeler PDF olarak indirildi.",
                null, // Proje ID'si yok, tüm projeler
                "fas fa-file-pdf",
                "pdf_export_all"
            );
        } catch (error) {
            console.error("Tüm projeleri PDF'e aktarırken hata oluştu:", error);
            showToast(`PDF oluşturulurken hata oluştu: ${error.message}`, true);
        }
      }

      // --- Sayfalandırma Fonksiyonları ---
      function updateRowsPerPage() {
          // Ekran genişliğine göre sayfa başına gösterilecek proje sayısını ayarla
          if (window.innerWidth <= 576) { // Mobil cihazlar için
              rowsPerPage = 8;
          } else { // Masaüstü ve tabletler için
              rowsPerPage = 10;
          }
      }

      function updatePagination(totalItems, currentP, totalP) {
          totalProjectsCountSpan.textContent = totalItems;
          currentPageSpan.textContent = currentP;
          totalPagesSpan.textContent = totalP;

          prevPageButton.disabled = currentP === 1;
          nextPageButton.disabled = currentP === totalP || totalP === 0;

          pageNumbersContainer.innerHTML = '';
          // Sadece mevcut sayfa etrafında birkaç numara göster
          const maxPageButtons = 5;
          let startPage = Math.max(1, currentP - Math.floor(maxPageButtons / 2));
          let endPage = Math.min(totalP, startPage + maxPageButtons - 1);

          if (endPage - startPage + 1 < maxPageButtons) {
              startPage = Math.max(1, endPage - maxPageButtons + 1);
          }

          for (let i = startPage; i <= endPage; i++) {
              const pageButton = document.createElement('button');
              pageButton.className = `page-btn ${i === currentP ? 'active' : ''}`;
              pageButton.textContent = i;
              pageButton.addEventListener('click', () => {
                  currentPage = i;
                  renderProjectsTable(filteredProjects);
              });
              pageNumbersContainer.appendChild(pageButton);
          }
      }
      
      // Sayfalandırma butonları olay dinleyicileri
      prevPageButton.addEventListener('click', () => {
          if (currentPage > 1) {
              currentPage--;
              renderProjectsTable(filteredProjects);
          }
      });

      nextPageButton.addEventListener('click', () => {
          if (currentPage < Math.ceil(filteredProjects.length / rowsPerPage)) {
              currentPage++;
              renderProjectsTable(filteredProjects);
          }
      });

      // Sadece okunmamış bildirim sayısını çeken fonksiyon
      async function fetchUnreadNotificationCount() {
          const notificationButton = document.getElementById('notificationButton');
          try {
              // API rotası düzeltildi: /api/notifications/unread/count -> /api/notifications/unread-count
              const response = await fetch(`${API_BASE_URL}/api/notifications/unread-count`);
              if (!response.ok) {
                  // 404 durumunda özel mesaj ve sayacı sıfırla
                  if (response.status === 404) {
                      console.warn('API endpoint not found: /api/notifications/unread-count. Setting notification count to 0.');
                      notificationButton.setAttribute('data-count', '0');
                      notificationButton.classList.remove('has-notifications');
                      return; // Hata fırlatma, sadece logla ve çık
                  }
                  // Diğer HTTP hataları için genel hata fırlatma
                  const errorText = await response.text(); // Yanıtı metin olarak oku
                  throw new Error(`Okunmamış bildirim sayısı çekilemedi. Sunucu yanıtı: ${response.status} - ${errorText.substring(0, 100)}...`);
              }
              const data = await response.json();
              const unreadCount = data.unread_count; // 'count' yerine 'unread_count' kullanıldı

              notificationButton.setAttribute('data-count', unreadCount);
              if (unreadCount > 0) {
                  notificationButton.classList.add('has-notifications');
              } else {
                  notificationButton.classList.remove('has-notifications');
              }
          } catch (error) {
              console.error('Okunmamış bildirim sayısı çekilemedi:', error);
              notificationButton.setAttribute('data-count', '!'); // Hata durumunda ünlem göster
              showToast(`Bildirim sayısı yüklenirken hata oluştu: ${error.message}`, true);
          }
      }

      // Bildirimleri çekme ve panele render etme fonksiyonu (panel açıldığında çağrılır)
      async function fetchNotifications() {
          const notificationListDiv = document.getElementById('notificationList');
          notificationListDiv.innerHTML = '<div class="no-notifications">Bildirimler yükleniyor...</div>'; // Yükleniyor mesajı

          try {
              // API rotası doğru: /api/notifications
              const response = await fetch(`${API_BASE_URL}/api/notifications`);
              if (!response.ok) {
                  if (response.status === 404) {
                      notificationListDiv.innerHTML = '<div class="no-notifications">Henüz yeni bildiriminiz yok.</div>';
                      document.getElementById('notificationButton').setAttribute('data-count', '0');
                      document.getElementById('notificationButton').classList.remove('has-notifications');
                      return;
                  }
                  const errorText = await response.text(); // Yanıtı metin olarak oku
                  throw new Error(`HTTP error! status: ${response.status} - ${errorText.substring(0, 100)}...`);
              }
              const notifications = await response.json();
              renderNotifications(notifications); // Sayacı tekrar senkronize et
              fetchUnreadNotificationCount();
          } catch (error) {
              console.error('Bildirimler çekilemedi:', error);
              notificationListDiv.innerHTML = '<div class="no-notifications" style="color: var(--danger);">Bildirimler yüklenemedi.</div>';
              showToast(`Bildirimler yüklenirken hata oluştu: ${error.message}`, true);
          }
      }

      // Bildirimleri panele render etme function
      function renderNotifications(notifications) {
          const notificationListDiv = document.getElementById('notificationList');
          const notificationButton = document.getElementById('notificationButton');
          notificationListDiv.innerHTML = '';
          if (notifications.length === 0) {
              notificationListDiv.innerHTML = '<div class="no-notifications">Henüz yeni bildiriminiz yok.</div>';
              notificationButton.setAttribute('data-count', '0');
              notificationButton.classList.remove('has-notifications');
              return;
          }

          let unreadCount = 0;
          // Sadece ilk 10 bildirimi göster (veya istediğiniz sayıda)
          const displayNotifications = notifications.slice(0, 10); // Limit to 10 for display

          displayNotifications.forEach(notification => {
              const notificationItem = document.createElement('div');
              notificationItem.classList.add('notification-item');
              if (notification.is_read === 0) { // is_read 0 ise okunmamış
                  notificationItem.classList.add('unread');
                  unreadCount++;
              }
              notificationItem.setAttribute('data-id', notification.id); // Bildirim ID'sini sakla

              // Bildirim tipine göre ikon ve renk (bu kısım backend'den gelmiyor, varsayılan bir mantık)
              // Backend'den `type` alanı gelmediği için, bu kısmı şimdilik sabit tutuyorum
              // Eğer backend'den `type` alanı gelirse, burayı dinamik hale getirebilirsiniz.
              let iconClass = 'fas fa-info-circle';
              let iconBgColor = 'rgba(9, 128, 211, 0.1)';
              let iconColor = 'var(--primary-light)';

              // Zaman farkını hesapla
              const now = new Date();
              const createdAt = new Date(notification.created_at);
              const seconds = Math.floor((now - createdAt) / 1000);

              let timeAgo;
              if (seconds < 60) {
                  timeAgo = `${seconds} saniye önce`;
              } else if (seconds < 3600) {
                  timeAgo = `${Math.floor(seconds / 60)} dakika önce`;
              } else if (seconds < 86400) {
                  timeAgo = `${Math.floor(seconds / 3600)} saat önce`;
              } else if (seconds < 2592000) { // 30 gün
                  timeAgo = `${Math.floor(seconds / 86400)} gün önce`;
              } else if (seconds < 31536000) { // 365 gün
                  timeAgo = `${Math.floor(seconds / 2592000)} ay önce`;
              } else {
                  timeAgo = `${Math.floor(seconds / 31536000)} yıl önce`;
              }

              notificationItem.innerHTML = `
                  <div class="notification-item-icon" style="background-color: ${iconBgColor}; color: ${iconColor};">
                      <i class="${iconClass}"></i>
                  </div>
                  <div class="notification-item-content">
                      <div class="notification-item-title">${notification.title}</div>
                      <div class="notification-item-description">${notification.message}</div>
                      <div class="notification-item-time">${timeAgo}</div>
                  </div>
              `;
              // API rotası düzeltildi: /api/notifications/{id}/mark_read -> /api/notifications/{id}/read
              notificationItem.addEventListener('click', () => markNotificationAsRead(notification.id));
              notificationListDiv.appendChild(notificationItem);
          });

          notificationButton.setAttribute('data-count', unreadCount);
          if (unreadCount > 0) {
              notificationButton.classList.add('has-notifications');
          } else {
              notificationButton.classList.remove('has-notifications');
          }
      }

      // Tek bir bildirimi okundu olarak işaretleme fonksiyonu
      async function markNotificationAsRead(notificationId) {
          try {
              // API rotası düzeltildi: /api/notifications/{id}/mark_read -> /api/notifications/{id}/read
              const response = await fetch(`${API_BASE_URL}/api/notifications/${notificationId}/read`, {
                  method: 'PUT',
                  headers: {
                      'Content-Type': 'application/json'
                  }
              });
              if (response.ok) {
                  // Bildirim panelini ve sayacı güncelle
                  fetchNotifications();
                  fetchUnreadNotificationCount();
              } else {
                  const errorText = await response.text(); // Yanıtı metin olarak oku
                  console.error('Bildirim okunmuş olarak işaretlenirken hata:', errorText, 'HTTP Durumu:', response.status);
                  showToast(`Bildirim okunmuş olarak işaretlenirken hata oluştu. Sunucu yanıtı: ${response.status} - ${errorText.substring(0, 100)}...`, true);
              }
          } catch (error) {
              console.error('Bildirim okunmuş olarak işaretlenirken ağ hatası:', error);
              showToast('Bildirim okunmuş olarak işaretlenirken ağ hatası oluştu.', true);
          }
      }

      // Tüm Bildirimleri Okundu Olarak İşaretle fonksiyonu
      async function markAllNotificationsAsRead() {
          console.log('markAllNotificationsAsRead çağrıldı.');
          try {
              // API rotası doğru: /api/notifications/mark_all_read
              const response = await fetch(`${API_BASE_URL}/api/notifications/mark_all_read`, {
                  method: 'PUT',
                  headers: {
                      'Content-Type': 'application/json'
                  }
              });
              console.log('API Yanıtı (Tümünü Okundu):', response);
              if (response.ok) {
                  const result = await response.json();
                  showToast(result.message || 'Tüm bildirimler okunmuş olarak işaretlendi.', false);
                  fetchNotifications(); // Bildirim listesini yenile
                  fetchUnreadNotificationCount(); // Sayacı yenile
              } else {
                  const errorText = await response.text(); // Yanıtı metin olarak oku
                  console.error('Tüm bildirimleri okundu olarak işaretlerken hata:', errorText, 'HTTP Durumu:', response.status);
                  showToast(`Tüm bildirimleri okundu olarak işaretlerken hata oluştu. Sunucu yanıtı: ${response.status} - ${errorText.substring(0, 100)}...`, true);
              }
          } catch (error) {
              console.error('Tüm bildirimleri okundu olarak işaretlerken ağ hatası:', error);
              showToast('Tüm bildirimleri okundu olarak işaretlerken ağ hatası oluştu.', true);
          }
      }


      // Event listeners for page load and button clicks
      document.addEventListener("DOMContentLoaded", () => {
        fetchProjects(); // Sayfa yüklendiğinde projeleri çek

        // Filtreleme butonları
        const filterBtn = document.getElementById("filterBtn");
        const filtersContainer = document.getElementById("filtersContainer");
        filterBtn.addEventListener("click", () => {
          filtersContainer.style.display =
            filtersContainer.style.display === "none" ? "grid" : "none"; // 'block' yerine 'grid' kullanıldı
        });

        document.getElementById("refreshData").addEventListener("click", () => {
          fetchProjects();
          showToast("Proje verileri yenilendi.");
        });

        // exportAllPdf butonu için sadece burada olay dinleyicisi ekleniyor.
        // Aşağıdaki tekrar eden kısım kaldırıldı.
        document.getElementById("exportAllPdf").addEventListener("click", async function() {
            const hasPermission = await checkPermission('pdf_olusturma');
            if (!hasPermission) return;
            exportAllProjectsToPdf();
        });

        // Genel arama inputu
        document.getElementById("searchInput").addEventListener("keyup", applyFiltersAndRenderTable);

        // Filtre inputlarına keyup ve change event'leri
        document
          .getElementById("filterProjectName")
          .addEventListener("keyup", applyFiltersAndRenderTable);
        document
          .getElementById("filterRefNo")
          .addEventListener("keyup", applyFiltersAndRenderTable);
        document
          .getElementById("filterCustomer")
          .addEventListener("keyup", applyFiltersAndRenderTable);
        document
          .getElementById("filterStatus")
          .addEventListener("change", applyFiltersAndRenderTable);

        // Filtreleri sıfırlama
        document.getElementById("resetFilters").addEventListener("click", () => {
          document.getElementById("filterProjectName").value = "";
          document.getElementById("filterRefNo").value = "";
          document.getElementById("filterCustomer").value = "";
          document.getElementById("filterStatus").value = "";
          document.getElementById("searchInput").value = ""; // Global aramayı da sıfırla
          applyFiltersAndRenderTable();
          showToast("Filtreler sıfırlandı.");
        });
      });

      function applyFiltersAndRenderTable() {
        const searchTerm = document.getElementById("searchInput").value.toLowerCase();
        const filterProjectName = document.getElementById("filterProjectName").value.toLowerCase();
        const filterRefNo = document.getElementById("filterRefNo").value.toLowerCase();
        const filterCustomer = document.getElementById("filterCustomer").value.toLowerCase();
        const filterStatus = document.getElementById("filterStatus").value; // Durum direkt string

        filteredProjects = allProjectsData.filter((project) => {
          const matchesSearch =
            (project.project_name &&
              project.project_name.toLowerCase().includes(searchTerm)) ||
            (project.reference_no &&
              project.reference_no.toLowerCase().includes(searchTerm)) ||
            (project.customer_name &&
              project.customer_name.toLowerCase().includes(searchTerm)) ||
            (project.project_location &&
              project.project_location.toLowerCase().includes(searchTerm));

          const matchesFilters =
            (filterProjectName === "" ||
              (project.project_name &&
                project.project_name.toLowerCase().includes(filterProjectName))) &&
            (filterRefNo === "" ||
              (project.reference_no &&
                project.reference_no.toLowerCase().includes(filterRefNo))) &&
            (filterCustomer === "" ||
              (project.customer_name &&
                project.customer_name.toLowerCase().includes(filterCustomer))) &&
            (filterStatus === "" || project.status === filterStatus);

          return matchesSearch && matchesFilters;
        });
        currentPage = 1; // Filtreler değiştiğinde ilk sayfaya dön
        renderProjectsTable(filteredProjects);
      }

function uint8ToBase64(uint8) {
  let CHUNK_SIZE = 0x8000; // 32KB
  let index = 0;
  let length = uint8.length;
  let result = '';
  let slice;
  while (index < length) {
    slice = uint8.subarray(index, Math.min(index + CHUNK_SIZE, length));
    result += String.fromCharCode.apply(null, slice);
    index += CHUNK_SIZE;
  }
  return btoa(result);
}

// 1. Yardımcı fonksiyon: Kullanıcı rolünü al
function getCurrentUserRole() {
    if (typeof currentUser !== 'undefined' && currentUser && currentUser.role) {
        return currentUser.role;
    } else {
        const storedUser = localStorage.getItem('currentUser');
        if (storedUser) {
            try {
                const user = JSON.parse(storedUser);
                return user.role;
            } catch (e) { return null; }
        }
    }
    return null;
}

// 2. Yardımcı fonksiyon: Yetki kontrolü
async function checkPermission(permissionKey) {
    const role = getCurrentUserRole();
    if (!role) {
        showToast('Kullanıcı rolü bulunamadı. Lütfen tekrar giriş yapın.', true);
        return false;
    }
    // Admin rolü için tüm yetkileri varsay
    if (role === 'Admin') {
        return true;
    }
    try {
        const response = await fetch(`${API_BASE_URL}/api/role-permissions?role=${encodeURIComponent(role)}`);
        if (!response.ok) throw new Error('Yetki sorgusu başarısız');
        const perms = await response.json();
        const permission = Array.isArray(perms) ? perms[0] : perms;
        if (permission[permissionKey] != 1) {
            let msg = '';
            if (permissionKey === 'pdf_olusturma') msg = 'PDF oluşturma yetkiniz yok!';
            else if (permissionKey === 'proje_duzenle') msg = 'Proje düzenleme yetkiniz yok!';
            else if (permissionKey === 'proje_sil') msg = 'Proje silme yetkiniz yok!';
            else msg = 'Bu işlem için yetkiniz yok!';
            showToast(msg, true);
            return false;
        }
        return true;
    } catch (error) {
        showToast('Yetki sorgusu sırasında hata oluştu.', true);
        return false;
    }
}


    </script>
  </body>
</html>
