<!DOCTYPE html>
<html lang="tr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ser Elektrik Otomasyon - Projeler</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
      :root {
        --primary: #005c9d;
        --primary-light: #0980d3;
        --white: #ffffff;
        --light-gray: #97a1aa;
        --dark-gray: #5e6870;
        --bg-color: #f8f9fa;
        --card-bg: #ffffff;
        --text-color: #333333;
        --input-bg: #f0f4f8;
        --border-color: #e1e5e9;
        --sidebar-bg: #ffffff;
        --topbar-bg: #ffffff;
        --success: #2ed573;
        --danger: #ff4757;
        --warning: #ffc107;
        --info: #0980d3;
      }

      [data-theme="dark"] {
        --bg-color: #121212;
        --card-bg: #1e1e1e;
        --text-color: #e0e0e0;
        --input-bg: #2d2d2d;
        --border-color: #3a3a3a;
        --sidebar-bg: #1a1a1a;
        --topbar-bg: #1a1a1a;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        transition: background-color 0.3s, color 0.3s;
      }

      body {
        background-color: var(--bg-color);
        color: var(--text-color);
        display: flex;
        min-height: 100vh;
        overflow-x: hidden;
      }
/* Checkbox Stilleri */
.checkbox-wrapper-46 {
    margin-right: 15px;
    display: flex;
    align-items: center;
}

.checkbox-wrapper-46 input[type="checkbox"] {
    display: none;
    visibility: hidden;
}

.checkbox-wrapper-46 .cbx {
    -webkit-user-select: none;
    user-select: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    margin: 0;
}

.checkbox-wrapper-46 .cbx span:first-child {
    position: relative;
    width: 18px;
    height: 18px;
    border-radius: 3px;
    transform: scale(1);
    vertical-align: middle;
    border: 1px solid #9098a9;
    transition: all 0.2s ease;
    margin-right: 8px;
}

.checkbox-wrapper-46 .cbx span:first-child svg {
    position: absolute;
    top: 3px;
    left: 2px;
    fill: none;
    stroke: #ffffff;
    stroke-width: 2;
    stroke-linecap: round;
    stroke-linejoin: round;
    stroke-dasharray: 16px;
    stroke-dashoffset: 16px;
    transition: all 0.3s ease;
    transition-delay: 0.1s;
    transform: translate3d(0, 0, 0);
}

.checkbox-wrapper-46 .cbx:hover span:first-child {
    border-color: #0980d3;
}

.checkbox-wrapper-46 .inp-cbx:checked + .cbx span:first-child {
    background: #0980d3;
    border-color: #0980d3;
    animation: wave-46 0.4s ease;
}

.checkbox-wrapper-46 .inp-cbx:checked + .cbx span:first-child svg {
    stroke-dashoffset: 0;
}

.checkbox-wrapper-46 .inp-cbx:checked + .cbx span:first-child:before {
    transform: scale(3.5);
    opacity: 0;
    transition: all 0.6s ease;
}

@keyframes wave-46 {
    50% {
        transform: scale(0.9);
    }
}

/* Mevcut stillerle uyumluluk için */
.progress-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
    margin-top: 10px;
    padding-top: 10px;
    border-top: 1px solid #eee;
}

.action-btn {
    margin-left: 5px;
    padding: 5px 10px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
}

.action-btn i {
    margin-right: 5px;
}
      /* Hamburger menü butonu */
      .hamburger-menu {
          display: none; /* Varsayılan olarak gizli */
          background-color: var(--primary);
          color: var(--white);
          border: none;
          border-radius: 8px;
          padding: 10px 12px;
          cursor: pointer;
          font-size: 20px;
          box-shadow: 0 2px 10px rgba(0,0,0,0.2);
          margin-right: 15px; /* Sağında boşluk bırak */
          flex-shrink: 0; /* Küçülmesini engelle */
      }

      .sidebar {
        width: 260px;
        background-color: var(--sidebar-bg);
        border-right: 1px solid var(--border-color);
        height: 100vh;
        position: fixed;
        overflow-y: auto;
        padding: 20px 0;
        z-index: 1000;
        transform: translateX(0); /* Masaüstünde görünür */
        transition: transform 0.3s ease-in-out;
      }

      .sidebar.show { /* Mobil görünümde açıldığında */
          transform: translateX(0);
      }
      .sidebar.hidden { /* Mobil görünümde gizli */
          transform: translateX(-100%);
      }

      .logo-container {
        display: flex;
        align-items: center;
        padding: 0 20px 25px 20px;
        border-bottom: 1px solid var(--border-color);
        margin-bottom: 25px;
      }

      .logo-icon {
        background: linear-gradient(135deg, var(--primary), var(--primary-light));
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--white);
        font-size: 20px;
        margin-right: 12px;
      }

      .logo-text {
        font-size: 20px;
        font-weight: 700;
        color: var(--primary);
      }

      .nav-item {
        padding: 12px 25px;
        display: flex;
        align-items: center;
        color: var(--text-color);
        text-decoration: none;
        border-left: 3px solid transparent;
        margin-bottom: 5px;
        transition: all 0.2s;
      }

      .nav-item:hover,
      .nav-item.active {
        background-color: rgba(9, 128, 211, 0.1);
        border-left-color: var(--primary-light);
        color: var(--primary-light);
      }

      .nav-item i {
        font-size: 18px;
        margin-right: 15px;
        width: 24px;
        text-align: center;
      }

      .main-content {
        flex: 1;
        margin-left: 260px; /* Sidebar genişliği kadar boşluk */
        transition: margin-left 0.3s ease-in-out;
        width: calc(100% - 260px); /* Kalan genişliği kapla */
      }
      .main-content.expanded {
          margin-left: 0; /* Sidebar gizlendiğinde boşluk sıfırla */
          width: 100%;
      }

      .topbar {
        background-color: var(--topbar-bg);
        border-bottom: 1px solid var(--border-color);
        padding: 15px 30px; /* Takvim.html ile aynı padding */
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: sticky;
        top: 0;
        z-index: 100;
        flex-wrap: nowrap; /* Masaüstünde sarmalamayı engelle */
        gap: 15px; /* Öğeler arası boşluk */
      }

      .search-container {
        position: relative;
        width: 300px; /* Takvim.html ile aynı genişlik */
        flex-grow: 1; /* Esnek genişlik */
        margin-right: 15px; /* Takvim.html ile aynı margin */
      }

      .search-container input {
        width: 100%;
        padding: 10px 15px 10px 40px;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        background-color: var(--input-bg);
        color: var(--text-color);
        font-size: 14px; /* Takvim.html ile aynı font-size */
      }

      .search-container i {
        position: absolute;
        left: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--light-gray);
        font-size: 16px; /* Takvim.html ile aynı font-size */
      }

      .topbar-actions {
        display: flex;
        align-items: center;
        gap: 20px; /* Takvim.html ile aynı gap */
        margin-left: auto; /* Masaüstünde sağa it */
        flex-shrink: 0; /* Küçülmesini engelle */
      }

      .notification-btn,
      .theme-toggle {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: var(--input-bg);
        color: var(--text-color);
        cursor: pointer;
        position: relative;
        flex-shrink: 0;
        font-size: 18px; /* Takvim.html ile aynı font-size */
      }

      .notification-btn::after {
        content: attr(data-count); /* JS ile dinamik olarak güncellenecek */
        position: absolute;
        top: 5px;
        right: 5px;
        background-color: #ff4757;
        color: white;
        font-size: 10px;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        /* Başlangıçta gizli, bildirim varsa gösterilecek */
        opacity: 0;
        transform: scale(0);
        transition: all 0.2s ease-out;
      }
      .notification-btn.has-notifications::after {
          opacity: 1;
          transform: scale(1);
      }

      .user-profile {
        display: flex;
        align-items: center;
        gap: 12px;
        cursor: pointer;
        flex-shrink: 0;
      }

      .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--primary), var(--primary-light));
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--white);
        font-weight: 600;
        font-size: 16px; /* Takvim.html ile aynı font-size */
      }

      .user-info {
        display: flex;
        flex-direction: column;
      }

      .user-name {
        font-weight: 600;
        font-size: 15px;
      }

      .user-role {
        font-size: 13px;
        color: var(--light-gray);
      }

      /* Tek Çıkış Butonu Stilleri */
      .logout-btn {
          display: flex; /* Varsayılan olarak masaüstünde görünür */
          align-items: center;
          justify-content: center;
          padding: 10px 20px; /* Takvim.html ile aynı padding */
          border-radius: 10px;
          font-size: 15px;
          font-weight: 600;
          gap: 8px;
          transition: all 0.3s ease;
          background: transparent;
          border: 1px solid var(--primary-light);
          color: var(--primary-light);
          margin-left: 10px; /* Masaüstünde sağa boşluk */
      }

      .logout-btn:hover {
          background-color: var(--primary); /* Takvim.html'deki gibi hover rengi */
          color: var(--white); /* Takvim.html'deki gibi yazı rengi */
          transform: translateY(-2px);
          box-shadow: 0 6px 20px rgba(0,0,0,0.2); /* Takvim.html'deki gibi gölge */
      }

      .projects-content {
        padding: 30px;
      }

      .page-title {
        font-size: 28px;
        margin-bottom: 25px;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .page-title i {
        color: var(--primary-light);
      }

      .filters-container {
        background-color: var(--card-bg);
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        padding: 20px;
        margin-bottom: 30px;
        display: none;
      }

      .filters-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
      }

      .filter-title {
        font-weight: 600;
        font-size: 18px;
      }

      .filter-reset {
        color: var(--primary-light);
        font-size: 14px;
        cursor: pointer;
      }

      .filter-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
      }

      .filter-group {
        margin-bottom: 15px;
      }

      .filter-label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: var(--text-color);
      }

      .filter-input {
        width: 100%;
        padding: 10px 15px;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        background-color: var(--input-bg);
        color: var(--text-color);
      }

      .projects-container {
        background-color: var(--card-bg);
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        overflow: hidden;
        margin-bottom: 30px;
      }

      .projects-header {
        padding: 15px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid var(--border-color);
        flex-wrap: wrap; /* Mobil görünümde alt alta gelmesi için */
        gap: 15px; /* Öğeler arası boşluk */
      }

      .projects-actions {
        display: flex;
        gap: 15px;
        flex-wrap: wrap; /* Mobil görünümde alt alta gelmesi için */
        justify-content: flex-end; /* Sağ tarafa hizala */
      }

      .btn {
        padding: 8px 15px;
        border-radius: 8px;
        border: none;
        background: linear-gradient(to right, var(--primary), var(--primary-light));
        color: var(--white);
        font-weight: 500;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.2s;
      }

      .btn-outline {
        background: transparent;
        border: 1px solid var(--primary-light);
        color: var(--primary-light);
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(9, 128, 211, 0.3);
      }

      /* Genel buton stilini biraz iyileştirebiliriz */
      .btn, .modal-btn {
          padding: 10px 20px; /* Buton padding'ini artır */
          border-radius: 10px; /* Daha yuvarlak köşeler */
          font-size: 15px; /* Yazı boyutunu biraz büyüt */
          font-weight: 600; /* Daha belirgin yazı */
          display: inline-flex; /* İçerik sığmasa bile düzgün hizalama */
          align-items: center;
          justify-content: center;
          gap: 8px; /* İkon ve yazı arası boşluk */
          transition: all 0.3s ease; /* Daha yumuşak geçişler */
      }

      /* Aksiyon butonları (tablo içindeki küçük butonlar) */
      .action-btn {
          width: auto; /* Genişliği içeriğe göre ayarla */
          min-width: 38px; /* Minimum genişlik */
          height: 38px; /* Yüksekliği artır */
          padding: 0 10px; /* Yatay padding ekle */
          border-radius: 10px; /* Daha yuvarlak */
          font-size: 16px; /* İkon boyutunu büyüt */
          display: inline-flex;
          align-items: center;
          justify-content: center;
          transition: all 0.2s ease-in-out;
          background-color: var(--input-bg); /* Hafif arkaplan */
          color: var(--text-color);
          border: 1px solid var(--border-color); /* Hafif border */
          box-shadow: 0 2px 5px rgba(0,0,0,0.05);
          cursor: pointer;
      }

      .action-btn:hover {
          background-color: var(--primary-light); /* Hover'da daha belirgin renk */
          color: var(--white); /* Yazı rengi beyaz olsun */
          box-shadow: 0 4px 12px rgba(9, 128, 211, 0.2); /* Daha belirgin gölge */
          transform: translateY(-1px) scale(1.02); /* Hafif kalkma efekti */
          border-color: var(--primary-light);
      }

      /* Progress actions içindeki butonlar (Kaydet/Sil) */
      .progress-actions .action-btn {
          min-width: 80px; /* "Kaydet" ve "Sil" gibi butonlar için daha fazla alan */
          height: 38px; /* Yüksekliği koru */
          font-size: 14px; /* Yazı boyutu */
          font-weight: 500;
          gap: 5px; /* İkon ve yazı arası boşluk */
      }

      .progress-actions .save-progress-btn {
          background: linear-gradient(to right, var(--success), #28a745); /* Yeşil gradient */
          color: var(--white);
          border: none;
      }

      .progress-actions .save-progress-btn:hover {
          background: linear-gradient(to right, #28a745, #218838); /* Daha koyu yeşil */
          box-shadow: 0 4px 12px rgba(46, 213, 115, 0.3);
      }

      .progress-actions .delete-progress-btn {
          background-color: var(--danger); /* Direkt kırmızı arkaplan */
          color: var(--white);
          border: none;
      }

      .progress-actions .delete-progress-btn:hover {
          background-color: #dc3545; /* Daha koyu kırmızı */
          box-shadow: 0 4px 12px rgba(255, 71, 87, 0.3);
      }

      /* Modaldaki İptal butonu */
      .modal-btn-cancel {
          background-color: var(--light-gray); /* Gri arkaplan */
          color: var(--white);
          border: none;
      }

      .modal-btn-cancel:hover {
          background-color: var(--dark-gray);
          box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      }

      .table-container {
        overflow-x: auto;
      }
      .projects-table {
        width: 100%;
        border-collapse: collapse;
      }

      .projects-table th {
        text-align: left;
        padding: 15px 20px;
        background-color: rgba(9, 128, 211, 0.05);
        color: var(--light-gray);
        font-weight: 500;
        border-bottom: 1px solid var(--border-color);
      }

      .projects-table td {
        padding: 15px 20px;
        border-bottom: 1px solid var(--border-color);
        vertical-align: middle;
        color: var(--text-color); /* Metin rengini temaya göre ayarla */
      }

      .projects-table tr {
        transition: background-color 0.2s;
      }

      .projects-table tr:hover {
        background-color: rgba(9, 128, 211, 0.05);
      }

      .status-badge {
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 500;
        display: inline-block;
      }

      /* Yeni durumlar için renk tanımları */
      .status-badge.gecikmeli {
        background-color: rgba(255, 71, 87, 0.1); /* Kırmızı tonu */
        color: #ff4757;
        border: 1px dashed #ff4757;
      }

      .status-badge.normal {
        background-color: rgba(46, 213, 115, 0.1); /* Yeşil tonu */
        color: #2ed573;
      }

      .status-badge.tamamlandı {
        background-color: rgba(9, 128, 211, 0.1); /* Mavi tonu */
        color: var(--primary-light);
      }

      /* Modal CSS - Genel Modal Stilleri */
      .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 2000;
        overflow-y: auto;
      }

      .modal-content {
        background: var(--card-bg);
        padding: 30px;
        border-radius: 12px;
        width: 800px;
        max-width: 95%; /* Mobil uyumluluk için */
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        overflow-y: auto;
        max-height: 90vh;
        margin: auto;
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid var(--border-color);
      }

      .modal-title {
        font-size: 24px;
        color: var(--primary);
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .modal-title i {
        color: var(--primary-light);
      }

      .close-modal-btn {
        background: none;
        border: none;
        font-size: 28px;
        cursor: pointer;
        color: var(--light-gray);
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: var(--text-color);
      }

      .form-input {
        width: 100%;
        padding: 12px 15px;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        background-color: var(--input-bg);
        color: var(--text-color);
        font-size: 16px;
      }
      .form-input:disabled {
        background-color: var(--border-color);
        opacity: 0.7;
        cursor: not-allowed;
      }

      .form-actions {
        display: flex;
        justify-content: flex-end;
        gap: 15px;
        margin-top: 20px;
      }

      .modal-btn {
        padding: 10px 20px;
        border-radius: 8px;
        border: none;
        background: linear-gradient(to right, var(--primary), var(--primary-light));
        color: var(--white);
        font-weight: 500;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.2s;
      }

      .modal-btn-cancel {
        background: var(--input-bg);
        color: var(--text-color);
        border: 1px solid var(--border-color);
      }
      .modal-btn-cancel:hover {
        background-color: var(--border-color);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .modal-btn-save {
        background: linear-gradient(to right, var(--primary), var(--primary-light));
        color: var(--white);
      }
      .modal-btn-save:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(9, 128, 211, 0.3);
      }

      /* Detail View Specifics */
      .detail-item {
        display: flex;
        flex-wrap: wrap;
        margin-bottom: 15px;
        align-items: baseline;
      }
      .detail-label {
        font-weight: 600;
        color: var(--dark-gray);
        width: 150px;
        flex-shrink: 0;
        margin-right: 15px;
      }
      .detail-value {
        flex-grow: 1;
        color: var(--text-color);
      }
      .detail-value .status-badge {
        margin-left: 0;
      }

      .progress-detail-section {
        margin-top: 30px;
        border-top: 1px solid var(--border-color);
        padding-top: 20px;
      }

      /* Dropdown Styles */
      .header-select-wrapper {
        margin-bottom: 15px;
        width: 100%;
      }

      .select-container {
        position: relative;
        width: 100%;
      }

      .select-arrow {
        position: absolute;
        top: 50%;
        right: 15px;
        transform: translateY(-50%);
        pointer-events: none;
        color: #6c757d;
        transition: transform 0.2s ease;
        z-index: 2;
      }

      .header-dropdown, #newStepHeader {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        background-color: var(--input-bg);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        padding: 10px 40px 10px 15px;
        font-size: 14px;
        color: var(--text-color);
        width: 100%;
        height: 42px;
        transition: all 0.2s ease;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        background-image: none;
      }

      .header-dropdown:focus, #newStepHeader:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.15);
        outline: none;
      }

      .header-dropdown:hover, #newStepHeader:hover {
        border-color: var(--primary-hover);
      }

      .header-dropdown option, #newStepHeader option {
        padding: 10px;
        background: var(--card-bg);
        color: var(--text-color);
      }

      .header-dropdown:focus + .select-arrow, #newStepHeader:focus + .select-arrow {
        transform: translateY(-50%) rotate(180deg);
        color: var(--primary-color);
      }

      .form-label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: var(--text-muted);
        font-size: 13px;
      }

      /* Dark Mode Specific Styles */
      [data-theme="dark"] .header-dropdown,
      [data-theme="dark"] #newStepHeader {
        background-color: var(--input-bg);
        border-color: var(--border-color);
        color: var(--text-color);
      }

      [data-theme="dark"] .header-dropdown:focus,
      [data-theme="dark"] #newStepHeader:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.15);
      }

      [data-theme="dark"] .select-arrow {
        color: var(--text-muted);
      }

      /* Readonly field styling */
      .readonly-field {
        background-color: var(--input-disabled-bg) !important;
        cursor: not-allowed;
        opacity: 0.8;
      }

      /* Completed step styling */
      .progress-detail-item.completed-step {
        opacity: 0.9;
        background-color: rgba(40, 167, 69, 0.05);
        border-left: 3px solid #28a745;
      }

      .progress-detail-item.completed-step .progress-detail-title {
        color: #28a745;
        font-weight: 600;
      }

      .progress-detail-item.completed-step .progress-dates {
        color: #6c757d;
      }

      .progress-detail-item {
        background-color: var(--input-bg);
        border-radius: 8px;
        padding: 15px 20px;
        margin-bottom: 10px;
        border-left: 4px solid var(--primary-light);
        display: block; /* İçindeki flex kutularına izin vermek için */
      }
      .progress-detail-title {
        font-weight: 600;
        margin-bottom: 5px;
      }
      .progress-detail-dates {
        font-size: 0.9em;
        color: var(--light-gray);
        margin-bottom: 5px;
      }
      .progress-detail-description {
        font-size: 0.95em;
        color: var(--text-color);
      }
      .progress-delay {
        color: var(--danger);
        font-weight: 600;
        margin-left: 10px;
      }

      /* Yeni İş Gidişatı Tasarımı İçin Ek CSS */
      .progress-item-header {
        display: flex;
        align-items: center;
        gap: 15px; /* Başlık ve tarihler arası boşluk */
        margin-bottom: 10px;
        flex-wrap: wrap; /* Küçük ekranlarda alta geçsin */
      }

      .progress-item-header .input-group {
        flex: 1; /* Başlık inputu genişlesin */
        min-width: 200px; /* Minimum genişlik */
        margin-bottom: 0; /* Üstteki .form-group'un margin'ini ezer */
      }

      .progress-item-header .input-group label {
        margin-bottom: 5px; /* Label ile input arası boşluk */
        color: var(--text-color); /* Burası güncellendi */
        font-weight: 500;
      }

      .progress-item-header .input-group input[type="text"],
      .progress-item-header .input-group input[type="date"] {
        padding: 8px 12px;
        border-radius: 6px;
        border: 1px solid var(--border-color);
        background-color: var(--input-bg);
        color: var(--text-color);
        width: 100%; /* Kendi grubunda tam genişlik */
      }

      .progress-dates {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
      }

      .progress-dates span {
        display: flex;
        align-items: center;
        gap: 5px;
        color: var(--text-color); /* Burası güncellendi */
        flex-direction: column; /* Label ve input alt alta */
        align-items: flex-start; /* Sola hizala */
      }
      
      .progress-dates span label {
          margin-bottom: 5px;
          color: var(--text-color); /* Burası güncellendi */
          font-weight: 500;
      }
       .progress-dates .date-display {
        font-size: 0.9em;
        color: var(--text-color);
      }
       .custom-delay-info {
        color: #ff6b6b;
        margin-top: 8px;
        font-weight: bold;
        font-style: italic;
        padding: 8px;
        background-color: rgba(255, 107, 107, 0.1);
        border-left: 3px solid #ff6b6b;
        border-radius: 3px;
      }

      .delay-days-container {
        display: flex; /* Flexbox kullanarak öğeleri aynı satırda hizala */
        align-items: center; /* Öğeleri dikeyde ortala */
        justify-content: space-between; /* Öğeleri iki yana yasla */
        gap: 10px; /* Öğeler arasında boşluk bırak */
        margin-top: 10px;
        background-color: var(--input-bg); /* Arka plan rengini temaya göre ayarla */
        padding: 10px;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        flex-wrap: wrap; /* Küçük ekranlarda sarmalamaya izin ver */
    }
    .delay-input-group { /* Erteleme inputu ve butonu için yeni grup */
        display: flex;
        align-items: center;
        gap: 10px;
    }

      .delay-days-container label {
        margin-right: 10px;
        font-weight: bold;
        color: var(--text-color);
      }

      .delay-days-input {
        flex-grow: 1;
        max-width: 100px;
        padding: 8px;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        background-color: var(--card-bg); /* Farklı bir arka plan rengi */
        color: var(--text-color);
        text-align: center; /* Sayıyı ortala */
    }

      .apply-delay-btn {
        background-color: #3498db;
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 6px;
        cursor: pointer;
        transition: background-color 0.2s;
      }
    .real-end-date-display {
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 0.9em;
        color: var(--text-color);
        white-space: nowrap; /* Metnin tek satırda kalmasını sağla */
    }

    .real-end-date-display label {
        margin-bottom: 0;
        font-weight: 500;
    }

      .apply-delay-btn:hover {
        background-color: #217dbb;
      }
       .delay-info {
        color: #ff9800;
        margin-top: 5px;
        font-style: italic;
        padding: 5px;
        background-color: rgba(255, 152, 0, 0.1);
        border-left: 3px solid #ff9800;
        border-radius: 3px;
      }
       .real-end-date-info {
        font-size: 0.85em;
        color: var(--light-gray); /* Daha soluk bir renk */
        margin-top: 2px;
        font-style: italic;
      }
      .progress-dates input.progress-datepicker {
        width: 130px; /* Tarih inputları için daha spesifik genişlik */
        padding: 8px 12px;
        border-radius: 6px;
        border: 1px solid var(--border-color);
        background-color: var(--input-bg);
        color: var(--text-color);
      }

      .progress-description-textarea {
        width: 100%;
        padding: 10px 15px;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        background-color: var(--input-bg);
        color: var(--text-color);
        min-height: 80px;
        resize: vertical;
      }

      .progress-actions {
        display: flex;
        justify-content: flex-end; /* Butonları sağa hizala */
        margin-top: 10px;
        gap: 10px;
      }

      .progress-actions .action-btn {
        padding: 6px 12px; /* Daha kompakt butonlar */
        border-radius: 6px;
        font-size: 14px;
      }

      .progress-actions .delete-progress-btn {
        background-color: rgba(255, 71, 87, 0.1);
        color: #ff4757;
        border: 1px solid #ff4757;
      }

      .progress-actions .delete-progress-btn:hover {
        background-color: #ff4757;
        color: var(--white);
      }

      /* PDF Report Content Styles (Inline used for html2canvas compatibility) */
      .pdf-report-content {
        font-family: "Segoe UI", Arial, sans-serif;
        padding: 20px;
        color: #333;
        background: #fff;
        box-sizing: border-box;
      }
      .pdf-header h1 {
        color: #005c9d;
        font-size: 28px;
        margin-bottom: 5px;
      }
      .pdf-header h2 {
        color: #0980d3;
        font-size: 22px;
        margin-bottom: 15px;
      }
      .pdf-info-table th,
      .pdf-info-table td {
        padding: 8px;
        border: 1px solid #e1e5e9;
        text-align: left;
      }
      .pdf-info-table th {
        background-color: #f0f4f8;
        color: #5e6870;
        width: 30%;
      }
      .pdf-section-title {
        color: #005c9d;
        border-bottom: 1px solid #e1e5e9;
        padding-bottom: 5px;
        margin-bottom: 15px;
      }
       .footer {
            text-align: center;
            padding: 20px;
            color: var(--light-gray);
            font-size: 14px;
            border-top: 1px solid var(--border-color);
            margin-top: 30px; /* Footer'ın üstünde boşluk bırak */
        }
      .pdf-footer {
        text-align: center;
        font-size: 12px;
        color: #6c757d;
        margin-top: 40px;
        border-top: 1px solid #eee;
        padding-top: 15px;
      }
      .pdf-delay-text {
        color: red;
        font-weight: bold;
      }
      .toast-success {
    background-color: #28a745 !important; /* Green for success */
}

.toast-error {
    background-color: #dc3545 !important; /* Red for error */
}
      /* Toast Message Styling (Fix for visual issues) */
      .toast {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background-color: #2ed573; /* Varsayılan yeşil renk */
        color: white;
        padding: 16px 24px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        display: flex;
        align-items: flex-start;
        gap: 12px;
        z-index: 10000;
        opacity: 0;
        transform: translateY(20px);
        transition: all 0.3s ease;
        max-width: 350px;
      }
      
      .toast-content {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }
      
      .toast .toast-title {
        font-weight: 600;
        font-size: 15px;
        line-height: 1.2;
      }
      
      .toast .toast-message {
        font-size: 14px;
        opacity: 0.9;
        line-height: 1.4;
      }

      .toast.show {
        opacity: 1;
        transform: translateY(0); /* Görünür olduğunda yerine gel */
        pointer-events: auto; /* Tıklamaları etkinleştir */
      }

      .toast.error {
        background-color: #ff4757; /* Kırmızı renk */
      }
      
      .toast.warning {
        background-color: #ffa502; /* Turuncu renk */
      }
      
      .toast.info {
        background-color: #1e90ff; /* Mavi renk */
      }
      
      .toast i {
        font-size: 20px;
        margin-top: 2px;
      }
      
      .toast.error i {
        color: #fff;
      }

      /* Pagination */
      .pagination {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 15px 20px;
          border-top: 1px solid var(--border-color);
          flex-wrap: wrap; /* Küçük ekranlarda sarmalamak için */
          gap: 10px; /* Elemanlar arası boşluk */
      }

      .pagination-info {
          font-size: 14px;
          color: var(--light-gray);
      }

      .pagination-controls {
          display: flex;
          gap: 10px;
          align-items: center;
      }

      #pageNumbers {
          display: flex;
          gap: 5px;
      }

      .page-btn {
          width: 36px;
          height: 36px;
          border-radius: 8px;
          display: flex;
          align-items: center;
          justify-content: center;
          background-color: var(--input-bg);
          color: var(--text-color);
          cursor: pointer;
          border: none;
          flex-shrink: 0;
      }

      .page-btn.active {
          background: linear-gradient(to right, var(--primary), var(--primary-light));
          color: var(--white);
      }

      .page-btn:hover:not(.active) {
          background-color: rgba(9, 128, 211, 0.1);
          color: var(--primary-light);
      }


      /* Responsive Medya Sorguları */
      @media (max-width: 992px) {
          .sidebar {
              width: 260px; /* Mobil görünümde açıkken genişlik */
              position: fixed; /* Mobil görünümde sabit */
              transform: translateX(-100%); /* Varsayılan olarak gizli */
              box-shadow: 0 0 20px rgba(0,0,0,0.3);
          }
          .sidebar.show {
              transform: translateX(0); /* Açıldığında görünür */
          }
          
          .logo-text, .nav-text {
              display: block; /* Mobil menü açıldığında görünür */
          }
          
          .logo-container {
              justify-content: flex-start;
              padding: 0 20px 25px 20px;
          }
          
          .logo-icon {
              margin-right: 12px;
          }
          
          .nav-item {
              justify-content: flex-start;
              padding: 12px 25px;
          }
          
          .nav-item i {
              margin-right: 15px;
          }
          
          .main-content {
              margin-left: 0; /* Mobil görünümde boşluk yok */
              width: 100%;
          }

          .hamburger-menu {
              display: block; /* Mobil görünümde göster */
              order: 1; /* Hamburger menü ilk sırada */
          }

          .topbar {
              flex-direction: row; /* Topbar için satır yönünü koru */
              justify-content: flex-start; /* Öğeleri başlangıca hizala */
              flex-wrap: wrap; /* Genel topbar içeriği için sarmalamaya izin ver */
              padding: 10px 15px; /* Mobil için daha küçük padding */
              align-items: center; /* Öğeleri dikeyde ortala */
              gap: 10px; /* Hamburger ve arama kutusu arasına boşluk */
          }

          .search-container {
              width: auto; /* Arama çubuğunun küçülmesine izin ver */
              flex-grow: 1; /* Kalan alanı kapla */
              order: 2; /* Hamburgerden sonra yerleştir */
              margin-left: 0; /* Önceki margin-left'i sıfırla */
              margin-right: 0; /* Takvim.html ile aynı margin */
          }

          .topbar-actions {
              width: auto; /* Otomatik genişlik */
              justify-content: flex-end; /* Aksiyonları sağa hizala */
              order: 3; /* Aramadan sonra yerleştir */
              margin-left: auto; /* Aksiyonları en sağa it */
              flex-wrap: nowrap; /* Aksiyonların kendilerinin sarmalamasını engelle */
              gap: 10px; /* Mobil'de aksiyonlar için daha küçük boşluk */
              margin-top: 0; /* Üstten boşluğu kaldır */
          }

          .user-profile {
              flex-grow: 0; /* Mobil'de büyümesini engelle */
          }

          /* Mobil için tek çıkış butonu */
          .logout-btn {
              padding: 10px 12px; /* Daha küçük padding */
              width: auto; /* Genişliği içeriğe göre ayarla */
              min-width: 40px; /* Minimum genişlik (ikon için) */
              height: 40px; /* Yüksekliği sabitle */
              margin-left: 0 !important; /* Masaüstü margin'ini sıfırla */
          }
          .logout-btn .logout-text {
              display: none; /* Metni gizle */
          }
          .logout-btn i {
              margin-right: 0; /* İkonun sağındaki boşluğu kaldır */
          }
      }

      @media (max-width: 576px) {
          .page-title {
              font-size: 22px;
              justify-content: center; /* Başlığı ortala */
          }
          .page-title i {
              margin-right: 8px;
          }
          .user-info {
              display: none; /* Mobil görünümde kullanıcı adını ve rolünü gizle */
          }

          /* Proje tablosu responsive düzenlemesi */
          .projects-table, .projects-table thead, .projects-table tbody, .projects-table th, .projects-table td, .projects-table tr {
              display: block;
          }
          .projects-table thead {
              display: none; /* Başlıkları gizle */
          }
          .projects-table tr {
              margin-bottom: 15px;
              border-radius: 8px;
              box-shadow: 0 2px 8px rgba(0,0,0,0.04);
              background: var(--card-bg); /* Temaya uygun kart rengi */
              border: 1px solid var(--border-color); /* Kart kenarlığı */
          }
          .projects-table td:first-child {
              padding-top: 15px; /* İlk hücreye üst boşluk */
          }
          .projects-table td:last-child {
              padding-bottom: 15px; /* Son hücreye alt boşluk */
          }
          .projects-table td {
              padding: 10px 15px; /* Daha uygun padding */
              border: none; /* Hücre kenarlıklarını kaldır */
              position: relative;
              text-align: left;
              display: flex; /* İçeriği yan yana hizala */
              justify-content: space-between; /* Başlık ve değeri ayır */
              align-items: center;
              font-size: 14px; /* Mobil için yazı boyutu */
          }
          .projects-table td:before {
              content: attr(data-label);
              font-weight: bold;
              color: var(--primary); /* Başlık rengi temaya uygun */
              display: block;
              margin-right: 15px; /* Başlık ile değer arası boşluk */
              min-width: 100px; /* Başlık için minimum genişlik */
              font-size: 13px;
              flex-shrink: 0; /* Küçülmesini engelle */
          }
          
          .status-badge {
              padding: 4px 8px;
              font-size: 11px;
          }

          .action-btn {
              width: 38px; /* Sabit genişlik */
              height: 38px; /* Sabit yükseklik */
              padding: 0; /* Padding'i sıfırla */
              font-size: 16px;
          }
          .action-btn i {
              margin: 0; /* İkonun margin'ini sıfırla */
          }
          .projects-table td[data-label="İşlemler"] {
              justify-content: center; /* İşlem butonlarını ortala */
          }
          .projects-table td[data-label="İşlemler"]::before {
              display: none; /* İşlemler başlığını gizle */
          }

          .pagination {
              flex-direction: column; /* Sayfalandırma bilgilerini ve kontrollerini dikey sırala */
              align-items: center;
          }

          .pagination-controls {
              margin-top: 10px;
          }
          .topbar {
                padding: 15px;
                flex-wrap: nowrap; /* Çok küçük ekranlarda da sarmalamayı engelle */
                gap: 10px; /* Hamburger ve arama kutusu arasına boşluk */
                flex-direction: row; 
                justify-content: flex-start; /* Öğeleri başlangıca hizala */
                align-items: center;
            }
            .hamburger-menu {
                order: 1; /* Hamburger menü ilk sırada */
            }
            .search-container {
                flex-grow: 1; /* Kalan alanı kapla */
                order: 2; /* Arama kutusu ikinci sırada */
                margin-left: 0; /* Önceki margin-left'i sıfırla */
                width: auto; /* Otomatik genişlik */
            }
            .topbar-actions {
                width: auto; /* Aksiyonların genişliği otomatik olsun */
                order: 3; /* Aksiyonlar üçüncü sırada */
                justify-content: flex-end; /* Aksiyonları sağa hizala */
                margin-left: auto; /* Sağ tarafa it */
                flex-wrap: nowrap; /* Aksiyonların kendi içinde sarmalamasını engelle */
                gap: 8px; /* Daha küçük boşluk */
            }
      }

      .notification-panel {
        position: fixed;
        top: 70px;
        right: 30px;
        width: 350px;
        max-width: 95vw;
        background: var(--card-bg);
        color: var(--text-color);
        border-radius: 14px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.18);
        z-index: 20000; /* Z-index artırıldı */
        border: 1px solid var(--border-color);
        display: none; /* Başlangıçta gizli */
        flex-direction: column;
        overflow: hidden;
        animation: fadeInNotif 0.2s;
      }
      .notification-panel.show {
          display: flex; /* Gösterildiğinde flex olarak ayarla */
      }
      @keyframes fadeInNotif {
        from { opacity: 0; transform: translateY(-20px); }
        to { opacity: 1; transform: translateY(0); }
      }
      .notification-panel-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px 20px 10px 20px;
        border-bottom: 1px solid var(--border-color);
        font-size: 18px;
        font-weight: 600;
        background: var(--topbar-bg);
      }
      .close-notification-btn {
        background: none;
        border: none;
        color: var(--text-color);
        font-size: 20px;
        cursor: pointer;
        padding: 0;
      }
      .notification-list {
        list-style: none;
        margin: 0;
        padding: 0 0 10px 0;
        max-height: 400px;
        overflow-y: auto;
      }
      .notification-list li {
        display: flex;
        align-items: flex-start;
        gap: 12px;
        padding: 14px 20px;
        border-bottom: 1px solid var(--border-color);
        font-size: 15px;
        transition: background 0.2s;
      }
      .notification-list li:last-child {
        border-bottom: none;
      }
      .notification-list .notif-icon {
        font-size: 18px;
        margin-top: 2px;
        min-width: 22px;
        text-align: center;
      }
      .notification-list .notif-title {
        font-weight: 600;
        margin-bottom: 2px;
        display: block;
      }
      .notification-list .notif-time {
        font-size: 12px;
        color: var(--light-gray);
        margin-top: 2px;
      }
      [data-theme="dark"] .notification-panel {
        background: var(--card-bg);
        color: var(--text-color);
        border-color: var(--border-color);
      }
      .notification-panel-footer {
            padding: 10px 15px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--bg-color);
        }

        .notification-action-btn {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-color);
            padding: 6px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .notification-action-btn:hover {
            background-color: var(--input-bg);
            border-color: var(--primary-light);
            color: var(--primary-light);
        }
        
        .notification-action-btn.danger:hover {
            border-color: var(--danger);
            color: var(--danger);
            background-color: rgba(255, 71, 87, 0.1);
        }

        .no-notifications {
            text-align: center;
            padding: 20px;
            color: var(--light-gray);
            font-size: 14px;
        }
    </style>
  </head>
  <body data-theme="light">
    <!-- Confirmation Modal -->
    <div id="notification-panel-placeholder"></div>

    <div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-sm modal-dialog-centered"> <!-- modal-dialog-centered eklendi -->
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmationModalLabel">Onay Gerekli</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="confirmationMessage">
                    Emin misiniz?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                    <button type="button" class="btn btn-primary" id="confirmActionBtn">Onayla</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Proje Detay/Düzenleme Modalı -->
    <div id="projectModal" class="modal">
      <div class="modal-content" id="projectModalContent">
        <div class="modal-header">
          <h2 class="modal-title" id="modalTitle">
            <i class="fas fa-info-circle"></i> Proje Detayları
          </h2>
          <button class="close-modal-btn" id="closeModalBtn">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div id="modalBody">
          <p>Yükleniyor...</p>
        </div>
        <div class="form-actions" id="modalActions">
          <button class="modal-btn modal-btn-cancel" id="cancelModalBtn">
            Kapat
          </button>
        </div>
      </div>
    </div>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
      <a href="index.html" style="text-decoration: none;">
        <div class="logo-container" style="cursor: pointer;">
          <img src="{{ url_for('static', filename='serlogo.png') }}" alt="Ser Elektrik Otomasyon" style="width: 180px; height: auto; padding-left: 10px;">
        </div>
      </a>
      

      <a href="index.html" class="nav-item">
        <i class="fas fa-home"></i>
        <span class="nav-text">Dashboard</span>
      </a>
      <a href="projeler.html" class="nav-item active">
        <i class="fas fa-project-diagram"></i>
        <span class="nav-text">Projeler</span>
      </a>
      <a href="proje_ekle.html" class="nav-item">
        <i class="fas fa-plus-circle"></i>
        <span class="nav-text">Yeni Proje</span>
      </a>
      <a href="raporlar.html" class="nav-item">
        <i class="fas fa-chart-line"></i>
        <span class="nav-text">Raporlar</span>
      </a>
      <a href="musteriler.html" class="nav-item">
        <i class="fas fa-users"></i>
        <span class="nav-text">Müşteriler</span>
      </a>
      <a href="takvim.html" class="nav-item">
        <i class="fas fa-calendar-alt"></i>
        <span class="nav-text">Takvim</span>
      </a>
      <a href="ayarlar.html" class="nav-item">
        <i class="fas fa-cog"></i>
        <span class="nav-text">Ayarlar</span>
      </a>
    </div>

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
      <div class="topbar">
        <!-- Hamburger Menü Butonu -->
        <button class="hamburger-menu" id="hamburgerMenu">
            <i class="fas fa-bars"></i>
        </button>
        <div class="search-container">
          <i class="fas fa-search"></i>
          <input
            type="text"
            id="searchInput"
            placeholder="Proje, müşteri veya referans no ara..."
          />
        </div>

        <div class="topbar-actions">
          <div class="theme-toggle" id="theme-toggle">
            <i class="fas fa-moon"></i>
          </div>

         <div class="notification-btn" id="notificationButton" data-count="0">
            <i class="fas fa-bell"></i>
         </div>
         <!-- Bildirim Paneli -->
        
        
         <div class="user-profile" id="userProfileLink">
            <div id="userAvatarContainer" class="avatar-container"></div>
            <div class="user-info">
                <div class="user-name" id="userName"></div>
                <div class="user-role" id="userRole"></div>
            </div>
        </div>
          <!-- Tek Çıkış Yap Butonu -->
          <button
            class="btn btn-outline logout-btn"
            id="logoutButton"
          >
            <i class="fas fa-sign-out-alt"></i> <span class="logout-text">Çıkış Yap</span>
          </button>
        </div>
      </div>

      <div class="projects-content">
        <h1 class="page-title" id="pageTitle">
          <i class="fas fa-project-diagram"></i>
          Tüm Projeler
        </h1>

        <div class="filters-container" id="filtersContainer">
          <div class="filters-header">
            <div class="filter-title">Proje Filtreleri</div>
            <div class="filter-reset" id="resetFilters">Tümünü Sıfırla</div>
          </div>
          <div class="filter-row">
            <div class="filter-group">
              <label for="filterProjectName" class="filter-label"
                >Proje Adı</label
              >
              <input
                type="text"
                class="filter-input"
                id="filterProjectName"
                placeholder="Proje adı girin"
              />
            </div>
            <div class="filter-group">
              <label for="filterRefNo" class="filter-label">Referans No</label>
              <input
                type="text"
                class="filter-input"
                id="filterRefNo"
                placeholder="Referans no girin"
              />
            </div>
            <div class="filter-group">
              <label for="filterCustomer" class="filter-label">Müşteri</label>
              <input
                type="text"
                class="filter-input"
                id="filterCustomer"
                placeholder="Müşteri adı"
              />
            </div>
            <div class="filter-group">
              <label for="filterStatus" class="filter-label">Durum</label>
              <select class="filter-input" id="filterStatus">
                <option value="">Tümü</option>
                <option value="Aktif">Aktif</option>
                <option value="Tamamlandı">Tamamlandı</option>
                <option value="Gecikti">Gecikti</option>
                <option value="Planlama Aşamasında">Planlama Aşamasında</option>
                <!-- Bu seçenekler artık backend'den gelen display_status ile eşleşmeyebilir,
                     ancak yine de filtre olarak kalabilirler. -->
                <option value="Aktif (İş Gecikmeli)">Aktif (İş Gecikmeli)</option>
                <option value="Planlama (İş Gecikmeli)">
                  Planlama (İş Gecikmeli)
                </option>
              </select>
            </div>
          </div>
        </div>

        <div class="projects-container">
          <div class="projects-header">
            <div class="card-title">Proje Listesi</div>
            <div class="projects-actions">
              <button class="btn btn-outline" id="filterBtn">
                <i class="fas fa-filter"></i> Filtrele
              </button>
              <button class="btn btn-outline" id="toggleMyProjectsBtn">
                <i class="fas fa-user-tie"></i> Projelerim
              </button>
                <!-- Yeni Proje Ekle butonu -->
               <button type="button" class="btn" title="Yeni Proje Ekle" onclick="window.location.href='proje_ekle.html'">
                 <i class="fas fa-plus"></i> Proje Ekle
                 </button>
              <button class="btn" id="exportAllPdf">
                <i class="fas fa-file-pdf"></i> Tümünü PDF Yap
              </button>
              <button class="btn" id="refreshData">
                <i class="fas fa-sync-alt"></i> Verileri Yenile
              </button>
            </div>
          </div>

          <div class="table-container">
            <table class="projects-table" id="projectsTable">
              <thead>
                <tr>
                  <th>Proje Adı</th>
                  <th>Referans No</th>
                  <th>Müşteri</th>
                  <th>Durum</th>
                  <th>Başlangıç</th>
                  <th>Bitiş</th>
                  <th>Toplam Gün</th>
                  <th>Geçen Gün</th>
                  <th>Gecikme Durumu</th>
                  <th>Yönetici</th>
                  <th>İşlemler</th>
                </tr>
              </thead>
              <tbody id="projectsTableBody">
                <tr>
                  <td colspan="11" style="text-align: center">
                    Projeler yükleniyor...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          
          <!-- Pagination -->
          <div class="pagination">
              <div class="pagination-info">Toplam <span id="totalProjectsCount">0</span> proje, sayfa <span id="currentPage">1</span>/<span id="totalPages">1</span></div>
              <div class="pagination-controls">
                  <button class="page-btn" id="prevPage"><i class="fas fa-chevron-left"></i></button>
                  <div id="pageNumbers">
                      <button class="page-btn active">1</button>
                  </div>
                  <button class="page-btn" id="nextPage"><i class="fas fa-chevron-right"></i></button>
              </div>
          </div>
        </div>

        <div class="footer">
          &copy; 2025 Ser Elektrik Otomasyon. Tüm hakları saklıdır. | Mustafa Öztürk
        </div>
      </div>
    </div>

    <!-- Toast bildirimi HTML'i -->
    <div class="toast" id="toast">
      <i class="fas fa-check-circle"></i>
      <div class="toast-content">
        <div id="toastTitle" class="toast-title">Başarılı</div>
        <span id="toastMessage">İşlem başarıyla tamamlandı</span>
      </div>
    </div>
    <script src="{{ url_for('static', filename='config.js') }}"></script>
<script>
    
    let currentUser = null; // Mevcut kullanıcı bilgisi
    let allProjectsData = [];
    let filteredProjects = []; // Filtrelenmiş projeleri tutacak
    let currentPage = 1;
    let rowsPerPage = 10; // Masaüstü varsayılanı
    let isMyProjectsView = false; // "Projelerim" görünümünde miyiz?

    // Pagination elementleri
    const totalProjectsCountSpan = document.getElementById('totalProjectsCount');
    const currentPageSpan = document.getElementById('currentPage');
    const totalPagesSpan = document.getElementById('totalPages');
    const prevPageButton = document.getElementById('prevPage');
    const nextPageButton = document.getElementById('nextPage');
    const pageNumbersContainer = document.getElementById('pageNumbers');
    const confirmationModalElement = document.getElementById('confirmationModal'); // Elementi al
    const confirmationModal = new bootstrap.Modal(confirmationModalElement); // Modal objesini oluştur
    const confirmActionBtn = document.getElementById('confirmActionBtn');
    let currentConfirmAction = null;
    const pageTitleElement = document.getElementById('pageTitle');
    const toggleMyProjectsBtn = document.getElementById('toggleMyProjectsBtn');


    // Genel Toast bildirim fonksiyonu
    function showToast(title, message, type = 'success') {
        const toast = document.getElementById('toast');
        const toastTitle = document.getElementById('toastTitle');
        const toastMessage = document.getElementById('toastMessage');

        if (!toast || !toastTitle || !toastMessage) {
            console.error("Toast elementleri bulunamadı!");
            return;
        }

        // Eğer sadece bir parametre verilmişse, bunu mesaj olarak kabul et
        if (arguments.length === 1) {
            message = title;
            title = type === 'error' ? 'Hata' : 'Başarılı';
        } else if (arguments.length === 2 && typeof message === 'boolean') {
            // Eski kullanım için geriye dönük uyumluluk
            type = message ? 'error' : 'success';
            message = title;
            title = type === 'error' ? 'Hata' : 'Başarılı';
        }

        toastTitle.textContent = title || (type === 'error' ? 'Hata' : 'Başarılı');
        toastMessage.textContent = message;
        
        // Mevcut tüm durum sınıflarını kaldır
        toast.classList.remove('success', 'error', 'info', 'warning');
        
        // Yeni durum sınıfını ekle
        const typeClass = type === 'error' ? 'error' : 
                         type === 'info' ? 'info' :
                         type === 'warning' ? 'warning' : 'success';
        toast.classList.add(typeClass);

        // Göster
        toast.classList.add('show');

        // 3 saniye sonra gizle
        setTimeout(() => {
            toast.classList.remove('show');
        }, 3000);
    }

    // Custom Confirm Modal (alert yerine kullanılacak)
    function showConfirmationModal(title, message, onConfirm) {
        document.getElementById('confirmationModalLabel').textContent = title; // Başlığı ayarla
        document.getElementById('confirmationMessage').textContent = message;
        currentConfirmAction = onConfirm;
        confirmationModalElement.style.zIndex = '20000'; // Modalın en üstte olmasını sağla
        confirmationModal.show();
    }

    // Kullanıcı bilgilerini yükle ve oturum kontrolünü yap
    function loadUserInfo() {
        const storedUser = localStorage.getItem('currentUser');
        if (!storedUser) {
            console.log("LocalStorage'da kullanıcı verisi bulunamadı. Giriş sayfasına yönlendiriliyor...");
            showToast("Oturum süreniz doldu veya giriş yapmadınız. Lütfen giriş yapın.", true);
            setTimeout(() => {
                window.location.href = 'login.html';
            }, 2000);
            return; // Buradan sonra işlem yapma, direkt yönlendir
        }

        try {
            currentUser = JSON.parse(storedUser); 
        } catch (e) {
            console.error("Kayıtlı kullanıcı verisi bozuk:", e);
            localStorage.removeItem('currentUser'); // Bozuk veriyi temizle
            showToast("Kullanıcı verileriniz bozuk. Lütfen tekrar giriş yapın.", true);
            setTimeout(() => {
                window.location.href = 'login.html';
            }, 2000);
            return; // Buradan sonra işlem yapma, direkt yönlendir
        }

        // Kullanıcı arayüzünü güncelleme (user-avatar.js yüklendikten sonra çağrılacak)
        const userNameElement = document.getElementById('userName');
        const userRoleElement = document.getElementById('userRole');

        if (userNameElement) {
            userNameElement.textContent = currentUser.fullname || currentUser.username || 'Kullanıcı';
        }
        if (userRoleElement) {
            userRoleElement.textContent = currentUser.role || 'Rol Yok';
        }
        // updateUserAvatar DOMContentLoaded içinde çağrılacak
    }

    // loadUserInfo fonksiyonunu hemen çağırıyoruz ki currentUser değişkeni set edilsin
    loadUserInfo();

    // Revizyon isteği butonları için event delegation
    document.addEventListener('click', function(e) {
        const revBtn = e.target.closest('.request-revision-btn');
        if (revBtn) {
            e.preventDefault();
            const progressId = revBtn.dataset.progressId;
            const projectId = revBtn.dataset.projectId;
            if (progressId && projectId) {
                showRevisionRequestModal(progressId, projectId);
            }
        }
    });

    // --- DOM Yüklendiğinde Çalışacak Kod ---
    document.addEventListener("DOMContentLoaded", function () {
      async function fetchWorkProgressHeaders() {
    try {
        const response = await fetch(`${API_BASE_URL}/api/work-progress-headers/active`);
        if (!response.ok) throw new Error('Başlıklar alınamadı');

        const headers = await response.json();
        return headers; // [{ id, title }, ...]
    } catch (error) {
        console.error("Başlık listesi alınamadı:", error);
        return [];
    }
}

        // user-avatar.js yüklendiyse updateUserAvatar'ı çağır
        if (currentUser && typeof updateUserAvatar === 'function') {
            updateUserAvatar(currentUser); 
        }

        // Topbar kullanıcı profili linki için event listener
        const userProfileLink = document.getElementById('userProfileLink');
        if (userProfileLink) {
            userProfileLink.addEventListener('click', () => {
                window.location.href = 'users.html';
            });
        }

        const logoutButton = document.getElementById("logoutButton");
        const themeToggle = document.getElementById("theme-toggle");
        const hamburgerMenu = document.getElementById('hamburgerMenu');
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('mainContent');

        // Tema değiştirme
        const savedTheme = localStorage.getItem("theme");
        if (savedTheme) {
            document.body.setAttribute("data-theme", savedTheme);
            themeToggle.innerHTML =
                savedTheme === "dark"
                ? '<i class="fas fa-sun"></i>'
                : '<i class="fas fa-moon"></i>';
        }
        themeToggle.addEventListener("click", () => {
            const currentTheme = document.body.getAttribute("data-theme");
            const newTheme = currentTheme === "dark" ? "light" : "dark";
            document.body.setAttribute("data-theme", newTheme);
            themeToggle.innerHTML =
                newTheme === "dark"
                ? '<i class="fas fa-sun"></i>'
                : '<i class="fas fa-moon"></i>';
            localStorage.setItem("theme", newTheme);
        });

        // Çıkış Yap butonu
        logoutButton.addEventListener("click", () => {
            localStorage.removeItem("currentUser");
            window.location.href = "login.html";
        });

        // Hamburger menü işlevselliği
        hamburgerMenu.addEventListener('click', () => {
            sidebar.classList.toggle('show');
            mainContent.classList.toggle('expanded');
        });

        // Sidebar dışına tıklayınca kapatma
        document.addEventListener('click', (event) => {
            if (sidebar.classList.contains('show') && 
                !sidebar.contains(event.target) && 
                !hamburgerMenu.contains(event.target)) {
                sidebar.classList.remove('show');
                mainContent.classList.remove('expanded');
            }
        });

        // Pencere boyutu değiştiğinde sidebar durumunu sıfırla (masaüstü için)
        window.addEventListener('resize', () => {
            if (window.innerWidth > 992) {
                sidebar.classList.remove('show');
                mainContent.classList.remove('expanded');
            }
            updateRowsPerPage(); // Ekran boyutuna göre sayfa başına satır sayısını güncelle
            applyFiltersAndRenderTable(); // Tabloyu yeniden render et
        });

        updateRowsPerPage(); // Sayfa yüklendiğinde başlangıç değeri ayarla

        fetchProjects(); // Sayfa yüklendiğinde projeleri çek
        fetchUnreadNotificationCount(); // Sayfa yüklendiğinde okunmamış bildirim sayısını çek

        // Bildirim Paneli İşlevselliği
        const notificationButton = document.getElementById('notificationButton');
        const notificationPanel = document.getElementById('notificationPanel');
        const closeNotificationPanel = document.getElementById('closeNotificationPanel');
        const notificationList = document.getElementById('notificationList');
        const markAllReadBtn = document.getElementById('markAllReadBtn');
        const clearAllNotificationsBtn = document.getElementById('clearAllNotificationsBtn');

        if (notificationButton) {
            notificationButton.addEventListener('click', (event) => {
                event.stopPropagation(); // Olayın body'ye yayılmasını engelle
                if (notificationPanel) {
                    notificationPanel.classList.toggle('show');
                    // Panel açıldığında bildirimleri yeniden yükle
                    if (notificationPanel.classList.contains('show')) {
                        fetchAndRenderNotifications();
                    }
                }
            });
        }

        if (closeNotificationPanel) {
            closeNotificationPanel.addEventListener('click', () => {
                if (notificationPanel) {
                    notificationPanel.classList.remove('show');
                }
            });
        }

        document.addEventListener('click', (event) => {
            // Bildirim paneli açıksa ve tıklama panelin veya bildirim butonunun dışında ise kapat
            if (notificationPanel && notificationPanel.classList.contains('show') && 
                !notificationPanel.contains(event.target) && 
                !notificationButton.contains(event.target)) {
                notificationPanel.classList.remove('show');
            }
        });

        if (markAllReadBtn) {
            markAllReadBtn.addEventListener('click', async () => {
                if (!currentUser || !currentUser.id) {
                    showToast('Kullanıcı oturumu bulunamadı.', true);
                    return;
                }
                showConfirmationModal('Tümünü Okundu İşaretle', 'Tüm bildirimleri okundu olarak işaretlemek istediğinizden emin misiniz?', async () => {
                    try {
                        const response = await fetch(`${API_BASE_URL}/api/notifications/mark-all-read`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ user_id: currentUser.id })
                        });
                        if (!response.ok) throw new Error('Tüm bildirimler okundu olarak işaretlenemedi.');
                        showToast('Tüm bildirimler okundu olarak işaretlendi.');
                        fetchAndRenderNotifications(); // Listeyi ve sayacı yenile
                    } catch (error) {
                        console.error('Tüm bildirimleri okundu hatası:', error);
                        showToast('Tüm bildirimler okundu olarak işaretlenirken hata oluştu.', true);
                    }
                });
            });
        }

        if (clearAllNotificationsBtn) {
            clearAllNotificationsBtn.addEventListener('click', async () => {
                if (!currentUser || !currentUser.id) {
                    showToast('Kullanıcı oturumu bulunamadı.', true);
                    return;
                }
                showConfirmationModal('Tüm Bildirimleri Temizle', 'Tüm bildirimleri silmek istediğinizden emin misiniz? Bu işlem geri alınamaz.', async () => {
                    try {
                        const response = await fetch(`${API_BASE_URL}/api/notifications/clear-all?user_id=${currentUser.id}`, {
                            method: 'DELETE'
                        });
                        if (!response.ok) throw new Error('Tüm bildirimler temizlenemedi.');
                        showToast('Tüm bildirimler başarıyla temizlendi.');
                        fetchAndRenderNotifications(); // Listeyi ve sayacı yenile
                    } catch (error) {
                        console.error('Tüm bildirimleri temizleme hatası:', error);
                        showToast('Tüm bildirimler temizlenirken hata oluştu.', true);
                    }
                });
            });
        }
    function updateRowsPerPage() {
        if (window.innerWidth < 576) {
            rowsPerPage = 5; // Mobil cihazlar için daha az satır
        } else if (window.innerWidth < 992) {
            rowsPerPage = 8; // Tabletler için orta sayıda satır
        } else {
            rowsPerPage = 10; // Masaüstü için varsayılan satır sayısı
        }
        currentPage = 1; // Sayfa başına satır sayısı değiştiğinde ilk sayfaya dön
        // Tabloyu yeniden render etmek için applyFiltersAndRenderTable çağrılacak
    }

        // Filtreleme butonları
        const filterBtn = document.getElementById("filterBtn");
        const filtersContainer = document.getElementById("filtersContainer");
        filterBtn.addEventListener("click", () => {
            filtersContainer.style.display =
                filtersContainer.style.display === "none" ? "grid" : "none";
        });

        document.getElementById("refreshData").addEventListener("click", () => {
            fetchProjects();
            showToast("Proje verileri yenilendi.");
        });

        document.getElementById("exportAllPdf").addEventListener("click", async function() {
            const hasPermission = await checkPermission('pdf_olusturma');
            if (!hasPermission) return;
            exportAllProjectsToPdf();
        });

        // "Projelerim" butonuna tıklama olayı
        toggleMyProjectsBtn.addEventListener('click', () => {
            isMyProjectsView = !isMyProjectsView; // Durumu tersine çevir
            if (isMyProjectsView) {
                toggleMyProjectsBtn.innerHTML = '<i class="fas fa-list"></i> Tüm Projeleri Görüntüle';
                pageTitleElement.innerHTML = '<i class="fas fa-project-diagram"></i> Projelerim';
            } else {
                toggleMyProjectsBtn.innerHTML = '<i class="fas fa-user-tie"></i> Projelerim';
                pageTitleElement.innerHTML = '<i class="fas fa-project-diagram"></i> Tüm Projeler';
            }
            applyFiltersAndRenderTable(); // Filtreleri yeniden uygula
        });


        // Genel arama inputu
        document.getElementById("searchInput").addEventListener("keyup", applyFiltersAndRenderTable);

        // Filtre inputlarına keyup ve change event'leri
        document
            .getElementById("filterProjectName")
            .addEventListener("keyup", applyFiltersAndRenderTable);
        document
            .getElementById("filterRefNo")
            .addEventListener("keyup", applyFiltersAndRenderTable);
        document
            .getElementById("filterCustomer")
            .addEventListener("keyup", applyFiltersAndRenderTable);
        document
            .getElementById("filterStatus")
            .addEventListener("change", applyFiltersAndRenderTable);

        // Filtreleri sıfırlama
        document.getElementById("resetFilters").addEventListener("click", () => {
            document.getElementById("filterProjectName").value = "";
            document.getElementById("filterRefNo").value = "";
            document.getElementById("filterCustomer").value = "";
            document.getElementById("filterStatus").value = "";
            document.getElementById("searchInput").value = ""; // Global aramayı da sıfırla
            applyFiltersAndRenderTable();
            showToast("Filtreler sıfırlandı.");
        });

        // Confirmation Modal "Onayla" butonu için olay dinleyicisi
        if (confirmActionBtn) {
            confirmActionBtn.addEventListener('click', () => {
                if (currentConfirmAction) {
                    currentConfirmAction();
                }
                confirmationModal.hide();
                confirmationModalElement.style.zIndex = ''; // z-index'i sıfırla
            });
        }
        
        // Bu sayfayı görüntüleme yetkisi kontrolü kaldırıldı.
        // Proje ekleme, düzenleme, silme gibi spesifik eylemler için yetki kontrolü yapılacaktır.
        // await checkPermission('projeler'); // Bu satır kaldırıldı.
    });

    // --- Yardımcı Fonksiyonlar ---
    // Tarih formatlama (DD.MM.YYYY)
    function formatDateForDisplay(dateStr) {
        if (!dateStr) return "";
        const parts = dateStr.split("-");
        if (parts.length === 3) {
            return `${parts[2]}.${parts[1]}.${parts[0]}`;
        }
        return dateStr;
    }

    // Tarih formatlama (YYYY-MM-DD) input için
    function formatDateForInput(dateStr) {
        if (!dateStr) return "";
        if (dateStr.includes(".")) {
            const parts = dateStr.split(".");
            return `${parts[2]}-${parts[1].padStart(2, "0")}-${parts[0].padStart(
                2,
                "0"
            )}`;
        }
        return dateStr;
    }

  
 function getStatusBadgeHtml(status) { // 'status' parametresi doğru şekilde kullanılıyor
        let statusClass = "normal"; // 'Aktif' veya herhangi bir spesifik adım başlığı için varsayılan
        let statusText = status; // Hata burada düzeltildi: 'status' parametresi kullanılıyor

        if (status.includes("Gecikmeli")) { // Hata burada düzeltildi: 'status' parametresi kullanılıyor
            statusClass = "gecikmeli";
        } else if (status === "Tamamlandı") { // Hata burada düzeltildi: 'status' parametresi kullanılıyor
            statusClass = "tamamlandı";
        } else if (status === "Planlama Aşamasında") { // Hata burada düzeltildi: 'status' parametresi kullanılıyor
            statusClass = "planlama";
        }
        // Diğer durumlar için (örn. "Montaj", "Test", "Kurulum" gibi adım başlıkları veya "Aktif")
        // varsayılan 'normal' sınıfı (yeşil) kullanılacaktır.

        return `<span class="status-badge ${statusClass}">${statusText}</span>`;
    }

// Tabloda kullanırken şöyle çağırın:
// getStatusBadgeHtml(project.display_status, project.total_delay_days)

    // Aktivite loglama fonksiyonu (frontend'den backend'e istek gönderecek)
    async function addActivity(title, rawDescription, project_id, icon = "fas fa-info-circle", actionType = "other") {
        if (!currentUser || !currentUser.id) {
            console.warn("Kullanıcı oturumu bulunamadı, aktivite kaydedilemedi.");
            return;
        }

        const activityData = {
            user_id: currentUser.id,
            project_id: project_id, // null olabilir
            title: title,
            description: rawDescription,
            icon: icon,
            action_type: actionType
        };

        try {
            const response = await fetch(`${API_BASE_URL}/api/activities`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(activityData)
            });
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Aktivite eklenirken bilinmeyen bir hata oluştu.');
            }
            console.log("Aktivite başarıyla kaydedildi:", activityData);
        } catch (error) {
            console.error('Aktivite ekleme hatası:', error);
        }
    }
    

    // --- Proje Listesi ve İşlemleri ---
    async function fetchProjects() {
        const tbody = document.getElementById("projectsTableBody");
        if (!tbody) {
            console.error("HATA: projectsTableBody elementi bulunamadı!");
            return;
        }

        tbody.innerHTML =
            '<tr><td colspan="11" style="text-align: center;"><i class="fas fa-spinner fa-spin"></i> Projeler yükleniyor...</td></tr>';
        console.log("FETCH_DEBUG: 'Projeler yükleniyor...' mesajı ayarlandı.");

        try {
            console.log(
                "FETCH_DEBUG: API çağrısı başlatılıyor:",
                `${API_BASE_URL}/api/projects`
            );
            const response = await fetch(`${API_BASE_URL}/api/projects`);
            console.log(
                "FETCH_DEBUG: API yanıtı alındı. Status:",
                response.status
            );

            if (!response.ok) {
                let errorDetails = "Bilinmeyen Hata";
                try {
                    const errorData = await response.json();
                    errorDetails = errorData.message || errorDetails;
                } catch (jsonError) {
                    errorDetails = `Yanıt JSON olarak parse edilemedi: ${response.statusText}`;
                }
                console.error(
                    "FETCH_DEBUG HATA: API yanıtı OK değil.",
                    `Durum: ${response.status}`,
                    `Detay: ${errorDetails}`
                );
                throw new Error(`HTTP hatası! Durum: ${response.status} - ${errorDetails}`);
            }

            const projects = await response.json();
            console.log(
                "FETCH_DEBUG: API'den çekilen ham projeler (allProjectsData'ya atanacak):",
                projects
            );

            allProjectsData = projects;
            console.log("FETCH_DEBUG: allProjectsData güncellendi. applyFiltersAndRenderTable çağrılıyor.");
            applyFiltersAndRenderTable(); // Filtreleri uygula ve tabloyu render et
            console.log("FETCH_DEBUG: Projeler yükleme tamamlandı.");
        } catch (error) {
            console.error("FETCH KAPSAMLI HATA: Projeler çekilemedi:", error);
            showToast(`Projeler yüklenirken hata oluştu: ${error.message}`, true);
            if (tbody) {
                tbody.innerHTML = `<tr><td colspan="11" style="text-align: center; color: var(--danger);">Projeler yüklenemedi. Hata: ${error.message} Lütfen sunucu bağlantısını ve loglarını kontrol edin.</td></tr>`;
            }
        }
    }
function renderProjectsTable(projectsToRender) {
        let tbody = document.getElementById("projectsTableBody");
        if (!tbody) {
            const table = document.getElementById("projectsTable");
            if (table) {
                tbody = document.createElement("tbody");
                tbody.id = "projectsTableBody";
                table.appendChild(tbody);
                console.warn("projectsTableBody bulunamadı, yeni tbody eklendi.");
            } else {
                console.error("RENDER_DEBUG: projectsTable ve projectsTableBody elementi bulunamadı!");
                return;
            }
        }

        console.log(
            "RENDER_DEBUG: renderProjectsTable başladı. projectsToRender (gelecek veri):",
            projectsToRender
        );

        tbody.innerHTML = "";
        console.log("RENDER_DEBUG: tbody içeriği temizlendi.");

        if (projectsToRender.length === 0) {
            tbody.innerHTML =
                '<tr><td colspan="11" style="text-align: center;">Gösterilecek proje bulunamadı.</td></tr>';
            updatePagination(0, 0, 0); // Sayfalandırmayı güncelle
            return;
        }

        // Pagination için dilimleme
        const startIndex = (currentPage - 1) * rowsPerPage;
        const endIndex = startIndex + rowsPerPage;
        const paginatedProjects = projectsToRender.slice(startIndex, endIndex);

        // Yardımcı fonksiyonlar:
        function dateDiffInDays(date1, date2) {
            // Tarih formatı: YYYY-MM-DD veya DD.MM.YYYY
            function parseDate(str) {
                if (!str) return null;
                if (str.includes('-')) {
                    // YYYY-MM-DD
                    const [y, m, d] = str.split('-');
                    return new Date(Number(y), Number(m) - 1, Number(d));
                } else if (str.includes('.')) {
                    // DD.MM.YYYY
                    const [d, m, y] = str.split('.');
                    return new Date(Number(y), Number(m) - 1, Number(d));
                }
                return null;
            }
            const dt1 = parseDate(date1);
            const dt2 = parseDate(date2);
            if (!dt1 || !dt2) return null;
            return Math.ceil((dt2 - dt1) / (1000 * 60 * 60 * 24));
        }

        function getTodayStr() {
            const today = new Date();
            return today.toISOString().slice(0, 10); // YYYY-MM-DD
        }

        paginatedProjects.forEach((project) => {
            // Toplam Gün
            let totalDays = dateDiffInDays(project.start_date, project.end_date);
            totalDays = (typeof totalDays === "number" && !isNaN(totalDays)) ? (totalDays >= 0 ? totalDays : 0) : '-';

            // Geçen Gün
            const todayStr = getTodayStr();
            let elapsedDays = dateDiffInDays(project.start_date, todayStr);
            elapsedDays = (typeof elapsedDays === "number" && !isNaN(elapsedDays)) ? (elapsedDays >= 0 ? elapsedDays : 0) : '-';

            // Gecikme Durumu (total_delay_days zaten backend'den geliyor)
            let combinedDelay = project.total_delay_days || 0;
            let gecikmeDurumu = "-";
            if (combinedDelay > 0) {
                gecikmeDurumu = combinedDelay + " gün";
            } else if (typeof combinedDelay === 'number' && combinedDelay === 0) {
                gecikmeDurumu = "0 gün";
            }

            // İlk ve son iş gidişatı tarihlerini kullan (varsa)
            const displayStartDate = project.first_progress_start || project.start_date;
            const displayEndDate = project.last_progress_end || project.end_date;

            const row = document.createElement("tr");
            row.innerHTML = `
                <td data-label="Proje Adı">${project.project_name ? project.project_name.normalize('NFC') : "-"}</td>
                <td data-label="Referans No">${project.reference_no || "-"}</td>
                <td data-label="Müşteri">${project.customer_name || "-"}</td>
                <td data-label="Durum">${getStatusBadgeHtml(project.display_status || "-", combinedDelay)}</td>
                <td data-label="Başlangıç">${formatDateForDisplay(displayStartDate || "-")}</td>
                <td data-label="Bitiş">${formatDateForDisplay(displayEndDate || "-")}</td>
                <td data-label="Toplam Gün">${totalDays !== '-' ? totalDays + ' gün' : '-'}</td>
                <td data-label="Geçen Gün">${elapsedDays !== '-' ? elapsedDays + ' gün' : '-'}</td>
                <td data-label="Gecikme Durumu">${gecikmeDurumu}</td>
                <td data-label="Yönetici">${project.project_manager_name || "-"}</td>
                <td data-label="İşlemler">
                    <div style="display: flex; gap: 10px;">
                        <button class="action-btn view-project-btn" data-id="${project.project_id}" title="Detayları Görüntüle"><i class="fas fa-eye"></i></button>
                        <button class="action-btn edit-project-btn" data-id="${project.project_id}" title="Projeyi Düzenle"><i class="fas fa-edit"></i></button>
                        <button class="action-btn delete-project-btn" data-id="${project.project_id}" title="Projeyi Sil"><i class="fas fa-trash"></i></button>
                        <button class="action-btn generate-pdf-btn" data-id="${project.project_id}" title="PDF Raporu Oluştur"><i class="fas fa-file-pdf"></i></button>
                    </div>
                </td>
            `;
            tbody.appendChild(row);
        });

        attachProjectTableEventListeners();
        updatePagination(projectsToRender.length, currentPage, Math.ceil(projectsToRender.length / rowsPerPage));
    }
function attachProjectTableEventListeners() {
        document.querySelectorAll(".view-project-btn").forEach((btn) => {
            btn.onclick = (e) => {
                e.preventDefault();
                const projectId = e.currentTarget.dataset.id;
                openProjectModal(projectId, "view");
            };
        });
        document.querySelectorAll(".edit-project-btn").forEach((btn) => {
            btn.onclick = async (e) => {
                e.preventDefault();
                const projectId = e.currentTarget.dataset.id;
                const hasPermission = await checkPermission('proje_duzenle');
                if (!hasPermission) return;
                openProjectModal(projectId, "edit");
            };
        });
        document.querySelectorAll(".delete-project-btn").forEach((btn) => {
            btn.onclick = async (e) => {
                e.preventDefault();
                const projectId = e.currentTarget.dataset.id;
                const hasPermission = await checkPermission('proje_sil');
                if (!hasPermission) return;
                showConfirmationModal(`Projeyi Sil`, `Bu projeyi silmek istediğinize emin misiniz? Bu işlem geri alınamaz!`, () => deleteProject(projectId));
            };
        });
        document.querySelectorAll(".generate-pdf-btn").forEach((btn) => {
            btn.onclick = async (e) => {
                e.preventDefault();
                const projectId = e.currentTarget.dataset.id;
                const project = allProjectsData.find((p) => p.project_id == projectId);
                if (project) {
                    const hasPermission = await checkPermission('pdf_olusturma');
                    if (!hasPermission) return;
                    generateProjectPdf(project);
                } else showToast("Proje bulunamadı!", true);
            };
        });
    }

    async function deleteProject(id) {
        const project = allProjectsData.find(p => String(p.project_id) === String(id));
        const projectName = project ? project.project_name : `ID: ${id}`;
        try {
            // user_id'yi query parametresi olarak ekle
            const response = await fetch(`${API_BASE_URL}/api/projects/${id}`, {
                method: "DELETE",
                headers: {
                    'Content-Type': 'application/json' // Content-Type başlığını ekle
                },
                body: JSON.stringify({ user_id: currentUser.id }) // user_id'yi JSON gövdesine ekle
            });
            const data = await response.json();
            if (response.ok) {
                showToast(data.message || "Proje başarıyla silindi");
                fetchProjects();
                // Aktivite kaydı eklendi
                addActivity(
                    "Proje Silindi",
                    `"${projectName}" projesi silindi.`,
                    id,
                    "fas fa-trash",
                    "project_delete"
                );
            } else {
                showToast(`Hata: ${data.message}`, true);
            }
        } catch (error) {
            console.error("Proje silme hatası:", error);
            showToast("Sunucuya bağlanılamadı veya bir sorun oluştu.", true);
        }
    }

    // --- Proje Detay/Düzenleme Modalı ve İş Gidişatı Fonksiyonları ---

    const projectModal = document.getElementById("projectModal");
    const projectModalContent = document.getElementById("projectModalContent");
    const closeModalBtn = document.getElementById("closeModalBtn");
    const cancelModalBtn = document.getElementById("cancelModalBtn");
    const modalTitle = document.getElementById("modalTitle");
    const modalBody = document.getElementById("modalBody");
    const modalActions = document.getElementById("modalActions");

    let modalBodyClickListener = null;

    // Modal kapatma fonksiyonu
    function closeProjectModal() {
        if (modalBodyClickListener) {
            modalBody.removeEventListener('click', modalBodyClickListener);
            modalBodyClickListener = null;
        }
        projectModal.style.display = "none";
        modalTitle.innerHTML = '<i class="fas fa-info-circle"></i> Proje Detayları';
        modalBody.innerHTML = "<p>Yükleniyor...</p>";
        modalActions.innerHTML = `<button class="modal-btn modal-btn-cancel" id="cancelModalBtn">Kapat</button>`;
        document.removeEventListener("keydown", handleEscapeKey);
        // Yeni kapatma butonuna olay dinleyicisi ekle
        const newCancelBtn = document.getElementById("cancelModalBtn");
        if (newCancelBtn) {
            newCancelBtn.addEventListener("click", closeProjectModal);
        }
        console.log("Modal kapatıldı.");
    }

    // Modal açma fonksiyonu
    async function openProjectModal(projectId, mode) {
  try {
    console.log("openProjectModal başladı, projectId:", projectId, "mode:", mode);
    const project = allProjectsData.find((p) => p.project_id == projectId);
    if (!project) {
      showToast("Proje bulunamadı!", true);
      return;
    }
    
    projectModal.style.display = "flex";
    modalBody.innerHTML =
    '<p style="text-align: center;"><i class="fas fa-spinner fa-spin"></i> Yükleniyor...</p>';
    
    if (mode === "view") {
      console.log("View modu için modal yükleniyor");
      modalTitle.innerHTML = `<i class="fas fa-info-circle"></i> Proje Detayları: ${project.project_name}`;
      await renderViewModal(project);
      modalActions.innerHTML = `<button class="modal-btn modal-btn-cancel" id="cancelModalBtn">Kapat</button>`;
      
      if (!modalBodyClickListener) {
        modalBodyClickListener = function(e) {
          if (e.target.closest('.open-location-btn')) {
            const btn = e.target.closest('.open-location-btn');
            const location = btn.dataset.location;
            openLocationInGoogleMaps(location);
          }
        };
        modalBody.addEventListener('click', modalBodyClickListener);
      }
      console.log("View modu modal hazır");
    } else if (mode === "edit") {
      console.log("Edit modu için modal yükleniyor");
      modalTitle.innerHTML = `<i class="fas fa-edit"></i> Projeyi Düzenle: ${project.project_name}`;
      await renderEditModal(project);
      modalActions.innerHTML = `
      <button class="modal-btn modal-btn-save" id="saveProjectBtn"><i class="fas fa-save"></i> Kaydet</button>
      <button class="modal-btn modal-btn-cancel" id="cancelModalBtn">İptal</button>
      `;
      
      // Event listener'lar ekleniyor
      const saveProjectBtn = document.getElementById("saveProjectBtn");
      if (saveProjectBtn) {
        saveProjectBtn.addEventListener("click", saveProjectChanges);
      } else {
        console.error("saveProjectBtn bulunamadı!");
      }
      
      const cancelModalBtn = document.getElementById("cancelModalBtn");
      if (cancelModalBtn) {
        cancelModalBtn.addEventListener("click", closeProjectModal);
      } else {
        console.error("cancelModalBtn bulunamadı!");
      }
      console.log("Edit modu modal hazır");
    }
    
    // Her zaman güncel kapatma butonlarına olay dinleyicisi ekle
    const cancelBtn = document.getElementById("cancelModalBtn");
    if (cancelBtn) {
      cancelBtn.addEventListener("click", closeProjectModal);
    } else {
      console.warn("cancelModalBtn bulunamadı, olay dinleyici eklenemedi");
    }
    
    if (closeModalBtn) {
      closeModalBtn.addEventListener("click", closeProjectModal);
    } else {
      console.warn("closeModalBtn bulunamadı, olay dinleyici eklenemedi");
    }
    
    // Modalın dışına tıklayarak kapatma
    projectModal.onclick = (e) => {
      if (e.target === projectModal) {
        closeProjectModal();
      }
    };
    
    // Esc tuşu ile kapatma
    document.addEventListener("keydown", handleEscapeKey);
    console.log("openProjectModal tamamlandı");
  } catch (error) {
    console.error("openProjectModal hatası:", error);
    modalBody.innerHTML = `<p style="text-align: center; color: red;">Modal yüklenirken bir hata oluştu: ${error.message}</p>
    <button class="btn" onclick="closeProjectModal()">Modali Kapat</button>`;
  }
}


    function handleEscapeKey(e) {
        if (e.key === "Escape" && projectModal.style.display === "flex") {
            closeProjectModal();
        }
    }

    // Google Haritalar'da konum açma fonksiyonu
    function openLocationInGoogleMaps(location) {
        if (!location) {
            showToast("Konum bilgisi bulunamadı!", true);
            return;
        }
        const encodedLocation = encodeURIComponent(location);
        const url = `https://www.google.com/maps/search/?api=1&query=${encodedLocation}`;
        window.open(url, '_blank');
    }

    async function renderViewModal(project) {
        let locationHtml = project.project_location || "-";
        if (project.project_location) {
            locationHtml += ` <button class="action-btn open-location-btn" data-location="${project.project_location}" title="Haritada Aç"><i class="fas fa-map-marker-alt"></i></button>`;
        }
        modalBody.innerHTML = `
            <div class="detail-item">
                <span class="detail-label">Proje Adı:</span>
                <span class="detail-value">${project.project_name ? project.project_name.normalize('NFC') : "-"}</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">Referans No:</span>
                <span class="detail-value">${project.reference_no || "-"}</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">Müşteri:</span>
                <span class="detail-value">${project.customer_name || "-"}</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">Konum:</span>
                <span class="detail-value">${locationHtml}</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">Durum:</span>
                <span class="detail-value">${getStatusBadgeHtml(project.display_status || "-")}</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">Başlangıç Tarihi:</span>
                <span class="detail-value">${formatDateForDisplay(project.start_date || "-")}</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">Bitiş Tarihi:</span>
                <span class="detail-value">${formatDateForDisplay(project.end_date || "-")}</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">Yönetici:</span>
                <span class="detail-value">${project.project_manager_name || "-"}</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">Açıklama:</span>
                <span class="detail-value">${project.description || "-"}</span>
            </div>
            <div class="progress-detail-section">
                <h3 class="modal-title" style="margin-bottom: 15px;"><i class="fas fa-tasks"></i> İş Gidişatı</h3>
                <div id="progressStepsContainer"></div>
                <button class="btn" style="margin-top: 15px;" id="addProgressStepBtn">
                    <i class="fas fa-plus"></i> İş Adımı Ekle
                </button>
            </div>
        `;
        try {
            await fetchProgressSteps(project.project_id);
        } catch (err) {
            const progressStepsContainer = document.getElementById("progressStepsContainer");
            if (progressStepsContainer) {
                progressStepsContainer.innerHTML = `<p style="color: var(--danger);">İş adımları yüklenemedi. Sunucuya ulaşılamıyor veya API hatası.</p>`;
            }
        }
    }

    // Düzenleme modalı fonksiyonu
 async function renderEditModal(project) {

        try {
            console.log("renderEditModal başladı, proje:", project.project_id);
            // Modalı "Yükleniyor" mesajıyla güncelle
            modalBody.innerHTML = '<p style="text-align: center;"><i class="fas fa-spinner fa-spin"></i> Form yükleniyor...</p>';

            // Müşterileri ve Proje Yöneticilerini çek
            console.log("Müşteriler ve yöneticiler fetch edilecek");
            let customers = [];
            let projectManagers = [];
            try {
                console.log("fetchCustomersForSelect çağrılıyor");
                customers = await fetchCustomersForSelect();
                console.log("Müşteriler çekildi:", customers.length);
            } catch (error) {
                console.error("Müşteri verilerini çekerken hata:", error);
                customers = [];
            }
            try {
                console.log("fetchProjectManagersForSelect çağrılıyor");
                projectManagers = await fetchProjectManagersForSelect();
                console.log("Proje yöneticileri çekildi:", projectManagers.length);
            } catch (error) {
                console.error("Proje yöneticisi verilerini çekerken hata:", error);
                projectManagers = [];
            }

            // Değişkenleri burada oluşturun
            let customerOptions = customers.map(c => 
                `<option value="${c.customer_id}" ${c.customer_id === project.customer_id ? 'selected' : ''}>${c.customer_name}</option>`
            ).join('');
            if (customers.length === 0) {
                customerOptions = `<option value="">Müşteri bulunamadı</option>`;
            }

            let managerOptions = projectManagers.map(pm => 
                `<option value="${pm.id}" ${pm.id === project.project_manager_user_id ? 'selected' : ''}>${pm.fullname}</option>`
            ).join('');
            if (projectManagers.length === 0) {
                managerOptions = `<option value="">Proje yöneticisi bulunamadı</option>`;
            }

            console.log("Select options hazırlandı");
            console.log("Form HTML hazırlanıyor");

            modalBody.innerHTML = `
                <input type="hidden" id="editProjectId" value="${project.project_id}">
                <div class="form-group">
                    <label for="editProjectName" class="form-label">Proje Adı</label>
                    <input type="text" id="editProjectName" class="form-input" value="${project.project_name ? project.project_name.normalize('NFC') : ""}">
                </div>
                <div class="form-group">
                    <label for="editReferenceNo" class="form-label">Referans No</label>
                    <input type="text" id="editReferenceNo" class="form-input" value="${project.reference_no || ""}">
                </div>
                <div class="form-group">
                    <label for="editCustomerId" class="form-label">Müşteri</label>
                    <select id="editCustomerId" class="form-input">
                        ${customerOptions}
                    </select>
                </div>
                <div class="form-group">
                    <label for="editLocation" class="form-label">Konum</label>
                    <input type="text" id="editLocation" class="form-input" value="${project.project_location || ""}">
                </div>
                <div class="form-group">
                    <label for="editStatus" class="form-label">Durum</label>
                    <select id="editStatus" class="form-input">
                        <option value="">Durum Seçiniz (Opsiyonel)</option> <!-- Boş seçenek eklendi -->
                        <option value="Tamamlandı">Tamamlandı</option>
                    </select>
                </div>
                <!-- Sözleşme Tarihi alanı -->
                <div class="form-group">
                    <label for="editContractDate" class="form-label">Sözleşme Tarihi</label>
                    <input type="date" id="editContractDate" class="form-input" value="${formatDateForInput(project.contract_date || "")}">
                </div>
                <!-- Toplantı Tarihi alanı -->
                <div class="form-group">
                    <label for="editMeetingDate" class="form-label">Toplantı Tarihi</label>
                    <input type="date" id="editMeetingDate" class="form-input" value="${formatDateForInput(project.meeting_date || "")}">
                </div>
                <div class="form-group">
                    <label for="editStartDate" class="form-label">Başlangıç Tarihi</label>
                    <input type="date" id="editStartDate" class="form-input" value="${formatDateForInput(project.start_date || "")}" disabled>
                </div>
                <div class="form-group">
                    <label for="editEndDate" class="form-label">Bitiş Tarihi</label>
                    <input type="date" id="editEndDate" class="form-input" value="${formatDateForInput(project.end_date || "")}" disabled>
                </div>
                <div class="form-group">
                    <label for="editProjectManagerId" class="form-label">Proje Yöneticisi</label>
                    <select id="editProjectManagerId" class="form-input">
                        ${managerOptions}
                    </select>
                </div>
                <div class="form-group">
                    <label for="editDescription" class="form-label">Açıklama</label>
                    <textarea id="editDescription" class="form-input" rows="4">${project.description || ""}</textarea>
                </div>
                <div class="progress-detail-section">
                    <h3 class="modal-title" style="margin-bottom: 15px;"><i class="fas fa-tasks"></i> İş Gidişatı</h3>
                    <div id="progressStepsContainer"></div>
                    <button class="btn" style="margin-top: 15px;" id="addProgressStepBtn">
                        <i class="fas fa-plus"></i> İş Adımı Ekle
                    </button>
                </div>
            `;
            console.log("Form HTML hazırlandı. İş adımları yükleniyor...");

            // İş adımlarını yükle - fetchProgressSteps
            await fetchProgressSteps(project.project_id, true);
            console.log("İş adımları yüklendi. Modal hazır.");
            

        } catch (error) {
            console.error("renderEditModal ile ilgili bir hata oluştu:", error);
            modalBody.innerHTML = `<p style="text-align: center; color: red;">Form yüklenirken bir hata oluştu: ${error.message}</p>`;
        }
    }

    // Müşterileri API'den çeken fonksiyon
    async function fetchCustomersForSelect() {
  try {
    console.log("fetchCustomersForSelect başladı");
    const response = await fetch(`${API_BASE_URL}/api/customers`);
    console.log("Müşteriler API yanıtı:", response.status);
    
    if (!response.ok) {
      const errorText = await response.text();
      console.error(`API Yanıtı Hata (Durum: ${response.status}):`, errorText);
      throw new Error(`Müşteriler çekilemedi: ${response.status} - ${errorText}`);
    }
    
    const customers = await response.json();
    console.log("Müşteriler başarıyla çekildi, toplam:", customers.length);
    return customers;
  } catch (error) {
    console.error("fetchCustomersForSelect hatası:", error);
    // Boş bir dizi dön, UI'nin çökmesini engelle
    return [];
  }
}

    // Proje Yöneticilerini API'den çeken fonksiyon
   async function fetchProjectManagersForSelect() {
  try {
    console.log("fetchProjectManagersForSelect başladı");
    const response = await fetch(`${API_BASE_URL}/api/users/non-admin`);
    console.log("Yöneticiler API yanıtı:", response.status);
    
    if (!response.ok) {
      const errorText = await response.text();
      console.error(`API Yanıtı Hata (Durum: ${response.status}):`, errorText);
      throw new Error(`Proje yöneticileri çekilemedi: ${response.status} - ${errorText}`);
    }
    
    const managers = await response.json();
    console.log("Yöneticiler başarıyla çekildi, toplam:", managers.length);
    return managers;
  } catch (error) {
    console.error("fetchProjectManagersForSelect hatası:", error);
    // Boş bir dizi dön, UI'nin çökmesini engelle
    return [];
  }
}


  async function saveProjectChanges() {
        const projectId = document.getElementById("editProjectId").value;
        const projectName = document.getElementById("editProjectName").value;
        const referenceNo = document.getElementById("editReferenceNo").value;
        const customerId = document.getElementById("editCustomerId").value;
        const projectLocation = document.getElementById("editLocation").value;
        const selectedStatus = document.getElementById("editStatus").value; // Kullanıcının seçtiği durum
        const contractDate = document.getElementById("editContractDate").value;
        const meetingDate = document.getElementById("editMeetingDate").value;
        const startDate = document.getElementById("editStartDate").value;
        const endDate = document.getElementById("editEndDate").value;
        const projectManagerId = document.getElementById("editProjectManagerId").value;
        const description = document.getElementById("editDescription").value;

        if (!projectName || !customerId || !projectManagerId || !startDate || !endDate) {
            showToast("Uyarı", "Lütfen tüm zorunlu alanları doldurun: Proje Adı, Müşteri, Proje Yöneticisi, Başlangıç Tarihi, Bitiş Tarihi.");
            return;
        }

        const projectData = {
    user_id: currentUser.id,
    project_name: projectName,
    reference_no: referenceNo,
    customer_id: customerId,
    project_location: projectLocation,
    contract_date: contractDate,
    meeting_date: meetingDate,
    start_date: startDate,
    end_date: endDate,
    project_manager_id: projectManagerId,
    description: description
};
        // Eğer kullanıcı "Tamamlandı" seçeneğini seçtiyse, bu durumu backend'e gönder
        if (selectedStatus === "Tamamlandı") {
            projectData.status = "Tamamlandı";
        }
        // Diğer durumlarda status alanı gönderilmeyecek, backend otomatik belirleyecek

        try {
            const response = await fetch(`${API_BASE_URL}/api/projects/${projectId}`, {
                method: "PUT",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify(projectData),
            });

            const data = await response.json();

            if (response.ok) {
                showToast("Başarılı", data.message || "Proje başarıyla güncellendi!");
                closeProjectModal();
                fetchProjects(); // Proje listesini yenile
                addActivity(
                    "Proje Güncellendi",
                    `"${projectName}" projesi güncellendi.`,
                    projectId,
                    "fas fa-edit",
                    "project_update"
                );
            } else {
                showToast(`Hata: ${data.message}`, true);
            }
        } catch (error) {
            console.error("Proje güncelleme hatası:", error);
            showToast("Sunucuya bağlanılamadı veya bir sorun oluştu.", true);
        }
    }

    // `isEditable` parametresi eklendi
 let successfulProgressEndpoint = null;
    async function fetchProgressSteps(projectId, isEditable = false) {
        try {
            console.log(`İş adımları getiriliyor: Proje ID ${projectId}`);
            
            let baseUrl = API_BASE_URL;
            if (baseUrl.endsWith('/')) {
                baseUrl = baseUrl.slice(0, -1);
            }
            
            const apiUrl = `${baseUrl}/api/projects/${projectId}/progress`;
            console.log(`İş adımları için API URL: ${apiUrl}`);
            
            const response = await fetch(apiUrl);
            console.log("API yanıt durumu:", response.status, response.statusText);
            
            if (!response.ok) {
                console.error(`API hatası: ${response.status} ${response.statusText}`);
                renderProgressSteps([], projectId, isEditable);
                return;
            }
            
            const data = await response.json();
            console.log("API'den gelen iş adımları verisi:", data);
            
            if (!data || (!Array.isArray(data) && !Array.isArray(data.steps))) {
                console.error("API'den geçersiz veri formatı geldi:", data);
                renderProgressSteps([], projectId, isEditable);
                return;
            }
            
            const steps = Array.isArray(data) ? data : data.steps;
            renderProgressSteps(steps, projectId, isEditable);
            
        } catch (error) {
            console.error("İş adımlarını getirme hatası:", error);
            renderProgressSteps([], projectId, isEditable);
        } finally {
            document.getElementById("projectModal").dataset.loading = "false";
            console.log("İş adımları yüklendi. Modal hazır.");
        }
    }
async function updateProjectDatesFromSteps(projectId) {
  try {
    console.log(`updateProjectDatesFromSteps başladı, projectId: ${projectId}`);
    
    // İlk olarak projenin mevcut detaylarını getir
    const projectResponse = await fetch(`${API_BASE_URL}/api/projects/${projectId}`);
    if (!projectResponse.ok) {
      console.error("Proje detayları getirilemedi:", projectResponse.status);
      throw new Error("Proje detayları getirilemedi");
    }
    
    const project = await projectResponse.json();
    console.log("Mevcut proje detayları alındı:", project);
    
    // Projeden önemli değerleri al
    const projectManagerId = project.project_manager_id || project.project_manager_user_id;
    
    if (!projectManagerId) {
      console.error("Proje yöneticisi bulunamadı. Güncelleme yapılamıyor.");
      showToast("Proje yöneticisi bulunamadı. Güncelleme yapılamıyor.", true);
      return;
    }
    
    // Tüm iş adımlarını getir
    const response = await fetch(`${API_BASE_URL}/api/projects/${projectId}/progress`);
    if (!response.ok) {
      console.error("İş adımları getirilemedi:", response.status);
      throw new Error("İş adımları getirilemedi");
    }
    
    const steps = await response.json();
    console.log(`${steps.length} iş adımı bulundu.`);
    
    if (!steps || steps.length === 0) {
      console.log("İş adımı bulunamadı, güncelleme yapılmıyor.");
      return; // İş adımı yoksa işlem yapma
    }
    
    // İlk olarak adımları tarihe göre sırala
    // Başlangıç tarihine göre artan sırada
    const startDateSortedSteps = [...steps].sort((a, b) => {
      const dateA = new Date(a.start_date || "9999-12-31");
      const dateB = new Date(b.start_date || "9999-12-31");
      return dateA - dateB;
    });
    
    // Bitiş tarihine göre azalan sırada (en son bitenler önce)
    const endDateSortedSteps = [...steps].sort((a, b) => {
      const dateA = new Date(a.end_date || "0000-01-01");
      const dateB = new Date(b.end_date || "0000-01-01");
      return dateB - dateA;
    });
    
    // İlk iş adımının başlangıç tarihi ve son iş adımının bitiş tarihi
    let earliestStartDate = null;
    let latestEndDate = null;
    
    // En erken başlangıç tarihi (ilk adım)
    if (startDateSortedSteps.length > 0 && startDateSortedSteps[0].start_date) {
      earliestStartDate = startDateSortedSteps[0].start_date;
      console.log("En erken başlangıç tarihi:", earliestStartDate);
    }
    
    // En geç bitiş tarihi (son adım)
    if (endDateSortedSteps.length > 0 && endDateSortedSteps[0].end_date) {
      latestEndDate = endDateSortedSteps[0].end_date;
      console.log("En geç bitiş tarihi:", latestEndDate);
    }
    
    // Projeyi güncelle
    if (earliestStartDate || latestEndDate) {
      console.log("Proje tarihlerini güncelliyorum...");
      
      // Bu kısımda sadece gerekli alanları gönderiyoruz
      const updateData = {
        user_id: currentUser.id,
        // Sadece tarih güncellemesi için minimum zorunlu alanlar
        project_manager_id: projectManagerId,
        start_date: earliestStartDate || project.start_date,
        end_date: latestEndDate || project.end_date
      };
      
      console.log("Proje güncellemek için gönderilen veriler:", updateData);
      
      const updateResponse = await fetch(`${API_BASE_URL}/api/projects/${projectId}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(updateData)
      });
      
      if (!updateResponse.ok) {
        console.log("Yanıt:", updateResponse.status);
        const errorText = await updateResponse.json();
        console.error("Proje tarihleri güncellenirken hata:", errorText);
      } else {
        console.log("Proje tarihleri başarıyla güncellendi");
        
        // Proje formundaki tarihleri güncelle
        if (earliestStartDate && document.getElementById("editStartDate")) {
          document.getElementById("editStartDate").value = formatDateForInput(earliestStartDate);
        }
        
        if (latestEndDate && document.getElementById("editEndDate")) {
          document.getElementById("editEndDate").value = formatDateForInput(latestEndDate);
        }
      }
    } else {
      console.log("Proje tarihleri için güncellenecek değer bulunamadı.");
    }
  } catch (error) {
    console.error("updateProjectDatesFromSteps hatası:", error);
    showToast("Proje tarihleri güncellenirken bir hata oluştu", true);
  }
}
async function applyDelayToStep(stepIndex, newlyAddedDelayDays, allSteps, projectId) {
        if (newlyAddedDelayDays <= 0) {
            showToast("Erteleme günü en az 1 olmalıdır.", true);
            return null; // Hata durumunda null döndür
        }

        try {
            console.log(`${stepIndex}. adıma ${newlyAddedDelayDays} gün erteleme uygulanıyor.`);

            // İlk olarak, hedef adımın kendi custom_delay_days değerini güncelle
            const currentStep = allSteps[stepIndex];
            const currentProgressId = currentStep.progress_id;

            // Mevcut step'in güncel değerlerini al
            const currentStepName = document.getElementById(`step-${currentProgressId}-name`).value;
            const currentStepDescription = document.getElementById(`step-${currentProgressId}-desc`).value;
            const currentStepStartDate = document.getElementById(`step-${currentProgressId}-start`).value;
            const originalCurrentStepEndDate = document.getElementById(`step-${currentProgressId}-end`).value; // Orijinal bitiş tarihini al

            // Gecikme eklenen adımın kendi bitiş tarihini güncelle
            const newCurrentStepEndDate = new Date(originalCurrentStepEndDate);
            newCurrentStepEndDate.setDate(newCurrentStepEndDate.getDate() + newlyAddedDelayDays);

            const targetStepData = {
                step_name: currentStepName,
                description: currentStepDescription,
                start_date: currentStepStartDate,
                // Güncellenmiş bitiş tarihini kullan
                end_date: newCurrentStepEndDate.toISOString().split('T')[0], 
                // Bu, backend'de mevcut custom_delay_days'e eklenecek
                newly_added_custom_delay: newlyAddedDelayDays 
            };

            // Frontend input'unu da hemen güncelle
            document.getElementById(`step-${currentProgressId}-end`).value = newCurrentStepEndDate.toISOString().split('T')[0];

            // Hedef adımı backend'de güncelle
            const targetStepResponse = await fetch(`${API_BASE_URL}/api/progress/${currentProgressId}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(targetStepData)
            });

            const targetStepResponseData = await targetStepResponse.json();
            if (!targetStepResponse.ok) {
                throw new Error(targetStepResponseData.message || 'Hedef iş adımı güncellenemedi.');
            }
            // Burada toast mesajını kaldırıyoruz, çünkü renderProgressSteps'ten sonra gösterilecek.
            // showToast(`"${targetStepData.step_name}" iş adımına ${newlyAddedDelayDays} gün erteleme eklendi.`);

            // Şimdi, sonraki adımların tarihlerini güncelle ve backend'e gönder
            // Bu döngü, gecikme uygulanan adımdan sonraki her adımı etkileyecek
            for (let i = stepIndex + 1; i < allSteps.length; i++) {
                const step = allSteps[i];
                const progressId = step.progress_id;

                const startDateInput = document.getElementById(`step-${progressId}-start`);
                const endDateInput = document.getElementById(`step-${progressId}-end`);
                const stepNameInput = document.getElementById(`step-${progressId}-name`);
                const descriptionInput = document.getElementById(`step-${progressId}-desc`);

                if (!startDateInput || !endDateInput || !stepNameInput || !descriptionInput) {
                    console.error(`${i}. adım için gerekli inputlar bulunamadı`);
                    continue;
                }

                // Mevcut başlangıç ve bitiş tarihlerini Date objelerine çevir
                const currentStartDate = new Date(startDateInput.value);
                const currentEndDate = new Date(endDateInput.value);

                // Yeni başlangıç ve bitiş tarihlerini hesapla (gecikme günlerini ekle)
                // setDate metodu, tarihi doğrudan değiştirir, bu yüzden yeni bir Date objesi oluşturmak önemlidir.
                const newStartDate = new Date(currentStartDate);
                newStartDate.setDate(newStartDate.getDate() + newlyAddedDelayDays);

                const newEndDate = new Date(currentEndDate);
                newEndDate.setDate(newEndDate.getDate() + newlyAddedDelayDays);

                // Frontend inputlarını güncelle
                startDateInput.value = newStartDate.toISOString().split('T')[0];
                endDateInput.value = newEndDate.toISOString().split('T')[0];

                // Backend'e göndermek için payload oluştur
                const subsequentStepData = {
                    step_name: stepNameInput.value,
                    description: descriptionInput.value,
                    start_date: newStartDate.toISOString().split('T')[0],
                    end_date: newEndDate.toISOString().split('T')[0],
                    // Bu adımlara yeni bir custom delay eklemiyoruz, sadece tarihlerini kaydırıyoruz.
                    newly_added_custom_delay: 0 
                };

                // Sonraki adımı backend'de güncelle
                const subsequentStepResponse = await fetch(`${API_BASE_URL}/api/progress/${progressId}`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(subsequentStepData)
                });

                const subsequentStepResponseData = await subsequentStepResponse.json();
                if (!subsequentStepResponse.ok) {
                    console.error(`Sonraki iş adımı (${stepNameInput.value}) güncellenemedi:`, subsequentStepResponseData.message);
                    showToast(`"${stepNameInput.value}" iş adımı güncellenirken hata: ${subsequentStepResponseData.message}`, true);
                } else {
                    console.log(`"${stepNameInput.value}" iş adımı başarıyla güncellendi.`);
                }
            }

            // İş adımlarını ve projeyi yeniden yükle
            await fetchProgressSteps(projectId, true);
            await fetchProjects();

            return targetStepResponseData; // Return the response data for the toast
        } catch (error) {
            console.error("Erteleme uygulama hatası:", error);
            showToast("Erteleme uygulanırken bir hata oluştu: " + error.message, true);
            return null;
        }
    }
    function renderProgressSteps(steps, projectId, isEditable = false) {
        if (!steps || !Array.isArray(steps)) {
            console.error("Geçersiz steps parametresi:", steps);
            const progressStepsContainer = document.getElementById("progressStepsContainer");
            if (progressStepsContainer) {
                progressStepsContainer.innerHTML = '<p>İş adımlarını yüklerken bir hata oluştu.</p>';
            }
            return;
        }
        
        // Container'a project-id özelliği ekle
        const container = document.getElementById('progressStepsContainer');
        if (container) {
            container.setAttribute('data-project-id', projectId);
            container.setAttribute('data-loading', 'false');
        }

        const progressStepsContainer = document.getElementById("progressStepsContainer");
        if (!progressStepsContainer) return;
        progressStepsContainer.innerHTML = "";
        console.log("Render progress steps (tüm array):", steps);

        if (steps.length === 0) {
            progressStepsContainer.innerHTML = '<p>Bu proje için henüz iş adımı eklenmemiş.</p>';
        } else {
            steps.forEach((step, index) => {
                console.log(`İş adımı ${index} (ID: ${step.progress_id || step.id || 'bilinmiyor'}):`, step);
                // Check if step is completed - check both is_completed and status fields
                const isCompleted = step.is_completed === true || step.is_completed === 1 || step.status === 'tamamlandi';
                const disabledAttr = isCompleted ? 'disabled' : '';
                const readonlyClass = isCompleted ? 'readonly-field' : '';
                
                const stepElement = document.createElement("div");
                stepElement.className = `progress-detail-item ${isCompleted ? 'completed-step' : ''}`;
                stepElement.dataset.stepIndex = index;
                stepElement.dataset.progressId = step.progress_id || step.id || '';
                
                // Add data attribute to easily check if step is completed
                if (isCompleted) {
                    stepElement.setAttribute('data-completed', 'true');
                }
                
                // For edit mode, we'll show a dropdown for header selection instead of a text input
                
                let titleContent;
                if (isEditable) {
                    // We'll fetch the headers when the edit form is opened
                    titleContent = `
                        <div class="header-select-wrapper">
                            <label for="step-${step.progress_id}-header" class="form-label">Başlık</label>
                            <div class="select-container">
                                <select id="step-${step.progress_id}-header" class="header-dropdown ${readonlyClass}" ${disabledAttr} required>
                                    <option value="">Başlık seçiniz...</option>
                                    <!-- Headers will be loaded dynamically -->
                                </select>
                                ${isCompleted ? '' : `
                                <div class="select-arrow">
                                    <i class="fas fa-chevron-down"></i>
                                </div>`}
                            </div>
                        </div>
                        <input type="hidden" id="step-${step.progress_id}-name" value="${step.step_name || step.title || ''}">
                    `;
                } else {
                    titleContent = `<span class="progress-detail-title">${step.step_name || step.title || ''}</span>`;
                }

                const startDateContent = isEditable ?
                    `<label for="step-${step.progress_id}-start">Başlangıç:</label>
                    <input type="date" id="step-${step.progress_id}-start" 
                           class="progress-datepicker ${readonlyClass}" 
                           value="${formatDateForInput(step.start_date || '')}" 
                           ${disabledAttr} 
                           required>` :
                    `Başlangıç: ${formatDateForDisplay(step.start_date || '-')}`;

                const endDateContent = isEditable ?
                    `<label for="step-${step.progress_id}-end">Bitiş:</label>
                    <input type="date" id="step-${step.progress_id}-end" 
                           class="progress-datepicker ${readonlyClass}" 
                           value="${formatDateForInput(step.end_date || '')}" 
                           ${disabledAttr} 
                           required>` :
                    `Bitiş: ${formatDateForDisplay(step.end_date || '-')}`;

                // Gerçek Bitiş Tarihi değeri, hem görüntülenecek hem de inputun değeri olacak
                const realEndDateValue = step.real_end_date ? formatDateForDisplay(step.real_end_date) : '-';
                
                // delayDaysContent içine Gerçek Bitiş Tarihi bilgisini ekle
                const delayDaysContent = isEditable ?
                    `<div class="delay-days-container">
                        <div class="delay-input-group">
                            <label for="step-${step.progress_id}-delay">Erteleme Ekle (gün):</label>
                            <input type="number" id="step-${step.progress_id}-delay" class="delay-days-input" min="0" value="0">
                            <button type="button" class="action-btn apply-delay-btn" data-id="${step.progress_id}" data-index="${index}"><i class="fas fa-check"></i> Uygula</button>
                        </div>
                        <span class="real-end-date-display">
                            <label>Gerçek Bitiş Tarihi:</label>
                            <span id="step-${step.progress_id}-real-end-display" style="font-weight: bold;">${realEndDateValue}</span>
                        </span>
                    </div>` : '';

                let delayInfoHtml = '';

                // Hesaplanan gecikme (delay_days)
                const delayDays = parseInt(step.delay_days) || 0;
                if (delayDays > 0) {
                    delayInfoHtml += `<div class="delay-info" style="color: #ff9800; margin-top: 5px; font-style: italic; padding: 5px; background-color: rgba(255, 152, 0, 0.1); border-left: 3px solid #ff9800; border-radius: 3px;">
                        Bu iş adımında ${delayDays} günlük hesaplanan gecikme var.
                    </div>`;
                }

                // Ertelenen gün (custom_delay_days)
                let customDelayDays = 0;
                if (step.custom_delay_days !== undefined && step.custom_delay_days !== null) {
                    customDelayDays = parseInt(step.custom_delay_days) || 0;
                } else if (step.custom_delay !== undefined && step.custom_delay !== null) {
                    customDelayDays = parseInt(step.custom_delay) || 0;
                }

                if (customDelayDays > 0) {
                    delayInfoHtml += `<div class="custom-delay-info" style="color: #ff6b6b; margin-top: 8px; font-weight: bold; font-style: italic; padding: 8px; background-color: rgba(255, 107, 107, 0.1); border-left: 3px solid #ff6b6b; border-radius: 3px;">
                        Bu iş gidişatı ${customDelayDays} gün ertelenmiştir! (Gerçek Bitiş Tarihi: ${formatDateForDisplay(step.real_end_date || '-')})
                    </div>`;
                }

                const descriptionContent = isEditable ?
                    `<textarea id="step-${step.progress_id}-desc" 
                              class="progress-description-textarea ${readonlyClass}" 
                              placeholder="Açıklama" 
                              ${disabledAttr}>${step.description || ''}</textarea>` :
                    `<div class="progress-detail-description">Açıklama: ${step.description || 'Yok'}</div>`;

                    let actionsContent = '';
                    if (isEditable) {
                        actionsContent = `
                        <div class="progress-actions d-flex justify-content-between align-items-center">
                            <div class="checkbox-wrapper-46 me-3">
                                <input type="checkbox" 
                                       id="complete-${step.progress_id}" 
                                       class="inp-cbx complete-step-checkbox"
                                       ${isCompleted ? 'checked disabled' : ''}
                                       onchange="updateProgressStatus(${step.progress_id}, this.checked)"
                                       data-id="${step.progress_id}" />
                                       
                                <label for="complete-${step.progress_id}" class="cbx" style="${isCompleted ? 'opacity: 1;' : ''}">
                                    <span>
                                        <svg viewBox="0 0 12 10" height="10px" width="12px">
                                            <polyline points="1.5 6 4.5 9 10.5 1"></polyline>
                                        </svg>
                                    </span>
                                    <span>${isCompleted ? 'Tamamlandı' : 'Tamamlandı'}</span>
                                </label>
                            </div>
                            <div class="d-flex align-items-center">
                                ${isCompleted ? `
                                <button type="button" 
                                        class="btn btn-warning btn-sm me-2 request-revision-btn" 
                                        data-progress-id="${step.progress_id}" 
                                        data-project-id="${projectId}"
                                        title="Revize İsteği Gönder">
                                    <i class="fas fa-edit"></i> Revize İsteği Gönder
                                </button>` : ''}
                                <button type="button" class="action-btn save-progress-btn" data-id="${step.progress_id}" data-project-id="${projectId}" title="Kaydet" ${isCompleted ? 'disabled' : ''}>
                                    <i class="fas fa-save"></i> Kaydet
                                </button>
                                <button type="button" class="action-btn delete-progress-btn" data-id="${step.progress_id}" data-project-id="${projectId}" title="Sil">
                                    <i class="fas fa-trash"></i> Sil
                                </button>
                            </div>
                        </div>`;
                    } else {
                        actionsContent = `
                        <div class="progress-actions d-flex justify-content-between align-items-center">
                            <span class="badge ${step.status === 'tamamlandi' ? 'bg-success' : 'bg-warning text-dark'}">
                                ${step.status === 'tamamlandi' ? 'Tamamlandı' : 'Devam Ediyor'}
                            </span>
                            ${step.status === 'tamamlandi' ? `
                            <button type="button" 
                                    class="btn btn-warning btn-sm request-revision-btn" 
                                    data-progress-id="${step.progress_id}" 
                                    data-project-id="${projectId}">
                                <i class="fas fa-edit"></i> Revize İsteği Gönder
                            </button>` : ''}
                        </div>`;
                    }

                stepElement.innerHTML = `
                    <div class="progress-item-header">
                        <div class="input-group" style="flex: 1;">
                            ${isEditable ? '<label for="step-' + step.progress_id + '-name">Adım Başlığı</label>' : ''}
                            ${titleContent}
                        </div>
                        <div class="progress-dates" style="margin-left: ${isEditable ? '20px' : '0'};">
                            <span>
                                ${startDateContent}
                            </span>
                            <span>
                                ${endDateContent}
                            </span>
                        </div>
                    </div>
                    ${delayInfoHtml}
                    <div class="input-group">
                        ${isEditable ? '<label for="step-' + step.progress_id + '-desc">Açıklama</label>' : ''}
                        ${descriptionContent}
                    </div>
                    ${delayDaysContent}
                    ${actionsContent}
                `;
                progressStepsContainer.appendChild(stepElement);
                
                // If step is completed, disable all form fields except the revision request button
                if (isCompleted && isEditable) {
                    // Select all form elements except the revision request button
                    const formElements = stepElement.querySelectorAll('input:not(.request-revision-btn), select, textarea, button:not(.request-revision-btn), .btn-edit, .btn-delete');
                    formElements.forEach(element => {
                        element.disabled = true;
                        element.style.pointerEvents = 'none';
                        element.style.opacity = '0.6';
                    });
                    
                    // Also disable any links that might be used for editing
                    const editLinks = stepElement.querySelectorAll('a[href*="edit"], .edit-link');
                    editLinks.forEach(link => {
                        link.style.pointerEvents = 'none';
                        link.style.opacity = '0.6';
                        link.style.cursor = 'not-allowed';
                        link.onclick = (e) => {
                            e.preventDefault();
                            return false;
                        };
                    });
                    
                    // Make sure the revision request button is clickable
                    const revBtns = stepElement.querySelectorAll('.request-revision-btn');
                    revBtns.forEach(btn => {
                        btn.disabled = false;
                        btn.style.pointerEvents = 'auto';
                        btn.style.opacity = '1';
                        btn.style.cursor = 'pointer';
                    });
                    
                    // Add a visual indicator that the step is completed and cannot be edited
                    const completedBadge = document.createElement('span');
                    completedBadge.className = 'badge bg-success ms-2';
                    completedBadge.textContent = 'Tamamlandı';
                    const titleElement = stepElement.querySelector('.progress-detail-title');
                    if (titleElement) {
                        titleElement.appendChild(completedBadge);
                    }
                    
                    // Ensure the revision request button is visible and clickable
                    const revBtn = stepElement.querySelector('.request-revision-btn');
                    if (revBtn) {
                        revBtn.style.display = 'inline-block';
                        revBtn.style.visibility = 'visible';
                    }
                }
            });

            if (isEditable) {
                // Load headers for each edit form
                document.querySelectorAll('.progress-detail-item').forEach(async (stepElement, index) => {
                    const progressId = stepElement.querySelector('button.save-progress-btn')?.dataset.id;
                    if (!progressId) return;
                    
                    const headerSelect = document.getElementById(`step-${progressId}-header`);
                    if (!headerSelect) return;
                    
                    try {
                        const res = await fetch(`${API_BASE_URL}/api/work-progress-headers/active`);
                        if (!res.ok) throw new Error("Başlıklar alınamadı");
                        const headersList = await res.json();
                        
                        // Clear existing options except the first one
                        headerSelect.innerHTML = '<option value="">Başlık seçiniz...</option>';
                        
                        // Add headers to the dropdown
                        headersList.forEach(header => {
                            const option = document.createElement('option');
                            option.value = header.id;
                            option.textContent = header.title;
                            headerSelect.appendChild(option);
                        });
                        
                        // Select the current header if it exists
                        const currentStep = steps.find(s => s.progress_id == progressId);
                        if (currentStep?.header_id) {
                            headerSelect.value = currentStep.header_id;
                        } else if (currentStep?.step_name) {
                            // Try to find a matching header by name if no header_id is set
                            const matchingHeader = headersList.find(h => 
                                h.title === currentStep.step_name
                            );
                            if (matchingHeader) {
                                headerSelect.value = matchingHeader.id;
                            }
                        }
                    } catch (err) {
                        console.error("Başlık listesi yüklenemedi:", err);
                    }
                });
                
                document.querySelectorAll('.save-progress-btn').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const progressId = e.currentTarget.dataset.id;
                        const projId = e.currentTarget.dataset.projectId;
                        const headerSelect = document.getElementById(`step-${progressId}-header`);
                        const selectedHeaderId = headerSelect.value;
                        const selectedHeaderText = headerSelect.options[headerSelect.selectedIndex].text;
                        const stepName = selectedHeaderText;
                        const startDate = document.getElementById(`step-${progressId}-start`).value;
                        const endDate = document.getElementById(`step-${progressId}-end`).value;
                        const description = document.getElementById(`step-${progressId}-desc`).value;

                        await editProgressStep(progressId, projId, {
                            step_name: stepName,
                            header_id: selectedHeaderId,
                            start_date: startDate,
                            end_date: endDate,
                            description: description,
                            newly_added_custom_delay: 0 // Kaydet butonuna basıldığında ek bir erteleme olmamalı
                        });
                    });
                });

                document.querySelectorAll('.delete-progress-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const progressId = e.currentTarget.dataset.id;
                        const projId = e.currentTarget.dataset.projectId;
                        showConfirmationModal(`İş Adımı Sil`, `Bu iş adımını silmek istediğinize emin misiniz? Bu işlem geri alınamaz!`, () => deleteProgressStep(progressId, projId));
                    });
                });

                document.querySelectorAll('.apply-delay-btn').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const progressId = e.currentTarget.dataset.id;
                        const stepIndex = parseInt(e.currentTarget.dataset.index);
                        const newDelayDays = parseInt(document.getElementById(`step-${progressId}-delay`).value) || 0;

                        if (newDelayDays > 0) {
                            const updatedStepInfo = await applyDelayToStep(stepIndex, newDelayDays, steps, projectId);
                            // Real end date'i doğrudan backend'den gelen değerle güncelle
                            if (updatedStepInfo && updatedStepInfo.real_end_date) {
                                document.getElementById(`step-${progressId}-real-end-display`).textContent = formatDateForDisplay(updatedStepInfo.real_end_date);
                                showToast(`Bu iş gidişatı ${newDelayDays} gün ertelenmiştir! (Gerçek Bitiş Tarihi: ${formatDateForDisplay(updatedStepInfo.real_end_date)})`);
                            } else {
                                showToast("Erteleme başarıyla uygulandı.");
                            }
                        } else {
                            showToast("Lütfen geçerli bir erteleme günü girin.", true);
                        }
                    });
                });
            }
        }
// Remove any existing click handlers
document.querySelectorAll('.complete-step-checkbox').forEach(checkbox => {
    checkbox.onclick = null;
});

// Add new click handler

        const addProgressStepButton = document.getElementById("addProgressStepBtn");
        if (addProgressStepButton) {
            addProgressStepButton.onclick = null;
            addProgressStepButton.onclick = function() {
                console.log("İş Adımı Ekle butonuna tıklandı");
                addNewProgressStepForm(projectId);
            };
        } else {
            console.error("addProgressStepBtn elementi bulunamadı!");
        }
    }

    async function addNewProgressStepForm(projectId) {
  console.log("addNewProgressStepForm başladı, projectId:", projectId);
  const progressStepsContainer = document.getElementById("progressStepsContainer");
  if (!progressStepsContainer) {
    console.error("progressStepsContainer elementi bulunamadı!");
    showToast("Hata", "İş adımı eklenemiyor: Form container bulunamadı");
    return;
  }

  if (document.getElementById('newProgressForm')) {
    console.log("Zaten açık bir ekleme formu var, yeni form açılmayacak.");
    showToast("Uyarı", "Zaten açık bir ekleme formu var.");
    return;
  }

  // API'den başlıkları çek
  let headersList = [];
  try {
    const res = await fetch(`${API_BASE_URL}/api/work-progress-headers/active`);
    if (!res.ok) throw new Error("Başlıklar alınamadı");
    headersList = await res.json();
  } catch (err) {
    console.error("Başlık listesi alınamadı:", err);
    showToast("Hata", "Başlıklar alınırken hata oluştu");
    return;
  }

  const formElement = document.createElement('div');
  formElement.id = 'newProgressForm';
  formElement.className = 'progress-detail-item';
  formElement.innerHTML = `
    <div class="progress-item-header">
                    <div class="header-select-wrapper" style="flex: 1;">
                        <label for="newStepHeader" class="form-label">Başlık</label>
                        <div class="select-container">
                            <select id="newStepHeader" class="header-dropdown" required>
                                <option value="">Başlık seçiniz...</option>
                                ${headersList.map(h => `<option value="${h.id}">${h.title}</option>`).join('')}
                            </select>
                            <div class="select-arrow">
                                <i class="fas fa-chevron-down"></i>
                            </div>
                        </div>
                    </div>

      <div class="progress-dates" style="margin-left: 20px;">
        <span>
          <label for="newStepStartDate">Başlangıç:</label>
          <input type="date" id="newStepStartDate" class="progress-datepicker" required>
        </span>
        <span>
          <label for="newStepEndDate">Bitiş:</label>
          <input type="date" id="newStepEndDate" class="progress-datepicker" required>
        </span>
      </div>
    </div>
    <div class="input-group">
      <label for="newStepDescription">Açıklama</label>
      <textarea id="newStepDescription" class="progress-description-textarea" placeholder="İş gidişat açıklaması"></textarea>
    </div>
    <div class="progress-actions">
      <button type="button" class="action-btn modal-btn-cancel" id="cancelAddProgressBtn"><i class="fas fa-times"></i> İptal</button>
      <button type="button" class="action-btn modal-btn-save" id="saveNewProgressBtn"><i class="fas fa-plus"></i> Ekle</button>
    </div>
  `;

  progressStepsContainer.appendChild(formElement);

  document.getElementById('saveNewProgressBtn').addEventListener('click', async () => {
    const headerId = document.getElementById('newStepHeader').value;
    const startDate = document.getElementById('newStepStartDate').value;
    const endDate = document.getElementById('newStepEndDate').value;
    const description = document.getElementById('newStepDescription').value;
    const headerSelect = document.getElementById('newStepHeader');
    const stepName = headerSelect.options[headerSelect.selectedIndex].text;


    if (!headerId || !startDate || !endDate) {
      showToast("Uyarı", "Lütfen tüm zorunlu alanları doldurun.");
      return;
    }

    try {
      const response = await fetch(`${API_BASE_URL}/api/projects/${projectId}/progress`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
  header_id: headerId,
  step_name: stepName, // Backend'in beklediği alan
  start_date: startDate,
  end_date: endDate,
  description: description,
  user_id: currentUser.id
})
      });

      const data = await response.json();
      if (response.ok) {
        showToast("Başarılı", "İş adımı başarıyla eklendi.");
        formElement.remove();
        await updateProjectDatesFromSteps(projectId);
        fetchProgressSteps(projectId, true);
        fetchProjects();
        addActivity('İş Adımı Eklendi', `Proje ID: ${projectId} için başlık ID ${headerId} ile iş adımı eklendi.`, projectId, 'fas fa-tasks', 'progress_add');
      } else {
        showToast(`Hata: ${data.message}`, true);
      }
    } catch (error) {
      console.error("Yeni iş adımı ekleme hatası:", error);
      showToast("Hata", "İş adımı eklenirken bir sorun oluştu: " + error.message);
    }
  });

  document.getElementById('cancelAddProgressBtn').addEventListener('click', () => {
    formElement.remove();
    showToast("Bilgi", "İş adımı ekleme iptal edildi.");
  });
}



  async function editProgressStep(progressId, projectId, updatedStepData) {
        try {
            // newly_added_custom_delay'i varsayılan olarak 0 ayarla eğer gelmiyorsa
            const payload = {
                ...updatedStepData,
                newly_added_custom_delay: updatedStepData.newly_added_custom_delay || 0
            };

            const response = await fetch(`${API_BASE_URL}/api/progress/${progressId}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload),
            });

            const data = await response.json();

            if (response.ok) {
                showToast("İş adımı başarıyla güncellendi.");

                // İş adımı güncellemesi başarılı olduktan sonra proje tarihlerini güncelle
                await updateProjectDatesFromSteps(projectId);

                // Listeyi güncelle
                fetchProjects();
                fetchProgressSteps(projectId, true);

                addActivity(
                    "İş Adımı Güncellendi",
                    `Proje ID: ${projectId} için "${updatedStepData.step_name}" iş adımı güncellendi.`,
                    projectId,
                    "fas fa-pen",
                    "progress_update"
                );
            } else {
                showToast(`Hata: ${data.message}`, true);
            }
        } catch (error) {
            console.error("İş adımı güncelleme hatası:", error);
            showToast("Hata", "İş adımı güncellenirken bir sorun oluştu.");
        }
    }

    // progress_id kullanıldı
    async function deleteProgressStep(progressId, projectId) {
        try {
            const response = await fetch(`${API_BASE_URL}/api/progress/${progressId}`, { // progressId kullanılıyor
                method: "DELETE",
            });
            const data = await response.json();
            if (response.ok) {
                showToast("Başarılı", "İş adımı başarıyla silindi!");
                fetchProjects(); // Projeler listesini de yenile (durum güncellenmiş olabilir)
                fetchProgressSteps(projectId, true); // Adımları yenile (düzenleme modunda kal)
                addActivity(
                    "İş Adımı Silindi",
                    `Proje ID: ${projectId} için bir iş adımı silindi.`,
                    projectId,
                    "fas fa-times",
                    "progress_delete"
                );
            } else {
                showToast(`Hata: ${data.message}`, true);
            }
        } catch (error) {
            console.error("İş adımı silme hatası:", error);
            showToast("Hata", "İş adımı silinirken bir sorun oluştu.");
        }
    }
/**
 * @fileoverview This script generates an HTML-based preview of a project report,
 * designed to be easily printed or saved as a PDF.
 * It fetches project progress and revision data from an API and dynamically
 * constructs a detailed, multi-page report.
 */

/**
 * Generates and displays an HTML-based PDF preview for a given project.
 * The function fetches progress steps and revision counts, then dynamically
 * creates an HTML document with project details, a progress bar, and a list of steps.
 * It intelligently paginates the progress steps to ensure a balanced layout.
 *
 * @param {Object} project - The project object containing details like project_id, project_name, etc.
 * @param {string} project.project_id - The unique ID of the project.
 * @param {string} project.project_name - The name of the project.
 * @param {string} project.reference_no - The project's reference number.
 * @param {string} project.project_manager_name - The name of the project manager.
 * @param {string} project.customer_name - The customer's name.
 * @param {string} project.display_status - The current status text of the project.
 * @param {string} project.contract_date - The contract signing date.
 * @param {string} project.start_date - The planned start date.
 * @param {string} project.end_date - The planned end date.
 * @param {string} project.real_end_date - The actual end date.
 * @param {Function} showToast - A utility function to display a toast notification.
 * @param {Function} addActivity - A utility function to log a user activity.
 */
 async function generateProjectPdf(project) {
    let progressSteps = [];
    let revisionCounts = {};
    const API_BASE_URL = "https://your-api-base-url.com"; // Placeholder URL, replace with your actual API URL

    try {
        // Fetch project progress steps from the API
        const progressResponse = await fetch(`${API_BASE_URL}/api/projects/${project.project_id}/progress`);
        if (progressResponse.ok) {
            progressSteps = await progressResponse.json();
        } else {
            console.error("Proje ilerleme adımları çekilirken hata oluştu. HTTP Status:", progressResponse.status);
        }

        // Fetch revision counts for each step from the API
        const revisionCountResponse = await fetch(`${API_BASE_URL}/api/projects/${project.project_id}/revision-counts-by-step`);
        if (revisionCountResponse.ok) {
            revisionCounts = await revisionCountResponse.json();
        } else {
            console.error("Revizyon sayıları çekilirken hata oluştu. HTTP Status:", revisionCountResponse.status);
        }

    } catch (e) {
        console.error("Veri çekme veya işleme sırasında beklenmeyen bir hata oluştu:", e);
    }

    // Helper function to format a date string for display in Turkish locale
    const formatDateForDisplay = (dateStr) => {
        if (!dateStr || dateStr === '-') return '-';
        try {
            const date = new Date(dateStr);
            if (isNaN(date.getTime())) throw new Error("Invalid date format");
            return date.toLocaleDateString('tr-TR');
        } catch (error) {
            console.error("Tarih formatı dönüştürülürken hata:", dateStr, error);
            return '-';
        }
    };

    // Helper function to calculate the number of days since the contract was signed
    const calculateDaysSinceContract = (contractDateStr) => {
        if (!contractDateStr) return 0;
        const contractDate = new Date(contractDateStr);
        const today = new Date();
        const diffTime = today.getTime() - contractDate.getTime();
        return Math.floor(diffTime / (1000 * 60 * 60 * 24));
    };

    // Helper function to generate an HTML string for project status with color coding
    const getProjectStatusHtml = (statusText) => {
        const isDelayed = statusText && statusText.includes('Gecikmeli');
        const color = isDelayed ? 'red' : '#4CAF50';
        const text = isDelayed ? 'Gecikmeli devam ediyor' : 'Gecikmesiz devam ediyor';
        return `<span style="color: ${color}; font-weight: bold; margin: 0;">${text}</span>`;
    };

    // Helper function to extract and format the project phase from the status text
    const getProjectPhaseText = (statusText) => {
        if (!statusText) return 'Aşama bilgisi bulunamadı';
        const phaseName = statusText.split('(')[0].trim();
        return `${phaseName} Aşamasında`;
    };

    // Helper function to generate an HTML string for a step's current status icon
    const getStepStatusHtml = (step) => {
        const today = new Date();
        const startDate = new Date(step.start_date);
        let statusText = '';
        if (step.is_completed) {
            statusText = `Tamamlandı <i class="fas fa-check-circle" style="color: green;"></i>`;
        } else if (today < startDate) {
            statusText = `Bekliyor <i class="fas fa-hourglass-start" style="color: grey;"></i>`;
        } else {
            statusText = `Devam Ediyor <i class="fas fa-spinner fa-spin" style="color: orange;"></i>`;
        }
        return statusText;
    };

    // Helper function to calculate the planned duration of a step
    const calculatePlannedDuration = (startDateStr, endDateStr) => {
        if (!startDateStr || !endDateStr) return '-';
        const startDate = new Date(startDateStr);
        const endDate = new Date(endDateStr);
        const diffTime = endDate.getTime() - startDate.getTime();
        return Math.floor(diffTime / (1000 * 60 * 60 * 24)) + 1;
    };

    // Helper function to calculate the actual duration of a step
    const calculateActualDuration = (startDateStr, realEndDateStr) => {
        if (!startDateStr) return '-';
        const startDate = new Date(startDateStr);
        const endDate = realEndDateStr ? new Date(realEndDateStr) : new Date();
        const diffTime = endDate.getTime() - startDate.getTime();
        return Math.floor(diffTime / (1000 * 60 * 60 * 24)) + 1;
    };

    // Calculates data for the project progress bar
    const calculateProgressBarData = (progressSteps) => {
        let totalPlannedDays = 0;
        let totalCompletedDays = 0;
        let totalDelayedDays = 0;
        const today = new Date();

        progressSteps.forEach(step => {
            const startDate = new Date(step.start_date);
            const endDate = new Date(step.end_date);
            const plannedDays = (endDate.getTime() - startDate.getTime()) / (1000 * 60 * 60 * 24) + 1;
            totalPlannedDays += plannedDays;
            if (step.is_completed) {
                const realEndDate = new Date(step.real_end_date);
                const stepCompletedDays = (realEndDate.getTime() - startDate.getTime()) / (1000 * 60 * 60 * 24) + 1;
                totalCompletedDays += stepCompletedDays;
                if (realEndDate > endDate) {
                    totalDelayedDays += (realEndDate.getTime() - endDate.getTime()) / (1000 * 60 * 60 * 24);
                }
            } else {
                if (today >= startDate) {
                    const stepPassedDays = (today.getTime() - startDate.getTime()) / (1000 * 60 * 60 * 24) + 1;
                    totalCompletedDays += stepPassedDays;
                }
            }
            totalDelayedDays += (step.delay_days || 0) + (step.custom_delay_days || 0);
        });

        const totalDuration = totalPlannedDays + totalDelayedDays;
        let completedPercentage = (totalCompletedDays / totalDuration) * 100;
        let delayPercentage = (totalDelayedDays / totalDuration) * 100;
        let remainingPercentage = 100 - completedPercentage - delayPercentage;

        completedPercentage = Math.round(Math.max(0, completedPercentage));
        delayPercentage = Math.round(Math.max(0, delayPercentage));
        remainingPercentage = Math.round(Math.max(0, remainingPercentage));

        const totalPercentage = completedPercentage + delayPercentage + remainingPercentage;
        if (totalPercentage !== 100) {
            remainingPercentage += 100 - totalPercentage;
        }

        return {
            totalPlannedDays: Math.ceil(totalPlannedDays),
            totalDelayedDays: Math.ceil(totalDelayedDays),
            totalRealDays: Math.ceil(totalCompletedDays + totalDelayedDays),
            completedPercentage,
            delayPercentage,
            remainingPercentage
        };
    };

    const progressBarData = calculateProgressBarData(progressSteps);

    // --- LOGIC CHANGE: DYNAMICALLY SPLIT STEPS FOR PAGINATION ---
    // Instead of a fixed number, we'll place the first 4 steps on the initial page
    // to better utilize the space. The rest will go on subsequent pages.
    const firstPageSteps = progressSteps.slice(0, 4);
    const remainingSteps = progressSteps.slice(4);

    // Helper function to generate HTML for a list of steps
    const generateStepHtml = (steps) => {
        if (steps.length === 0) return '';
        return steps.map((step, index) => {
            const stepId = step.progress_id;
            const revisionCountForStep = stepId ? (revisionCounts[String(stepId)] || 0) : 'Bulunamadı';
            return `
                <div class="progress-step-item" style="margin-bottom:12px;">
                    <div style="font-weight:bold; font-size:15px; margin-bottom: 5px; margin-top: 0;">
                        ${step.title || 'Başlık bilgisi yok'} <span style="font-weight: normal; float: right;">${getStepStatusHtml(step)}</span>
                    </div>
                    <div style="display:flex; justify-content:space-between; font-size:13px; color:#555;">
                        <div style="width:50%;">
                            <p><strong>Planlı Başlangıç:</strong> ${formatDateForDisplay(step.start_date || '-')}</p>
                            <p><strong>Planlı Bitiş:</strong> ${formatDateForDisplay(step.end_date || '-')}</p>
                            <p><strong>Gerçek Bitiş:</strong> ${formatDateForDisplay(step.real_end_date || '-')}</p>
                            <p><strong>Revize Sayısı:</strong> ${revisionCountForStep}</p>
                        </div>
                        <div style="width:50%; text-align:right;">
                            <p><strong>Planlanan Toplam Süre:</strong> ${calculatePlannedDuration(step.start_date, step.end_date)} gün</p>
                            <p><strong>Gecikme Toplam Süre:</strong> ${(step.delay_days || 0) + (step.custom_delay_days || 0)} gün</p>
                            <p><strong>Gerçek Toplam Süre:</strong> ${calculateActualDuration(step.start_date, step.real_end_date)} gün</p>
                        </div>
                    </div>
                    ${step.description ? `<div style="font-size:13px; margin-top: 5px;">Açıklama: ${step.description}</div>` : ''}
                </div>
            `;
        }).join('');
    };

    const firstPageStepsHtml = generateStepHtml(firstPageSteps);
    const remainingStepsHtml = generateStepHtml(remainingSteps);

    // Open a new window to display the PDF preview
    const newWindow = window.open('', '_blank', 'width=900,height=800,resizable=yes,scrollbars=yes');
    if (!newWindow) {
        showToast("PDF önizlemesi için yeni pencere açılamadı. Tarayıcınızın pop-up engelleyicisini kontrol edin.", true);
        return;
    }

    // Main HTML content for the PDF preview
    const fullHtmlContent = `
        <!DOCTYPE html>
        <html lang="tr">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>${project.project_name ? project.project_name.normalize('NFC') : "Proje"} Raporu Önizlemesi</title>
            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
            <style>
                @page {
                    size: A4;
                    margin: 0;
                }
                body {
                    font-family: 'Segoe UI', Arial, sans-serif;
                    margin: 0;
                    padding: 0;
                    background-color: #f0f2f5;
                }
                .pdf-container {
                    width: 210mm;
                    margin: 0 auto;
                    background: #fff;
                    box-shadow: 0 0 10px rgba(0,0,0,0.1);
                    min-height: 297mm;
                    box-sizing: border-box;
                    padding-top: 60px;
                    padding-bottom: 60px;
                }
                .screen-header, .screen-footer {
                    width: 170mm;
                    margin: 0 auto;
                    padding: 15px 0;
                }
                .screen-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    border-bottom: 1px solid #eee;
                    margin-bottom: 15px;
                }
                .screen-footer {
                    border-top: 1px solid #eee;
                    margin-top: 15px;
                    text-align: center;
                    color: #6c757d;
                    font-size: 12px;
                }
                .main-content {
                    box-sizing: border-box;
                    padding: 0 20mm;
                }

                /* PRINT STYLES */
                @media print {
                    body {
                        background-color: #fff;
                        -webkit-print-color-adjust: exact;
                        margin-top: 0;
                    }
                    .pdf-container {
                        margin: 0;
                        box-shadow: none;
                        padding: 0;
                        min-height: 100%;
                    }
                    .print-button-container {
                        display: none;
                    }
                    .screen-header, .screen-footer {
                        display: none;
                    }

                    /* Common header and footer for print */
                    .print-header {
                        display: block;
                        position: fixed;
                        top: 0;
                        left: 0;
                        right: 0;
                        height: 50px;
                        padding: 30px 20mm 5px 20mm; /* Increased top padding */
                        box-sizing: border-box;
                        background-color: #fff;
                        border-bottom: 1px solid #eee;
                        -webkit-print-color-adjust: exact;
                    }
                    .print-footer {
                        display: block;
                        position: fixed;
                        bottom: 0;
                        left: 0;
                        right: 0;
                        height: 50px;
                        padding: 5px 20mm;
                        box-sizing: border-box;
                        background-color: #fff;
                        border-top: 1px solid #eee;
                        font-size: 12px;
                        color: #6c757d;
                        text-align: center;
                        -webkit-print-color-adjust: exact;
                    }
                    .print-header > div, .print-footer > div {
                        width: 170mm;
                        margin: 0 auto;
                        height: 100%;
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                    }
                    .print-header img {
                        height: 35px;
                    }

                    .main-content {
                        padding-top: 80px; /* Leave enough space for the header */
                        padding-bottom: 50px;
                    }

                    .pdf-section-title {
                        page-break-before: always;
                    }

                    .progress-step-item {
                        page-break-inside: avoid;
                    }

                    .page-break-after {
                        page-break-after: always;
                    }

                    /* Page numbering */
                    body {
                        counter-reset: page-number;
                    }
                    .print-footer::before {
                        counter-increment: page-number;
                        content: "Sayfa " counter(page-number);
                        display: block;
                        text-align: center;
                    }
                }
                @media screen {
                    .print-header, .print-footer {
                        display: none;
                    }
                }
            </style>
        </head>
        <body>
            <!-- Static header and footer for print -->
            <div class="print-header">
                <div style="display:flex; justify-content:space-between; align-items:center; width:100%;">
                    <img src="https://serotomasyon.tr/static/serlogo.png" alt="Ser Elektrik Otomasyon Logo" style="height: 50px; margin-right: 15px;">
                    <h1 style="font-size: 20px; color: #005c9d; margin: 0; text-align: center; flex-grow: 1;">Proje Takip Formu</h1>
                    <div style="font-size: 12px; color: #6c757d; text-align: right; margin-left: 15px;">
                        ${formatDateForDisplay(new Date())}
                    </div>
                </div>
            </div>
            <div class="print-footer">
                <!-- Page number will be added here automatically -->
            </div>

            <div class="pdf-container">
                <!-- Header and footer for screen view -->
                <div class="screen-header">
                    <img src="https://serotomasyon.tr/static/serlogo.png" alt="Ser Elektrik Otomasyon Logo" style="height: 50px;">
                    <h1 style="font-size: 24px; color: #005c9d; margin: 0; text-align: center;">Proje Takip Formu</h1>
                    <div style="font-size: 14px; color: #555; text-align: right;">
                        ${formatDateForDisplay(new Date())}
                    </div>
                </div>
                <div class="main-content">
                    <!-- Section 1: Project Basic Information -->
                    <div style="border-top: 1px solid #ccc; margin-top: 10px; padding-top: 10px;">
                        <div style="display: flex; justify-content: space-between; font-size: 14px;">
                            <div style="width: 50%;">
                                <h3 style="margin: 0 0 10px 0; color: #005c9d; font-size: 16px;">
                                    ${project.reference_no || '-'}
                                </h3>
                                <p><strong>Proje Yöneticisi:</strong> ${project.project_manager_name || '-'}</p>
                                <p><strong>İşin Adı:</strong> ${project.project_name ? project.project_name.normalize('NFC') : '-'}</p>
                                <p><strong>Müşteri Adı:</strong> ${project.customer_name || '-'}</p>
                            </div>
                            <div style="width: 50%; text-align: right;">
                                <p style="margin: 0; font-weight: bold;">${getProjectStatusHtml(project.display_status)}</p>
                                <p style="margin-top: 10px;"><strong>Sözleşme imzalanalı:</strong> ${calculateDaysSinceContract(project.contract_date)} gün oldu</p>
                            </div>
                        </div>
                    </div>

                    <!-- Section 2: Project Duration and Progress -->
                    <div style="border-top: 1px solid #ccc; margin-top: 20px; padding-top: 20px;">
                        <div style="display: flex; justify-content: space-between; font-size: 14px;">
                            <div style="width: 50%;">
                                <p><strong>Sözleşme Tarihi:</strong> ${formatDateForDisplay(project.contract_date || '-')}</p>
                                <p><strong>Planlı Başlangıç:</strong> ${formatDateForDisplay(project.start_date || '-')}</p>
                                <p><strong>Planlı Bitiş:</strong> ${formatDateForDisplay(project.end_date || '-')}</p>
                                <p><strong>Gerçek Bitiş:</strong> ${formatDateForDisplay(project.real_end_date || '-')}</p>
                            </div>
                            <div style="width: 50%; text-align: right;">
                                <p><strong>Planlanan Toplam Süre:</strong> ${progressBarData.totalPlannedDays || '-'} gün</p>
                                <p><strong>Gecikme Toplam Süre:</strong> ${progressBarData.totalDelayedDays || '-'} gün</p>
                                <p><strong>Gerçek Toplam Süre:</strong> ${progressBarData.totalRealDays || '-'} gün</p>
                            </div>
                        </div>

                        <h4 style="text-align: center; font-size: 16px; margin-top: 20px; color: #005c9d;">
                            ${getProjectPhaseText(project.display_status)}
                        </h4>

                        <div style="height: 20px; background-color: #e0e0e0; border-radius: 10px; overflow: hidden; margin-top: 15px;">
                            <div style="height: 100%; display: flex;">
                                <div style="background-color: #4CAF50; width: ${progressBarData.completedPercentage}%;"></div>
                                <div style="background-color: #f44336; width: ${progressBarData.delayPercentage}%;"></div>
                                <div style="background-color: #ccc; width: ${progressBarData.remainingPercentage}%;"></div>
                            </div>
                        </div>
                        <div style="font-size: 12px; margin-top: 5px; display: flex; justify-content: space-between;">
                            <div style="text-align: left;"><span style="color: #4CAF50;">■</span> Tamamlanan Süre: ${progressBarData.totalRealDays} gün</div>
                            <div style="text-align: center;"><span style="color: #f44336;">■</span> Gecikme Süresi: ${progressBarData.totalDelayedDays} gün</div>
                            <div style="text-align: right;"><span style="color: #ccc;">■</span> Kalan Süre: ${progressBarData.totalPlannedDays - progressBarData.totalRealDays} gün</div>
                        </div>
                    </div>

                    <!-- Project Progress Steps (First page) -->
                    ${firstPageStepsHtml.length > 0 ? `
                    <div style="margin-top: 20px; padding-top: 20px;">
                        <div class="pdf-section-title" style='font-size:18px; color:#005c9d; border-bottom:1px solid #e1e5e9; padding-bottom:5px; margin-bottom:15px;'><i class="fas fa-tasks"></i> İş Gidişatı</div>
                        <div>
                            ${firstPageStepsHtml}
                        </div>
                    </div>
                    ` : ''}

                    <!-- Project Progress Steps (Remaining pages) -->
                    ${remainingStepsHtml.length > 0 ? `
                    <div class="page-break-after"></div>
                    <div style="margin-top: 20px; padding-top: 20px;">
                        <div class="pdf-section-title" style='font-size:18px; color:#005c9d; border-bottom:1px solid #e1e5e9; padding-bottom:5px; margin-bottom:15px;'><i class="fas fa-tasks"></i> İş Gidişatı</div>
                        <div>
                            ${remainingStepsHtml}
                        </div>
                    </div>
                    ` : ''}
                </div>
            </div>

            <div class="print-button-container" style="text-align: center; margin-top: 20px; padding-bottom: 20px;">
                <button class="print-button" onclick="window.print()" style="background-color: #005c9d; color: white; padding: 10px 20px; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; transition: background-color 0.3s ease;">
                    <i class="fas fa-print"></i> PDF Kaydet / Yazdır
                </button>
            </div>
        </body>
        </html>
    `;

    newWindow.document.write(fullHtmlContent);
    newWindow.document.close();

    newWindow.onload = () => {
        showToast(`${project.project_name ? project.project_name.normalize('NFC') : "proje"} için PDF raporu önizlemesi hazır.`);
        addActivity(
            "PDF Raporu Önizlendi",
            `${project.project_name ? project.project_name.normalize('NFC') : "proje"} için PDF raporu önizlemesi açıldı.`,
            project.project_id,
            "fas fa-file-pdf",
            "pdf_preview"
        );
    };
}

async function exportAllProjectsToPdf() {
        showToast("Tüm projeler PDF olarak hazırlanıyor...", false);

        let allProjectsHtml = `
            <div style="font-family: 'Segoe UI', Arial, sans-serif; padding: 15mm; color: #333; background: #fff; box-sizing: border-box;">
                <div style="text-align: center; margin-bottom: 20px;">
                    <h1 style='font-size:28px;color:#005c9d;margin-bottom:5px;'>Ser Elektrik Otomasyon</h1>
                    <h2 style='font-size:22px;color:#0980d3;margin-bottom:15px;'>Tüm Projeler Raporu</h2>
                </div>
                <table style="width:100%; border-collapse: collapse; margin-bottom: 20px; border: 1px solid #e1e5e9;">
                    <thead>
                        <tr>
                            <th style="border: 1px solid #e1e5e9; padding: 10px 8px; text-align: left; background-color: #f0f4f8; font-weight: bold; color: #5e6870;">Proje Adı</th>
                            <th style="border: 1px solid #e1e5e9; padding: 10px 8px; text-align: left; background-color: #f0f4f8; font-weight: bold; color: #5e6870;">Referans No</th>
                            <th style="border: 1px solid #e1e5e9; padding: 10px 8px; text-align: left; background-color: #f0f4f8; font-weight: bold; color: #5e6870;">Müşteri</th>
                            <th style="border: 1px solid #e1e5e9; padding: 10px 8px; text-align: left; background-color: #f0f4f8; font-weight: bold; color: #5e6870;">Durum</th>
                            <th style="border: 1px solid #e1e5e9; padding: 10px 8px; text-align: left; background-color: #f0f4f8; font-weight: bold; color: #5e6870;">Başlangıç</th>
                            <th style="border: 1px solid #e1e5e9; padding: 10px 8px; text-align: left; background-color: #f0f4f8; font-weight: bold; color: #5e6870;">Bitiş</th>
                            <th style="border: 1px solid #e1e5e9; padding: 10px 8px; text-align: left; background-color: #f0f4f8; font-weight: bold; color: #5e6870;">Toplam Gün</th>
                            <th style="border: 1px solid #e1e5e9; padding: 10px 8px; text-align: left; background-color: #f0f4f8; font-weight: bold; color: #5e6870;">Geçen Gün</th>
                            <th style="border: 1px solid #e1e5e9; padding: 10px 8px; text-align: left; background-color: #f0f4f8; font-weight: bold; color: #5e6870;">Gecikme Durumu</th>
                            <th style="border: 1px solid #e1e5e9; padding: 10px 8px; text-align: left; background-color: #f0f4f8; font-weight: bold; color: #5e6870;">Yönetici</th>
                        </tr>
                    </thead>
                    <tbody>
        `;

        function dateDiffInDays(date1, date2) {
            function parseDate(str) {
                if (!str) return null;
                if (str.includes('-')) {
                    const [y, m, d] = str.split('-');
                    return new Date(Number(y), Number(m) - 1, Number(d));
                } else if (str.includes('.')) {
                    const [d, m, y] = str.split('.');
                    return new Date(Number(y), Number(m) - 1, Number(d));
                }
                return null;
            }
            const dt1 = parseDate(date1);
            const dt2 = parseDate(date2);
            if (!dt1 || !dt2) return null;
            return Math.ceil((dt2 - dt1) / (1000 * 60 * 60 * 24));
        }

        function getTodayStr() {
            const today = new Date();
            return today.toISOString().slice(0, 10);
        }

        allProjectsData.forEach((project, index) => {
            let totalDays = dateDiffInDays(project.start_date, project.end_date);
            totalDays = (typeof totalDays === "number" && !isNaN(totalDays)) ? (totalDays >= 0 ? totalDays : 0) : '-';

            const todayStr = getTodayStr();
            let elapsedDays = dateDiffInDays(project.start_date, todayStr);
            elapsedDays = (typeof elapsedDays === "number" && !isNaN(elapsedDays)) ? (elapsedDays >= 0 ? elapsedDays : 0) : '-';

            let delayDays = 0;
            if (project.total_delay_days !== undefined && project.total_delay_days !== null) {
                delayDays = Number(project.total_delay_days);
                if (isNaN(delayDays)) delayDays = 0;
            }
            
            let overdue = 0;
            if (project.end_date) {
                const endDateObj = (() => {
                    if (project.end_date.includes('-')) {
                        const [y, m, d] = project.end_date.split('-');
                        return new Date(Number(y), Number(m) - 1, Number(d));
                    } else if (project.end_date.includes('.')) {
                        const [d, m, y] = project.end_date.split('.');
                        return new Date(Number(y), Number(m) - 1, Number(d));
                    }
                    return null;
                })();
                const todayObj = new Date();
                if (endDateObj && todayObj > endDateObj && project.status !== 'Tamamlandı') {
                    overdue = Math.ceil((todayObj - endDateObj) / (1000 * 60 * 60 * 24));
                }
            }
            
            let gecikmeDurumu = "-";
            const combinedDelay = delayDays + overdue;
            if (combinedDelay > 0) {
                gecikmeDurumu = combinedDelay + " gün";
            } else if (typeof combinedDelay === 'number' && combinedDelay === 0) {
                gecikmeDurumu = "0 gün";
            }

            const rowBgColor = index % 2 === 0 ? '#ffffff' : '#f9f9f9';

            allProjectsHtml += `
                <tr style="background-color: ${rowBgColor};">
                    <td style="border: 1px solid #e1e5e9; padding: 8px; text-align: left;">${project.project_name ? project.project_name.normalize('NFC') : "-"}</td>
                    <td style="border: 1px solid #e1e5e9; padding: 8px; text-align: left;">${project.reference_no || "-"}</td>
                    <td style="border: 1px solid #e1e5e9; padding: 8px; text-align: left;">${project.customer_name || "-"}</td>
                    <td style="border: 1px solid #e1e5e9; padding: 8px; text-align: left;">${project.display_status || "-"}</td>
                    <td style="border: 1px solid #e1e5e9; padding: 8px; text-align: left;">${formatDateForDisplay(project.start_date || "-")}</td>
                    <td style="border: 1px solid #e1e5e9; padding: 8px; text-align: left;">${formatDateForDisplay(project.end_date || "-")}</td>
                    <td style="border: 1px solid #e1e5e9; padding: 8px; text-align: left;">${totalDays !== '-' ? totalDays + ' gün' : '-'}</td>
                    <td style="border: 1px solid #e1e5e9; padding: 8px; text-align: left;">${elapsedDays !== '-' ? elapsedDays + ' gün' : '-'}</td>
                    <td style="border: 1px solid #e1e5e9; padding: 8px; text-align: left;">${gecikmeDurumu}</td>
                    <td style="border: 1px solid #e1e5e9; padding: 8px; text-align: left;">${project.project_manager_name || "-"}</td>
                </tr>
            `;
        });

        allProjectsHtml += `
                    </tbody>
                </table>
                <div style="text-align: center; font-size: 10px; color: #6c757d; margin-top: 30px; border-top: 1px solid #eee; padding-top: 10px;">
                    © 2025 Ser Elektrik Otomasyon. Tüm hakları saklıdır.
                </div>
            </div>
        `;

        const element = document.createElement('div');
        element.innerHTML = allProjectsHtml;

        const options = {
            margin: 10,
            filename: 'Tüm_Projeler_Raporu.pdf',
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2, logging: true, dpi: 192, letterRendering: true },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' }
        };

        try {
            await html2pdf().from(element).set(options).save();
            showToast("Tüm projeler PDF olarak başarıyla dışa aktarıldı!");
            addActivity(
                "Tüm Projeler PDF Dışa Aktarıldı",
                "Tüm projeler PDF olarak indirildi.",
                null,
                "fas fa-file-pdf",
                "pdf_export_all"
            );
        } catch (error) {
            console.error("Tüm projeleri PDF'e aktarırken hata oluştu:", error);
            showToast(`PDF oluşturulurken hata oluştu: ${error.message}`, true);
        }
    }

    function updatePagination(totalItems, currentP, totalP) {
        totalProjectsCountSpan.textContent = totalItems;
        currentPageSpan.textContent = currentP;
        totalPagesSpan.textContent = totalP;

        prevPageButton.disabled = currentP === 1;
        nextPageButton.disabled = currentP === totalP || totalP === 0;

        pageNumbersContainer.innerHTML = '';
        // Sadece mevcut sayfa etrafında birkaç numara göster
        const maxPageButtons = 5;
        let startPage = Math.max(1, currentP - Math.floor(maxPageButtons / 2));
        let endPage = Math.min(totalP, startPage + maxPageButtons - 1);

        if (endPage - startPage + 1 < maxPageButtons) {
            startPage = Math.max(1, endPage - maxPageButtons + 1);
        }

        for (let i = startPage; i <= endPage; i++) {
            const pageButton = document.createElement('button');
            pageButton.className = `page-btn ${i === currentP ? 'active' : ''}`;
            pageButton.textContent = i;
            pageButton.addEventListener('click', () => {
                currentPage = i;
                renderProjectsTable(filteredProjects);
            });
            pageNumbersContainer.appendChild(pageButton);
        }
    }
    
    // Sayfalandırma butonları olay dinleyicileri
    prevPageButton.addEventListener('click', () => {
        if (currentPage > 1) {
            currentPage--;
            renderProjectsTable(filteredProjects);
        }
    });

    nextPageButton.addEventListener('click', () => {
        if (currentPage < Math.ceil(filteredProjects.length / rowsPerPage)) {
            currentPage++;
            renderProjectsTable(filteredProjects);
        }
    });

    function applyFiltersAndRenderTable() {
        const searchTerm = document.getElementById("searchInput").value.toLowerCase();
        const filterProjectName = document.getElementById("filterProjectName").value.toLowerCase();
        const filterRefNo = document.getElementById("filterRefNo").value.toLowerCase();
        const filterCustomer = document.getElementById("filterCustomer").value.toLowerCase();
        const filterStatus = document.getElementById("filterStatus").value; // Durum direkt string

        let projectsToFilter = allProjectsData;

        // "Projelerim" filtresi
        if (isMyProjectsView && currentUser && currentUser.id) {
            projectsToFilter = projectsToFilter.filter(project => 
                project.project_manager_user_id == currentUser.id
            );
        }

        filteredProjects = projectsToFilter.filter((project) => {
            const matchesSearch =
                (project.project_name &&
                project.project_name.toLowerCase().includes(searchTerm)) ||
                (project.reference_no &&
                project.reference_no.toLowerCase().includes(searchTerm)) ||
                (project.customer_name &&
                project.customer_name.toLowerCase().includes(searchTerm)) ||
                (project.project_location &&
                project.project_location.toLowerCase().includes(searchTerm));

            // Backend'den gelen 'display_status' ile filtreleme yap
            const matchesStatus = filterStatus === "" || 
                                (project.display_status && project.display_status.includes(filterStatus));


            const matchesFilters =
                (filterProjectName === "" ||
                (project.project_name &&
                    project.project_name.toLowerCase().includes(filterProjectName))) &&
                (filterRefNo === "" ||
                (project.reference_no &&
                    project.reference_no.toLowerCase().includes(filterRefNo))) &&
                (filterCustomer === "" ||
                (project.customer_name &&
                    project.customer_name.toLowerCase().includes(filterCustomer))) &&
                matchesStatus; // Yeni durum filtresi

            return matchesSearch && matchesFilters;
        });
        currentPage = 1; // Filtreler değiştiğinde ilk sayfaya dön
        renderProjectsTable(filteredProjects);
    }

    function uint8ToBase64(uint8) {
        let CHUNK_SIZE = 0x8000; // 32KB
        let index = 0;
        let length = uint8.length;
        let result = '';
        let slice;
        while (index < length) {
            slice = uint8.subarray(index, Math.min(index + CHUNK_SIZE, length));
            result += String.fromCharCode.apply(null, slice);
            index += CHUNK_SIZE;
        }
        return btoa(result);
    }

    function getCurrentUserRole() {
        // currentUser global olarak set edildiği için doğrudan ona erişebiliriz
        return currentUser ? currentUser.role : null;
    }

    // Bildirimleri çekme ve gösterme fonksiyonu (yeni_musteri.html'den kopyalandı)
    async function fetchAndRenderNotifications() {
        const notificationList = document.getElementById('notificationList');
        const notificationButton = document.getElementById('notificationButton');

        if (!currentUser || !currentUser.id) {
            if (notificationList) notificationList.innerHTML = '<p class="no-notifications">Bildirimleri görmek için giriş yapın.</p>';
            if (notificationButton) {
                notificationButton.setAttribute('data-count', '0');
                notificationButton.classList.remove('has-notifications');
            }
            return;
        }

        try {
            const response = await fetch(`${API_BASE_URL}/api/notifications?user_id=${currentUser.id}`);
            if (!response.ok) throw new Error('Bildirimler çekilemedi.');
            const notifications = await response.json();
            
            if (notificationList) notificationList.innerHTML = ''; // Listeyi temizle
            if (notifications.length === 0) {
                if (notificationList) notificationList.innerHTML = '<p class="no-notifications">Henüz bildirim yok.</p>';
                if (notificationButton) {
                    notificationButton.setAttribute('data-count', '0');
                    notificationButton.classList.remove('has-notifications');
                }
                return;
            }

            let unreadCount = 0;
            notifications.forEach(notification => {
                if (!notification.is_read) {
                    unreadCount++;
                }
                const notificationItem = document.createElement('div');
                notificationItem.className = `notification-item ${notification.is_read ? '' : 'unread'}`;
                notificationItem.dataset.id = notification.id;
                notificationItem.innerHTML = `
                    <div class="notification-item-icon">
                        <i class="${notification.icon || 'fas fa-info-circle'}"></i>
                    </div>
                    <div class="notification-item-content">
                        <div class="notification-item-title">${notification.title}</div>
                        <div class="notification-item-description">${notification.message}</div>
                        <div class="notification-item-time">${new Date(notification.timestamp).toLocaleString('tr-TR')}</div>
                    </div>
                    <div class="notification-item-actions">
                        <button class="delete-notification-btn" data-id="${notification.id}">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
                notificationItem.querySelector('.notification-item-content').addEventListener('click', (e) => {
                    e.stopPropagation(); // İçerik tıklaması silme butonuna yayılmasın
                    markNotificationAsRead(notification.id);
                });
                notificationItem.querySelector('.delete-notification-btn').addEventListener('click', (e) => {
                    e.stopPropagation(); // Silme butonu tıklaması öğeye yayılmasın
                    deleteNotification(notification.id);
                });
                if (notificationList) notificationList.appendChild(notificationItem);
            });
            if (notificationButton) {
                notificationButton.setAttribute('data-count', unreadCount);
                if (unreadCount > 0) {
                    notificationButton.classList.add('has-notifications');
                } else {
                    notificationButton.classList.remove('has-notifications');
                }
            }

        } catch (error) {
            console.error('Bildirimleri çekerken hata:', error);
            if (notificationList) notificationList.innerHTML = '<p class="no-notifications" style="color: var(--danger);">Bildirimler yüklenemedi.</p>';
        }
    }

    // Bildirimi okundu olarak işaretle
    async function markNotificationAsRead(notificationId) {
        try {
            const response = await fetch(`${API_BASE_URL}/api/notifications/${notificationId}/read`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: currentUser.id })
            });
            if (!response.ok) throw new Error('Bildirim okundu olarak işaretlenemedi.');
            fetchAndRenderNotifications(); // Listeyi yenile
        } catch (error) {
            console.error('Bildirim okundu hatası:', error);
            showToast('Bildirim okundu olarak işaretlenemedi.', true);
        }
    }

    // Bildirimi sil
    async function deleteNotification(notificationId) {
        if (!currentUser || !currentUser.id) {
            showToast('Kullanıcı oturumu bulunamadı.', true);
            return;
        }
        showConfirmationModal('Bildirimi Sil', 'Bu bildirimi silmek istediğinizden emin misiniz?', async () => {
            try {
                const response = await fetch(`${API_BASE_URL}/api/notifications/${notificationId}?user_id=${currentUser.id}`, {
                    method: 'DELETE'
                });
                if (!response.ok) throw new Error('Bildirim silinemedi.');
                showToast('Bildirim başarıyla silindi.', false);
                fetchAndRenderNotifications(); // Listeyi yenile
            } catch (error) {
                console.error('Bildirim silme hatası:', error);
                showToast('Bildirim silinirken hata oluştu.', true);
            }
        });
    }


    async function fetchUnreadNotificationCount() {
        const notificationButton = document.getElementById('notificationButton');
        try {
            let userId = currentUser ? currentUser.id : null;

            if (!userId) {
                console.warn('Kullanıcı ID bulunamadı. Okunmamış bildirim sayısı çekilemiyor.');
                notificationButton.setAttribute('data-count', '0');
                notificationButton.classList.remove('has-notifications');
                return;
            }

            const response = await fetch(`${API_BASE_URL}/api/notifications/unread-count?user_id=${userId}`);
            if (!response.ok) {
                if (response.status === 404) {
                    console.warn('API endpoint not found: /api/notifications/unread-count. Setting notification count to 0.');
                    notificationButton.setAttribute('data-count', '0');
                    notificationButton.classList.remove('has-notifications');
                    return;
                }
                const errorText = await response.text();
                throw new Error(`Okunmamış bildirim sayısı çekilemedi. Sunucu yanıtı: ${response.status} - ${errorText.substring(0, 100)}...`);
            }
            const data = await response.json();
            const unreadCount = data.unread_count;

            notificationButton.setAttribute('data-count', unreadCount);
            if (unreadCount > 0) {
                notificationButton.classList.add('has-notifications');
            } else {
                notificationButton.classList.remove('has-notifications');
            }
        } catch (error) {
            console.error('Okunmamış bildirim sayısı çekilemedi:', error);
            notificationButton.setAttribute('data-count', '!');
            showToast(`Bildirim sayısı yüklenirken hata oluştu: ${error.message}`, true);
        }
    }

    async function checkPermission(permissionKey) {
        const role = getCurrentUserRole();
        if (!role) {
            showToast('Kullanıcı rolü bulunamadı. Lütfen tekrar giriş yapın.', true);
            setTimeout(() => { window.location.href = 'index.html'; }, 1500);
            return false;
        }
        try {
            const response = await fetch(`${API_BASE_URL}/api/role-permissions?role=${encodeURIComponent(role)}`);
            if (!response.ok) throw new Error('Yetki sorgusu başarısız');
            const perms = await response.json();
            const permission = Array.isArray(perms) ? perms[0] : perms; // API'den dönen yapıya göre ayarlayın
            if (permission[permissionKey] != 1) { // Yetkinin 1 olması gerekiyor
                let msg = 'Bu işlem için yetkiniz yok!';
                if (permissionKey === 'proje_duzenle') msg = 'Proje düzenleme yetkiniz yok!';
                else if (permissionKey === 'proje_sil') msg = 'Proje silme yetkiniz yok!';
                else if (permissionKey === 'pdf_olusturma') msg = 'PDF oluşturma yetkiniz yok!';
                showToast(msg, true);
                return false;
            }
            return true;
        } catch (error) {
            console.error('Yetki sorgusu sırasında hata oluştu:', error);
            showToast('Yetki sorgusu sırasında hata oluştu. Lütfen tekrar deneyin.', true);
            setTimeout(() => { window.location.href = 'index.html'; }, 1500);
            return false;
        }
    }
    // Sayfa yüklendiğinde event listener'ları ekle
document.addEventListener('DOMContentLoaded', function() {
    // Mevcut event delegation kodu
    document.addEventListener('click', function(e) {
        // Mevcut click handler'lar...
        
        // Tamamlama checkbox'ı için
        if (e.target.closest('.complete-step-checkbox')) {
            const checkbox = e.target.closest('.complete-step-checkbox');
            const progressId = checkbox.dataset.id;
            const isChecked = checkbox.checked;
            
            if (isChecked) {
                if (confirm('Bu iş gidişatını tamamlandı olarak işaretlemek istediğinize emin misiniz? (Bu işlem geri alınamaz)')) {
                    updateProgressStatus(progressId, true);
                } else {
                    checkbox.checked = false;
                }
            } else {
                // Eğer kullanıcı işareti kaldırmak isterse
                updateProgressStatus(progressId, false);
            }
        }
    });
});
const progressStepsContainer = document.querySelector('#progress-steps-container');
        if (progressStepsContainer) {
            progressStepsContainer.addEventListener('change', function(e) {
                // Sadece checkbox'ları hedefle
                if (e.target && e.target.matches('input[type="checkbox"]')) {
                    const checkbox = e.target;
                    const progressId = checkbox.dataset.progressId;
                    const isChecked = checkbox.checked;

                    if (isChecked) {
                        if (confirm('Bu adımı tamamlamak istediğinizden emin misiniz? (Bu işlem geri alınamaz)')) {
                            // Onaylanırsa API'ye isteği gönder
                            updateProgressStatus(progressId, true);
                        } else {
                            // Onaylanmazsa checkbox'ı eski haline getir
                            checkbox.checked = false;
                        }
                    } else {
                        // İşaret kaldırıldığında doğrudan API'ye istek gönder
                        updateProgressStatus(progressId, false);
                    }
                }
            });
        }
        async function updateProgressStatus(progressId, isChecked) {
            const checkbox = document.querySelector(`#complete-${progressId}`);
            if (!checkbox) {
                console.error('Checkbox bulunamadı');
                return;
            }
            
            const stepElement = checkbox.closest('.progress-detail-item');
            if (!stepElement) {
                console.error('İş adımı bulunamadı');
                return;
            }
            
            // Tüm olası proje ID'si kaynaklarını kontrol et
            let foundProjectId = null;
            
            // 1. Progress adımları container'ından al
            if (!foundProjectId) {
                const container = document.getElementById('progressStepsContainer');
                if (container) {
                    foundProjectId = container.getAttribute('data-project-id');
                    console.log('progressStepsContainer dan alındı:', foundProjectId);
                }
            }
            
            // 2. Modal'dan al
            if (!foundProjectId) {
                const modal = document.querySelector('#projectModal');
                if (modal && modal.dataset.projectId) {
                    foundProjectId = modal.dataset.projectId;
                    console.log('Modal dan alındı:', foundProjectId);
                }
            }
            
            // 3. URL'den al
            if (!foundProjectId) {
                const urlMatch = window.location.pathname.match(/\/projects\/(\d+)/);
                if (urlMatch && urlMatch[1]) {
                    foundProjectId = urlMatch[1];
                    console.log('URL path den alındı:', foundProjectId);
                } else {
                    const urlParams = new URLSearchParams(window.location.search);
                    foundProjectId = urlParams.get('project_id');
                    console.log('URL parametresinden alındı:', foundProjectId);
                }
            }
            
            // 4. Sayfadaki gizli input'tan al
            if (!foundProjectId) {
                const hiddenProjectId = document.querySelector('input[name="project_id"]');
                if (hiddenProjectId && hiddenProjectId.value) {
                    foundProjectId = hiddenProjectId.value;
                    console.log('Gizli input tan alındı:', foundProjectId);
                }
            }
            
            // 5. İş adımının veri özelliklerinden al
            if (!foundProjectId) {
                // Önce kendisinde ara
                if (stepElement.dataset.projectId) {
                    foundProjectId = stepElement.dataset.projectId;
                    console.log('Step elementinden alındı (data-project-id):', foundProjectId);
                }
                // Sonra üst elementlerde ara
                else {
                    const parentWithId = stepElement.closest('[data-project-id]');
                    if (parentWithId) {
                        foundProjectId = parentWithId.dataset.projectId;
                        console.log('Üst elementten alındı (data-project-id):', foundProjectId);
                    }
                }
            }
            
            if (!foundProjectId) {
                console.error('Proje ID bulunamadı', {
                    stepElement: stepElement,
                    modal: !!document.querySelector('#projectModal'),
                    urlParams: window.location.search,
                    hiddenInput: document.querySelector('input[name="project_id"]'),
                    container: document.getElementById('progressStepsContainer')
                });
                showToast('Hata', 'Proje bilgisine ulaşılamadı. Lütfen sayfayı yenileyip tekrar deneyin.', 'error');
                checkbox.checked = !isChecked; // Checkbox durumunu geri al
                return;
            }
            
            // foundProjectId'yi doğrudan kullanıyoruz
            const projectIdToUse = foundProjectId; 
            
            try {
                const response = await fetch(`/api/progress/${progressId}/complete`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({ 
                        is_completed: isChecked,
                        project_id: projectIdToUse
                    })
                });

                const result = await response.json();
                
                if (!response.ok || !result.success) {
                    throw new Error(result.message || 'Bir hata oluştu');
                }
                
                // İşlem başarılıysa UI'ı güncelle
                if (isChecked) {
                    // Tamamlandı olarak işaretlendi
                    stepElement.classList.add('completed-step');
                    stepElement.setAttribute('data-completed', 'true');
                    
                    // Tüm form elemanlarını devre dışı bırak
                    const formElements = stepElement.querySelectorAll('input, select, textarea, button, .btn-edit, .btn-delete');
                    formElements.forEach(element => {
                        if (element !== checkbox) { // Checkbox hariç
                            element.disabled = true;
                            element.style.pointerEvents = 'none';
                            element.style.opacity = '0.6';
                        }
                    });
                    
                    // Bağlantıları devre dışı bırak
                    const links = stepElement.querySelectorAll('a');
                    links.forEach(link => {
                        link.style.pointerEvents = 'none';
                        link.style.opacity = '0.6';
                        link.style.cursor = 'not-allowed';
                        link.onclick = (e) => {
                            e.preventDefault();
                            return false;
                        };
                    });
                    
                    // Checkbox etiketini güncelle
                    const label = checkbox.nextElementSibling;
                    if (label && label.classList.contains('form-check-label')) {
                        label.textContent = 'Tamamlandı';
                        label.style.color = '#4caf50';
                        label.style.fontWeight = 'bold';
                    }
                    
                    // Tamamlandı rozeti ekle (eğer yoksa)
                    let badge = stepElement.querySelector('.progress-detail-title .badge');
                    if (!badge) {
                        badge = document.createElement('span');
                        badge.className = 'badge bg-success ms-2';
                        badge.textContent = 'Tamamlandı';
                        const titleElement = stepElement.querySelector('.progress-detail-title');
                        if (titleElement) {
                            titleElement.appendChild(badge);
                        }
                    }
                    
                    // showToast kaldırıldı - zaten aşağıda tek bir başarı mesajı gösterilecek
                } else {
                    // Tamamlanmadı olarak işaretlendi
                    stepElement.classList.remove('completed-step');
                    stepElement.removeAttribute('data-completed');
                    
                    // Tüm form elemanlarını tekrar etkinleştir
                    const formElements = stepElement.querySelectorAll('input, select, textarea, button, .btn-edit, .btn-delete');
                    formElements.forEach(element => {
                        element.disabled = false;
                        element.style.pointerEvents = '';
                        element.style.opacity = '';
                    });
                    
                    // Bağlantıları tekrar etkinleştir
                    const links = stepElement.querySelectorAll('a');
                    links.forEach(link => {
                        link.style.pointerEvents = '';
                        link.style.opacity = '';
                        link.style.cursor = '';
                        link.onclick = null;
                    });
                    
                    // Checkbox etiketini sıfırla
                    const label = checkbox.nextElementSibling;
                    if (label && label.classList.contains('form-check-label')) {
                        label.textContent = 'Tamamlandı olarak işaretle';
                        label.style.color = '';
                        label.style.fontWeight = '';
                    }
                    
                    // Tamamlandı rozetini kaldır
                    const badge = stepElement.querySelector('.progress-detail-title .badge');
                    if (badge) {
                        badge.remove();
                    }
                    
                    // showToast kaldırıldı - zaten aşağıda tek bir başarı mesajı gösterilecek
                }
                
                // Proje detaylarını güncelle
                if (projectIdToUse) {
                    updateProjectDatesFromSteps(projectIdToUse);
                }
                
                // Tek bir başarı mesajı göster
            
            if (isChecked) {
                const stepElement = document.querySelector(`.progress-step[data-progress-id="${progressId}"]`);
                if (stepElement) {
                    stepElement.setAttribute('data-is-completed', '1');
                    const formElements = stepElement.querySelectorAll('input, select, textarea');
                    formElements.forEach(element => {
                        element.disabled = true;
                    });
                }
            }
            
            const projectId = document.querySelector('.project-details')?.dataset.projectId;
            if (projectId) {
                // fetchProgressSteps fonksiyonunun burada çağrıldığını varsayıyoruz.
                // Eğer bu fonksiyon yoksa, bu satırı kaldırabilirsiniz.
                // await fetchProgressSteps(projectId);
            }
        } catch (error) {
            console.error('Hata:', error);
            showToast('Hata', error.message || 'İşlem sırasında bir hata oluştu', 'error');
            checkbox.checked = !isChecked;
        }
    }
    function showToast(title, message, type) {
        const toastContainer = document.getElementById('toast-container');
        if (!toastContainer) {
            // Eğer toast-container yoksa, bir tane oluştur
            const newToastContainer = document.createElement('div');
            newToastContainer.id = 'toast-container';
            document.body.appendChild(newToastContainer);
        }
        
        // Bootstrap'in kendi Toast bileşenini kullandığını varsayarak...
        const toast = document.createElement('div');
        toast.className = `toast align-items-center text-white bg-${type} border-0`;
        toast.setAttribute('role', 'alert');
        toast.setAttribute('aria-live', 'assertive');
        toast.setAttribute('aria-atomic', 'true');
        toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        `;
        document.getElementById('toast-container').appendChild(toast);
        const bsToast = new bootstrap.Toast(toast, { delay: 5000 });
        bsToast.show();
    }
</script>
    <!-- Revizyon İsteği Modal -->
    <style>
        /* Custom Modal Styling */
        #revisionRequestModal .modal-dialog {
            display: flex;
            align-items: center;
            min-height: calc(100% - 1rem);
            margin: 0.5rem auto;
        }
        
        #revisionRequestModal .modal-content {
            border: none;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            background-color: var(--card-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
        }
        
        #revisionRequestModal .modal-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: var(--white);
            padding: 1.2rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            position: relative;
        }
        
        #revisionRequestModal .modal-title {
            font-weight: 600;
            font-size: 1.25rem;
            color: var(--white);
            width: 100%;
            padding-right: 2rem;
        }
        
        #revisionRequestModal .btn-close {
            position: absolute;
            right: 1.5rem;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0.8;
            transition: all 0.2s ease;
            background: none;
            color: var(--white);
            font-size: 1.5rem;
            line-height: 1;
            padding: 0.5rem;
            margin: 0;
            border: none;
            border-radius: 4px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #revisionRequestModal .btn-close:hover {
            opacity: 1;
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        #revisionRequestModal .btn-close::before {
            content: '×';
            font-size: 2rem;
            line-height: 1;
            margin-top: -4px;
        }
        
        #revisionRequestModal .modal-body {
            padding: 1.5rem;
            background-color: var(--card-bg);
        }
        
        #revisionRequestModal .form-label {
            font-weight: 500;
            color: var(--text-color);
            margin-bottom: 0.5rem;
        }
        
        #revisionRequestModal .form-control {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            transition: all 0.3s ease;
            background-color: var(--input-bg);
            color: var(--text-color);
            width: 100%;
        }
        
        #revisionRequestModal .form-control:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 0.25rem rgba(0, 92, 157, 0.15);
        }
        
        #revisionRequestModal textarea.form-control {
            min-height: 120px;
            resize: vertical;
        }
        
        #revisionRequestModal .modal-footer {
            border-top: 1px solid var(--border-color);
            padding: 1.25rem 1.5rem;
            background-color: var(--card-bg);
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }
        
        #revisionRequestModal .btn {
            padding: 0.6rem 1.75rem;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.2s ease;
            min-width: 100px;
            text-align: center;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        #revisionRequestModal .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            border: none;
            color: white;
        }
        
        #revisionRequestModal .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 92, 157, 0.2);
            background: linear-gradient(135deg, var(--primary-light) 0%, var(--primary) 100%);
        }
        
        #revisionRequestModal .btn-secondary {
            background-color: var(--primary);
            color: white;
            border: 1px solid var(--primary);
        }
        
        [data-theme="dark"] #revisionRequestModal .btn-secondary {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        #revisionRequestModal .btn-secondary:hover {
            background-color: var(--primary-light);
            color: white;
            border-color: var(--primary-light);
        }
        
        [data-theme="dark"] #revisionRequestModal .btn-secondary:hover {
            background-color: var(--primary-light);
            color: white;
            border-color: var(--primary-light);
        }
        
        /* Dark mode specific styles */
        [data-theme="dark"] #revisionRequestModal .form-control::placeholder {
            color: var(--light-gray);
            opacity: 0.7;
        }
        
        [data-theme="dark"] #revisionRequestModal .form-control:focus {
            background-color: var(--input-bg);
            color: var(--text-color);
        }
        
        /* Animation */
        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        #revisionRequestModal .modal-dialog {
            animation: modalFadeIn 0.3s ease-out;
        }
        
        /* Form group styling */
        #revisionRequestModal .form-group {
            margin-bottom: 1.5rem;
        }
        
        /* Responsive adjustments */
        @media (max-width: 576px) {
            #revisionRequestModal .modal-dialog {
                margin: 0.5rem;
            }
            #revisionRequestModal .modal-content {
                border-radius: 8px;
            }
            #revisionRequestModal .btn {
                padding: 0.5rem 1.25rem;
                min-width: 80px;
            }
        }
    </style>
    
    <div class="modal fade" id="revisionRequestModal" tabindex="-1" aria-labelledby="revisionRequestModalLabel" aria-hidden="true" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="revisionRequestModalLabel">
                        Revizyon İsteği Gönder
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
                </div>
                <form id="revisionRequestForm">
                    <div class="modal-body">
                        <input type="hidden" id="revisionProgressId" name="progress_id">
                        <input type="hidden" id="revisionProjectId" name="project_id">
                        
                        <div class="form-group">
                            <label for="revisionTitle" class="form-label">
                                Başlık
                            </label>
                            <input type="text" class="form-control" id="revisionTitle" name="title" 
                                   placeholder="Revizyon başlığını giriniz" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="revisionMessage" class="form-label">
                                Açıklama
                            </label>
                            <textarea class="form-control" id="revisionMessage" name="message" 
                                      rows="5" placeholder="Revizyon detaylarını açıklayınız..." required></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            İptal
                        </button>
                        <button type="submit" class="btn btn-primary">
                            Gönder
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="static/bildirim.js"></script>
    <script src="static/user-avatar.js"></script>
    
    <script>
        // Revizyon isteği modalını göster
        function showRevisionRequestModal(progressId, projectId) {
            const modalElement = document.getElementById('revisionRequestModal');
            if (!modalElement) {
                console.error('Revizyon isteği modalı bulunamadı');
                return;
            }
            
            // Form alanlarını sıfırla
            document.getElementById('revisionProgressId').value = progressId;
            document.getElementById('revisionProjectId').value = projectId;
            document.getElementById('revisionTitle').value = '';
            document.getElementById('revisionMessage').value = '';
            
            // Modalı göster
            const modal = new bootstrap.Modal(modalElement);
            modal.show();
        }
        
        // Revizyon isteği formu gönderimi
     document.addEventListener('DOMContentLoaded', function() {
    const revisionForm = document.getElementById('revisionRequestForm');
    if (revisionForm) {
        revisionForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(revisionForm);
            const progressId = formData.get('progress_id');
            const projectId = formData.get('project_id');
            const title = formData.get('title')?.trim() || '';
            const message = formData.get('message')?.trim() || '';
            
            // Form doğrulama
            if (!title || !message) {
                showToast('Uyarı', 'Lütfen tüm alanları doldurunuz', 'warning');
                return;
            }
            
            const submitBtn = revisionForm.querySelector('button[type="submit"]');
            const originalBtnText = submitBtn?.innerHTML || 'Gönder';
            
            try {
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Gönderiliyor...';
                }

                const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content || 
                                document.querySelector('[name=csrf_token]')?.value;

                const response = await fetch('/api/revision-requests', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken || '',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({
                        progress_id: progressId,
                        project_id: projectId,
                        title: title,
                        message: message
                        // created_by backend'den session'dan alınacak
                    })
                });
                
                const responseData = await response.json();
                
                if (!response.ok) {
                    throw new Error(responseData.message || 'Revizyon isteği gönderilirken bir hata oluştu');
                }
                
                showToast('Başarılı', 'Revizyon isteğiniz başarıyla gönderildi', 'success');
                revisionForm.reset();
                
                const modal = bootstrap.Modal.getInstance(document.getElementById('revisionRequestModal'));
                if (modal) {
                    modal.hide();
                }
                
                if (window.location.pathname.includes('proje-detay')) {
                    const urlProjectId = new URLSearchParams(window.location.search).get('id');
                    if (urlProjectId) {
                        fetchProgressSteps(urlProjectId, true);
                    }
                }
                
            } catch (error) {
                console.error('Revizyon isteği gönderilirken hata oluştu:', error);
                showToast('Hata', error.message || 'Revizyon isteği gönderilirken bir hata oluştu', 'error');
            } finally {
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalBtnText;
                }
            }
        });
    }
});
    </script>
  </body>
</html>
